function ArrayList(){this.count=0,this.head=new ArrayListNode(null),this.tail=new ArrayListNode(null),this.head.next=this.tail,this.tail.prev=this.head}function ArrayListNode(t){this.next=null,this.prev=null,this.value=t}function ArrayListIter(t,e){this.head=t,this.tail=e,this.cursor=t}function IndexMinPQ(t){this.size=t,this.count=0,this.pq=new Array(t+1),this.qp=new Array(t+1),this.keys=new Array(t+1);for(var e=0;e<=this.size;e++)this.qp[e]=-1,this.keys[e]=Number.MAX_VALUE}function DodecahedronMesh(t,e){this._init(t,e)}function HexahedronMesh(t,e){this._init(t,e)}function IcosahedronMesh(t,e){this._init(t,e)}function MeshBuffer(t){this.gl=t,this.attributes={}}function OctahedronMesh(t,e){this._init(t,e)}function TetrahedronMesh(t,e){this._init(t,e)}function RawPanorama(t,e){this.gl=t,this.region=e,this.cubeVBO=null,this.cubeSize=0,this.cubeMap=null,this._initCube(),this.modelMat=YFM.Math.Matrix.rotate3d(90,1,0,0)}function TESSvertex(){this.next=null,this.prev=null,this.anEdge=null,this.coords=[0,0,0],this.s=0,this.t=0,this.pqHandle=0,this.n=0,this.idx=0}function TESSface(){this.next=null,this.prev=null,this.anEdge=null,this.trail=null,this.n=0,this.marked=!1,this.inside=!1}function TESShalfEdge(t){this.next=null,this.Sym=null,this.Onext=null,this.Lnext=null,this.Org=null,this.Lface=null,this.activeRegion=null,this.winding=0,this.side=t}function TESSmesh(){var t=new TESSvertex,e=new TESSface,i=new TESShalfEdge(0),r=new TESShalfEdge(1);t.next=t.prev=t,t.anEdge=null,e.next=e.prev=e,e.anEdge=null,e.trail=null,e.marked=!1,e.inside=!1,i.next=i,i.Sym=r,i.Onext=null,i.Lnext=null,i.Org=null,i.Lface=null,i.winding=0,i.activeRegion=null,r.next=r,r.Sym=i,r.Onext=null,r.Lnext=null,r.Org=null,r.Lface=null,r.winding=0,r.activeRegion=null,this.vHead=t,this.fHead=e,this.eHead=i,this.eHeadSym=r}function DictNode(){this.key=null,this.next=null,this.prev=null}function Dict(t,e){this.head=new DictNode,this.head.next=this.head,this.head.prev=this.head,this.frame=t,this.leq=e}function PQnode(){this.handle=null}function PQhandleElem(){this.key=null,this.node=null}function PriorityQ(t,e){this.size=0,this.max=t,this.nodes=[],this.nodes.length=t+1;for(i=0;i<this.nodes.length;i++)this.nodes[i]=new PQnode;this.handles=[],this.handles.length=t+1;for(var i=0;i<this.handles.length;i++)this.handles[i]=new PQhandleElem;this.initialized=!1,this.freeList=0,this.leq=e,this.nodes[1].handle=1,this.handles[1].key=null}function ActiveRegion(){this.eUp=null,this.nodeUp=null,this.windingNumber=0,this.inside=!1,this.sentinel=!1,this.dirty=!1,this.fixUpperEdge=!1}function Tesselator(){this.mesh=null,this.normal=[0,0,0],this.sUnit=[0,0,0],this.tUnit=[0,0,0],this.bmin=[0,0],this.bmax=[0,0],this.windingRule=Tess2.WINDING_ODD,this.dict=null,this.pq=null,this.event=null,this.vertexIndexCounter=0,this.vertices=[],this.vertexIndices=[],this.vertexCount=0,this.elements=[],this.elementCount=0}function Floor(t,e,i,r,s,o,n){this.loaded=!1,this.gl=t,this.id=e,this.deflection=null!=r?r:0,this.region=s,this.index=o,this.loadListener=n,this.mapWidth=0,this.mapHeight=0,this.vOffset=0,this.unitHeight=0,this.extrude=new FloorExtrude(t),this.boundary=new FloorBoundary(t,20),this.quickPolygon=new FloorQuickPolygon(t),this.quadTree=null,this.icons=null,this.models=null,this.markers=new FloorMarkers(this.gl,this.region,this),this.texRect=new FloorTextureRect(this.region,this.gl,0),this.texRectSpec=new FloorTextureRect(this.region,this.gl,1),this.texRectUltra=new FloorTextureRect(this.region,this.gl,2),this.trajectory=new FloorTrajectory(this.region,this,this.gl),this.dummyUnitList=[],this.BBCheck=-1;var a=this;if(null===this.loadListener)a._load_svg(i);else{var h=new XMLHttpRequest;h.open("GET",i,!0),h.responseType="text",h.onload=function(t){200==this.status?(console.log("-ajax request ok"),a._load_svg(this.response),a.loadListener.onLoadFinish(a)):(a.loadListener.onLoadFailed(a,this.status),console.log("-ajax error:%d",this.status))},h.send()}null===Floor.prototype.quadVBO&&this._initQuad(t)}function FloorBoundary(t,e){this.gl=t,this.height=e,this.boundarySideVBO=null,this.boundarySideCBO=null,this.boundarySideSize=0,this.boundarySideVarray=[],this.boundarySideCarray=[],this.loaded=!1}function FloorExtrude(t){this.gl=t,this.height=0,this.extrudeTopVBO=null,this.extrudeTopCBO=null,this.extrudeTopSize=0,this.extrudeTopVarray=[],this.extrudeTopCarray=[],this.extrudeSideVBO=null,this.extrudeSideCBO=null,this.extrudeSideSize=0,this.extrudeSideVarray=[],this.extrudeSideCarray=[],this.borderVBO=null,this.borderSize=0,this.borderVarray=[],this.borderNormal=YFM.Math.Vector.vec(0,0,1),this.loaded=!1}function FloorIconPlus(t,e,i){this.gl=t,this.region=e,this.floor=i,this.quadTree=new FloorQuadTree(i,100),this._makeVBO()}function FloorIcons(t,e,i){this.gl=t,this.region=e,this.floor=i,this.quadTree=new FloorQuadTree(i,100),this.iconTex=null;var r=[];r.push(YFM.Math.Vector.pos(-1,-1,0)),r.push(YFM.Math.Vector.pos(1,-1,0)),r.push(YFM.Math.Vector.pos(1,1,0)),r.push(YFM.Math.Vector.pos(-1,1,0));var s,o=[];for(s=0;s<16;s++)this._calcTexCoords(o,r,s);this.quadVBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.quadVBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(o,3),this.gl.STATIC_DRAW),this.quadBufferSize=o.length/2}function FloorMarkers(t,e,i){this.gl=t,this.region=e,this.floor=i,this.markerArray=[],this.markerIMinPQ=new IndexMinPQ(32),this.markerSorted=[],this.light=YFM.Math.Vector.vec(.5,.5,1),this._initQuad(t)}function FloorModels(t,e,i,r){this.gl=t,this.region=e,this.floor=i,this.vPitch=r,this.quadTree=new FloorQuadTree(i,r)}function FloorQuickIcons(t,e,i,r){this.gl=t,this.region=e,this.floor=i,this.height=r||10,this.tex=null,this.texName=null,this.pointsVBO=null,this.pointsSize=0,this.pointsVarray=[]}function FloorQuickPolygon(t){this.gl=t,this.height=1,this.quickPolygonVBO=null,this.quickPolygonCBO=null,this.quickPolygonSize=0,this.quickPolygonVarray=[],this.quickPolygonCarray=[],this.loaded=!1}function FloorTextureRect(t,e,i){this.region=t,this.gl=e,this.height=2,this.textureRectVBO=null,this.textureRectSize=0,this.textureRectVarray=[],this.loaded=!1;var r=YFM.Math.Vector;this.tex=[],this.tex.push(r.vec(0,0)),this.tex.push(r.vec(1,0)),this.tex.push(r.vec(1,1)),this.tex.push(r.vec(0,1)),this.number=i}function FloorTrajectory(t,e,i){this.region=t,this.floor=e,this.gl=i,this.height=1,this.meshList=[],this.time=0}function AnimationMgr(t,e,i,r){this.region=t,this.camera=e,this.touchMgr=i,this.listener=r,this.seq=new ArrayList,this.mover=new Mover,this.mover.setMaxForce(16),this.mover.setMaxSpeed(16),this.current=null}function Animation(t,e,i){this.tag=t,this.type=e,this.frame=i,this.step=0}function Region(t,e,i,r){this.id=t,this.matRegion=YFM.Math.Matrix.mat(),this.glCanvas=e,this.gl=YFM.WebGL.setupWebGL(e),this.gl.viewport(0,0,e.width,e.height),this.gl.clearColor(.9,.9,.9,1),YFM.gGL=this.gl,this.hh=e.height/2,this.hw=e.width/2,this.tqct=new TextBlockQuickCheckTree(i.width,i.height),this.txtCanvas=i,this.ctx2d=i.getContext("2d"),this.ctx2d.font="24px Microsoft YaHei",this.ctx2d.fillStyle="#FF0000",this.ctx2d.textAlign="center",this.ctx2d.textBaseline="middle",this.fontHeight=this._determineFontHeight("font: "+this.ctx2d.font+";"),this.camera=new DeviceOrientationCamera,this.camera.setPerspective(60,e.width/e.height,60,2e4),this.camera.setLookOffset(0,0,-400),this.orthMat=YFM.Math.Matrix.orthographic(-e.width/2,e.width/2,-e.height/2,e.height/2,-1,1),this.renderParam={projMat:null,viewMat:null,regionMat:null,vrMat:null,bivrMat:null,pvrMat:null},this.listener=r,this.floors=[],this.baseColorShader=new BaseColorProgram(this.gl),this.basePhongShader=new BasePhongProgram(this.gl),this.selectColorShader=new SelectColorProgram(this.gl),this.regionPhongShader=new RegionPhongProgram(this.gl),this.billboardIconShader=new BillboardIconProgram(this.gl),this.marker2DShader=new Marker2DProgram(this.gl),this.color2DShader=new Color2DProgram(this.gl),this.modelPhongShader=new ModelPhongProgram(this.gl),this.ssrShader=new SSRProgram(this.gl,this),this.trajectoryShader=new TrajectoryProgram(this.gl),this.maxSize=0,this.vPitch=0,this.displayFloorIndex=-1,this.azimuth=0;var s=this;this.touchMgr=new RegionTouchMgr(this.camera,i,this.ctx2d,this,{onClick:function(t,e){s.listener&&s.listener.onClick&&s.listener.onClick(t,e)},onDClick:function(t,e){s.listener&&s.listener.onDClick&&s.listener.onDClick(t,e)},on2FClick:function(t,e){s.listener&&s.listener.on2FClick&&s.listener.on2FClick(t,e)},onLongPressUp:function(t,e){s.listener&&s.listener.onLongPressUp&&s.listener.onLongPressUp(t,e)},onScroll:function(t,e){s.listener&&s.listener.onScroll&&s.listener.onScroll(t,e)}}),this.animMgr=new AnimationMgr(this,this.camera,this.touchMgr,{onAnimStart:function(t){s.listener&&s.listener.onAnimStart(t)},onAnimFinish:function(t){s.listener&&s.listener.onAnimFinish(t)},onAnimCancle:function(t){s.listener&&s.listener.onAnimCancel(t)}}),this.locMarker=new RegionLocMarker(this.gl,20,2152900137,3992977408,this),this.frustum=new FrustumWorldSpace,this.route=new SSRoute(this),this.texturePool=new TexturePool(this.gl),this.extrudeLightNormal=YFM.Math.Vector.normalize(YFM.Math.Vector.vec(0,1,1)),this.extrudeLightOver=YFM.Math.Vector.normalize(YFM.Math.Vector.vec(0,1,1)),this.extrudeLight=this.extrudeLightNormal,this.modelLight=YFM.Math.Vector.normalize(YFM.Math.Vector.vec(-1,-1,1)),this.overlook=!1,this.drawUnitTextAlways=!1,this.drawAllUnit=!1,this.customFloorHeight=null,this.regionThumbnail=new RegionThumbnail(this),this.regionThumbnailFlag=!1,this.status=YFM.Map.STATUS_TOUCH,this.listener&&this.listener.onStatusChange(this.status),this.ambient=YFM.Math.Vector.pos(.9,.9,.9),this.diffuse=YFM.Math.Vector.pos(.2,.2,.2),this.orgPos=YFM.Math.Vector.pos(0,0,0),this.markerAnim={},this._initMarkerAnim()}function RegionLocMarker(t,e,i,r,s){var o=YFM.Math.Vector,n=YFM.WebGL.Color;this.gl=t,this.size=e,this.faceColor=o.vec(n.hexColorRed(i),n.hexColorGreen(i),n.hexColorBlue(i),n.hexColorAlpha(i)),this.lineColor=o.vec(n.hexColorRed(r),n.hexColorGreen(r),n.hexColorBlue(r),n.hexColorAlpha(r)),this.region=s,this.waveRadius=o.vec(12,12),this.waveMax=48,this.waveMin=12,this.waveStep=(this.waveMax-this.waveMin)/56,this.locMarkerTexName=null,this.locMarker=null,this.regionLoc=YFM.Math.Vector.pos(0,0,0),this.floorLoc={floor:-1,x:0,y:0},this.anim={floor:0,dist:.1,flag:!1,mover:new Mover(0,0,0),target:null},this._init(t,e)}function RegionThumbnail(t){this.region=t,this.visibility=!1,this.renderParam=null,this.extrudeLight=YFM.Math.Vector.normalize(YFM.Math.Vector.vec(.5,.5,1)),this.scaleRate=1}function RegionTouchMgr(t,e,i,r,s){function o(t){if(a.enable)switch(t.preventDefault(),a._updateEventLayerPos(t),t.type){case"touchstart":a.strategy.touchDown(t);break;case"touchmove":a.strategy.touchMove(t);break;case"touchend":a.strategy.touchUp(t);break;case"touchcancel":a.strategy.touchCancel(t)}}function n(t){if(a.enable)switch(t.preventDefault(),t.type){case"mousedown":document.body.tabIndex=-1,document.body.focus(),document.onkeypress=arguments.callee,a._updateEventLayerPos(t),a.strategy_desktop.mouseDown(t);break;case"mouseup":document.onkeypress=null,a._updateEventLayerPos(t),a.strategy_desktop.mouseUp(t);break;case"mouseleave":document.onkeypress=null,a._updateEventLayerPos(t),a.strategy_desktop.mouseLeave(t);case"mousemove":a._updateEventLayerPos(t),a.strategy_desktop.mouseMove(t);break;case"mousewheel":a._updateEventLayerPos(t),a.strategy_desktop.mouseWheel(t);break;case"keypress":a.strategy_desktop.keyPress(t)}}this.hangUp=!1,this.camera=t,this.canvas=e,this.ctx2d=i,this.region=r,this.listener=s,this.touchFloorIndex=-1,this.focusFloorDirty=!0,this.enable=!0,this.isMobile=this._isMobileBrowser(),this.uiScaleRate=1,this.overlook=!1,this.longPressFlag=!1,this.box=e.getBoundingClientRect(),this.touchRec={savedmat:YFM.Math.Matrix.matClone(r._getRegionMat()),pitchCnt:0,degree:0,screenSpacing:0,viewSpacing:0,radius0x:0,radius0y:0,layer0x:0,layer0y:0,layer1x:0,layer1y:0,dy0:0,dy1:0,start0x:0,start0y:0,start1x:0,start1y:0,pre0y:0,pre1y:0,midX:0,midY:0},this.planeRec={planeHeight:0,midpos:null,start0:null,start1:null,prev:null,translateX:0,translateY:0,firstAngle:0},this.viewZoom={max:3e3,min:150};var a=this;this.strategy_desktop={timeStampPrev:0,timeStampCur:0,clickFlag:!1,pitchLock:!1,rotateLock:!1,zoomLock:!1,zoomTarget:null,deltaPitch:0,deltaAngle:0,mousePressed:!1,mouseDown:function(t){this.timeStampPrev=this.timeStampCur,this.timeStampCur=(new Date).getTime(),a.planeRec.planeHeight=a._touch_plane_height(a.touchRec.layer0x,a.touchRec.layer0y),a.touchRec.savedmat=YFM.Math.Matrix.matClone(a.region._getRegionMat()),a.planeRec.start0=a._pos_in_world_space(a.touchRec.layer0x,a.touchRec.layer0y),a.planeRec.translateX=0,a.planeRec.translateY=0,this.mousePressed=!0,this.rotateLock=!1,this.pitchLock=!1,this.zoomLock=!1},mouseUp:function(t){var e=(new Date).getTime(),i=a.planeRec.translateX,r=a.planeRec.translateY;if(!(this.rotateLock||this.pitchLock||this.zoomLock)){if(this.clickFlag){var s=e-this.timeStampPrev;i*i+r*r<100&&s<200&&a._onDClick(a.touchRec.layer0x,a.touchRec.layer0y),this.clickFlag=!1}else{var o=e-this.timeStampCur;if(i*i+r*r<100)if(o<100){this.clickFlag=!0;var n=this;setTimeout(function(){n.clickFlag&&(n.clickFlag=!1,a._onClick(a.touchRec.layer0x,a.touchRec.layer0y))},200)}else o>800&&a._onLongPressUp(a.touchRec.layer0x,a.touchRec.layer0y)}this.mousePressed=!1,this.deltaAngle=0,this.deltaPitch=0}},mouseLeave:function(t){this.mousePressed=!1,this.deltaAngle=0,this.deltaPitch=0},mouseMove:function(t){if(a.enable&&(this.mousePressed&&YFM.Map.STATUS_TOUCH!==a.region.getStatus()&&a.region.setStatus(YFM.Map.STATUS_TOUCH),this.mousePressed&&!this.pitchLock&&!this.rotateLock&&!this.zoomLock)){var e=a._pos_in_world_space(a.touchRec.layer0x,a.touchRec.layer0y);a.planeRec.translateX=e[0]-a.planeRec.start0[0],a.planeRec.translateY=e[1]-a.planeRec.start0[1];var i=YFM.Math.Matrix.postTranslate(a.touchRec.savedmat,a.planeRec.translateX,a.planeRec.translateY,0);if(a.region.displayFloorIndex===a.touchFloorIndex&&a._mapConstraint(a.camera.getPVMat(),i))return;a.region._setRegionMat(i),a._onScroll(a.planeRec.translateX,a.planeRec.translateY),a.focusFloorDirty=!0}},mouseWheel:function(t){if(a.enable&&(this.zoomLock||(this.zoomLock=!0),this.zoomLock)){var e=-t.wheelDelta/2;a.planeRec.planeHeight=a._touch_plane_height(a.touchRec.layer0x,a.touchRec.layer0y);var i=a._world_to_view(a._pos_in_world_space(a.touchRec.layer0x,a.touchRec.layer0y)),r=YFM.Math.Vector.pos(0,0,0),s=YFM.Math.Vector.sub(r,i),o=YFM.Math.Vector.normalize(s),n=a.camera.getLookOffset();e>0?YFM.Math.Vector.norm3(n)>=a.viewZoom.max&&(e=0):e<0&&(0===a.touchFloorIndex||a.region.displayFloorIndex===a.touchFloorIndex)&&YFM.Math.Vector.norm3(s)<=a.viewZoom.min&&(e=0),YFM.Math.Vector.scaleTo(o,e),YFM.Math.Vector.subTo(n,n,o),a.camera.setLookOffset(n[0],n[1],n[2]),a.focusFloorDirty=!0}},keyPress:function(t){if(a.enable&&this.mousePressed){var e=!1,i=!1;if("a"===t.key?(this.deltaAngle+=1,e=!0):"d"===t.key?(this.deltaAngle-=1,e=!0):"w"==t.key?(this.deltaPitch=-1,i=!0):"s"==t.key&&(this.deltaPitch=1,i=!0),!this.rotateLock&&e&&(this.rotateLock=!0,a.touchRec.savedmat=YFM.Math.Matrix.matClone(a.region._getRegionMat()),a.planeRec.start0=a._pos_in_world_space(a.touchRec.layer0x,a.touchRec.layer0y),this.deltaAngle=0),this.rotateLock){var r=YFM.Math.Matrix.postRotateXY(a.touchRec.savedmat,this.deltaAngle,a.planeRec.start0[0],a.planeRec.start0[1]);a.region._setRegionMat(r),a.focusFloorDirty=!0}if(!this.pitchLock&&i){var s=a.planeRec.start0=a._pos_in_world_space(a.touchRec.layer0x,a.touchRec.layer0y);a.camera.resetLookOffsetTan(),a.region.lookAtWorldLoc(s[0],s[1],s[2]),this.pitchLock=!0}if(this.pitchLock){var o=a.camera.getPitch();(o+=this.deltaPitch)<=RegionTouchMgr.prototype.PITCH_LIMIT&&this.deltaPitch<0?o=RegionTouchMgr.prototype.PITCH_LIMIT:o>=0&&this.deltaPitch>0?(o=0,a.overlook||(a.region._onOverlook(!0),a.overlook=!0)):o<=0&&this.deltaPitch<0&&a.overlook&&(a.region._onOverlook(!1),a.overlook=!1),a.camera.setPitch(o),a.focusFloorDirty=!0}}}},this.strategy_none={name:"none",timeStampPrev:0,timeStampCur:0,clickFlag:!1,twoFingerClickFlag:!1,timeStampTwoFinger:0,mouseDown:function(t){a._onMouseDown(a.touchRec.layer0x,a.touchRec.layer0y)},touchDown:function(t){if(this.timeStampPrev=this.timeStampCur,this.timeStampCur=(new Date).getTime(),a.longPressFlag=!1,1==t.touches.length)a.planeRec.planeHeight=a._touch_plane_height(a.touchRec.layer0x,a.touchRec.layer0y),a.hangUp=!1,a.touchRec.savedmat=YFM.Math.Matrix.matClone(a.region._getRegionMat()),a.touchRec.start0x=a.touchRec.layer0x,a.touchRec.start0y=a.touchRec.layer0y,a.touchRec.radius0x=t.touches[0].radiusX,a.touchRec.radius0y=t.touches[0].radiusY,a.planeRec.prev=a.planeRec.start0=a._pos_in_world_space(a.touchRec.layer0x,a.touchRec.layer0y),a.planeRec.translateX=0,a.planeRec.translateY=0;else if(t.touches.length>1){if(!a.enable)return;this.startTime=t.timeStamp,a.planeRec.planeHeight=a._touch_plane_height(a.touchRec.layer0x,a.touchRec.layer0y),a.hangUp=!1,a.touchRec.savedmat=YFM.Math.Matrix.matClone(a.region._getRegionMat()),a.touchRec.start0x=a.touchRec.layer0x,a.touchRec.start0y=a.touchRec.layer0y,a.touchRec.radius0x=t.touches[0].radiusX,a.touchRec.radius0y=t.touches[0].radiusY,a.planeRec.prev=a.planeRec.start0=a._pos_in_world_space(a.touchRec.layer0x,a.touchRec.layer0y),a.planeRec.translateX=0,a.planeRec.translateY=0,a.touchRec.start1x=a.touchRec.layer1x,a.touchRec.start1y=a.touchRec.layer1y,a.planeRec.start1=a._pos_in_world_space(a.touchRec.layer1x,a.touchRec.layer1y),a.touchRec.screenSpacing=a._spacingScreenSpace(a.touchRec.start0x,a.touchRec.start0y,a.touchRec.start1x,a.touchRec.start1y),a.touchRec.viewSpacing=a._spacingViewSpace(a.touchRec.start0x,a.touchRec.start0y,a.touchRec.start1x,a.touchRec.start1y).spacing,a.planeRec.midpos=a._midpoint(a.touchRec.layer0x,a.touchRec.layer0y,a.touchRec.layer1x,a.touchRec.layer1y),a.planeRec.firstAngle=a._calc_angle(t),a.strategy=a.strategy_multi}},touchMove:function(t){if(a.enable){var e,i;e=a.touchRec.layer0x-a.touchRec.start0x,i=a.touchRec.layer0y-a.touchRec.start0y,1==t.touches.length&&e*e+i*i>100&&(a.strategy=a.strategy_scroll)}},touchUp:function(t){var e=(new Date).getTime();if(this.clickFlag)e-this.timeStampPrev<300&&a._onDClick(a.touchRec.start0x,a.touchRec.start0y),this.clickFlag=!1;else{var i=e-this.timeStampCur;if(i<100){this.clickFlag=!0;var r=this;setTimeout(function(){r.clickFlag&&(r.clickFlag=!1,r.twoFingerClickFlag?r.twoFingerClickFlag=!1:a._onClick(a.touchRec.start0x,a.touchRec.start0y))},300)}else i>800&&(a.longPressFlag||a._onLongPressUp(a.touchRec.start0x,a.touchRec.start0y))}0==t.touches.length&&(a.hangUp=!1)},touchCancel:function(t){a.hangUp=!1}},this.strategy_multi={name:"multi",mouseDown:function(t){a._onMouseDown(a.touchRec.layer0x,a.touchRec.layer0y)},touchDown:function(t){},touchMove:function(t){a.touchRec.pitchCnt=0,a.strategy=a.strategy_rotate},touchUp:function(t){a.hangUp=!1,(new Date).getTime()-a.strategy_none.timeStampCur<100&&(a.touchRec.screenSpacing<300&&a._on2FClick(a.touchRec.start0x,a.touchRec.start0y),a.strategy_none.twoFingerClickFlag=!0),a.strategy=a.strategy_none},touchCancel:function(t){a.strategy=a.strategy_none,a.hangUp=!1}},this.strategy_scroll={name:"scroll",mouseDown:function(t){a._onMouseDown(a.touchRec.layer0x,a.touchRec.layer0y)},touchDown:function(t){t.touches.length>1&&(a.touchRec.savedmat=YFM.Math.Matrix.matClone(a.region._getRegionMat()),a.touchRec.start0x=a.touchRec.layer0x,a.touchRec.start0y=a.touchRec.layer0y,a.touchRec.start1x=a.touchRec.layer1x,a.touchRec.start1y=a.touchRec.layer1y,a.touchRec.screenSpacing=a._spacingScreenSpace(a.touchRec.layer0x,a.touchRec.layer0y,a.touchRec.layer1x,a.touchRec.layer1y),a.touchRec.viewSpacing=a._spacingViewSpace(a.touchRec.layer0x,a.touchRec.layer0y,a.touchRec.layer1x,a.touchRec.layer1y).spacing,a.planeRec.midpos=a._midpoint(a.touchRec.layer0x,a.touchRec.layer0y,a.touchRec.layer1x,a.touchRec.layer1y),a.planeRec.firstAngle=a._calc_angle(t),a.strategy=a.strategy_multi)},touchMove:function(t){YFM.Map.STATUS_TOUCH!==a.region.getStatus()&&a.region.setStatus(YFM.Map.STATUS_TOUCH);var e=a._pos_in_world_space(a.touchRec.layer0x,a.touchRec.layer0y);a.planeRec.translateX=e[0]-a.planeRec.start0[0],a.planeRec.translateY=e[1]-a.planeRec.start0[1],a.planeRec.prev=e;var i=YFM.Math.Matrix.postTranslate(a.touchRec.savedmat,a.planeRec.translateX,a.planeRec.translateY,0);if(a.region.displayFloorIndex===a.touchFloorIndex){var r,s,o,n,h,u,l,c,d=YFM.Math.Matrix,g=YFM.Math.Vector;r=g.pos(0,0,-1),s=g.pos(0,0,1),h=d.mul(a.camera.getPVMat(),a.region.matRegion),u=d.invert(h),o=d.mulVec(u,r),n=d.mulVec(u,s),o[0]/=o[3],o[1]/=o[3],o[2]/=o[3],o[3]/=o[3],n[0]/=n[3],n[1]/=n[3],n[2]/=n[3],n[3]/=n[3],l=YFM.Math.Line.linePP(o,n),h=d.mul(a.camera.getPVMat(),i),u=d.invert(h),o=d.mulVec(u,r),n=d.mulVec(u,s),o[0]/=o[3],o[1]/=o[3],o[2]/=o[3],o[3]/=o[3],n[0]/=n[3],n[1]/=n[3],n[2]/=n[3],n[3]/=n[3],c=YFM.Math.Line.linePP(o,n);var p=a.region.floors[a.touchFloorIndex],M=p.intersectionLine(l);if(p.intersectionLine(c)<M)return}a.region._setRegionMat(i),a._onScroll(a.planeRec.translateX,a.planeRec.translateY),a.focusFloorDirty=!0},touchUp:function(t){(new Date).getTime(),a.strategy_none.timeStampCur;a.hangUp=!1,a.strategy=a.strategy_none,t.touches.length},touchCancel:function(t){a.hangUp=!1,a.strategy=a.strategy_none}},this.strategy_rotate={name:"rotate",mouseDown:function(t){},touchDown:function(t){},touchMove:function(t){a.camera.getPVMat();if(!(a.hangUp||t.touches.length<2)){if(YFM.Map.STATUS_TOUCH!==a.region.getStatus()){var e=a._spacingScreenSpace(a.touchRec.layer0x,a.touchRec.layer0y,a.touchRec.layer1x,a.touchRec.layer1y),i=a.touchRec.screenSpacing-e,r=-a.camera.getLookOffsetNormal();return(r+=i/20)>a.viewZoom.max?r=a.viewZoom.max:r<a.viewZoom.min&&(r=a.viewZoom.min),void a.camera.setLookOffset(0,0,-r)}var s=a.touchRec.layer0y-a.touchRec.start0y;if(s*(a.touchRec.layer1y-a.touchRec.start1y)>0){var i=s/256,o=a.camera.getPitch();(o+=i)<=RegionTouchMgr.prototype.PITCH_LIMIT&&i<0?o=RegionTouchMgr.prototype.PITCH_LIMIT:o>=0&&i>0?(o=0,a.overlook||(a.region._onOverlook(!0),a.overlook=!0)):o<=0&&i<0&&a.overlook&&(a.region._onOverlook(!1),a.overlook=!1),a.camera.getPitch(),a.camera.setPitch(o)}if(!((e=a._spacingScreenSpace(a.touchRec.layer0x,a.touchRec.layer0y,a.touchRec.layer1x,a.touchRec.layer1y))<200)){var n=a._spacingViewSpace(a.touchRec.layer0x,a.touchRec.layer0y,a.touchRec.layer1x,a.touchRec.layer1y),h=a._calc_angle(t)-a.planeRec.firstAngle,u=YFM.Math.Matrix.postRotateXY(a.touchRec.savedmat,h,a.planeRec.midpos[0],a.planeRec.midpos[1],!0),l=(a.touchRec.viewSpacing-n.spacing)/2;l<0&&n.z<0&&n.z>-20&&(l=-30);var c=a._world_to_view(a.planeRec.midpos),d=YFM.Math.Vector.pos(0,0,0),g=YFM.Math.Vector.sub(d,c),i=YFM.Math.Vector.normalize(g),p=a.camera.getLookOffset();l>0?YFM.Math.Vector.norm3(p)>=a.viewZoom.max&&(l=0):l<0&&(0===a.touchFloorIndex||a.region.displayFloorIndex===a.touchFloorIndex)&&YFM.Math.Vector.norm3(g)<=a.viewZoom.min&&(l=0),YFM.Math.Vector.scaleTo(i,l);var M=YFM.Math.Vector.sub(p,i);a.camera.setLookOffset(M[0],M[1],M[2]),a.region._setRegionMat(u),a.focusFloorDirty=!0}}},touchUp:function(t){t.touches.length>1?a.hangUp=!0:t.touches.length>=0?(a.hangUp=!1,a.strategy=a.strategy_none,a.longPressFlag=!0,a.touchRec.savedmat=YFM.Math.Matrix.matClone(a.region._getRegionMat()),a.touchRec.start0x=a.touchRec.layer0x,a.touchRec.start0y=a.touchRec.layer0y,a.planeRec.prev=a.planeRec.start0=a._pos_in_world_space(a.touchRec.layer0x,a.touchRec.layer0y),a.planeRec.translateX=0,a.planeRec.translateY=0,(new Date).getTime()-a.strategy_none.timeStampCur<100&&(a.touchRec.screenSpacing<300&&a._on2FClick(a.touchRec.start0x,a.touchRec.start0y),a.strategy_none.twoFingerClickFlag=!0)):a.strategy=a.strategy_none},touchCancel:function(t){a.hangUp=!1,a.strategy=a.strategy_none}},this.strategy=this.strategy_none,this.isMobile?(e.addEventListener("touchstart",o,!1),e.addEventListener("touchmove",o,!1),e.addEventListener("touchend",o,!1),e.addEventListener("touchcancel",o,!1)):(e.addEventListener("mousedown",n,!1),e.addEventListener("mouseup",n,!1),e.addEventListener("mousemove",n,!1),e.addEventListener("mouseleave",n,!1),e.addEventListener("mousewheel",n,!1))}function SSRoute(t){this.region=t,this.time=0,this.timeThumbnail=0,this.width=8,this.stepLen=128,this.dataLoad=!1,this.rotateLeft=YFM.Math.Matrix.rotateXY(90,0,0),this.rotateRight=YFM.Math.Matrix.rotateXY(-90,0,0),this.routeHeight=30,this.displayFloor=-1,this.polylineThumbnail=null,this.polylineZ=null,this.handledPts=null,this.routeData=null,this.light=YFM.Math.Vector.vec(0,0,1),this.tailSize=this.width/2,this.tailColor=YFM.Math.Vector.pos(YFM.WebGL.Color.hexColorRed(47925),YFM.WebGL.Color.hexColorGreen(47925),YFM.WebGL.Color.hexColorBlue(47925)),this.updateNSFlag=!0,this.naviStatus={projection:null,miniOffset:0,validate:!1,projDist:0,goalDist:0,globalDist:0,serialDist:0,nextSerialDist:0,azimuth:0,sug:YFM.Map.Navigate.Suggestion.NONE,nextSug:YFM.Map.Navigate.NextSuggestion.NONE},this._initTail(),this.routeMover={enable:!1,callback:null,index:0,t:0,vt:0,velocity:1,direction:1,ppolyline:null,position:null}}function RouteSeg(t,e,i){this.start=t,this.end=e,this.floor=i,this.segVec=YFM.Math.Vector.sub(this.end,this.start),this.lenSQ=YFM.Math.Vector.dot3(this.segVec,this.segVec),this.len=Math.sqrt(this.lenSQ),this.azimuth=this._makeAzimuth(),this.followLen=0}function FloorRoute(t,e,i){this.floor=t,this.region=e,this.route=i,this.segList=[],this.posList=[],this.lastPos=null,this.box=null,this.lastSegVec=null}function Euler(t,e,i,r){this.x=t||0,this.y=e||0,this.z=i||0,this.order=r||Euler.DefaultOrder}function PPolyline(t){this.sumLength=0,this.segList=[];var e,i,r,s,o;if(i=t.length,r=i-1,i<2)throw new Error("PPolyline pts cnt < 2");for(e=0,s=0;s<r;s++)e+=this._addSeg(t[s],t[s+1]);for(this.sumLength=e,e=0,o=null,s=0;s<r;s++)e+=this._handleSeg(this.segList[s],e,o),o=this.segList[s]}function Quaternion(t,e,i,r){this.x=t||0,this.y=e||0,this.z=i||0,this.w=void 0!==r?r:1}function PlanePolygon(t){this.barrier=[],this.plane=this._makePlanePts(t)}function Mover(t,e,i){this.mass=this.DEFAULT_MASS,this.maxForce=this.DEFAULT_MAX_FORCE,this.maxSpeed=this.DEFAULT_MAX_SPEED,this.location=YFM.Math.Vector.pos(t||0,e||0,i||0),this.velocity=YFM.Math.Vector.vec(0,0,0),this.acceleration=YFM.Math.Vector.vec(0,0,0)}function FloorQuadTree(t,e){this.floor=t,this.root=new FloorQuadNode(null,t,0,t.mapWidth,0,t.mapHeight,e,"0",0),this.objMap={}}function FloorQuadNode(t,e,i,r,s,o,n,a,h){this.parentNode=t,this.floor=e,this.xmin=i,this.xmax=r,this.ymin=s,this.ymax=o,this.height=n,this.mask=a,this.level=h;var u,l,c,d,g=[];u=e.floorPos2Region(i,s),l=e.floorPos2Region(r,s),c=e.floorPos2Region(r,o),d=e.floorPos2Region(i,o),g.push(YFM.Math.Vector.pos(u[0],u[1],u[2]-100)),g.push(YFM.Math.Vector.pos(l[0],l[1],l[2]-100)),g.push(YFM.Math.Vector.pos(c[0],c[1],c[2]-100)),g.push(YFM.Math.Vector.pos(d[0],d[1],d[2]-100)),g.push(YFM.Math.Vector.pos(u[0],u[1],u[2]+n)),g.push(YFM.Math.Vector.pos(l[0],l[1],l[2]+n)),g.push(YFM.Math.Vector.pos(c[0],c[1],c[2]+n)),g.push(YFM.Math.Vector.pos(d[0],d[1],d[2]+n)),this.obb=new OBB(g),this.objectList=[],this.children=new Array(null,null,null,null),this.splited=!1}function FrustumWorldSpace(){this.near=YFM.Math.Vector.vec(),this.far=YFM.Math.Vector.vec(),this.left=YFM.Math.Vector.vec(),this.right=YFM.Math.Vector.vec(),this.top=YFM.Math.Vector.vec(),this.bottom=YFM.Math.Vector.vec()}function OBB(t){this.isOBB=!0;var e,i;e=YFM.Math.Matrix.covariance3x3(t),i=YFM.Math.Matrix.eig3x3(e),this.t=YFM.Math.Vector.vec(i.vec[0],i.vec[1],i.vec[2]),this.s=YFM.Math.Vector.vec(i.vec[3],i.vec[4],i.vec[5]),this.r=YFM.Math.Vector.vec(i.vec[6],i.vec[7],i.vec[8]),this._calc_bounding(t)}function TextBlockQuickCheckTree(t,e){this.root=new AABBNode(this,"0",0,0,t,e),this.blockPool=[],this.blockList=[]}function AABBNode(t,e,i,r,s,o){this.tree=t,this.mask=e,this.rect=[i,r,s,o],this.objList=[],this.level<2&&this._splite()}function MtlItem(){this.Ns=32,this.Ka=YFM.Math.Vector.pos(),this.Kd=YFM.Math.Vector.pos(),this.Ks=YFM.Math.Vector.pos(),this.mapKd=null}function ObjModel(t){this.region=t,this.floor=null,this.obb=null,this.gl=t.gl,this.objects=[],this.texturePool=t.texturePool,this.modelMatrix=YFM.Math.Matrix.mat(),this.baseUrl=null,this.hasMaterials=!1,this.materials={}}function CameraRaw(){this.dirty=!0,this.mat_base_view=YFM.Math.Matrix.mat(),this.mat_t_view=YFM.Math.Matrix.mat(),this.mat_r_view=YFM.Math.Matrix.mat(),this.mat_view=YFM.Math.Matrix.mat(),this.mat_projection=YFM.Math.Matrix.mat(),this.mat_pv=YFM.Math.Matrix.mat(),this.mat_ipv=YFM.Math.Matrix.mat(),this.mat_iv=YFM.Math.Matrix.mat()}function DeviceOrientationCamera(){this.dirty=!0,this.mat_base_view=YFM.Math.Matrix.mat(),this.mat_t_view=YFM.Math.Matrix.mat(),this.mat_view=YFM.Math.Matrix.mat(),this.mat_projection=YFM.Math.Matrix.mat(),this.mat_pv=YFM.Math.Matrix.mat(),this.mat_ipv=YFM.Math.Matrix.mat(),this.mat_iv=YFM.Math.Matrix.mat(),this.quaternion=new Quaternion,this.pitchEnable=!0,this.pitch=this.DEFAULT_PITCH,this.lookAt=YFM.Math.Vector.vec(0,0,0),this.lookOffset=YFM.Math.Vector.vec(0,0,-400),this.zee=YFM.Math.Vector.vec(0,0,1),this.q0=new Quaternion(Math.sqrt(.5),0,0,Math.sqrt(.5)),this.q1=new Quaternion(-Math.sqrt(.5),0,0,Math.sqrt(.5)),this.q2=new Quaternion,this.enabled=!1,this.deviceOrientation=null,this.screenOrientation=0,this.roll=0,this.alphaOffsetAngle=0;var t=this,e=function(e){t.deviceOrientation=e,t.dirty=!0},i=function(){t.screenOrientation=window.orientation||0};this.connect=function(){window.addEventListener("deviceorientation",e,!1),window.addEventListener("orientationchange",i,!1),t.enabled=!0,t.pitchEnable=!1,t.dirty=!0},this.disconnect=function(){window.removeEventListener("orientationchange",i,!1),window.removeEventListener("deviceorientation",e,!1),t.enabled=!1,t.deviceOrientation=null,t.pitchEnable=!0,t.quaternion=new Quaternion,t.dirty=!0,t.roll=0},this.ldsN=4,this.ldsIndex=0,this.rgss=[],this.rgss.push(YFM.Math.Vector.vec(0,.25)),this.rgss.push(YFM.Math.Vector.vec(.5,0)),this.rgss.push(YFM.Math.Vector.vec(.75,.5)),this.rgss.push(YFM.Math.Vector.vec(.25,.75))}function BaseColorProgram(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.aColor=t.getAttribLocation(this.program,"aColor"),this.uModelMat=t.getUniformLocation(this.program,"uModelMat"),this.uFloorMat=t.getUniformLocation(this.program,"uFloorMat"),this.uRegionMat=t.getUniformLocation(this.program,"uRegionMat"),this.uViewMat=t.getUniformLocation(this.program,"uViewMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjectionMat"),this.uMapHeight=t.getUniformLocation(this.program,"uMapHeight"),this.uTex=t.getUniformLocation(this.program,"uTex"),this.uColorFlag=t.getUniformLocation(this.program,"uColorFlag"),this.dummyTex=t.createTexture(),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.dummyTex),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,null)}function BasePhongProgram(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.aColor=t.getAttribLocation(this.program,"aColor"),this.aNormal=t.getAttribLocation(this.program,"aNormal"),this.uAmbient=t.getUniformLocation(this.program,"uAmbient"),this.uDiffuse=t.getUniformLocation(this.program,"uDiffuse"),this.uFloorMat=t.getUniformLocation(this.program,"uFloorMat"),this.uPVRMat=t.getUniformLocation(this.program,"uPVRMat"),this.uNormalMat=t.getUniformLocation(this.program,"uNormalMat"),this.uMapHeight=t.getUniformLocation(this.program,"uMapHeight"),this.uHeightScale=t.getUniformLocation(this.program,"uHeightScale"),this.uLightPos=t.getUniformLocation(this.program,"uLightPos"),this.uLighting=t.getUniformLocation(this.program,"uLighting"),this.uLighting=t.getUniformLocation(this.program,"uLighting")}function BillboardIconProgram(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.aTexCoord=t.getAttribLocation(this.program,"aTexCoord"),this.uTex=t.getUniformLocation(this.program,"uTex"),this.uModelMat=t.getUniformLocation(this.program,"uModelMat"),this.uRegionMat=t.getUniformLocation(this.program,"uRegionMat"),this.uiViewMat=t.getUniformLocation(this.program,"uiViewMat"),this.uViewMat=t.getUniformLocation(this.program,"uViewMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjMat")}function Color2DProgram(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.uColor=t.getUniformLocation(this.program,"uColor"),this.uModelMat=t.getUniformLocation(this.program,"uModelMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjMat")}function Marker2DProgram(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.aTexCoord=t.getAttribLocation(this.program,"aTexCoord"),this.uTex=t.getUniformLocation(this.program,"uTex"),this.uModelMat=t.getUniformLocation(this.program,"uModelMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjMat")}function ModelPhongProgram(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.aNormal=t.getAttribLocation(this.program,"aNormal"),this.aTexCoord=t.getAttribLocation(this.program,"aTexCoord"),this.uNs=t.getUniformLocation(this.program,"uNs"),this.uKa=t.getUniformLocation(this.program,"uKa"),this.uKd=t.getUniformLocation(this.program,"uKd"),this.uKs=t.getUniformLocation(this.program,"uKs"),this.uTexFlag=t.getUniformLocation(this.program,"uTexFlag"),this.uTex=t.getUniformLocation(this.program,"uTex"),this.uColorFlag=t.getUniformLocation(this.program,"uColorFlag"),this.uColor=t.getUniformLocation(this.program,"uColor"),this.uModelMat=t.getUniformLocation(this.program,"uModelMat"),this.uFloorMat=t.getUniformLocation(this.program,"uFloorMat"),this.uRegionMat=t.getUniformLocation(this.program,"uRegionMat"),this.uViewMat=t.getUniformLocation(this.program,"uViewMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjMat"),this.uNormalMat=t.getUniformLocation(this.program,"uNormalMat"),this.uLightPos=t.getUniformLocation(this.program,"uLightPos"),this.defaultNs=32,this.defaultColor=YFM.Math.Vector.pos(1,1,1),this.defaultKa=YFM.Math.Vector.pos(.3,.3,.3),this.defaultKd=YFM.Math.Vector.pos(1,1,1),this.defaultKs=YFM.Math.Vector.pos(.1,.1,.1)}function PointSpiritProgram(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.uTex=t.getUniformLocation(this.program,"uTex"),this.uRegionMat=t.getUniformLocation(this.program,"uRegionMat"),this.uViewMat=t.getUniformLocation(this.program,"uViewMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjMat")}function RawPanoramaProgram(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.uModelMat=t.getUniformLocation(this.program,"uModelMat"),this.uViewMat=t.getUniformLocation(this.program,"uViewMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjectionMat"),this.uTexMap=t.getUniformLocation(this.program,"uTexMap")}function RegionPhongProgram(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.aNormal=t.getAttribLocation(this.program,"aNormal"),this.uColor=t.getUniformLocation(this.program,"uColor"),this.uModelMat=t.getUniformLocation(this.program,"uModelMat"),this.uRegionMat=t.getUniformLocation(this.program,"uRegionMat"),this.uViewMat=t.getUniformLocation(this.program,"uViewMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjMat"),this.uNormalMat=t.getUniformLocation(this.program,"uNormalMat"),this.uLightPos=t.getUniformLocation(this.program,"uLightPos")}function SSRProgram(t,e){this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.aTexCoord=t.getAttribLocation(this.program,"aTexCoord"),this.aLineDist=t.getAttribLocation(this.program,"aLineDist"),this.uTime=t.getUniformLocation(this.program,"uTime"),this.uHH=t.getUniformLocation(this.program,"uHH"),this.uHW=t.getUniformLocation(this.program,"uHW"),this.uTotalLen=t.getUniformLocation(this.program,"uTotalLen"),this.uNaviArg=t.getUniformLocation(this.program,"uNaviArg"),this.uTranFlag=t.getUniformLocation(this.program,"uTranFlag"),this.uLimitFlag=t.getUniformLocation(this.program,"uLimitFlag"),this.uLimitMin=t.getUniformLocation(this.program,"uLimitMin"),this.uLimitMax=t.getUniformLocation(this.program,"uLimitMax"),this.useProgram(),this.setHH(e.hh),this.setHW(e.hw)}function SelectColorProgram(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.uModelMat=t.getUniformLocation(this.program,"uModelMat"),this.uRegionMat=t.getUniformLocation(this.program,"uRegionMat"),this.uViewMat=t.getUniformLocation(this.program,"uViewMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjectionMat"),this.uColor=t.getUniformLocation(this.program,"uColor")}function TrajectoryProgram(t,e){this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.aTexCoord=t.getAttribLocation(this.program,"aTexCoord"),this.uPVRMat=t.getUniformLocation(this.program,"uPVRMat"),this.uFloorMat=t.getUniformLocation(this.program,"uFloorMat"),this.uMapHeight=t.getUniformLocation(this.program,"uMapHeight"),this.uTime=t.getUniformLocation(this.program,"uTime"),this.uTex=t.getUniformLocation(this.program,"uTex")}function TexturePool(t){this.gl=t,this.pool={}}function TextureWrap(t,e,i){this.name=t,this.url=e,this.img=i,this.w=0,this.h=0}function VAttribs(t){this.gl=t,this.attributes={}}var YFM={};ArrayList.prototype={constructor:ArrayList,getIter:function(){return new ArrayListIter(this.head,this.tail)},size:function(){return this.count},addHigh:function(t){var e=new ArrayListNode(t);e.prev=this.tail.prev,e.next=this.tail,this.tail.prev.next=e,this.tail.prev=e,this.count+=1},addLow:function(t){var e=new ArrayListNode(t);e.prev=this.head,e.next=this.head.next,this.head.next.prev=e,this.head.next=e,this.count+=1},clean:function(){this.count=0,this.head=new ArrayListNode(null),this.tail=new ArrayListNode(null),this.head.next=this.tail,this.tail.prev=this.head},remove:function(t){var e,i,r;if(t<-this.count||t>this.count-1)e=null;else if(t>=0){for(r=0,i=this.head.next;r<t;r++)i=i.next;e=i.value,i.prev.next=i.next,i.next.prev=i.prev,this.count-=1}else if(t<0){for(r=t,i=this.tail.prev;r<0;r++)i=i.prev;e=i.value,i.prev.next=i.next,i.next.prev=i.prev,this.count-=1}return e},removeHigh:function(){var t;return this.count>=1?(t=this.tail.prev.value,this.tail.prev.prev.next=this.tail,this.tail.prev=this.tail.prev.prev,this.count-=1):t=null,t},removeLow:function(){var t;return this.count>=1?(t=this.head.next.value,this.head.next.next.prev=this.head,this.head.next=this.head.next.next,this.count-=1):t=null,t},get:function(t){var e,i,r;if(t<-this.count||t>this.count-1)throw new Error("Access out of range");if(t>=0){for(r=0,i=this.head.next;r<t;r++)i=i.next;e=i.value}else if(t<0){for(r=t,i=this.tail.prev;r<0;r++)i=i.prev;e=i.value}return e},put:function(t,e){var i,r;if(t<-this.count||t>this.count-1)throw new Error("Access out of range");if(t>=0){for(r=0,i=this.head.next;r<t;r++)i=i.next;i.value=e}else if(t<0){for(r=t,i=this.tail.prev;r<0;r++)i=i.prev;i.value=e}}},ArrayListIter.prototype={constructor:ArrayListIter,hasNext:function(){return this.cursor.next!=this.tail},getNext:function(){var t=this.cursor.next.value;return this.cursor=this.cursor.next,t}},IndexMinPQ.prototype={constructor:IndexMinPQ,clean:function(){this.count=0;for(var t=0;t<=this.size;t++)this.qp[t]=-1,this.keys[t]=Number.MAX_VALUE},setSize:function(t){var e,i;if((e=t-this.size)<0)for(i=e;i<0;i++)this.pq.pop(),this.qp.pop(),this.keys.pop();else if(e>0)for(i=0;i<e;i++)this.pq.push(null),this.qp.push(null),this.keys.push(null);this.size=t,this.clean()},getSize:function(){return this.size},getCount:function(){return this.count},changeKey:function(t,e){if(t<0||t>this.size)throw new Error("IndexMinPQ.changeKey, out of range index:"+t);if(!this.contains(t))throw new Error("IndexMinPQ.changeKey, do not contains index:"+t);this.keys[t]=e,this._swim(this.qp[t]),this._sink(this.qp[t])},decreaseKey:function(t,e){if(t<0||t>this.size)throw new Error("IndexMinPQ.decreaseKey, out of range index:"+t);if(!this.contains(t))throw new Error("IndexMinPQ.decreaseKey, do not contains index:"+t);if(this.keys[t]<=e)throw new Error("IndexMinPQ.decreaseKey, key[i] <= key");this.keys[t]=e,this._swim(this.qp[t])},increaseKey:function(t,e){if(t<0||t>this.size)throw new Error("IndexMinPQ.increaseKey, out of range index:"+t);if(!this.contains(t))throw new Error("IndexMinPQ.increaseKey, do not contains index:"+t);if(this.keys[t]>=e)throw new Error("IndexMinPQ.increaseKey, key[i] <= key");this.keys[t]=e,this._swim(this.qp[t])},deleteMin:function(){if(this.count<=0)throw new Error("IndexMinPQ.deleteMin, empty content");var t;return t=this.pq[1],this._exch(1,this.count),this.count-=1,this._sink(1),this.qp[t]=-1,this.keys[this.pq[this.count+1]]=Number.MAX_VALUE,this.pq[this.count+1]=-1,t},delete:function(t){if(t<0||t>this.size)throw new Error("IndexMinPQ.delete, out of range index:"+t);if(!this.contains(t))throw new Error("IndexMinPQ.delete, do not contains index:"+t);var e=qp[t];this._exch(e,this.count),this.count-=1,this._swim(e),this._sink(e),this.keys[t]=Number.MAX_VALUE,this.qp[t]=-1},contains:function(t){if(t<0||t>this.size)throw new Error("IndexMinPQ.countains, out of range index:"+t);return-1!==this.qp[t]},isEmpty:function(){return 0===this.count},keyOf:function(t){if(t<0||t>this.size)throw new Error("IndexMinPQ.keyOf, out of range index:"+t);if(!this.contains(t))throw new Error("IndexMinPQ.keyOf, do not contains index:"+t);return this.keys[t]},minIndex:function(){if(this.count<=0)throw new Error("IndexMinPQ.minIndex, empty content");return this.pq[1]},minKey:function(){if(this.count<=0)throw new Error("IndexMinPQ.minKey, empty content");return this.keys[this.pq[1]]},indexAt:function(t){if(t<0||t>this.count)throw new Error("IndexMinPQ.indexAt, out of range pos:"+t);return this.pq[t+1]},insert:function(t,e){if(t<0||t>this.size)throw new Error("IndexMinPQ.insert, out of range index:"+t);if(this.contains(t))throw new Error("IndexMinPQ.insert, do contains index:"+t);this.count+=1,this.qp[t]=this.count,this.pq[this.count]=t,this.keys[t]=e,this._swim(this.count)},_exch:function(t,e){if(t<0||t>this.size)throw new Error("IndexMinPQ._exch, out of range i:"+t);if(e<0||e>this.size)throw new Error("IndexMinPQ._exch, out of range j:"+e);var i=this.pq[t];this.pq[t]=this.pq[e],this.pq[e]=i,this.qp[this.pq[t]]=t,this.qp[this.pq[e]]=e},_greater:function(t,e){if(t<0||t>this.size)throw new Error("IndexMinPQ._greater, out of range i:"+t);if(e<0||e>this.size)throw new Error("IndexMinPQ._greater, out of range j:"+e);return this.keys[this.pq[t]]>this.keys[this.pq[e]]},_sink:function(t){var e;if(t<0||t>this.size)throw new Error("IndexMinPQ._sink, out of range k:"+t);for(;2*t<=this.count&&((e=2*t)<this.count&&this._greater(e,e+1)&&e++,this._greater(t,e));)this._exch(t,e),t=e},_swim:function(t){if(t<0||t>this.size)throw new Error("IndexMinPQ._swin, out of range k:"+t);for(;t>1;){var e=Math.round(t/2);if(!this._greater(e,t))break;this._exch(t,e),t=e}}},YFM.Map={},YFM.Map.STATUS_TOUCH=0,YFM.Map.STATUS_SENSOR=1,YFM.Map.STATUS_NAVIGATE=2,YFM.Map.STATUS_TRACE=3,YFM.Map.Navigate={},YFM.Map.Navigate.Suggestion={NONE:"none",FRONT:"front",LEFT:"left",BACKWARD:"backward",RIGHT:"right"},YFM.Map.Navigate.NextSuggestion={NONE:"none",FRONT:"front",LEFT:"left",RIGHT:"right",ARRIVE:"arrive"},YFM.Math={clamp:function(t,e,i){return Math.max(e,Math.min(i,t))},map:function(t,e,i,r,s){return r+(t-e)/(i-e)*(s-r)},deg2Radian:function(t){return 2*t*Math.PI/360},radian2Deg:function(t){return 360*t/(2*Math.PI)},flatten:function(t,e){var i,r=t.length,s=!1;Array.isArray(t[0])&&(s=!0,null==e?(r*=t[0].length,i=t[0].length):(r*=e,i=e));var o=new Float32Array(r);if(s)for(var n=0,a=0;a<t.length;++a)for(var h=0;h<i;++h)o[n++]=t[a][h];else for(a=0;a<t.length;++a)o[a]=t[a];return o},argumentsToArray:function(t){return[].concat.apply([],Array.prototype.slice.apply(t))},floatEquals:function(t,e){return Math.abs(t-e)<=1e-5||(Math.abs(t)>Math.abs(e)?Math.abs((t-e)/t):Math.abs((t-e)/e))<=1e-8},floatNotZero:function(t){return Math.abs(t)>1e-20},vf2str:function(t,e){for(var i="[ ",r=t.length,s=0;s<r;s++)i+=t[s].toFixed(e),i+=", ";return i+="]"},lerp:function(t,e,i){return t+(e-t)*i}},DodecahedronMesh.prototype={constructor:DodecahedronMesh,getMeshVBO:function(){return this.meshVBO},getMeshBufSize:function(){return this.meshBufSize},_init:function(t,e){this.mesh=[],this._dodecahedron(e),this.meshVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.meshVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(this.mesh,3),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),this.meshBufSize=this.mesh.length/2,this.mesh=null},_dodecahedron:function(t){var e=(1+Math.sqrt(5))/2,i=1/e,r=[];r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,-1,-1))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,-1,1))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,1,-1))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,1,1))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,-1,-1))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,-1,1))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,1,-1))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,1,1))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,-i,-e))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,-i,e))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,i,-e))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,i,e))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-i,-e,0))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-i,e,0))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(i,-e,0))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(i,e,0))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-e,0,-i))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(e,0,-i))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-e,0,i))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(e,0,i))),this._divideTriangle(r[3],r[11],r[7],t),this._divideTriangle(r[3],r[7],r[15],t),this._divideTriangle(r[3],r[15],r[13],t),this._divideTriangle(r[7],r[19],r[17],t),this._divideTriangle(r[7],r[17],r[6],t),this._divideTriangle(r[7],r[6],r[15],t),this._divideTriangle(r[17],r[4],r[8],t),this._divideTriangle(r[17],r[8],r[10],t),this._divideTriangle(r[17],r[10],r[6],t),this._divideTriangle(r[8],r[0],r[16],t),this._divideTriangle(r[8],r[16],r[2],t),this._divideTriangle(r[8],r[2],r[10],t),this._divideTriangle(r[0],r[12],r[1],t),this._divideTriangle(r[0],r[1],r[18],t),this._divideTriangle(r[0],r[18],r[16],t),this._divideTriangle(r[6],r[10],r[2],t),this._divideTriangle(r[6],r[2],r[13],t),this._divideTriangle(r[6],r[13],r[15],t),this._divideTriangle(r[2],r[16],r[18],t),this._divideTriangle(r[2],r[18],r[3],t),this._divideTriangle(r[2],r[3],r[13],t),this._divideTriangle(r[18],r[1],r[9],t),this._divideTriangle(r[18],r[9],r[11],t),this._divideTriangle(r[18],r[11],r[3],t),this._divideTriangle(r[4],r[14],r[12],t),this._divideTriangle(r[4],r[12],r[0],t),this._divideTriangle(r[4],r[0],r[8],t),this._divideTriangle(r[11],r[9],r[5],t),this._divideTriangle(r[11],r[5],r[19],t),this._divideTriangle(r[11],r[19],r[7],t),this._divideTriangle(r[19],r[5],r[14],t),this._divideTriangle(r[19],r[14],r[4],t),this._divideTriangle(r[19],r[4],r[17],t),this._divideTriangle(r[1],r[12],r[14],t),this._divideTriangle(r[1],r[14],r[5],t),this._divideTriangle(r[1],r[5],r[9],t)},_divideTriangle:function(t,e,i,r){if(r>0){var s=YFM.Math.Vector.mix(t,e,.5),o=YFM.Math.Vector.mix(t,i,.5),n=YFM.Math.Vector.mix(e,i,.5);s=YFM.Math.Vector.normalize(s),o=YFM.Math.Vector.normalize(o),n=YFM.Math.Vector.normalize(n),this._divideTriangle(t,s,o,r-1),this._divideTriangle(s,e,n,r-1),this._divideTriangle(n,i,o,r-1),this._divideTriangle(s,n,o,r-1)}else this._triangle(t,e,i)},_triangle:function(t,e,i){var r=YFM.Math.Vector.sub(e,t),s=YFM.Math.Vector.sub(i,e),o=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(r,s));this.mesh.push(t),this.mesh.push(o),this.mesh.push(e),this.mesh.push(o),this.mesh.push(i),this.mesh.push(o)}},HexahedronMesh.prototype={constructor:HexahedronMesh,getMeshVBO:function(){return this.meshVBO},getMeshBufSize:function(){return this.meshBufSize},_init:function(t,e){this.mesh=[],this._hexahedron(e),this.meshVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.meshVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(this.mesh,3),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),this.meshBufSize=this.mesh.length/2,this.mesh=null},_hexahedron:function(t){var e=[],i=Math.sqrt(2)/2;e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,1,-i))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,0,-i))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,-1,-i))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,0,-i))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,1,i))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,0,i))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,-1,i))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,0,i))),this._divideTriangle(e[0],e[1],e[3],t),this._divideTriangle(e[3],e[1],e[2],t),this._divideTriangle(e[4],e[7],e[5],t),this._divideTriangle(e[5],e[7],e[6],t),this._divideTriangle(e[7],e[3],e[6],t),this._divideTriangle(e[6],e[3],e[2],t),this._divideTriangle(e[6],e[2],e[5],t),this._divideTriangle(e[5],e[2],e[1],t),this._divideTriangle(e[4],e[5],e[0],t),this._divideTriangle(e[0],e[5],e[1],t),this._divideTriangle(e[7],e[4],e[0],t),this._divideTriangle(e[0],e[3],e[7],t)},_divideTriangle:function(t,e,i,r){if(r>0){var s=YFM.Math.Vector.mix(t,e,.5),o=YFM.Math.Vector.mix(t,i,.5),n=YFM.Math.Vector.mix(e,i,.5);s=YFM.Math.Vector.normalize(s),o=YFM.Math.Vector.normalize(o),n=YFM.Math.Vector.normalize(n),this._divideTriangle(t,s,o,r-1),this._divideTriangle(s,e,n,r-1),this._divideTriangle(n,i,o,r-1),this._divideTriangle(s,n,o,r-1)}else this._triangle(t,e,i)},_triangle:function(t,e,i){var r=YFM.Math.Vector.sub(e,t),s=YFM.Math.Vector.sub(i,e),o=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(r,s));this.mesh.push(t),this.mesh.push(o),this.mesh.push(e),this.mesh.push(o),this.mesh.push(i),this.mesh.push(o)}},IcosahedronMesh.prototype={constructor:IcosahedronMesh,getMeshVBO:function(){return this.meshVBO},getMeshBufSize:function(){return this.meshBufSize},_init:function(t,e){this.mesh=[],this._icosahedron(e),this.meshVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.meshVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(this.mesh,3),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),this.meshBufSize=this.mesh.length/2,this.mesh=null},_icosahedron:function(t){var e=(1+Math.sqrt(5))/2,i=[];i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,e,0))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,e,0))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,-e,0))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,-e,0))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,-1,e))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,1,e))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,-1,-e))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,1,-e))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(e,0,-1))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(e,0,1))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-e,0,-1))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-e,0,1))),this._divideTriangle(i[0],i[11],i[5],t),this._divideTriangle(i[0],i[5],i[1],t),this._divideTriangle(i[0],i[1],i[7],t),this._divideTriangle(i[0],i[7],i[10],t),this._divideTriangle(i[0],i[10],i[11],t),this._divideTriangle(i[1],i[5],i[9],t),this._divideTriangle(i[5],i[11],i[4],t),this._divideTriangle(i[11],i[10],i[2],t),this._divideTriangle(i[10],i[7],i[6],t),this._divideTriangle(i[7],i[1],i[8],t),this._divideTriangle(i[3],i[9],i[4],t),this._divideTriangle(i[3],i[4],i[2],t),this._divideTriangle(i[3],i[2],i[6],t),this._divideTriangle(i[3],i[6],i[8],t),this._divideTriangle(i[3],i[8],i[9],t),this._divideTriangle(i[4],i[9],i[5],t),this._divideTriangle(i[2],i[4],i[11],t),this._divideTriangle(i[6],i[2],i[10],t),this._divideTriangle(i[8],i[6],i[7],t),this._divideTriangle(i[9],i[8],i[1],t)},_divideTriangle:function(t,e,i,r){if(r>0){var s=YFM.Math.Vector.mix(t,e,.5),o=YFM.Math.Vector.mix(t,i,.5),n=YFM.Math.Vector.mix(e,i,.5);s=YFM.Math.Vector.normalize(s),o=YFM.Math.Vector.normalize(o),n=YFM.Math.Vector.normalize(n),this._divideTriangle(t,s,o,r-1),this._divideTriangle(s,e,n,r-1),this._divideTriangle(n,i,o,r-1),this._divideTriangle(s,n,o,r-1)}else this._triangle(t,e,i)},_triangle:function(t,e,i){var r=YFM.Math.Vector.sub(e,t),s=YFM.Math.Vector.sub(i,e),o=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(r,s));this.mesh.push(t),this.mesh.push(o),this.mesh.push(e),this.mesh.push(o),this.mesh.push(i),this.mesh.push(o)}},YFM.Mesh={},YFM.Mesh.CATEGORY_TETRHEDRON="tetrahedron",YFM.Mesh.CATEGORY_HEXADEDRON="hexahedron",YFM.Mesh.CATEGORY_OCTAHEDRON="octahedron",YFM.Mesh.CATEGORY_DODECAHEDRON="dodecahedron",YFM.Mesh.CATEGORY_ICOSAHEDRON="icosahedron",YFM.Mesh.CATEGORY_SPHERE="SPHERE",MeshBuffer.prototype={constructor:MeshBuffer,addAttribute:function(t,e,i,r){var s=this.gl,o=new Float32Array(e),n=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,n),s.bufferData(s.ARRAY_BUFFER,o,s.STATIC_DRAW),s.bindBuffer(s.ARRAY_BUFFER,null),this.attributes[t]={vbo:n,size:i,length:e.length/i}},getAttribute:function(t){return this.attributes[t]}},OctahedronMesh.prototype={constructor:OctahedronMesh,getMeshVBO:function(){return this.meshVBO},getMeshBufSize:function(){return this.meshBufSize},_init:function(t,e){this.mesh=[],this._octahedron(e),this.meshVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.meshVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(this.mesh,3),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),this.meshBufSize=this.mesh.length/2,this.mesh=null},_octahedron:function(t){var e=[];e.push(YFM.Math.Vector.pos(1,0,0)),e.push(YFM.Math.Vector.pos(-1,0,0)),e.push(YFM.Math.Vector.pos(0,1,0)),e.push(YFM.Math.Vector.pos(0,-1,0)),e.push(YFM.Math.Vector.pos(0,0,1)),e.push(YFM.Math.Vector.pos(0,0,-1)),this._divideTriangle(e[0],e[2],e[4],t),this._divideTriangle(e[0],e[4],e[3],t),this._divideTriangle(e[0],e[3],e[5],t),this._divideTriangle(e[0],e[5],e[2],t),this._divideTriangle(e[1],e[2],e[5],t),this._divideTriangle(e[1],e[5],e[3],t),this._divideTriangle(e[1],e[3],e[4],t),this._divideTriangle(e[1],e[4],e[2],t)},_divideTriangle:function(t,e,i,r){if(r>0){var s=YFM.Math.Vector.mix(t,e,.5),o=YFM.Math.Vector.mix(t,i,.5),n=YFM.Math.Vector.mix(e,i,.5);s=YFM.Math.Vector.normalize(s),o=YFM.Math.Vector.normalize(o),n=YFM.Math.Vector.normalize(n),this._divideTriangle(t,s,o,r-1),this._divideTriangle(s,e,n,r-1),this._divideTriangle(n,i,o,r-1),this._divideTriangle(s,n,o,r-1)}else this._triangle(t,e,i)},_triangle:function(t,e,i){var r=YFM.Math.Vector.sub(e,t),s=YFM.Math.Vector.sub(i,e),o=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(r,s));this.mesh.push(t),this.mesh.push(o),this.mesh.push(e),this.mesh.push(o),this.mesh.push(i),this.mesh.push(o)}},TetrahedronMesh.prototype={constructor:TetrahedronMesh,getMeshVBO:function(){return this.meshVBO},getMeshBufSize:function(){return this.meshBufSize},_init:function(t,e){this.mesh=[],this._tetrahedron(e),this.meshVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.meshVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(this.mesh,3),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),this.meshBufSize=this.mesh.length/2,this.mesh=null},_tetrahedron:function(t){var e=[];e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,1,1))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,-1,1))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,1,-1))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,-1,-1))),this._divideTriangle(e[2],e[1],e[0],t),this._divideTriangle(e[0],e[3],e[2],t),this._divideTriangle(e[1],e[3],e[0],t),this._divideTriangle(e[2],e[3],e[1],t)},_divideTriangle:function(t,e,i,r){if(r>0){var s=YFM.Math.Vector.mix(t,e,.5),o=YFM.Math.Vector.mix(t,i,.5),n=YFM.Math.Vector.mix(e,i,.5);s=YFM.Math.Vector.normalize(s),o=YFM.Math.Vector.normalize(o),n=YFM.Math.Vector.normalize(n),this._divideTriangle(t,s,o,r-1),this._divideTriangle(s,e,n,r-1),this._divideTriangle(n,i,o,r-1),this._divideTriangle(s,n,o,r-1)}else this._triangle(t,e,i)},_triangle:function(t,e,i){var r=YFM.Math.Vector.sub(e,t),s=YFM.Math.Vector.sub(i,e),o=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(r,s));this.mesh.push(t),this.mesh.push(o),this.mesh.push(e),this.mesh.push(o),this.mesh.push(i),this.mesh.push(o)}},RawPanorama.prototype={constructor:RawPanorama,render:function(t,e){null!==this.cubeMap&&(this.gl.enable(this.gl.CULL_FACE),this.gl.frontFace(this.gl.CW),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL),t.setModelMatrix(YFM.Math.Matrix.mul(e,this.modelMat)),t.bindTexture(this.cubeMap),t.drawTriangles(this.cubeVBO,this.cubeSize),this.gl.disable(this.gl.DEPTH_TEST),this.gl.frontFace(this.gl.CCW),this.gl.disable(this.gl.CULL_FACE))},setCubeTex:function(t,e,i,r,s,o){var n={imgList:new Array(6),imgCount:0},a=this;n.imgList[0]=new Image,n.imgList[0].onload=function(){a._handleTextureLoaded(0,n)},n.imgList[0].src=t,n.imgList[1]=new Image,n.imgList[1].onload=function(){a._handleTextureLoaded(1,n)},n.imgList[1].src=e,n.imgList[2]=new Image,n.imgList[2].onload=function(){a._handleTextureLoaded(2,n)},n.imgList[2].src=i,n.imgList[3]=new Image,n.imgList[3].onload=function(){a._handleTextureLoaded(3,n)},n.imgList[3].src=r,n.imgList[4]=new Image,n.imgList[4].onload=function(){a._handleTextureLoaded(4,n)},n.imgList[4].src=s,n.imgList[5]=new Image,n.imgList[5].onload=function(){a._handleTextureLoaded(5,n)},n.imgList[5].src=o},_initCube:function(){var t=this.gl,e=[],i=[YFM.Math.Vector.pos(-5e3,-5e3,5e3),YFM.Math.Vector.pos(-5e3,5e3,5e3),YFM.Math.Vector.pos(5e3,5e3,5e3),YFM.Math.Vector.pos(5e3,-5e3,5e3),YFM.Math.Vector.pos(-5e3,-5e3,-5e3),YFM.Math.Vector.pos(-5e3,5e3,-5e3),YFM.Math.Vector.pos(5e3,5e3,-5e3),YFM.Math.Vector.pos(5e3,-5e3,-5e3)];this._quad(i,e,1,0,3,2),this._quad(i,e,2,3,7,6),this._quad(i,e,3,0,4,7),this._quad(i,e,6,5,1,2),this._quad(i,e,4,5,6,7),this._quad(i,e,5,4,0,1),this.cubeVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.cubeVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(e,3),t.STATIC_DRAW),this.cubeSize=e.length},_quad:function(t,e,i,r,s,o){e.push(t[i]),e.push(t[r]),e.push(t[s]),e.push(t[i]),e.push(t[s]),e.push(t[o])},_makeCubeTex:function(t,e,i,r,s,o){var n=this.gl;null!==this.cubeMap&&n.deleteTexture(this.cubeMap),this.cubeMap=n.createTexture(),n.bindTexture(n.TEXTURE_CUBE_MAP,this.cubeMap),n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,t),n.texImage2D(n.TEXTURE_CUBE_MAP_NEGATIVE_X,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,r),n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_Y,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,e),n.texImage2D(n.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,s),n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_Z,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,i),n.texImage2D(n.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,o),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_MAG_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE)},_handleTextureLoaded:function(t,e){e.imgCount+=1,6==e.imgCount&&this._makeCubeTex(e.imgList[0],e.imgList[1],e.imgList[2],e.imgList[3],e.imgList[4],e.imgList[5])}},YFM.SVG=function(){var t=function(t,e,i){return[t/255,e/255,i/255,1]},e={aliceblue:t(240,248,255),antiquewhite:t(250,235,215),aqua:t(0,255,255),aquamarine:t(127,255,212),azure:t(240,255,255),beige:t(245,245,220),bisque:t(255,228,196),black:t(0,0,0),blanchedalmond:t(255,235,205),blue:t(0,0,255),blueviolet:t(138,43,226),brown:t(165,42,42),burlywood:t(222,184,135),cadetblue:t(95,158,160),chartreuse:t(127,255,0),chocolate:t(210,105,30),coral:t(255,127,80),cornflowerblue:t(100,149,237),cornsilk:t(255,248,220),crimson:t(220,20,60),cyan:t(0,255,255),darkblue:t(0,0,139),darkcyan:t(0,139,139),darkgoldenrod:t(184,134,11),darkgray:t(169,169,169),darkgreen:t(0,100,0),darkgrey:t(169,169,169),darkkhaki:t(189,183,107),darkmagenta:t(139,0,139),darkolivegreen:t(85,107,47),darkorange:t(255,140,0),darkorchid:t(153,50,204),darkred:t(139,0,0),darksalmon:t(233,150,122),darkseagreen:t(143,188,143),darkslateblue:t(72,61,139),darkslategray:t(47,79,79),darkslategrey:t(47,79,79),darkturquoise:t(0,206,209),darkviolet:t(148,0,211),deeppink:t(255,20,147),deepskyblue:t(0,191,255),dimgray:t(105,105,105),dimgrey:t(105,105,105),dodgerblue:t(30,144,255),firebrick:t(178,34,34),floralwhite:t(255,250,240),forestgreen:t(34,139,34),fuchsia:t(255,0,255),gainsboro:t(220,220,220),ghostwhite:t(248,248,255),gold:t(255,215,0),goldenrod:t(218,165,32),gray:t(128,128,128),grey:t(128,128,128),green:t(0,128,0),greenyellow:t(173,255,47),honeydew:t(240,255,240),hotpink:t(255,105,180),indianred:t(205,92,92),indigo:t(75,0,130),ivory:t(255,255,240),khaki:t(240,230,140),lavender:t(230,230,250),lavenderblush:t(255,240,245),lawngreen:t(124,252,0),lemonchiffon:t(255,250,205),lightblue:t(173,216,230),lightcoral:t(240,128,128),lightcyan:t(224,255,255),lightgoldenrodyellow:t(250,250,210),lightgray:t(211,211,211),lightgreen:t(144,238,144),lightgrey:t(211,211,211),lightpink:t(255,182,193),lightsalmon:t(255,160,122),lightseagreen:t(32,178,170),lightskyblue:t(135,206,250),lightslategray:t(119,136,153),lightslategrey:t(119,136,153),lightsteelblue:t(176,196,222),lightyellow:t(255,255,224),lime:t(0,255,0),limegreen:t(50,205,50),linen:t(250,240,230),magenta:t(255,0,255),maroon:t(128,0,0),mediumaquamarine:t(102,205,170),mediumblue:t(0,0,205),mediumorchid:t(186,85,211),mediumpurple:t(147,112,219),mediumseagreen:t(60,179,113),mediumslateblue:t(123,104,238),mediumspringgreen:t(0,250,154),mediumturquoise:t(72,209,204),mediumvioletred:t(199,21,133),midnightblue:t(25,25,112),mintcream:t(245,255,250),mistyrose:t(255,228,225),moccasin:t(255,228,181),navajowhite:t(255,222,173),navy:t(0,0,128),oldlace:t(253,245,230),olive:t(128,128,0),olivedrab:t(107,142,35),orange:t(255,165,0),orangered:t(255,69,0),orchid:t(218,112,214),palegoldenrod:t(238,232,170),palegreen:t(152,251,152),paleturquoise:t(175,238,238),palevioletred:t(219,112,147),papayawhip:t(255,239,213),peachpuff:t(255,218,185),peru:t(205,133,63),pink:t(255,192,203),plum:t(221,160,221),powderblue:t(176,224,230),purple:t(128,0,128),red:t(255,0,0),rosybrown:t(188,143,143),royalblue:t(65,105,225),saddlebrown:t(139,69,19),salmon:t(250,128,114),sandybrown:t(244,164,96),seagreen:t(46,139,87),seashell:t(255,245,238),sienna:t(160,82,45),silver:t(192,192,192),skyblue:t(135,206,235),slateblue:t(106,90,205),slategray:t(112,128,144),slategrey:t(112,128,144),snow:t(255,250,250),springgreen:t(0,255,127),steelblue:t(70,130,180),tan:t(210,180,140),teal:t(0,128,128),thistle:t(216,191,216),tomato:t(255,99,71),turquoise:t(64,224,208),violet:t(238,130,238),wheat:t(245,222,179),white:t(255,255,255),whitesmoke:t(245,245,245),yellow:t(255,255,0),yellowgreen:t(154,205,50)},i=function(t,e){return function(t,e,i,r){return[t/255,e/255,i/255,r]}(parseInt(t.slice(0,2),16),parseInt(t.slice(2,4),16),parseInt(t.slice(4,6),16),e)},r=function(t){return t.concat(t)};return{fillColor:function(t,s){var o;if(o=null===s||void 0===s?1:parseFloat(s),t){if("none"===t)return null;if(0==t.indexOf("#"))return 7==t.length?t=t.slice(1):4==t.length&&(t=(t=t.slice(1)).split("").map(r).join("")),i(t,o);var n=e[t];return n?[n[0],n[1],n[2],o]:void 0}},strokeColor:function(t,s){var o;if(o=null===s||void 0===s?1:parseFloat(s),t){if("none"===t)return null;if(0==t.indexOf("#"))return 7==t.length?t=t.slice(1):4==t.length&&(t=(t=t.slice(1)).split("").map(r).join("")),i(t,o);var n=e[t];return n?[n[0],n[1],n[2],o]:void 0}}}}(),SVGParser=function(t,e,i,r){this.floor=t,this.region=e,this.extrude=i,this.boundary=r,this.gl=this.region.gl,this.regUnit=/^unit/g,this.regIcon=/^icon/g,this.regExtrude=/_ex/,this.regBoundary=/^boundary/,this.extrudeValue=/_ex(\d*)/,this.pathCommand=/([a-z])[\s,]*((-?\d*\.?\d*(?:e[\-+]?\d+)?[\s]*,?[\s]*)+)/gi,this.pathValues=/(-?\d*\.?\d*(?:e[\-+]?\d+)?)[\s]*,?[\s]*/gi,this.tCommand=/(\w+\((\-?\d+\.?\d*e?\-?\d*,?)+\))+/gi,this.tValues=/[\w\.\-]+/gi,this.regTrim=/(^\s*)|(\s*$)/g,this.RECURSION_LIMIT=8,this.FLT_EPSILON=1.1920929e-7,this.PATH_DISTANCE_EPSILON=.2,this.distanceTolerance=this.PATH_DISTANCE_EPSILON*this.PATH_DISTANCE_EPSILON,this.TWO_PI=2*Math.PI,this.transformStack=new SVGTransformStack},SVGParser.prototype={constructor:SVGParser,GROUP_TYPE_EXTRUDE:1,GROUP_TYPE_ICON:2,GROUP_TYPE_BOUNDARY:3,imgCursor:0,readSVG:function(t,e){var i=parseInt(t.getAttribute("width")),r=parseInt(t.getAttribute("height"));if(!i||!r)throw new Error("read svg failed");this.transformStack.clean();for(var s=0;s<t.childNodes.length;s++){var o=t.childNodes.item(s);"g"===o.nodeName&&this._readGroup(o,e,0)}return{width:i,height:r}},_readStyle:function(t){var e={},i=t.getAttribute("style");if(i){for(var r,s,o,n=i.split(";"),a=0,h=n.length;a<h;a++)2===(r=n[a].split(":")).length&&(s=r[0].replace(this.regTrim,""),o=r[1].replace(this.regTrim,""),e[s]=o);e.fill=YFM.SVG.fillColor(e.fill,e["fill-opacity"]),e.stroke=YFM.SVG.strokeColor(e.stroke,e["stroke-opacity"]),"evenodd"===e["fill-rule"]?e.fill_rule=Tess2.WINDING_ODD:e.fill_rule=Tess2.WINDING_NONZERO,e["stroke-width"]&&(e.stroke_width=parseFloat(e["stroke-width"]))}else{var u=t.getAttribute("fill"),l=t.getAttribute("stroke"),c=t.getAttribute("fill-rule"),d=t.getAttribute("fill-opacity"),g=t.getAttribute("stroke-opacity"),p=t.getAttribute("stroke-width");e.fill=YFM.SVG.fillColor(u,d),e.stroke=YFM.SVG.strokeColor(l,g),e.fill_rule="evenodd"===c?Tess2.WINDING_ODD:Tess2.WINDING_NONZERO,p&&(e.stroke_width=parseFloat(p))}return e},_mergeStyle:function(t,e){return{fill:null===e.fill?null:e.fill||t.fill,fill_rule:e.fill_rule||0===e.fill_rule?e.fill_rule:t.fill_rule,stroke:null===e.stroke?null:e.stroke||t.stroke,stroke_width:e.stroke_width||t.stroke_width}},_readGroup:function(t,e,i){var r=t.getAttribute("id"),s=0,o=this._readStyle(t);if(r){if(i)s=i;else if(this.regExtrude.test(r)){var n;r.replace(this.extrudeValue,function(t,e){return n=parseFloat(e)||20,e}),this.extrude.setHeight(n),this.regUnit.test(r)&&this.floor.setUnitHeight(n),s=SVGParser.prototype.GROUP_TYPE_EXTRUDE}else this.regIcon.test(r)?s=SVGParser.prototype.GROUP_TYPE_ICON:this.regBoundary.test(r)&&(s=SVGParser.prototype.GROUP_TYPE_BOUNDARY);this.currentGroup={id:r,type:s,objarray:[],varray:[],carray:[]},e.push(this.currentGroup)}else this.currentGroup?s=i:(this.currentGroup={id:r,type:s,objarray:[],varray:[],carray:[]},e.push(this.currentGroup));var a=t.getAttribute("transform");a&&this.transformStack.pushTransform(a);for(var h=0;h<t.childNodes.length;h++){var u=t.childNodes.item(h);1==u.nodeType&&("g"==u.nodeName?this._readGroup(u,e,s):this._readObject(u,s,o))}a&&this.transformStack.popTransform()},_readObject:function(t,e,i){var r=this._mergeStyle(i,this._readStyle(t)),s=t.getAttribute("transform");s&&this.transformStack.pushTransform(s),"rect"==t.nodeName?this._addRect(t,e,r):"image"===t.nodeName?this._addImage(t):"polyline"===t.nodeName?this._addPoly(t,e,r,!1):"polygon"===t.nodeName?this._addPoly(t,e,r,!0):"line"===t.nodeName?this._addLine(t,r):"circle"===t.nodeName?this._addEllipse(t,r,e):"ellipse"===t.nodeName?this._addEllipse(t,r,e):"path"===t.nodeName&&this._addPath(t,r,e),s&&this.transformStack.popTransform()},_addRect:function(t,e,i){var r=parseFloat(t.getAttribute("width")),s=parseFloat(t.getAttribute("height")),o=parseFloat(t.getAttribute("x"))||0,n=parseFloat(t.getAttribute("y"))||0,a=[],h=this.transformStack.getCurrentMat();if(h){var u=this._multVec3(h,this._pos2(o,n)),l=this._multVec3(h,this._pos2(o+r,n)),c=this._multVec3(h,this._pos2(o+r,n+s)),d=this._multVec3(h,this._pos2(o,n+s));a.push(u[0]),a.push(u[1]),a.push(l[0]),a.push(l[1]),a.push(c[0]),a.push(c[1]),a.push(d[0]),a.push(d[1])}else a.push(o),a.push(n),a.push(o+r),a.push(n),a.push(o+r),a.push(n+s),a.push(o),a.push(n+s);this._addShape(a,i,e,!0,null)},_addLine:function(t,e){if(e.stroke){var i=t.getAttribute("x1"),r=t.getAttribute("y1"),s=t.getAttribute("x2"),o=t.getAttribute("y2"),n=parseFloat(i),a=parseFloat(r),h=parseFloat(s),u=parseFloat(o),l=this.transformStack.getCurrentMat();if(l){var c=this._multVec3(l,this._pos2(n,a)),d=this._multVec3(l,this._pos2(h,u));n=c[0],a=c[1],h=d[0],u=d[1]}this._addSegAdapt(e,n,a,h,u)}},_addPoly:function(t,e,i,r){for(var s,o,n,a=[],h=t.getAttribute("points").replace(/\s+/," ").split(" "),u=0;u<h.length;u++)2===(s=h[u].split(",")).length&&(o=parseFloat(s[0]),n=parseFloat(s[1]),a.push(o),a.push(n));this._addShape(a,i,e,r,this.transformStack.getCurrentMat())},_addSeg:function(t,e,i,r,s,o){var n;n=t.stroke_width?.5*t.stroke_width:.5;var a,h,u,l,c=r-e,d=s-i,g=Math.sqrt(c*c+d*d),p=(d/=g)*n,M=(c/=g)*n,f=e-p,m=r-p,v=i+M,x=s+M,F=e+p,_=r+p,y=i-M,R=s-M,T=t.stroke;return o?(a=o.left,h=o.right,u=YFM.Math.Vector.pos(f,v),l=YFM.Math.Vector.pos(F,y),this.currentGroup.varray.push(a),this.currentGroup.carray.push(T),this.currentGroup.varray.push(h),this.currentGroup.carray.push(T),this.currentGroup.varray.push(u),this.currentGroup.carray.push(T),this.currentGroup.varray.push(h),this.currentGroup.carray.push(T),this.currentGroup.varray.push(l),this.currentGroup.carray.push(T),this.currentGroup.varray.push(u),this.currentGroup.carray.push(T),a=u,h=l):(a=YFM.Math.Vector.pos(f,v),h=YFM.Math.Vector.pos(F,y)),u=YFM.Math.Vector.pos(m,x),l=YFM.Math.Vector.pos(_,R),this.currentGroup.varray.push(a),this.currentGroup.carray.push(T),this.currentGroup.varray.push(h),this.currentGroup.carray.push(T),this.currentGroup.varray.push(u),this.currentGroup.carray.push(T),this.currentGroup.varray.push(h),this.currentGroup.carray.push(T),this.currentGroup.varray.push(l),this.currentGroup.carray.push(T),this.currentGroup.varray.push(u),this.currentGroup.carray.push(T),{left:u,right:l}},_addSegAdapt:function(t,e,i,r,s){var o;o=t.stroke_width?.5*t.stroke_width:.5;for(var n,a,h=r-e,u=s-i,l=Math.sqrt(h*h+u*u),c=(u/=l)*o,d=(h/=l)*o,g=1/Math.ceil(l/20),p=[],M=[],f=0;f<1;f+=g)n=h*f,a=u*f,p.push(YFM.Math.Vector.pos(e+n-c,i+a+d)),M.push(YFM.Math.Vector.pos(e+n+c,i+a-d));p.push(YFM.Math.Vector.pos(r-c,s+d)),M.push(YFM.Math.Vector.pos(r+c,s-d));for(var m=t.stroke,v=0,x=p.length-1;v<x;v++)this.currentGroup.varray.push(p[v]),this.currentGroup.carray.push(m),this.currentGroup.varray.push(M[v]),this.currentGroup.carray.push(m),this.currentGroup.varray.push(p[v+1]),this.currentGroup.carray.push(m),this.currentGroup.varray.push(M[v]),this.currentGroup.carray.push(m),this.currentGroup.varray.push(M[v+1]),this.currentGroup.carray.push(m),this.currentGroup.varray.push(p[v+1]),this.currentGroup.carray.push(m)},_addEllipse:function(t,e,i){if(e.fill||e.stroke){var r,s,o;if((o=t.getAttribute("r"))?r=s=parseFloat(o)||0:(r=parseFloat(t.getAttribute("rx"))||0,s=parseFloat(t.getAttribute("ry"))||0),!(r<=0||s<=0)){var n,a,h,u,l=parseFloat(t.getAttribute("cx"))||0,c=parseFloat(t.getAttribute("cy"))||0,d=[],g=[],p=[],M=[],f=this.transformStack.getCurrentMat(),m=10/Math.max(r,s),v=this.TWO_PI/32;if(m>v&&(m=v),f){for(u=this._multVec3(f,this._pos2(l,c)),n=0;n<this.TWO_PI;n+=m)if(A=this._multVec3(f,this._pos2(l+r*Math.cos(n),c+s*Math.sin(n))),d.push(A[0]),d.push(A[1]),g.push(YFM.Math.Vector.pos(A[0],A[1])),e.stroke){R=e.stroke_width?.5*e.stroke_width:.5;var x=A[0]-u[0],F=A[1]-u[1],_=(x/=T=Math.sqrt(x*x+F*F))*R,y=(F/=T)*R;p.push(YFM.Math.Vector.pos(A[0]-_,A[1]-y)),M.push(YFM.Math.Vector.pos(A[0]+_,A[1]+y))}}else for(u=this._pos2(l,c),n=0;n<this.TWO_PI;n+=m)if(a=l+r*Math.cos(n),h=c+s*Math.sin(n),d.push(a),d.push(h),g.push(YFM.Math.Vector.pos(a,h)),e.stroke){var R;R=e.stroke_width?.5*e.stroke_width:.5;var x=(A=this._pos2(a,h))[0]-u[0],F=A[1]-u[1],T=Math.sqrt(x*x+F*F),_=(x/=T)*R,y=(F/=T)*R;p.push(YFM.Math.Vector.pos(A[0]-_,A[1]-y)),M.push(YFM.Math.Vector.pos(A[0]+_,A[1]+y))}if(e.fill){var b=[];b.push(d);var S=[];S.push(g),this._tesselate(e.fill,b,S,i,e.fill_rule)}if(e.stroke)if(SVGParser.prototype.GROUP_TYPE_EXTRUDE===i){var A,Y,P=g.length;for(V=0;V<P;V++){if(A=g[V],V==P-1){if(!close)break;Y=g[0]}else Y=g[V+1];this.extrude.addBorder(YFM.Math.Vector.pos(A[0],A[1],0),YFM.Math.Vector.pos(Y[0],Y[1],0),e.stroke)}}else{for(var L=e.stroke,V=0,w=p.length-1;V<w;V++)this.currentGroup.varray.push(p[V]),this.currentGroup.carray.push(L),this.currentGroup.varray.push(M[V]),this.currentGroup.carray.push(L),this.currentGroup.varray.push(p[V+1]),this.currentGroup.carray.push(L),this.currentGroup.varray.push(M[V]),this.currentGroup.carray.push(L),this.currentGroup.varray.push(M[V+1]),this.currentGroup.carray.push(L),this.currentGroup.varray.push(p[V+1]),this.currentGroup.carray.push(L);this.currentGroup.varray.push(p[V]),this.currentGroup.carray.push(L),this.currentGroup.varray.push(M[V]),this.currentGroup.carray.push(L),this.currentGroup.varray.push(p[0]),this.currentGroup.carray.push(L),this.currentGroup.varray.push(M[V]),this.currentGroup.carray.push(L),this.currentGroup.varray.push(M[0]),this.currentGroup.carray.push(L),this.currentGroup.varray.push(p[0]),this.currentGroup.carray.push(L)}}}},_randomColor:function(){var t=[];return t.push(Math.random()),t.push(Math.random()),t.push(Math.random()),t.push(1),t},_addImage:function(t){var e=[],i=[],r=parseFloat(t.getAttribute("width")),s=parseFloat(t.getAttribute("height")),o=parseFloat(t.getAttribute("top"))||0,n=parseFloat(t.getAttribute("x"))||0,a=parseFloat(t.getAttribute("y"))||0,h=t.getAttribute("xlink:href"),u=[],l=this.transformStack.getCurrentMat();if(l){var c=this._multVec3(l,this._pos2(n,a)),d=this._multVec3(l,this._pos2(n+r,a)),g=this._multVec3(l,this._pos2(n+r,a+s)),p=this._multVec3(l,this._pos2(n,a+s));u.push(YFM.Math.Vector.pos(c[0],c[1],o)),u.push(YFM.Math.Vector.pos(d[0],d[1],o)),u.push(YFM.Math.Vector.pos(g[0],g[1],o)),u.push(YFM.Math.Vector.pos(p[0],p[1],o))}else u.push(YFM.Math.Vector.pos(n,a,o)),u.push(YFM.Math.Vector.pos(n+r,a,o)),u.push(YFM.Math.Vector.pos(n+r,a+s,o)),u.push(YFM.Math.Vector.pos(n,a+s,o));e.push(YFM.Math.Vector.vec(0,0)),e.push(YFM.Math.Vector.vec(1,0)),e.push(YFM.Math.Vector.vec(1,1)),e.push(YFM.Math.Vector.vec(0,1)),i.push(u[0]),i.push(e[0]),i.push(u[1]),i.push(e[1]),i.push(u[2]),i.push(e[2]),i.push(u[0]),i.push(e[0]),i.push(u[2]),i.push(e[2]),i.push(u[3]),i.push(e[3]);var M=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,M),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(i,4),this.gl.STATIC_DRAW);var f="svgimg_"+SVGParser.prototype.imgCursor;SVGParser.prototype.imgCursor+=1,this.currentGroup.imgList||(this.currentGroup.imgList=[]),this.currentGroup.imgList.push({quad:M,texName:f}),this.region.addTexture(f,h)},_addShape:function(t,e,i,r,s){var o,n,a,h,u,l,c=[],d=t.length/2,g=[];for(o=0;o<d;o++)n=t[2*o+0],a=t[2*o+1],s?(h=this._multVec3(s,this._pos2(n,a)),c.push(YFM.Math.Vector.pos(h[0],h[1])),g.push(h[0]),g.push(h[1])):(c.push(YFM.Math.Vector.pos(n,a)),g.push(n),g.push(a));if(e.fill){var p=[];p.push(g);var M=[];M.push(c),this._tesselate(e.fill,p,M,i,e.fill_rule)}var f;if(e.stroke)for(o=0;o<d;o++){if(n=g[2*o+0],a=g[2*o+1],o==d-1){if(!r)break;u=g[0],l=g[1]}else u=g[2*(o+1)+0],l=g[2*(o+1)+1];SVGParser.prototype.GROUP_TYPE_EXTRUDE===i?this.extrude.addBorder(YFM.Math.Vector.pos(n,a,0),YFM.Math.Vector.pos(u,l,0),e.stroke):f=this._addSeg(e,n,a,u,l,f)}},_addPath:function(t,e,i){var r=t.getAttribute("d"),s=new String(r),o=YFM.Math.Vector,n=this,a={a:7,c:6,o:2,h:1,l:2,m:2,r:4,q:4,s:4,t:2,v:1,u:3,z:0},h=[];s.replace(n.pathCommand,function(t,e,i){var r=[],s=e.toLowerCase();if(i.replace(n.pathValues,function(t,e){e&&r.push(+e)}),"m"==s&&r.length>2&&(h.push([e].concat(r.splice(0,2))),s="l",e="m"==e?"l":"L"),"o"==s&&1==r.length&&h.push([e,r[0]]),"r"==s)h.push([e].concat(r));else for(;r.length>=a[s]&&(h.push([e].concat(r.splice(0,a[s]))),a[s]););});var u,l,c,d,g,p,M,f,m,v,x=this.transformStack.getCurrentMat(),F=[],_=null;for(u=0,l=h.length;u<l;u++){if("M"===(c=h[u])[0])_&&0!==_.pts.length&&(_.close=!1,F.push(_)),d=o.pos(c[1],c[2]),_={pts:[],close:!1},this._moveTo(_.pts,d,x);else if("m"===c[0])_&&0!==_.pts.length&&(_.close=!1,F.push(_)),d=d?o.pos(d[0]+c[1],d[1]+c[2]):o.pos(c[1],c[2]),_={pts:[],close:!1},this._moveTo(_.pts,d,x);else if("z"===c[0]||"Z"===c[0])_.close=!0,F.push(_),_=null;else if("L"===c[0])d=o.pos(c[1],c[2]),this._lineTo(_.pts,d,x);else if("l"===c[0])d=o.pos(d[0]+c[1],d[1]+c[2]),this._lineTo(_.pts,d,x);else if("H"===c[0])d=o.pos(c[1],d[1]),this._lineTo(_.pts,d,x);else if("h"===c[0])d=o.pos(d[0]+c[1],d[1]),this._lineTo(_.pts,d,x);else if("V"===c[0])d=o.pos(d[0],c[1]),this._lineTo(_.pts,d,x);else if("v"===c[0])d=o.pos(d[0],d[1]+c[1]),this._lineTo(_.pts,d,x);else if("Q"===c[0])M=d,f=o.pos(c[1],c[2]),m=o.pos(c[3],c[4]),this._qBerzier(_.pts,M,f,m,x),d=m;else if("q"===c[0])M=d,f=o.pos(d[0]+c[1],d[1]+c[2]),m=o.pos(d[0]+c[3],d[1]+c[4]),this._qBerzier(_.pts,M,f,m,x),d=m;else if("T"===c[0]){if("Q"!==g&&"q"!==g&&"T"!==g&&"t"!==g)throw console.log(s),console.log(h),new Error("Berzier no preorder Q/q cmd:"+u);M=m,f=o.add(M,o.sub(m,f)),m=o.pos(c[1],c[2]),this._qBerzier(_.pts,M,f,m,x),d=m}else if("t"===c[0]){if("Q"!==g&&"q"!==g&&"T"!==g&&"t"!==g)throw console.log(s),console.log(h),new Error("Berzier no preorder Q/q cmd:"+u);M=m,f=o.add(M,o.sub(m,f)),m=o.pos(d[0]+c[1],d[1]+c[2]),this._qBerzier(_.pts,M,f,m,x),d=m}else if("C"===c[0])M=d,f=o.pos(c[1],c[2]),m=o.pos(c[3],c[4]),v=o.pos(c[5],c[6]),this._cBersizer(_.pts,M,f,m,v,x),d=v;else if("c"===c[0])M=d,f=o.pos(d[0]+c[1],d[1]+c[2]),m=o.pos(d[0]+c[3],d[1]+c[4]),v=o.pos(d[0]+c[5],d[1]+c[6]),this._cBersizer(_.pts,M,f,m,v,x),d=v;else if("S"===c[0]){if("C"!==g&&"c"!==g&&"S"!==g&&"s"!==g)throw console.log(s),console.log(h),new Error("Berzier no preorder C/c cmd:"+u);M=v,f=o.add(M,o.sub(v,m)),m=o.pos(c[1],c[2]),v=o.pos(c[3],c[4]),this._cBersizer(_.pts,M,f,m,v,x),d=v}else if("s"===c[0]){if("C"!==g&&"c"!==g&&"S"!==g&&"s"!==g)throw console.log(s),console.log(h),new Error("Berzier no preorder C/c cmd:"+u);M=v,f=o.add(M,o.sub(v,m)),m=o.pos(d[0]+c[1],d[1]+c[2]),v=o.pos(d[0]+c[3],d[1]+c[4]),this._cBersizer(_.pts,M,f,m,v,x),d=v}else"A"===c[0]?(p=o.pos(c[6],c[7]),this._arc(_.pts,d,p,c[1],c[2],c[3],c[4],c[5],x),d=p):"a"===c[0]&&(p=o.pos(d[0]+c[6],d[1]+c[7]),this._arc(_.pts,d,p,c[1],c[2],c[3],c[4],c[5],x),d=p);g=c[0]}_&&0!==_.pts.length&&(_.close=!1,F.push(_)),this._pathEnd(F,e,i,r)},_moveTo:function(t,e,i){i&&(e=this._multVec3(i,this._pos2(e[0],e[1]))),t.push(e)},_lineTo:function(t,e,i){i&&(e=this._multVec3(i,this._pos2(e[0],e[1]))),t.push(e)},_arc:function(t,e,i,r,s,o,n,a,h){var u=this._convertArc(e[0],e[1],r,s,o,n,a,i[0],i[1]),l=10/Math.max(u.rx,u.ry),c=Math.floor(Math.abs(u.angleExtent)/l);c<16&&(c=16);var d,g,p,M=u.angleExtent/c;if(h)for(d=0,g=u.angleStart;d<c;d++)g=u.angleStart+d*M,p=this._multVec3(h,this._pos2(u.cx+u.rx*Math.cos(g),u.cy+u.ry*Math.sin(g))),t.push(YFM.Math.Vector.pos(p[0],p[1]));else for(d=0,g=u.angleStart;d<c;d++)g=u.angleStart+d*M,t.push(YFM.Math.Vector.pos(u.cx+u.rx*Math.cos(g),u.cy+u.ry*Math.sin(g)));h&&(i=this._multVec3(h,this._pos2(i[0],i[1]))),t.push(i)},_convertArc:function(t,e,i,r,s,o,n,a,h){var u=(t-a)/2,l=(e-h)/2,s=Math.PI*(s%360)/180,c=Math.cos(s),d=Math.sin(s),g=c*u+d*l,p=-d*u+c*l,M=(i=Math.abs(i))*i,f=(r=Math.abs(r))*r,m=g*g,v=p*p,x=m/M+v/f;x>1&&(M=(i=Math.sqrt(x)*i)*i,f=(r=Math.sqrt(x)*r)*r);var F=o==n?-1:1,_=(M*f-M*v-f*m)/(M*v+f*m);_=_<0?0:_;var y,R,T=F*Math.sqrt(_),b=T*(i*p/r),S=T*(-r*g/i),A=(t+a)/2+(c*b-d*S),Y=(e+h)/2+(d*b+c*S),P=(g-b)/i,L=(p-S)/r,V=(-g-b)/i,w=(-p-S)/r;R=Math.sqrt(P*P+L*L),y=P;var E=(F=L<0?-1:1)*Math.acos(y/R);R=Math.sqrt((P*P+L*L)*(V*V+w*w)),y=P*V+L*w;var k=(F=P*w-L*V<0?-1:1)*Math.acos(y/R);return!n&&k>0?k-=2*Math.PI:n&&k<0&&(k+=2*Math.PI),k%=2*Math.PI,E%=2*Math.PI,{cx:A,cy:Y,rx:i,ry:r,angleStart:E,angleExtent:k,xAngle:s}},_qBerzier:function(t,e,i,r,s){s&&(e=this._multVec3(s,this._pos2(e[0],e[1])),i=this._multVec3(s,this._pos2(i[0],i[1])),r=this._multVec3(s,this._pos2(r[0],r[1]))),t.push(e),this._qBersizerDivPlus(t,e,i,r,0),t.push(r)},_cBersizer:function(t,e,i,r,s,o){o&&(e=this._multVec3(o,this._pos2(e[0],e[1])),i=this._multVec3(o,this._pos2(i[0],i[1])),r=this._multVec3(o,this._pos2(r[0],r[1])),s=this._multVec3(o,this._pos2(s[0],s[1]))),t.push(e),this._cBersizerDivPlus(t,e,i,r,s,0),t.push(s)},_qBersizerDivPlus:function(t,e,i,r,s){if(!(s>this.RECURSION_LIMIT)){var o=YFM.Math.Vector,n=o.mid(e,i),a=o.mid(i,r),h=o.mid(n,a),u=r[0]-e[0],l=r[1]-e[1],c=Math.abs((i[0]-r[0])*l-(i[1]-r[1])*u);if(c>this.FLT_EPSILON){if(c*c<=this.distanceTolerance*(u*u+l*l))return void t.push(h)}else if(u=h[0]-.5*(e[0]+r[0]),l=h[1]-.5*(e[1]+r[1]),u*u+l*l<=this.distanceTolerance)return void t.push(h);this._qBersizerDivPlus(t,e,n,h,s+1),this._qBersizerDivPlus(t,h,a,r,s+1)}},_cBersizerDivPlus:function(t,e,i,r,s,o){if(!(o>this.RECURSION_LIMIT)){var n=YFM.Math.Vector,a=n.mid(e,i),h=n.mid(i,r),u=n.mid(r,s),l=n.mid(a,h),c=n.mid(h,u),d=n.mid(l,c);if(o>0){var g=s[0]-e[0],p=s[1]-e[1],M=Math.abs((i[0]-s[0])*p-(i[1]-s[1])*g),f=Math.abs((r[0]-s[0])*p-(r[1]-s[1])*g);if(M>this.FLT_EPSILON&&f>this.FLT_EPSILON){if((M+f)*(M+f)<=this.distanceTolerance*(g*g+p*p))return void t.push(d)}else if(M>this.FLT_EPSILON){if(M*M<=this.distanceTolerance*(g*g+p*p))return void t.push(d)}else if(f>this.FLT_EPSILON){if(f*f<=this.distanceTolerance*(g*g+p*p))return void t.push(d)}else if(g=d[0]-.5*(e[0]+s[0]),p=d[1]-.5*(e[1]+s[1]),g*g+p*p<=this.distanceTolerance)return void t.push(d)}this._cBersizerDivPlus(t,e,a,l,d,o+1),this._cBersizerDivPlus(t,d,c,u,s,o+1)}},_pathEnd:function(t,e,i,r){var s,o,n,a,h,u,l,c;if(e.stroke)for(s=0,o=t.length;s<o;s++)if((h=t[s].pts).length>5e4)console.log("shapeEnd liule:%s",r);else for(n=0,a=h.length;n<a;n++){if(u=YFM.Math.Vector.pos(h[n][0],h[n][1]),n==a-1){if(!t[s].close)break;l=YFM.Math.Vector.pos(h[0][0],h[0][1])}else l=YFM.Math.Vector.pos(h[n+1][0],h[n+1][1]);SVGParser.prototype.GROUP_TYPE_EXTRUDE===i?this.extrude.addBorder(u,l,e.stroke):c=this._addSeg(e,u[0],u[1],l[0],l[1],c)}if(e.fill){var d,g=[],p=[];for(s=0,o=t.length;s<o;s++)if(e.fill||t[s].close){if((h=t[s].pts).length>3e4)continue;for(d=[],n=0,a=h.length;n<a;n++)d.push(h[n][0]),d.push(h[n][1]);g.push(d),p.push(h)}g.length>0&&this._tesselate(e.fill,g,p,i,e.fill_rule)}},_multVec3:function(t,e){var i,r,s,o=[];return i=e[0],r=e[1],s=e[2],o.push(i*t[0]+r*t[3]+s*t[6]),o.push(i*t[1]+r*t[4]+s*t[7]),o.push(i*t[2]+r*t[5]+s*t[8]),o},_pos2:function(t,e){var i=[];return i.push(t),i.push(e),i.push(1),i},_add:function(t,e){var i=[];return i.push(t[0]+e[0]),i.push(t[1]+e[1]),i.push(t[2]+e[2]),i},_sub:function(t,e){var i=[];return i.push(t[0]-e[0]),i.push(t[1]-e[1]),i.push(t[2]-e[2]),i},_norm:function(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1])},_normalize:function(t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]),i=[];return i.push(t[0]/e),i.push(t[1]/e),i.push(t[2]),i},_scale:function(t,e){var i=[];return i.push(t[0]*e),i.push(t[1]*e),i.push(t[2]*e),i},_tesselate:function(t,e,i,r,s){void 0===s&&(s=Tess2.WINDING_NONZERO);var o,n=[],a={contours:e,windingRule:s,elementType:Tess2.POLYGONS,polySize:3,vertexSize:2};try{o=Tess2.tesselate(a)}catch(t){return void console.log("error opt:%o",a)}var h,u,l,c,d,g=[];for(h=0,u=o.vertices.length;h<u;h+=2)g.push(YFM.Math.Vector.pos(o.vertices[h],o.vertices[h+1]));var p=this.currentGroup.carray.length;for(h=0,u=o.elements.length;h<u;h+=3)l=o.elements[h],c=o.elements[h+1],d=o.elements[h+2],0!==r&&(n.push(g[l]),n.push(g[c]),n.push(g[d])),0!==r&&SVGParser.prototype.GROUP_TYPE_BOUNDARY!==r||(this.currentGroup.varray.push(g[l]),this.currentGroup.carray.push(t),this.currentGroup.varray.push(g[c]),this.currentGroup.carray.push(t),this.currentGroup.varray.push(g[d]),this.currentGroup.carray.push(t));if(SVGParser.prototype.GROUP_TYPE_EXTRUDE===r){var M=this.extrude.addExtrude(i,n,t);this.currentGroup.objarray.push({color:t,top_start:M.top_start,top_len:M.top_len,side_start:M.side_start,side_len:M.side_len})}else SVGParser.prototype.GROUP_TYPE_BOUNDARY===r?this.boundary.addExtrude(i,n,t):this.currentGroup.objarray.push({color:t,start:p,len:o.elements.length});return!0}},SVGTransformStack=function(){this.transformCmd=/(\w+\((\-?\d+\.?\d*e?\-?\d*[,\s]?)+\))+/gi,this.transformVal=/[\w\.\-]+/gi,this.matStack=[],this.currentMat=null},SVGTransformStack.prototype={constructor:SVGTransformStack,pushTransform:function(t){this.matStack.push(this._parseTransform(t));for(var e=this._mat(),i=0,r=this.matStack.length;i<r;i++)e=this._matMul(e,this.matStack[i]);this.currentMat=e},popTransform:function(){if(this.matStack.length>0&&this.matStack.pop(),this.matStack.length>0){for(var t=this._mat(),e=0,i=this.matStack.length;e<i;e++)t=this._matMul(t,this.matStack[e]);this.currentMat=t}else this.currentMat=null},clean:function(){this.matStack=[],this.currentMat=null},getCurrentMat:function(){return this.currentMat},_parseMatrix:function(t){var e=[];if("matrix"===t[0])e.push(parseFloat(t[1])),e.push(parseFloat(t[2])),e.push(0),e.push(parseFloat(t[3])),e.push(parseFloat(t[4])),e.push(0),e.push(parseFloat(t[5])),e.push(parseFloat(t[6])),e.push(1);else if("translate"===t[0])e.push(1),e.push(0),e.push(0),e.push(0),e.push(1),e.push(0),e.push(parseFloat(t[1])),e.push(parseFloat(t[2])),e.push(1);else if("scale"===t[0]){var i,r;2===t.length?i=r=parseFloat(t[1]):(i=parseFloat(t[1]),r=parseFloat(t[2])),e.push(i),e.push(0),e.push(0),e.push(0),e.push(r),e.push(0),e.push(0),e.push(0),e.push(1)}else if("rotate"===t[0]){var s,o,n,a,h;s=YFM.Math.deg2Radian(parseFloat(t[1])),o=Math.cos(s),n=Math.sin(s),e.push(o),e.push(n),e.push(0),e.push(-n),e.push(o),e.push(0),2===t.length?(e.push(0),e.push(0),e.push(1)):(a=parseFloat(t[2]),h=parseFloat(t[3]),e.push(a*(1-o)+h*n),e.push(h*(1-o)-a*n),e.push(1))}return e},_parseTransform:function(t){if(!t)return null;var e,i,r,s,o=t.match(this.transformCmd);s=this._mat();for(e in o)i=o[e].match(this.transformVal),r=this._parseMatrix(i),s=this._matMul(s,r);return s},_matMul:function(t,e){var i,r,s,o,n=[];for(o=0;o<3;o++)i=e[3*o+0],r=e[3*o+1],s=e[3*o+2],n.push(i*t[0]+r*t[3]+s*t[6]),n.push(i*t[1]+r*t[4]+s*t[7]),n.push(i*t[2]+r*t[5]+s*t[8]);return n},_mat:function(){var t=[];return t.push(1),t.push(0),t.push(0),t.push(0),t.push(1),t.push(0),t.push(0),t.push(0),t.push(1),t}};var Tess2={};Tess2.WINDING_ODD=0,Tess2.WINDING_NONZERO=1,Tess2.WINDING_POSITIVE=2,Tess2.WINDING_NEGATIVE=3,Tess2.WINDING_ABS_GEQ_TWO=4,Tess2.POLYGONS=0,Tess2.CONNECTED_POLYGONS=1,Tess2.BOUNDARY_CONTOURS=2,Tess2.tesselate=function(t){for(var e=t.debug||!1,i=new Tesselator,r=0;r<t.contours.length;r++)i.addContour(t.vertexSize||2,t.contours[r]);return i.tesselate(t.windingRule||Tess2.WINDING_ODD,t.elementType||Tess2.POLYGONS,t.polySize||3,t.vertexSize||2,t.normal||[0,0,1]),{vertices:i.vertices,vertexIndices:i.vertexIndices,vertexCount:i.vertexCount,elements:i.elements,elementCount:i.elementCount,mesh:e?i.mesh:void 0}};var assert=function(t){if(!t)throw Error("Assertion Failed!")};TESShalfEdge.prototype={get Rface(){return this.Sym.Lface},set Rface(t){this.Sym.Lface=t},get Dst(){return this.Sym.Org},set Dst(t){this.Sym.Org=t},get Oprev(){return this.Sym.Lnext},set Oprev(t){this.Sym.Lnext=t},get Lprev(){return this.Onext.Sym},set Lprev(t){this.Onext.Sym=t},get Dprev(){return this.Lnext.Sym},set Dprev(t){this.Lnext.Sym=t},get Rprev(){return this.Sym.Onext},set Rprev(t){this.Sym.Onext=t},get Dnext(){return this.Sym.Onext.Sym},set Dnext(t){this.Sym.Onext.Sym=t},get Rnext(){return this.Sym.Lnext.Sym},set Rnext(t){this.Sym.Lnext.Sym=t}},TESSmesh.prototype={makeEdge_:function(t){var e=new TESShalfEdge(0),i=new TESShalfEdge(1);t.Sym.side<t.side&&(t=t.Sym);var r=t.Sym.next;return i.next=r,r.Sym.next=e,e.next=t,t.Sym.next=i,e.Sym=i,e.Onext=e,e.Lnext=i,e.Org=null,e.Lface=null,e.winding=0,e.activeRegion=null,i.Sym=e,i.Onext=i,i.Lnext=e,i.Org=null,i.Lface=null,i.winding=0,i.activeRegion=null,e},splice_:function(t,e){var i=t.Onext,r=e.Onext;i.Sym.Lnext=e,r.Sym.Lnext=t,t.Onext=r,e.Onext=i},makeVertex_:function(t,e,i){var r=t;assert(null!==r);var s=i.prev;r.prev=s,s.next=r,r.next=i,i.prev=r,r.anEdge=e;var o=e;do{o.Org=r,o=o.Onext}while(o!==e)},makeFace_:function(t,e,i){var r=t;assert(null!==r);var s=i.prev;r.prev=s,s.next=r,r.next=i,i.prev=r,r.anEdge=e,r.trail=null,r.marked=!1,r.inside=i.inside;var o=e;do{o.Lface=r,o=o.Lnext}while(o!==e)},killEdge_:function(t){t.Sym.side<t.side&&(t=t.Sym);var e=t.next,i=t.Sym.next;e.Sym.next=i,i.Sym.next=e},killVertex_:function(t,e){var i=t.anEdge,r=i;do{r.Org=e,r=r.Onext}while(r!==i);var s=t.prev,o=t.next;o.prev=s,s.next=o},killFace_:function(t,e){var i=t.anEdge,r=i;do{r.Lface=e,r=r.Lnext}while(r!==i);var s=t.prev,o=t.next;o.prev=s,s.next=o},makeEdge:function(){var t=new TESSvertex,e=new TESSvertex,i=new TESSface,r=this.makeEdge_(this.eHead);return this.makeVertex_(t,r,this.vHead),this.makeVertex_(e,r.Sym,this.vHead),this.makeFace_(i,r,this.fHead),r},splice:function(t,e){var i=!1,r=!1;if(t!==e){if(e.Org!==t.Org&&(r=!0,this.killVertex_(e.Org,t.Org)),e.Lface!==t.Lface&&(i=!0,this.killFace_(e.Lface,t.Lface)),this.splice_(e,t),!r){var s=new TESSvertex;this.makeVertex_(s,e,t.Org),t.Org.anEdge=t}if(!i){var o=new TESSface;this.makeFace_(o,e,t.Lface),t.Lface.anEdge=t}}},delete:function(t){var e=t.Sym,i=!1;if(t.Lface!==t.Rface&&(i=!0,this.killFace_(t.Lface,t.Rface)),t.Onext===t)this.killVertex_(t.Org,null);else if(t.Rface.anEdge=t.Oprev,t.Org.anEdge=t.Onext,this.splice_(t,t.Oprev),!i){var r=new TESSface;this.makeFace_(r,t,t.Lface)}e.Onext===e?(this.killVertex_(e.Org,null),this.killFace_(e.Lface,null)):(t.Lface.anEdge=e.Oprev,e.Org.anEdge=e.Onext,this.splice_(e,e.Oprev)),this.killEdge_(t)},addEdgeVertex:function(t){var e=this.makeEdge_(t),i=e.Sym;this.splice_(e,t.Lnext),e.Org=t.Dst;var r=new TESSvertex;return this.makeVertex_(r,i,e.Org),e.Lface=i.Lface=t.Lface,e},splitEdge:function(t,e){var i=this.addEdgeVertex(t).Sym;return this.splice_(t.Sym,t.Sym.Oprev),this.splice_(t.Sym,i),t.Dst=i.Org,i.Dst.anEdge=i.Sym,i.Rface=t.Rface,i.winding=t.winding,i.Sym.winding=t.Sym.winding,i},connect:function(t,e){var i=!1,r=this.makeEdge_(t),s=r.Sym;if(e.Lface!==t.Lface&&(i=!0,this.killFace_(e.Lface,t.Lface)),this.splice_(r,t.Lnext),this.splice_(s,e),r.Org=t.Dst,s.Org=e.Org,r.Lface=s.Lface=t.Lface,t.Lface.anEdge=s,!i){var o=new TESSface;this.makeFace_(o,r,t.Lface)}return r},zapFace:function(t){var e,i,r,s,o,n=t.anEdge;i=n.Lnext;do{i=(e=i).Lnext,e.Lface=null,null===e.Rface&&(e.Onext===e?this.killVertex_(e.Org,null):(e.Org.anEdge=e.Onext,this.splice_(e,e.Oprev)),(r=e.Sym).Onext===r?this.killVertex_(r.Org,null):(r.Org.anEdge=r.Onext,this.splice_(r,r.Oprev)),this.killEdge_(e))}while(e!=n);s=t.prev,(o=t.next).prev=s,s.next=o},countFaceVerts_:function(t){var e=t.anEdge,i=0;do{i++,e=e.Lnext}while(e!==t.anEdge);return i},mergeConvexFaces:function(t){var e,i,r,s,o;for(e=this.fHead.next;e!==this.fHead;e=e.next)if(e.inside)for(o=(i=e.anEdge).Org;;){if(r=i.Lnext,(s=i.Sym)&&s.Lface&&s.Lface.inside&&this.countFaceVerts_(e)+this.countFaceVerts_(s.Lface)-2<=t&&Geom.vertCCW(i.Lprev.Org,i.Org,s.Lnext.Lnext.Org)&&Geom.vertCCW(s.Lprev.Org,s.Org,i.Lnext.Lnext.Org)&&(r=s.Lnext,this.delete(s),i=null,s=null),i&&i.Lnext.Org===o)break;i=r}return!0},check:function(){var t,e,i,r,s,o,n=this.fHead,a=this.vHead,h=this.eHead;for(e=n,e=n;(t=e.next)!==n;e=t){assert(t.prev===e),s=t.anEdge;do{assert(s.Sym!==s),assert(s.Sym.Sym===s),assert(s.Lnext.Onext.Sym===s),assert(s.Onext.Sym.Lnext===s),assert(s.Lface===t),s=s.Lnext}while(s!==t.anEdge)}for(assert(t.prev===e&&null===t.anEdge),r=a,r=a;(i=r.next)!==a;r=i){assert(i.prev===r),s=i.anEdge;do{assert(s.Sym!==s),assert(s.Sym.Sym===s),assert(s.Lnext.Onext.Sym===s),assert(s.Onext.Sym.Lnext===s),assert(s.Org===i),s=s.Onext}while(s!==i.anEdge)}for(assert(i.prev===r&&null===i.anEdge),o=h,o=h;(s=o.next)!==h;o=s)assert(s.Sym.next===o.Sym),assert(s.Sym!==s),assert(s.Sym.Sym===s),assert(null!==s.Org),assert(null!==s.Dst),assert(s.Lnext.Onext.Sym===s),assert(s.Onext.Sym.Lnext===s);assert(s.Sym.next===o.Sym&&s.Sym===this.eHeadSym&&s.Sym.Sym===s&&null===s.Org&&null===s.Dst&&null===s.Lface&&null===s.Rface)}};var Geom={};Geom.vertEq=function(t,e){return t.s===e.s&&t.t===e.t},Geom.vertLeq=function(t,e){return t.s<e.s||t.s===e.s&&t.t<=e.t},Geom.transLeq=function(t,e){return t.t<e.t||t.t===e.t&&t.s<=e.s},Geom.edgeGoesLeft=function(t){return Geom.vertLeq(t.Dst,t.Org)},Geom.edgeGoesRight=function(t){return Geom.vertLeq(t.Org,t.Dst)},Geom.vertL1dist=function(t,e){return Math.abs(t.s-e.s)+Math.abs(t.t-e.t)},Geom.edgeEval=function(t,e,i){assert(Geom.vertLeq(t,e)&&Geom.vertLeq(e,i));var r=e.s-t.s,s=i.s-e.s;return r+s>0?r<s?e.t-t.t+(t.t-i.t)*(r/(r+s)):e.t-i.t+(i.t-t.t)*(s/(r+s)):0},Geom.edgeSign=function(t,e,i){assert(Geom.vertLeq(t,e)&&Geom.vertLeq(e,i));var r=e.s-t.s,s=i.s-e.s;return r+s>0?(e.t-i.t)*r+(e.t-t.t)*s:0},Geom.transEval=function(t,e,i){assert(Geom.transLeq(t,e)&&Geom.transLeq(e,i));var r=e.t-t.t,s=i.t-e.t;return r+s>0?r<s?e.s-t.s+(t.s-i.s)*(r/(r+s)):e.s-i.s+(i.s-t.s)*(s/(r+s)):0},Geom.transSign=function(t,e,i){assert(Geom.transLeq(t,e)&&Geom.transLeq(e,i));var r=e.t-t.t,s=i.t-e.t;return r+s>0?(e.s-i.s)*r+(e.s-t.s)*s:0},Geom.vertCCW=function(t,e,i){return t.s*(e.t-i.t)+e.s*(i.t-t.t)+i.s*(t.t-e.t)>=0},Geom.interpolate=function(t,e,i,r){return t=t<0?0:t,i=i<0?0:i,t<=i?0==i?(e+r)/2:e+t/(t+i)*(r-e):r+i/(t+i)*(e-r)},Geom.intersect=function(t,e,i,r,s){var o,n,a;Geom.vertLeq(t,e)||(a=t,t=e,e=a),Geom.vertLeq(i,r)||(a=i,i=r,r=a),Geom.vertLeq(t,i)||(a=t,t=i,i=a,a=e,e=r,r=a),Geom.vertLeq(i,e)?Geom.vertLeq(e,r)?((o=Geom.edgeEval(t,i,e))+(n=Geom.edgeEval(i,e,r))<0&&(o=-o,n=-n),s.s=Geom.interpolate(o,i.s,n,e.s)):((o=Geom.edgeSign(t,i,e))+(n=-Geom.edgeSign(t,r,e))<0&&(o=-o,n=-n),s.s=Geom.interpolate(o,i.s,n,r.s)):s.s=(i.s+e.s)/2,Geom.transLeq(t,e)||(a=t,t=e,e=a),Geom.transLeq(i,r)||(a=i,i=r,r=a),Geom.transLeq(t,i)||(a=t,t=i,i=a,a=e,e=r,r=a),Geom.transLeq(i,e)?Geom.transLeq(e,r)?((o=Geom.transEval(t,i,e))+(n=Geom.transEval(i,e,r))<0&&(o=-o,n=-n),s.t=Geom.interpolate(o,i.t,n,e.t)):((o=Geom.transSign(t,i,e))+(n=-Geom.transSign(t,r,e))<0&&(o=-o,n=-n),s.t=Geom.interpolate(o,i.t,n,r.t)):s.t=(i.t+e.t)/2},Dict.prototype={min:function(){return this.head.next},max:function(){return this.head.prev},insert:function(t){return this.insertBefore(this.head,t)},search:function(t){var e=this.head;do{e=e.next}while(null!==e.key&&!this.leq(this.frame,t,e.key));return e},insertBefore:function(t,e){do{t=t.prev}while(null!==t.key&&!this.leq(this.frame,t.key,e));var i=new DictNode;return i.key=e,i.next=t.next,t.next.prev=i,i.prev=t,t.next=i,i},delete:function(t){t.next.prev=t.prev,t.prev.next=t.next}},PriorityQ.prototype={floatDown_:function(t){var e,i,r,s=this.nodes,o=this.handles;for(e=s[t].handle;;){if((r=t<<1)<this.size&&this.leq(o[s[r+1].handle].key,o[s[r].handle].key)&&++r,assert(r<=this.max),i=s[r].handle,r>this.size||this.leq(o[e].key,o[i].key)){s[t].handle=e,o[e].node=t;break}s[t].handle=i,o[i].node=t,t=r}},floatUp_:function(t){var e,i,r,s=this.nodes,o=this.handles;for(e=s[t].handle;;){if(r=t>>1,i=s[r].handle,0==r||this.leq(o[i].key,o[e].key)){s[t].handle=e,o[e].node=t;break}s[t].handle=i,o[i].node=t,t=r}},init:function(){for(var t=this.size;t>=1;--t)this.floatDown_(t);this.initialized=!0},min:function(){return this.handles[this.nodes[1].handle].key},isEmpty:function(){this.size},insert:function(t){var e,i;if(2*(e=++this.size)>this.max){this.max*=2;var r;r=this.nodes.length,this.nodes.length=this.max+1;for(s=r;s<this.nodes.length;s++)this.nodes[s]=new PQnode;r=this.handles.length,this.handles.length=this.max+1;for(var s=r;s<this.handles.length;s++)this.handles[s]=new PQhandleElem}return 0===this.freeList?i=e:(i=this.freeList,this.freeList=this.handles[i].node),this.nodes[e].handle=i,this.handles[i].node=e,this.handles[i].key=t,this.initialized&&this.floatUp_(e),i},extractMin:function(){var t=this.nodes,e=this.handles,i=t[1].handle,r=e[i].key;return this.size>0&&(t[1].handle=t[this.size].handle,e[t[1].handle].node=1,e[i].key=null,e[i].node=this.freeList,this.freeList=i,--this.size,this.size>0&&this.floatDown_(1)),r},delete:function(t){var e,i=this.nodes,r=this.handles;assert(t>=1&&t<=this.max&&null!==r[t].key),i[e=r[t].node].handle=i[this.size].handle,r[i[e].handle].node=e,--this.size,e<=this.size&&(e<=1||this.leq(r[i[e>>1].handle].key,r[i[e].handle].key)?this.floatDown_(e):this.floatUp_(e)),r[t].key=null,r[t].node=this.freeList,this.freeList=t}};var Sweep={};Sweep.regionBelow=function(t){return t.nodeUp.prev.key},Sweep.regionAbove=function(t){return t.nodeUp.next.key},Sweep.debugEvent=function(t){},Sweep.addWinding=function(t,e){t.winding+=e.winding,t.Sym.winding+=e.Sym.winding},Sweep.edgeLeq=function(t,e,i){var r=t.event,s=e.eUp,o=i.eUp;return s.Dst===r?o.Dst===r?Geom.vertLeq(s.Org,o.Org)?Geom.edgeSign(o.Dst,s.Org,o.Org)<=0:Geom.edgeSign(s.Dst,o.Org,s.Org)>=0:Geom.edgeSign(o.Dst,r,o.Org)<=0:o.Dst===r?Geom.edgeSign(s.Dst,r,s.Org)>=0:Geom.edgeEval(s.Dst,r,s.Org)>=Geom.edgeEval(o.Dst,r,o.Org)},Sweep.deleteRegion=function(t,e){e.fixUpperEdge&&assert(0===e.eUp.winding),e.eUp.activeRegion=null,t.dict.delete(e.nodeUp)},Sweep.fixUpperEdge=function(t,e,i){assert(e.fixUpperEdge),t.mesh.delete(e.eUp),e.fixUpperEdge=!1,e.eUp=i,i.activeRegion=e},Sweep.topLeftRegion=function(t,e){var i,r=e.eUp.Org;do{e=Sweep.regionAbove(e)}while(e.eUp.Org===r);if(e.fixUpperEdge){if(null===(i=t.mesh.connect(Sweep.regionBelow(e).eUp.Sym,e.eUp.Lnext)))return null;Sweep.fixUpperEdge(t,e,i),e=Sweep.regionAbove(e)}return e},Sweep.topRightRegion=function(t){var e=t.eUp.Dst,t=null;do{t=Sweep.regionAbove(t)}while(t.eUp.Dst===e);return t},Sweep.addRegionBelow=function(t,e,i){var r=new ActiveRegion;return r.eUp=i,r.nodeUp=t.dict.insertBefore(e.nodeUp,r),r.fixUpperEdge=!1,r.sentinel=!1,r.dirty=!1,i.activeRegion=r,r},Sweep.isWindingInside=function(t,e){switch(t.windingRule){case Tess2.WINDING_ODD:return 0!=(1&e);case Tess2.WINDING_NONZERO:return 0!=e;case Tess2.WINDING_POSITIVE:return e>0;case Tess2.WINDING_NEGATIVE:return e<0;case Tess2.WINDING_ABS_GEQ_TWO:return e>=2||e<=-2}return assert(!1),!1},Sweep.computeWinding=function(t,e){e.windingNumber=Sweep.regionAbove(e).windingNumber+e.eUp.winding,e.inside=Sweep.isWindingInside(t,e.windingNumber)},Sweep.finishRegion=function(t,e){var i=e.eUp,r=i.Lface;r.inside=e.inside,r.anEdge=i,Sweep.deleteRegion(t,e)},Sweep.finishLeftRegions=function(t,e,i){for(var r,s=null,o=e,n=e.eUp;o!==i;){if(o.fixUpperEdge=!1,s=Sweep.regionBelow(o),(r=s.eUp).Org!=n.Org){if(!s.fixUpperEdge){Sweep.finishRegion(t,o);break}r=t.mesh.connect(n.Lprev,r.Sym),Sweep.fixUpperEdge(t,s,r)}n.Onext!==r&&(t.mesh.splice(r.Oprev,r),t.mesh.splice(n,r)),Sweep.finishRegion(t,o),n=s.eUp,o=s}return n},Sweep.addRightEdges=function(t,e,i,r,s,o){var n,a,h,u,l=!0;h=i;do{assert(Geom.vertLeq(h.Org,h.Dst)),Sweep.addRegionBelow(t,e,h.Sym),h=h.Onext}while(h!==r);for(null===s&&(s=Sweep.regionBelow(e).eUp.Rprev),a=e,u=s;n=Sweep.regionBelow(a),(h=n.eUp.Sym).Org===u.Org;)h.Onext!==u&&(t.mesh.splice(h.Oprev,h),t.mesh.splice(u.Oprev,h)),n.windingNumber=a.windingNumber-h.winding,n.inside=Sweep.isWindingInside(t,n.windingNumber),a.dirty=!0,!l&&Sweep.checkForRightSplice(t,a)&&(Sweep.addWinding(h,u),Sweep.deleteRegion(t,a),t.mesh.delete(u)),l=!1,a=n,u=h;a.dirty=!0,assert(a.windingNumber-h.winding===n.windingNumber),o&&Sweep.walkDirtyRegions(t,a)},Sweep.spliceMergeVertices=function(t,e,i){t.mesh.splice(e,i)},Sweep.vertexWeights=function(t,e,i){var r=Geom.vertL1dist(e,t),s=Geom.vertL1dist(i,t),o=.5*s/(r+s),n=.5*r/(r+s);t.coords[0]+=o*e.coords[0]+n*i.coords[0],t.coords[1]+=o*e.coords[1]+n*i.coords[1],t.coords[2]+=o*e.coords[2]+n*i.coords[2]},Sweep.getIntersectData=function(t,e,i,r,s,o){e.coords[0]=e.coords[1]=e.coords[2]=0,e.idx=-1,Sweep.vertexWeights(e,i,r),Sweep.vertexWeights(e,s,o)},Sweep.checkForRightSplice=function(t,e){var i=Sweep.regionBelow(e),r=e.eUp,s=i.eUp;if(Geom.vertLeq(r.Org,s.Org)){if(Geom.edgeSign(s.Dst,r.Org,s.Org)>0)return!1;Geom.vertEq(r.Org,s.Org)?r.Org!==s.Org&&(t.pq.delete(r.Org.pqHandle),Sweep.spliceMergeVertices(t,s.Oprev,r)):(t.mesh.splitEdge(s.Sym),t.mesh.splice(r,s.Oprev),e.dirty=i.dirty=!0)}else{if(Geom.edgeSign(r.Dst,s.Org,r.Org)<0)return!1;Sweep.regionAbove(e).dirty=e.dirty=!0,t.mesh.splitEdge(r.Sym),t.mesh.splice(s.Oprev,r)}return!0},Sweep.checkForLeftSplice=function(t,e){var i,r=Sweep.regionBelow(e),s=e.eUp,o=r.eUp;if(assert(!Geom.vertEq(s.Dst,o.Dst)),Geom.vertLeq(s.Dst,o.Dst)){if(Geom.edgeSign(s.Dst,o.Dst,s.Org)<0)return!1;Sweep.regionAbove(e).dirty=e.dirty=!0,i=t.mesh.splitEdge(s),t.mesh.splice(o.Sym,i),i.Lface.inside=e.inside}else{if(Geom.edgeSign(o.Dst,s.Dst,o.Org)>0)return!1;e.dirty=r.dirty=!0,i=t.mesh.splitEdge(o),t.mesh.splice(s.Lnext,o.Sym),i.Rface.inside=e.inside}return!0},Sweep.checkForIntersect=function(t,e){var i,r,s,o,n=Sweep.regionBelow(e),a=e.eUp,h=n.eUp,u=a.Org,l=h.Org,c=a.Dst,d=h.Dst,g=new TESSvertex;if(assert(!Geom.vertEq(d,c)),assert(Geom.edgeSign(c,t.event,u)<=0),assert(Geom.edgeSign(d,t.event,l)>=0),assert(u!==t.event&&l!==t.event),assert(!e.fixUpperEdge&&!n.fixUpperEdge),u===l)return!1;if(i=Math.min(u.t,c.t),r=Math.max(l.t,d.t),i>r)return!1;if(Geom.vertLeq(u,l)){if(Geom.edgeSign(d,u,l)>0)return!1}else if(Geom.edgeSign(c,l,u)<0)return!1;return Sweep.debugEvent(t),Geom.intersect(c,u,d,l,g),assert(Math.min(u.t,c.t)<=g.t),assert(g.t<=Math.max(l.t,d.t)),assert(Math.min(d.s,c.s)<=g.s),assert(g.s<=Math.max(l.s,u.s)),Geom.vertLeq(g,t.event)&&(g.s=t.event.s,g.t=t.event.t),s=Geom.vertLeq(u,l)?u:l,Geom.vertLeq(s,g)&&(g.s=s.s,g.t=s.t),Geom.vertEq(g,u)||Geom.vertEq(g,l)?(Sweep.checkForRightSplice(t,e),!1):!Geom.vertEq(c,t.event)&&Geom.edgeSign(c,t.event,g)>=0||!Geom.vertEq(d,t.event)&&Geom.edgeSign(d,t.event,g)<=0?d===t.event?(t.mesh.splitEdge(a.Sym),t.mesh.splice(h.Sym,a),e=Sweep.topLeftRegion(t,e),a=Sweep.regionBelow(e).eUp,Sweep.finishLeftRegions(t,Sweep.regionBelow(e),n),Sweep.addRightEdges(t,e,a.Oprev,a,a,!0),TRUE):c===t.event?(t.mesh.splitEdge(h.Sym),t.mesh.splice(a.Lnext,h.Oprev),n=e,e=Sweep.topRightRegion(e),o=Sweep.regionBelow(e).eUp.Rprev,n.eUp=h.Oprev,h=Sweep.finishLeftRegions(t,n,null),Sweep.addRightEdges(t,e,h.Onext,a.Rprev,o,!0),!0):(Geom.edgeSign(c,t.event,g)>=0&&(Sweep.regionAbove(e).dirty=e.dirty=!0,t.mesh.splitEdge(a.Sym),a.Org.s=t.event.s,a.Org.t=t.event.t),Geom.edgeSign(d,t.event,g)<=0&&(e.dirty=n.dirty=!0,t.mesh.splitEdge(h.Sym),h.Org.s=t.event.s,h.Org.t=t.event.t),!1):(t.mesh.splitEdge(a.Sym),t.mesh.splitEdge(h.Sym),t.mesh.splice(h.Oprev,a),a.Org.s=g.s,a.Org.t=g.t,a.Org.pqHandle=t.pq.insert(a.Org),Sweep.getIntersectData(t,a.Org,u,c,l,d),Sweep.regionAbove(e).dirty=e.dirty=n.dirty=!0,!1)},Sweep.walkDirtyRegions=function(t,e){for(var i,r,s=Sweep.regionBelow(e);;){for(;s.dirty;)e=s,s=Sweep.regionBelow(s);if(!e.dirty&&(s=e,null==(e=Sweep.regionAbove(e))||!e.dirty))return;if(e.dirty=!1,i=e.eUp,r=s.eUp,i.Dst!==r.Dst&&Sweep.checkForLeftSplice(t,e)&&(s.fixUpperEdge?(Sweep.deleteRegion(t,s),t.mesh.delete(r),r=(s=Sweep.regionBelow(e)).eUp):e.fixUpperEdge&&(Sweep.deleteRegion(t,e),t.mesh.delete(i),i=(e=Sweep.regionAbove(s)).eUp)),i.Org!==r.Org)if(i.Dst===r.Dst||e.fixUpperEdge||s.fixUpperEdge||i.Dst!==t.event&&r.Dst!==t.event)Sweep.checkForRightSplice(t,e);else if(Sweep.checkForIntersect(t,e))return;i.Org===r.Org&&i.Dst===r.Dst&&(Sweep.addWinding(r,i),Sweep.deleteRegion(t,e),t.mesh.delete(i),e=Sweep.regionAbove(s))}},Sweep.connectRightVertex=function(t,e,i){var r,s=i.Onext,o=Sweep.regionBelow(e),n=e.eUp,a=o.eUp,h=!1;n.Dst!==a.Dst&&Sweep.checkForIntersect(t,e),Geom.vertEq(n.Org,t.event)&&(t.mesh.splice(s.Oprev,n),e=Sweep.topLeftRegion(t,e),s=Sweep.regionBelow(e).eUp,Sweep.finishLeftRegions(t,Sweep.regionBelow(e),o),h=!0),Geom.vertEq(a.Org,t.event)&&(t.mesh.splice(i,a.Oprev),i=Sweep.finishLeftRegions(t,o,null),h=!0),h?Sweep.addRightEdges(t,e,i.Onext,s,s,!0):(r=Geom.vertLeq(a.Org,n.Org)?a.Oprev:n,r=t.mesh.connect(i.Lprev,r),Sweep.addRightEdges(t,e,r,r.Onext,r.Onext,!1),r.Sym.activeRegion.fixUpperEdge=!0,Sweep.walkDirtyRegions(t,e))},Sweep.connectLeftDegenerate=function(t,e,i){var r,s,o,n,a;return r=e.eUp,Geom.vertEq(r.Org,i)?(assert(!1),void Sweep.spliceMergeVertices(t,r,i.anEdge)):Geom.vertEq(r.Dst,i)?(assert(!1),e=Sweep.topRightRegion(e),s=n=(o=(a=Sweep.regionBelow(e)).eUp.Sym).Onext,a.fixUpperEdge&&(assert(s!==o),Sweep.deleteRegion(t,a),t.mesh.delete(o),o=s.Oprev),t.mesh.splice(i.anEdge,o),Geom.edgeGoesLeft(s)||(s=null),void Sweep.addRightEdges(t,e,o.Onext,n,s,!0)):(t.mesh.splitEdge(r.Sym),e.fixUpperEdge&&(t.mesh.delete(r.Onext),e.fixUpperEdge=!1),t.mesh.splice(i.anEdge,r),void Sweep.sweepEvent(t,i))},Sweep.connectLeftVertex=function(t,e){var i,r,s,o,n,a,h=new ActiveRegion;h.eUp=e.anEdge.Sym,i=t.dict.search(h).key,(r=Sweep.regionBelow(i))&&(o=i.eUp,n=r.eUp,0!==Geom.edgeSign(o.Dst,e,o.Org)?(s=Geom.vertLeq(n.Dst,o.Dst)?i:r,i.inside||s.fixUpperEdge?(a=s===i?t.mesh.connect(e.anEdge.Sym,o.Lnext):t.mesh.connect(n.Dnext,e.anEdge).Sym,s.fixUpperEdge?Sweep.fixUpperEdge(t,s,a):Sweep.computeWinding(t,Sweep.addRegionBelow(t,i,a)),Sweep.sweepEvent(t,e)):Sweep.addRightEdges(t,i,e.anEdge,e.anEdge,null,!0)):Sweep.connectLeftDegenerate(t,i,e))},Sweep.sweepEvent=function(t,e){t.event=e,Sweep.debugEvent(t);for(var i=e.anEdge;null===i.activeRegion;)if((i=i.Onext)==e.anEdge)return void Sweep.connectLeftVertex(t,e);var r=Sweep.topLeftRegion(t,i.activeRegion);assert(null!==r);var s=Sweep.regionBelow(r),o=s.eUp,n=Sweep.finishLeftRegions(t,s,null);n.Onext===o?Sweep.connectRightVertex(t,r,n):Sweep.addRightEdges(t,r,n.Onext,o,o,!0)},Sweep.addSentinel=function(t,e,i,r){var s=new ActiveRegion,o=t.mesh.makeEdge();o.Org.s=i,o.Org.t=r,o.Dst.s=e,o.Dst.t=r,t.event=o.Dst,s.eUp=o,s.windingNumber=0,s.inside=!1,s.fixUpperEdge=!1,s.sentinel=!0,s.dirty=!1,s.nodeUp=t.dict.insert(s)},Sweep.initEdgeDict=function(t){t.dict=new Dict(t,Sweep.edgeLeq);var e=t.bmax[0]-t.bmin[0],i=t.bmax[1]-t.bmin[1],r=t.bmin[0]-e,s=t.bmax[0]+e,o=t.bmin[1]-i,n=t.bmax[1]+i;Sweep.addSentinel(t,r,s,o),Sweep.addSentinel(t,r,s,n)},Sweep.doneEdgeDict=function(t){for(var e,i=0;null!==(e=t.dict.min().key);)e.sentinel||(assert(e.fixUpperEdge),assert(1==++i)),assert(0==e.windingNumber),Sweep.deleteRegion(t,e)},Sweep.removeDegenerateEdges=function(t){var e,i,r,s=t.mesh.eHead;for(e=s.next;e!==s;e=i)i=e.next,r=e.Lnext,Geom.vertEq(e.Org,e.Dst)&&e.Lnext.Lnext!==e&&(Sweep.spliceMergeVertices(t,r,e),t.mesh.delete(e),r=(e=r).Lnext),r.Lnext===e&&(r!==e&&(r!==i&&r!==i.Sym||(i=i.next),t.mesh.delete(r)),e!==i&&e!==i.Sym||(i=i.next),t.mesh.delete(e))},Sweep.initPriorityQ=function(t){var e,i,r,s=0;for(i=(r=t.mesh.vHead).next;i!==r;i=i.next)s++;for(s+=8,e=t.pq=new PriorityQ(s,Geom.vertLeq),i=(r=t.mesh.vHead).next;i!==r;i=i.next)i.pqHandle=e.insert(i);return i===r&&(e.init(),!0)},Sweep.donePriorityQ=function(t){t.pq=null},Sweep.removeDegenerateFaces=function(t,e){var i,r,s;for(i=e.fHead.next;i!==e.fHead;i=r)r=i.next,s=i.anEdge,assert(s.Lnext!==s),s.Lnext.Lnext===s&&(Sweep.addWinding(s.Onext,s),t.mesh.delete(s));return!0},Sweep.computeInterior=function(t){var e,i;if(Sweep.removeDegenerateEdges(t),!Sweep.initPriorityQ(t))return!1;for(Sweep.initEdgeDict(t);null!==(e=t.pq.extractMin());){for(;null!==(i=t.pq.min())&&Geom.vertEq(i,e);)i=t.pq.extractMin(),Sweep.spliceMergeVertices(t,e.anEdge,i.anEdge);Sweep.sweepEvent(t,e)}return t.event=t.dict.min().key.eUp.Org,Sweep.debugEvent(t),Sweep.doneEdgeDict(t),Sweep.donePriorityQ(t),!!Sweep.removeDegenerateFaces(t,t.mesh)&&(t.mesh.check(),!0)},Tesselator.prototype={dot_:function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},normalize_:function(t){var e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2];assert(e>0),e=Math.sqrt(e),t[0]/=e,t[1]/=e,t[2]/=e},longAxis_:function(t){var e=0;return Math.abs(t[1])>Math.abs(t[0])&&(e=1),Math.abs(t[2])>Math.abs(t[e])&&(e=2),e},computeNormal_:function(t){var e,i,r,s,o,n,a,h=[0,0,0],u=[0,0,0],l=[0,0,0],c=[0,0,0],d=[0,0,0],g=[null,null,null],p=[null,null,null],M=this.mesh.vHead;for(e=M.next,a=0;a<3;++a)s=e.coords[a],u[a]=s,p[a]=e,h[a]=s,g[a]=e;for(e=M.next;e!==M;e=e.next)for(a=0;a<3;++a)(s=e.coords[a])<u[a]&&(u[a]=s,p[a]=e),s>h[a]&&(h[a]=s,g[a]=e);if(a=0,h[1]-u[1]>h[0]-u[0]&&(a=1),h[2]-u[2]>h[a]-u[a]&&(a=2),u[a]>=h[a])return t[0]=0,t[1]=0,void(t[2]=1);for(n=0,i=p[a],r=g[a],l[0]=i.coords[0]-r.coords[0],l[1]=i.coords[1]-r.coords[1],l[2]=i.coords[2]-r.coords[2],e=M.next;e!==M;e=e.next)c[0]=e.coords[0]-r.coords[0],c[1]=e.coords[1]-r.coords[1],c[2]=e.coords[2]-r.coords[2],d[0]=l[1]*c[2]-l[2]*c[1],d[1]=l[2]*c[0]-l[0]*c[2],d[2]=l[0]*c[1]-l[1]*c[0],(o=d[0]*d[0]+d[1]*d[1]+d[2]*d[2])>n&&(n=o,t[0]=d[0],t[1]=d[1],t[2]=d[2]);n<=0&&(t[0]=t[1]=t[2]=0,t[this.longAxis_(l)]=1)},checkOrientation_:function(){var t,e,i,r,s=this.mesh.fHead,o=this.mesh.vHead;for(t=0,e=s.next;e!==s;e=e.next)if(!((r=e.anEdge).winding<=0))do{t+=(r.Org.s-r.Dst.s)*(r.Org.t+r.Dst.t),r=r.Lnext}while(r!==e.anEdge);if(t<0){for(i=o.next;i!==o;i=i.next)i.t=-i.t;this.tUnit[0]=-this.tUnit[0],this.tUnit[1]=-this.tUnit[1],this.tUnit[2]=-this.tUnit[2]}},projectPolygon_:function(){var t,e,i,r,s,o=this.mesh.vHead,n=[0,0,0],a=!1;for(n[0]=this.normal[0],n[1]=this.normal[1],n[2]=this.normal[2],0===n[0]&&0===n[1]&&0===n[2]&&(this.computeNormal_(n),a=!0),e=this.sUnit,i=this.tUnit,e[r=this.longAxis_(n)]=0,e[(r+1)%3]=1,e[(r+2)%3]=0,i[r]=0,i[(r+1)%3]=0,i[(r+2)%3]=n[r]>0?1:-1,t=o.next;t!==o;t=t.next)t.s=this.dot_(t.coords,e),t.t=this.dot_(t.coords,i);for(a&&this.checkOrientation_(),s=!0,t=o.next;t!==o;t=t.next)s?(this.bmin[0]=this.bmax[0]=t.s,this.bmin[1]=this.bmax[1]=t.t,s=!1):(t.s<this.bmin[0]&&(this.bmin[0]=t.s),t.s>this.bmax[0]&&(this.bmax[0]=t.s),t.t<this.bmin[1]&&(this.bmin[1]=t.t),t.t>this.bmax[1]&&(this.bmax[1]=t.t))},addWinding_:function(t,e){t.winding+=e.winding,t.Sym.winding+=e.Sym.winding},tessellateMonoRegion_:function(t,e){var i,r;for(i=e.anEdge,assert(i.Lnext!==i&&i.Lnext.Lnext!==i);Geom.vertLeq(i.Dst,i.Org);i=i.Lprev);for(;Geom.vertLeq(i.Org,i.Dst);i=i.Lnext);for(r=i.Lprev;i.Lnext!==r;)if(Geom.vertLeq(i.Dst,r.Org)){for(;r.Lnext!==i&&(Geom.edgeGoesLeft(r.Lnext)||Geom.edgeSign(r.Org,r.Dst,r.Lnext.Dst)<=0);)r=(s=t.connect(r.Lnext,r)).Sym;r=r.Lprev}else{for(;r.Lnext!=i&&(Geom.edgeGoesRight(i.Lprev)||Geom.edgeSign(i.Dst,i.Org,i.Lprev.Org)>=0);)i=(s=t.connect(i,i.Lprev)).Sym;i=i.Lnext}for(assert(r.Lnext!==i);r.Lnext.Lnext!==i;){var s=t.connect(r.Lnext,r);r=s.Sym}return!0},tessellateInterior_:function(t){var e,i;for(e=t.fHead.next;e!==t.fHead;e=i)if(i=e.next,e.inside&&!this.tessellateMonoRegion_(t,e))return!1;return!0},discardExterior_:function(t){var e,i;for(e=t.fHead.next;e!==t.fHead;e=i)i=e.next,e.inside||t.zapFace(e)},setWindingNumber_:function(t,e,i){var r,s;for(r=t.eHead.next;r!==t.eHead;r=s)s=r.next,r.Rface.inside!==r.Lface.inside?r.winding=r.Lface.inside?e:-e:i?t.delete(r):r.winding=0},getNeighbourFace_:function(t){return t.Rface&&t.Rface.inside?t.Rface.n:-1},outputPolymesh_:function(t,e,i,r){var s,o,n,a,h,u=0,l=0;for(i>3&&t.mergeConvexFaces(i),s=t.vHead.next;s!==t.vHead;s=s.next)s.n=-1;for(o=t.fHead.next;o!=t.fHead;o=o.next)if(o.n=-1,o.inside){n=o.anEdge,a=0;do{-1===(s=n.Org).n&&(s.n=l,l++),a++,n=n.Lnext}while(n!==o.anEdge);assert(a<=i),o.n=u,++u}for(this.elementCount=u,e==Tess2.CONNECTED_POLYGONS&&(u*=2),this.elements=[],this.elements.length=u*i,this.vertexCount=l,this.vertices=[],this.vertices.length=l*r,this.vertexIndices=[],this.vertexIndices.length=l,s=t.vHead.next;s!==t.vHead;s=s.next)if(-1!=s.n){var c=s.n*r;this.vertices[c+0]=s.coords[0],this.vertices[c+1]=s.coords[1],r>2&&(this.vertices[c+2]=s.coords[2]),this.vertexIndices[s.n]=s.idx}var d=0;for(o=t.fHead.next;o!==t.fHead;o=o.next)if(o.inside){n=o.anEdge,a=0;do{s=n.Org,this.elements[d++]=s.n,a++,n=n.Lnext}while(n!==o.anEdge);for(h=a;h<i;++h)this.elements[d++]=-1;if(e==Tess2.CONNECTED_POLYGONS){n=o.anEdge;do{this.elements[d++]=this.getNeighbourFace_(n),n=n.Lnext}while(n!==o.anEdge);for(h=a;h<i;++h)this.elements[d++]=-1}}},outputContours_:function(t,e){var i,r,s,o=0,n=0;for(this.vertexCount=0,this.elementCount=0,i=t.fHead.next;i!==t.fHead;i=i.next)if(i.inside){s=r=i.anEdge;do{this.vertexCount++,r=r.Lnext}while(r!==s);this.elementCount++}this.elements=[],this.elements.length=2*this.elementCount,this.vertices=[],this.vertices.length=this.vertexCount*e,this.vertexIndices=[],this.vertexIndices.length=this.vertexCount;var a=0,h=0,u=0;for(o=0,i=t.fHead.next;i!==t.fHead;i=i.next)if(i.inside){n=0,s=r=i.anEdge;do{this.vertices[a++]=r.Org.coords[0],this.vertices[a++]=r.Org.coords[1],e>2&&(this.vertices[a++]=r.Org.coords[2]),this.vertexIndices[h++]=r.Org.idx,n++,r=r.Lnext}while(r!==s);this.elements[u++]=o,this.elements[u++]=n,o+=n}},addContour:function(t,e){var i,r;for(null===this.mesh&&(this.mesh=new TESSmesh),t<2&&(t=2),t>3&&(t=3),i=null,r=0;r<e.length;r+=t)null==i?(i=this.mesh.makeEdge(),this.mesh.splice(i,i.Sym)):(this.mesh.splitEdge(i),i=i.Lnext),i.Org.coords[0]=e[r+0],i.Org.coords[1]=e[r+1],i.Org.coords[2]=t>2?e[r+2]:0,i.Org.idx=this.vertexIndexCounter++,i.winding=1,i.Sym.winding=-1},tesselate:function(t,e,i,r,s){if(this.vertices=[],this.elements=[],this.vertexIndices=[],this.vertexIndexCounter=0,s&&(this.normal[0]=s[0],this.normal[1]=s[1],this.normal[2]=s[2]),this.windingRule=t,r<2&&(r=2),r>3&&(r=3),!this.mesh)return!1;this.projectPolygon_(),Sweep.computeInterior(this);var o=this.mesh;return e==Tess2.BOUNDARY_CONTOURS?this.setWindingNumber_(o,1,!0):this.tessellateInterior_(o),o.check(),e==Tess2.BOUNDARY_CONTOURS?this.outputContours_(o,r):this.outputPolymesh_(o,e,i,r),!0}},YFM.WebGL=function(){var t=function(t){return'<table style="background-color: #8CE; width: 100%; height: 100%;"><tr><td align="center"><div style="display: table-cell; vertical-align: middle;"><div style="">'+t+"</div></div></td></tr></table>"},e=function(t,e){for(var i=["webgl","experimental-webgl","webkit-3d","moz-webgl"],r=null,s=0;s<i.length;++s){try{r=t.getContext(i[s],e)}catch(t){}if(r)break}return r};return{create3DContext:e,setupWebGL:function(i,r){function s(e){var r=i.parentNode;r&&(r.innerHTML=t(e))}if(!window.WebGLRenderingContext)return s('This page requires a browser that supports WebGL.<br/><a href="http://get.webgl.org">Click here to upgrade your browser.</a>'),null;var o=e(i,r);return o||s('It doesn\'t appear your computer can support WebGL.<br/><a href="http://get.webgl.org/troubleshooting/">Click here for more information.</a>'),o},makeShader:function(t,e,i){var r,s;if(r=t.createShader(t.VERTEX_SHADER),t.shaderSource(r,e),t.compileShader(r),!t.getShaderParameter(r,t.COMPILE_STATUS))return n="Vertex shader failed to compile.  The error log is:<pre>"+t.getShaderInfoLog(r)+"</pre>",alert(n),-1;if(s=t.createShader(t.FRAGMENT_SHADER),t.shaderSource(s,i),t.compileShader(s),!t.getShaderParameter(s,t.COMPILE_STATUS))return n="Fragment shader failed to compile.  The error log is:<pre>"+t.getShaderInfoLog(s)+"</pre>",alert(n),-1;var o=t.createProgram();if(t.attachShader(o,r),t.attachShader(o,s),t.linkProgram(o),!t.getProgramParameter(o,t.LINK_STATUS)){var n="Shader program failed to link.  The error log is:<pre>"+t.getProgramInfoLog(o)+"</pre>";return alert(n),-1}return o}}}(),YFM.WebGL.Color=function(){var t=function(t){return((16711680&t)>>16)/255},e=function(t){return((65280&t)>>8)/255},i=function(t){return(255&t)/255},r=function(t){return((4278190080&t)>>>24)/255};return{hexColorRed:t,hexColorGreen:e,hexColorBlue:i,hexColorAlpha:r,randomHexRGB:function(){return 4278190080|Math.floor(255*Math.random())<<16|Math.floor(255*Math.random())<<8|Math.floor(255*Math.random())},getRGBVec:function(r){return YFM.Math.Vector.pos(t(r),e(r),i(r))},getRGBAVec:function(s){return YFM.Math.Vector.vec(t(s),e(s),i(s),r(s))}}}(),window.requestAnimFrame=function(t,e){window.setTimeout(t,1e3/30)},Floor.prototype={constructor:Floor,quadVBO:null,selectUnit:function(t,e,i){this.extrude.selectUnit(t,e,i)},cleanSelect:function(){this.extrude.cleanSelect()},getSize:function(){return this.loaded?this.mapSize:null},getAspect:function(){return{w:this.mapWidth,h:this.mapHeight}},isLoaded:function(){return this.loaded},setUnitHeight:function(t){this.unitHeight=t,this.quickPolygon.setHeight(t+1),this.texRect.setHeight(t+2.5),this.texRectSpec.setHeight(t+2.5),this.texRectUltra.setHeight(t+2.5)},setVOffset:function(t,e){var i=t*e;YFM.Math.Matrix.setTranslateZ(this.floorMat,i),this.penddingVOffset=null;var r=[];r.push(YFM.Math.Vector.pos(0,0,i)),r.push(YFM.Math.Vector.pos(this.mapWidth,0,i)),r.push(YFM.Math.Vector.pos(this.mapWidth,this.mapHeight,i)),r.push(YFM.Math.Vector.pos(0,this.mapHeight,i)),this.planePolygon=new PlanePolygon(r),this.icons=new FloorIcons(this.gl,this.region,this),this.iconPlus=new FloorIconPlus(this.gl,this.region,this),this.quadTree=new FloorQuadTree(this,100),this.models=new FloorModels(this.gl,this.region,this,t/3),this.vOffset=i},addTrajectory:function(t){this.trajectory.addTrajectory(t)},cleanTrajectory:function(){this.trajectory.cleanTrajectory()},insertUnit:function(t){for(var e,i,r=YFM.Math.Vector,s=[],o=0,n=t.pts.length;o<n;o++)e=t.pts[o][0],i=this.mapHeight-t.pts[o][1],s.push(r.pos(e,i,0)),s.push(r.pos(e,i,this.unitHeight));var a=new OBB(s),h=r.pos(a.center[0],this.mapHeight-a.center[1],a.center[2]);a.transform(this.floorMat),a.adj_center=r.pos(a.center[0],a.center[1],a.center[2]+.5*this.unitHeight),this.quadTree.insertObjectOBBCenter(t,a,h)},insertIcon:function(t,e,i){this.icons.insertIcon(t,e,i,2)},insertIconPlus:function(t,e,i){this.iconPlus.insertIcon(t,e,i,2)},insertModel:function(t,e,i,r,s,o){return t.setFloor(this),t.setModelMatrix(YFM.Math.Matrix.postTranslate(YFM.Math.Matrix.postRotate3d(YFM.Math.Matrix.postRotate3d(YFM.Math.Matrix.scale(i,0,0,0),90,1,0,0),e,0,0,1),r,this.mapHeight-s,o)),this.models.insertModel(t)},removeModel:function(t){return this.models.removeModel(t)},searchModel:function(t,e){return null!=this.models?this.models.rayCheck(t,e):[]},searchUnit:function(t,e){return null!=this.quadTree?this.quadTree.rayCheckOBB(t,e):[]},searchIcon:function(t,e,i){return null!=this.icons?this.icons.rayCheck(t,e,i):[]},searchIconPlus:function(t,e){return null!=this.iconPlus?this.iconPlus.rayCheck(t,e):[]},intersectionLine:function(t){return null==this.planePolygon?1024:this.planePolygon.intersectionLine(t,this.floorMat)},floorPos2Region:function(t,e){var i;return i=YFM.Math.Vector.pos(t,this.mapHeight-e,0),YFM.Math.Matrix.mulVec(this.floorMat,i)},getFloorMat:function(){return this.floorMat},frustumCheck:function(t){return null==this.quadTree?-1:this.quadTree.frustumCheck(t)},setObjectColor:function(t,e,i){var r=this.groupMap[t];if(r&&e>=0&&e<r.objarray.length)if(0===r.type&&r.colorVBO){for(var s=this.gl,o=r.objarray[e],n=YFM.WebGL.Color.getRGBAVec(i),a=[],h=0;h<o.len;h++)a.push(n);s.bindBuffer(s.ARRAY_BUFFER,r.colorVBO),s.bufferSubData(s.ARRAY_BUFFER,4*o.start*4,YFM.Math.flatten(a,4)),s.bindBuffer(s.ARRAY_BUFFER,null),o.setted=!0}else if(1===r.type){o=r.objarray[e];this.extrude.setObjectColor(o.top_start,o.top_len,o.side_start,o.side_len,i),o.setted=!0}},resetObjectColor:function(t,e){var i=this.groupMap[t];if(i&&e>=0&&e<i.objarray.length)if(0===i.type&&i.colorVBO){for(var r=this.gl,s=i.objarray[e],o=[],n=0;n<s.len;n++)o.push(s.color);r.bindBuffer(r.ARRAY_BUFFER,i.colorVBO),r.bufferSubData(r.ARRAY_BUFFER,4*s.start*4,YFM.Math.flatten(o,4)),r.bindBuffer(r.ARRAY_BUFFER,null),s.setted=!1}else if(1===i.type){s=i.objarray[e];this.extrude.setObjectColor(s.top_start,s.top_len,s.side_start,s.side_len,s.color),s.setted=!1}},resetObjectColorAll:function(t){var e=this.groupMap[t];if(e)if(0===e.type&&e.colorVBO)for(var i=this.gl,r=0,s=e.objarray.length;r<s;r++){for(var o=e.objarray[r],n=[],a=0;a<o.len;a++)n.push(o.color);i.bindBuffer(i.ARRAY_BUFFER,e.colorVBO),i.bufferSubData(i.ARRAY_BUFFER,4*o.start*4,YFM.Math.flatten(n,4)),i.bindBuffer(i.ARRAY_BUFFER,null),o.setted=!1}else if(1===e.type)for(var r=0,s=e.objarray.length;r<s;r++){o=e.objarray[r];this.extrude.setObjectColor(o.top_start,o.top_len,o.side_start,o.side_len,o.color),o.setted=!1}},renderBase:function(t,e,i){if(this.loaded){t.setMapHeight(this.mapHeight),t.setFloorMatrix(this.floorMat),t.setModelMatrix(YFM.Math.Matrix.mat()),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.ALWAYS);var r,s,o,n,a,h;for(r=0,s=this.groupList.length;r<s;r++)if(o=this.groupList[r],(i||SVGParser.prototype.GROUP_TYPE_ICON!==o.type)&&(t.setColorFlag(1),o.trianglesVBO&&o.trianglesSize>0&&t.drawTrianglesPlus(o.trianglesVBO,o.colorVBO,o.trianglesSize),o.imgList))for(t.setColorFlag(0),n=0,a=o.imgList.length;n<a;n++)null!==(h=this.region.getTexture(o.imgList[n].texName))&&(t.bindTexture(h.tex),t.drawTriangles(o.imgList[n].quad,6));this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.BLEND)}},renderExtrude:function(t,e){this.loaded&&(t.setMapHeight(this.mapHeight),t.setFloorMatrix(this.floorMat),this.extrude.render(t,e),this.boundary.render(t),this.quickPolygon.render(t))},renderModels:function(t,e,i,r){this.models.renderModels(t,e,i,r)},renderIcons:function(t,e){this.icons.renderIcons(t,e),this.iconPlus.renderIcons(t,e)},renderMarkers:function(t,e,i,r,s){this.markers.render(t,e,i,r,s)},renderTextureRect:function(t){this.texRect.render(t),this.texRectSpec.render(t),this.texRectUltra.render(t)},renderUnit:function(t,e){if(this.loaded){if(this.dummyShader=e,this.gl.depthMask(!1),this.region.drawAllUnit)this.quadTree.render(t,this._renderUnit,this,1024);else{var i=this.quadTree.getContainLevel(t);this.quadTree.render(t,this._renderUnit,this,i)}this.gl.depthMask(!0)}},renderTrajectory:function(){this.trajectory.render()},_renderUnit:function(t,e){var i;i=t.pos.isOBB?e.region.regionPos2Screen(t.pos.adj_center):e.region.regionPos2Screen(t.pos);var r,s,o,n;if(!t.obj.block){l=e.region.ctx2d.measureText(t.obj.text);t.obj.block={hw:(l.width+4)/2,hh:e.region.fontHeight/2}}var a=0;if(t.obj.icon){var h=e.region.getTexture(t.obj.icon);null!==h&&(t.obj.tex={tex:h,texSize:YFM.Math.Vector.vec(h.w/2,h.h/2)},delete t.obj.icon)}if(t.obj.tex&&(a=t.obj.tex.tex.w/2),r=i[0]-t.obj.block.hw-a,s=i[1]-t.obj.block.hh,o=i[0]+t.obj.block.hw,n=i[1]+t.obj.block.hh,!e.region.tqct.check(r,s,o,n)&&(e.region._drawText(t.obj.text,i[0],i[1]),t.obj.tex)){var u;u=t.pos.isOBB?e.region.regionPos2ScreenGL(t.pos.center):e.region.regionPos2ScreenGL(t.pos);var l=YFM.Math.Matrix.scaleXYZ(t.obj.tex.texSize,0,0,0);YFM.Math.Matrix.postTranslate(l,u[0],u[1],0);u[0]-=t.obj.block.hw+a-8;var c=YFM.Math.Matrix.postRotateXY(YFM.Math.Matrix.postTranslate(YFM.Math.Matrix.scaleXYZ(t.obj.tex.texSize,0,0,0),u[0],u[1],0),e.region.camera.getRoll(),u[0],u[1]);e.dummyShader.setModelMatrix(c),e.dummyShader.bindTexture(t.obj.tex.tex.tex),e.dummyShader.drawTriangles(Floor.prototype.quadVBO,6,0)}},_load_svg:function(t){var e=this.gl,i=(new DOMParser).parseFromString(t,"image/svg+xml"),r=new SVGParser(this,this.region,this.extrude,this.boundary);this.groupList=[],this.groupMap={};var s=r.readSVG(i.documentElement,this.groupList);this.mapWidth=s.width,this.mapHeight=s.height,this.mapSize=Math.sqrt(this.mapWidth*this.mapWidth,this.mapHeight*this.mapHeight);var o,n,a;for(n=0,a=this.groupList.length;n<a;n++)o=this.groupList[n],this.groupMap[o.id]=o,o.trianglesSize=o.varray.length,o.trianglesSize>0&&(o.trianglesVBO=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,o.trianglesVBO),e.bufferData(e.ARRAY_BUFFER,YFM.Math.flatten(o.varray,4),e.STATIC_DRAW),o.colorVBO=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,o.colorVBO),e.bufferData(e.ARRAY_BUFFER,YFM.Math.flatten(o.carray,4),e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,null)),delete o.varray,delete o.carray;this.floorMat=YFM.Math.Matrix.translate(-this.mapWidth/2,-this.mapHeight/2,0),this.floorMat=YFM.Math.Matrix.postRotate3d(this.floorMat,-this.deflection,0,0,1),this.extrude.buildExtrude(),this.boundary.buildExtrude(),this.loaded=!0},_initQuad:function(t){var e=[],i=[],r=[];r.push(YFM.Math.Vector.vec(0,1)),r.push(YFM.Math.Vector.vec(1,1)),r.push(YFM.Math.Vector.vec(1,0)),r.push(YFM.Math.Vector.vec(0,0)),i.push(YFM.Math.Vector.pos(-1,-1,0)),i.push(YFM.Math.Vector.pos(1,-1,0)),i.push(YFM.Math.Vector.pos(1,1,0)),i.push(YFM.Math.Vector.pos(-1,1,0)),e.push(i[0]),e.push(r[0]),e.push(i[1]),e.push(r[1]),e.push(i[2]),e.push(r[2]),e.push(i[0]),e.push(r[0]),e.push(i[2]),e.push(r[2]),e.push(i[3]),e.push(r[3]),Floor.prototype.quadVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,Floor.prototype.quadVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(e,3),t.STATIC_DRAW)}},FloorBoundary.prototype={constructor:FloorBoundary,render:function(t){this.loaded&&null!=this.boundarySideVBO&&(this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL),t.setLighting(1),t.setHeightScale(1),t.drawTriangles(this.boundarySideVBO,this.boundarySideCBO,this.boundarySideSize),this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.BLEND))},addExtrude:function(t,e,i){var r,s,o,n,a,h,u;for(n=0,o=t.length;n<o;n++){for(s=(r=t[n]).length,a=0;a<s-1;a++)h=r[a],u=r[a+1],this._putSideQuad(u,h,i);h=r[a],u=r[0],this._putSideQuad(u,h,i)}},buildExtrude:function(){this.boundarySideSize=this.boundarySideVarray.length/2,0!==this.boundarySideSize?(this.boundarySideVBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.boundarySideVBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(this.boundarySideVarray,4),this.gl.STATIC_DRAW),this.boundarySideCBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.boundarySideCBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(this.boundarySideCarray,4),this.gl.STATIC_DRAW),this.boundarySideVarray=[],this.boundarySideCarray=[],this.loaded=!0):this.loaded=!1},_putSideQuad:function(t,e,i){var r,s,o,n,a,h=[],u=[];r=YFM.Math.Vector.pos(t[0],t[1],t[2]),s=YFM.Math.Vector.pos(e[0],e[1],e[2]),o=YFM.Math.Vector.pos(e[0],e[1],e[2]-this.height),n=YFM.Math.Vector.pos(t[0],t[1],t[2]-this.height),h.push(r),h.push(o),h.push(s),u.push(r),u.push(n),u.push(o),a=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(YFM.Math.Vector.sub(s,r),YFM.Math.Vector.sub(o,s))),this.boundarySideVarray.push(h[0]),this.boundarySideVarray.push(a),this.boundarySideVarray.push(h[1]),this.boundarySideVarray.push(a),this.boundarySideVarray.push(h[2]),this.boundarySideVarray.push(a),this.boundarySideVarray.push(u[0]),this.boundarySideVarray.push(a),this.boundarySideVarray.push(u[1]),this.boundarySideVarray.push(a),this.boundarySideVarray.push(u[2]),this.boundarySideVarray.push(a),this.boundarySideCarray.push(i),this.boundarySideCarray.push(i),this.boundarySideCarray.push(i),this.boundarySideCarray.push(i),this.boundarySideCarray.push(i),this.boundarySideCarray.push(i)}},FloorExtrude.prototype={constructor:FloorExtrude,setHeight:function(t){this.height=t},setObjectColor:function(t,e,i,r,s){var o,n,a=this.gl,h=[];for(n=s instanceof Array?s:YFM.WebGL.Color.getRGBAVec(s),o=0;o<e;o++)h.push(n);for(a.bindBuffer(a.ARRAY_BUFFER,this.extrudeTopCBO),a.bufferSubData(a.ARRAY_BUFFER,4*t*4,YFM.Math.flatten(h,4)),h=[],o=0;o<r;o++)h.push(n);a.bindBuffer(a.ARRAY_BUFFER,this.extrudeSideCBO),a.bufferSubData(a.ARRAY_BUFFER,4*i*4,YFM.Math.flatten(h,4)),a.bindBuffer(a.ARRAY_BUFFER,null)},render:function(t,e){this.loaded&&(null!=this.extrudeTopVBO&&(this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL),t.setLighting(1),t.setHeightScale(1),null!=this.extrudeSideVBO&&t.drawTriangles(this.extrudeSideVBO,this.extrudeSideCBO,this.extrudeSideSize),t.setLighting(0),t.drawTriangles(this.extrudeTopVBO,this.extrudeTopCBO,this.extrudeTopSize),this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.BLEND)),null!=this.borderVBO&&0!==this.borderSize&&(this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL),this.gl.lineWidth(2),t.drawLines(this.borderVBO,this.borderSize),this.gl.lineWidth(1),this.gl.disable(this.gl.DEPTH_TEST)))},addBorder:function(t,e,i){t[2]+=this.height,e[2]+=this.height,this.borderVarray.push(t),this.borderVarray.push(i),this.borderVarray.push(this.borderNormal),this.borderVarray.push(e),this.borderVarray.push(i),this.borderVarray.push(this.borderNormal)},addExtrude:function(t,e,i){var r,s,o,n,a,h,u,l,c,d,g=e.length/3,p=YFM.Math.Vector.vec(0,0,1),M={top_start:0,top_len:0,side_start:0,side_len:0};for(M.top_start=this.extrudeTopCarray.length,M.top_len=3*g,n=0;n<g;n++)l=e[3*n+0],c=e[3*n+1],d=e[3*n+2],this.extrudeTopVarray.push(YFM.Math.Vector.pos(l[0],l[1],l[2]+this.height)),this.extrudeTopVarray.push(p),this.extrudeTopVarray.push(YFM.Math.Vector.pos(d[0],d[1],d[2]+this.height)),this.extrudeTopVarray.push(p),this.extrudeTopVarray.push(YFM.Math.Vector.pos(c[0],c[1],c[2]+this.height)),this.extrudeTopVarray.push(p),this.extrudeTopCarray.push(i),this.extrudeTopCarray.push(i),this.extrudeTopCarray.push(i);for(M.side_start=this.extrudeSideCarray.length,M.side_len=0,n=0,o=t.length;n<o;n++){for(s=(r=t[n]).length,a=0;a<s-1;a++)h=r[a],u=r[a+1],this._putSideQuad(u,h,i),M.side_len+=6;h=r[a],u=r[0],this._putSideQuad(u,h,i),M.side_len+=6}return M},buildExtrude:function(){this.extrudeTopVBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.extrudeTopVBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(this.extrudeTopVarray,4),this.gl.STATIC_DRAW),this.extrudeTopSize=this.extrudeTopVarray.length/2,this.extrudeTopVarray=[],this.extrudeTopCBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.extrudeTopCBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(this.extrudeTopCarray,4),this.gl.STATIC_DRAW),this.extrudeTopCarray=[],this.extrudeSideVBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.extrudeSideVBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(this.extrudeSideVarray,4),this.gl.STATIC_DRAW),this.extrudeSideSize=this.extrudeSideVarray.length/2,this.extrudeSideVarray=[],this.extrudeSideCBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.extrudeSideCBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(this.extrudeSideCarray,4),this.gl.STATIC_DRAW),this.extrudeSideCarray=[],this.borderVBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.borderVBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(this.borderVarray,3),this.gl.STATIC_DRAW),this.borderSize=this.borderVarray.length/3,this.borderVarray=[],0!==this.extrudeTopSize||0!==this.extrudeSideSize||0!==this.borderSize?this.loaded=!0:this.loaded=!1},_clock_wise_tri:function(t){var e=0;return e+=(t[1][0]-t[0][0])*(t[1][1]+t[0][1]),e+=(t[2][0]-t[1][0])*(t[2][1]+t[1][1]),(e+=(t[0][0]-t[2][0])*(t[0][1]+t[2][1]))>0},_clock_wise_pts:function(t){for(var e=0,i=t.length,r=0;r<i;r++)e+=(t[(r+1)%i][0]-t[r][0])*(t[(r+1)%i][1]+t[r][1]);return e>0},_putSideQuad:function(t,e,i){var r,s,o,n,a,h=[],u=[];r=YFM.Math.Vector.pos(t[0],t[1],t[2]),s=YFM.Math.Vector.pos(e[0],e[1],e[2]),o=YFM.Math.Vector.pos(e[0],e[1],e[2]+this.height),n=YFM.Math.Vector.pos(t[0],t[1],t[2]+this.height),h.push(r),h.push(o),h.push(s),u.push(r),u.push(n),u.push(o),a=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(YFM.Math.Vector.sub(s,r),YFM.Math.Vector.sub(o,s))),this.extrudeSideVarray.push(h[0]),this.extrudeSideVarray.push(a),this.extrudeSideVarray.push(h[1]),this.extrudeSideVarray.push(a),this.extrudeSideVarray.push(h[2]),this.extrudeSideVarray.push(a),this.extrudeSideVarray.push(u[0]),this.extrudeSideVarray.push(a),this.extrudeSideVarray.push(u[1]),this.extrudeSideVarray.push(a),this.extrudeSideVarray.push(u[2]),this.extrudeSideVarray.push(a),this.extrudeSideCarray.push(i),this.extrudeSideCarray.push(i),this.extrudeSideCarray.push(i),this.extrudeSideCarray.push(i),this.extrudeSideCarray.push(i),this.extrudeSideCarray.push(i)}},FloorIconPlus.prototype={constructor:FloorIconPlus,insertIcon:function(t,e,i,r){this.quadTree.insertObject(t,this.floor.index,e,i,r)},rayCheck:function(t,e){return this.quadTree.rayCheck(t,0,e)},renderIcons:function(t,e){this.shader=e,this.quadTree.render(t,this._renderIcon,this,1024)},_renderIcon:function(t,e){var i=e.region.getTexture(t.obj.tex);if(i){if(e.shader.bindTexture(i.tex),!t.quadVBO){var r=t.obj.rate||1,s=i.w/2,o=i.h/2;t.quadVBO=e._makeVBO(r*s,r*o),t.radiusSQ=s*s+o*o}e.shader.setModelMatrix(YFM.Math.Matrix.translate(t.pos[0],t.pos[1],t.pos[2])),e.shader.drawTriangles(t.quadVBO,6,0)}},_makeVBO:function(t,e){var i=[];i.push(YFM.Math.Vector.pos(-e,-t,0)),i.push(YFM.Math.Vector.pos(e,-t,0)),i.push(YFM.Math.Vector.pos(e,t,0)),i.push(YFM.Math.Vector.pos(-e,t,0));var r=[];r.push(YFM.Math.Vector.vec(0,0)),r.push(YFM.Math.Vector.vec(0,1)),r.push(YFM.Math.Vector.vec(1,1)),r.push(YFM.Math.Vector.vec(1,0));var s=[];s.push(i[0]),s.push(r[0]),s.push(i[1]),s.push(r[1]),s.push(i[2]),s.push(r[2]),s.push(i[0]),s.push(r[0]),s.push(i[2]),s.push(r[2]),s.push(i[3]),s.push(r[3]);var o=this.gl.createBuffer();return this.gl.bindBuffer(this.gl.ARRAY_BUFFER,o),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(s,3),this.gl.STATIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null),o}},FloorIcons.prototype={constructor:FloorIcons,insertIcon:function(t,e,i,r){this.quadTree.insertObject(t,this.floor.index,e,i,r)},rayCheck:function(t,e,i){return this.quadTree.rayCheck(t,e,i)},renderIcons:function(t,e){if(this.shader=e,null===this.iconTex){var i=this.region.getTexture("pubIcons");null!=i&&(this.iconTex=i.tex)}null!==this.iconTex&&(this.shader.bindTexture(this.iconTex),this.quadTree.render(t,this._renderIcon,this,1024))},_renderIcon:function(t,e){null!==e.iconTex&&(e.shader.setModelMatrix(YFM.Math.Matrix.translate(t.pos[0],t.pos[1],t.pos[2])),e.shader.drawTriangles(e.quadVBO,6,6*t.obj.type))},_calcTexCoords:function(t,e,i){var r,s;r=Math.floor((i-1)/8),s=(i-1)%8;var o=[];o.push(YFM.Math.Vector.pos(1/8*s,1/8*r)),o.push(YFM.Math.Vector.pos(1/8*s,1/8*(r+1))),o.push(YFM.Math.Vector.pos(1/8*(s+1),1/8*(r+1))),o.push(YFM.Math.Vector.pos(1/8*(s+1),1/8*r)),t.push(e[0]),t.push(o[0]),t.push(e[1]),t.push(o[1]),t.push(e[2]),t.push(o[2]),t.push(e[0]),t.push(o[0]),t.push(e[2]),t.push(o[2]),t.push(e[3]),t.push(o[3])}},FloorMarkers.prototype={constructor:FloorMarkers,cursor:0,shift:1e4,removeMarker:function(t){for(var e=null,i=!1,r=[],s=0;s<this.markerArray.length;s++)t===this.markerArray[s].id?(i=!0,e=this.markerArray[s]):r.push(this.markerArray[s]);return i&&(this.markerArray=r),e},insertMarker:function(t,e,i){var r=FloorMarkers.prototype.cursor*FloorMarkers.prototype.shift+this.floor.index,s=this.floor.floorPos2Region(e,i);return s[2]+=t.height,t.id=r,t.pos=s,this.markerArray.push(t),FloorMarkers.prototype.cursor++,r},insertTextureMarker:function(t,e,i,r,s,o){var n=this.floor.floorPos2Region(e,i);n[2]+=r;var a=FloorMarkers.prototype.cursor*FloorMarkers.prototype.shift+this.floor.index,h={type:1,id:a,texName:t,tex:null,texSize:YFM.Math.Vector.vec(10,10),envelop:YFM.Math.Vector.vec(0),pos:n,distSQ:0,height:r,offsetX:s,offsetY:o};return this.markerArray.push(h),FloorMarkers.prototype.cursor++,a},render:function(t,e,i,r,s){var o,n,a,h,u=this.markerIMinPQ.getSize();for(this.markerArray.length>u?this.markerIMinPQ.setSize(Math.floor(1.5*this.markerArray.length)):this.markerArray.length<u/2?this.markerIMinPQ.setSize(this.markerArray.length):this.markerIMinPQ.clean(),n=0;n<this.markerArray.length;n++)o=this.markerArray[n],t.containCheckPoint(o.pos)&&(a=YFM.Math.Vector.distanceSQ(o.pos,s),o.distSQ=a,this.markerIMinPQ.insert(n,a));for(this.markerSorted=[],h=this.markerIMinPQ.getCount(),n=0;n<h;n++)this.markerSorted.push(this.markerIMinPQ.deleteMin());for(n=h-1;n>=0;n--)1===(o=this.markerArray[this.markerSorted[n]]).type&&this._renderTex(r,e,i,o)},findMarker:function(t,e){for(var i,r=0;r<this.markerSorted.length;r++)if(i=this.markerArray[this.markerSorted[r]],this._envelopCheck(i.envelop,t,e))return{id:i.id,dist:i.distSQ};return null},_envelopCheck:function(t,e,i){return e>=t[0]&&e<=t[2]&&i>=t[1]&&i<=t[3]},_renderTex:function(t,e,i,r){if(null===r.tex){var s=this.region.getTexture(r.texName);null!==s&&(r.tex=s.tex,r.texSize[0]=s.w/2,r.texSize[1]=s.h/2)}if(null!==r.tex){var o,n,a=YFM.Math.Matrix.mulVec(t,r.pos);if(o=YFM.gRegion.glCanvas.width/2,n=YFM.gRegion.glCanvas.height/2,a[0]/=a[3],a[1]/=a[3],a[2]/=a[3],a[3]/=a[3],a[0]*=o,a[1]*=n,r.id===this.region.markerAnim.id){this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA);var h=this.region.markerAnim,u=YFM.Math.Matrix.scaleXYZ(h.waveRadius,0,0,0),l=YFM.Math.Matrix.postTranslate(u,a[0],a[1],0);e.useProgram(),e.setModelMatrix(l),e.drawTriangles(h.circleVBO,h.waveColor,0,h.circleSize),h.waveRadius[0]>h.waveMin?(h.waveRadius[0]-=h.waveStep,h.waveRadius[1]-=h.waveStep):(h.waveRadius[0]=h.waveMax,h.waveRadius[1]=h.waveMax),this.gl.disable(this.gl.BLEND)}i.useProgram(),i.bindTexture(r.tex),r.envelop[0]=o+a[0]-r.offsetX-r.texSize[0],r.envelop[1]=n-(a[1]+r.offsetY+r.texSize[1]),r.envelop[2]=o+a[0]+r.offsetX+r.texSize[0],r.envelop[3]=n-(a[1]+r.offsetY-r.texSize[1]),u=YFM.Math.Matrix.postRotateXY(YFM.Math.Matrix.postTranslate(YFM.Math.Matrix.scaleXYZ(r.texSize,0,0,0),a[0]-r.offsetX,a[1]+r.offsetY,0),this.region.camera.getRoll(),a[0],a[1]),i.setModelMatrix(u),this.gl.depthMask(!1),i.drawTriangles(this.quadVBO,6,0),this.gl.depthMask(!0)}},_initQuad:function(t){var e=[],i=[],r=[];r.push(YFM.Math.Vector.vec(0,1)),r.push(YFM.Math.Vector.vec(1,1)),r.push(YFM.Math.Vector.vec(1,0)),r.push(YFM.Math.Vector.vec(0,0)),i.push(YFM.Math.Vector.pos(-1,-1,0)),i.push(YFM.Math.Vector.pos(1,-1,0)),i.push(YFM.Math.Vector.pos(1,1,0)),i.push(YFM.Math.Vector.pos(-1,1,0)),e.push(i[0]),e.push(r[0]),e.push(i[1]),e.push(r[1]),e.push(i[2]),e.push(r[2]),e.push(i[0]),e.push(r[0]),e.push(i[2]),e.push(r[2]),e.push(i[3]),e.push(r[3]),this.quadVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.quadVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(e,3),t.STATIC_DRAW)}},FloorModels.prototype={constructor:FloorModels,removeModel:function(t){return this.quadTree.removeObject(t)},insertModel:function(t){return this.quadTree.insertObjectOBB(t,t.obb)},rayCheck:function(t,e){return this.quadTree.rayCheckOBB(t,e)},renderModels:function(t,e,i,r){this.shader=e,this.vrfMat=YFM.Math.Matrix.mul(i,this.floor.getFloorMat()),e.setFloorMatrix(this.floor.getFloorMat()),e.setLightPos(r),this.gl.enable(this.gl.CULL_FACE),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL),this.quadTree.render(t,this._renderModel,this,1024),this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.CULL_FACE)},_renderModel:function(t,e){t.obj.render(e.shader,e.vrfMat)}},FloorQuickIcons.prototype={constructor:FloorQuickIcons,render:function(t){if(null!=this.pointsVBO){if(null===this.tex){var e=this.region.getTexture(this.texName);null!==e&&(this.tex=e.tex)}null!==this.tex&&(t.bindTexture(this.tex),t.drawPoints(this.pointsVBO,this.pointsSize))}},setTex:function(t){this.tex=null,this.texName=t},addPoint:function(t,e){var i=this.floor.floorPos2Region(t,e);i[2]+=this.height,this.pointsVarray.push(i)},clean:function(){null!==this.pointsVBO&&this.gl.deleteBuffer(this.pointsVBO),this.pointsVBO=null,this.pointsSize=0,this.pointsVarray=[]},buildPoints:function(){null!==this.pointsVBO&&this.gl.deleteBuffer(this.pointsVBO),this.pointsVBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.pointsVBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(this.pointsVarray,3),this.gl.STATIC_DRAW),this.pointsSize=this.pointsVarray.length,this.pointsVarray=[]}},FloorQuickPolygon.prototype={constructor:FloorQuickPolygon,setHeight:function(t){this.height=t},render:function(t){this.loaded&&null!==this.quickPolygonVBO&&(this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL),t.setLighting(1),t.drawTriangles(this.quickPolygonVBO,this.quickPolygonCBO,this.quickPolygonSize),this.gl.disable(this.gl.DEPTH_TEST))},addQuickPolygon:function(t,e){var i,r=t.length,s=YFM.Math.Vector.vec(0,0,1),o=new ArrayList,n=YFM.WebGL.Color.getRGBVec(e);for(i=0;i<r;i++)o.addHigh(t[i]);var a=this._triangulate_cut_ear(t,o);if(null!==a){var h=a.length/3;for(i=0;i<h;i++){var u=[];u.push(a[3*i+0]),u.push(a[3*i+1]),u.push(a[3*i+2]),this.quickPolygonVarray.push(YFM.Math.Vector.pos(u[0][0],u[0][1],u[0][2]+this.height)),this.quickPolygonVarray.push(s),this.quickPolygonVarray.push(YFM.Math.Vector.pos(u[1][0],u[1][1],u[1][2]+this.height)),this.quickPolygonVarray.push(s),this.quickPolygonVarray.push(YFM.Math.Vector.pos(u[2][0],u[2][1],u[2][2]+this.height)),this.quickPolygonVarray.push(s),this.quickPolygonCarray.push(n),this.quickPolygonCarray.push(n),this.quickPolygonCarray.push(n)}}},buildQuickPolygon:function(){this.quickPolygonVarray.length<=0||(this.cleanQuickPolygon(),this.quickPolygonVBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.quickPolygonVBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(this.quickPolygonVarray,4),this.gl.STATIC_DRAW),this.quickPolygonSize=this.quickPolygonVarray.length/2,this.quickPolygonVarray=[],this.quickPolygonCBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.quickPolygonCBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(this.quickPolygonCarray,4),this.gl.STATIC_DRAW),this.quickPolygonCarray=[],this.loaded=!0)},cleanQuickPolygon:function(){if(null!==this.quickPolygonVBO){var t=this.quickPolygonVBO,e=this.gl;this.quickPolygonVBO=null,this.loaded=!1,setTimeout(function(){e.deleteBuffer(t)},2e3)}if(null!==this.quickPolygonCBO){var t=this.quickPolygonCBO,e=this.gl;this.quickPolygonCBO=null,this.loaded=!1,setTimeout(function(){e.deleteBuffer(t)},2e3)}},_clock_wise_tri:function(t){var e=0;return e+=(t[1][0]-t[0][0])*(t[1][1]+t[0][1]),e+=(t[2][0]-t[1][0])*(t[2][1]+t[1][1]),(e+=(t[0][0]-t[2][0])*(t[0][1]+t[2][1]))>0},_clock_wise_pts:function(t){for(var e=0,i=t.length,r=0;r<i;r++)e+=(t[(r+1)%i][0]-t[r][0])*(t[(r+1)%i][1]+t[r][1]);return e>0},_is_left_turn:function(t,e,i){return(e[0]-t[0])*(i[1]-t[1])-(i[0]-t[0])*(e[1]-t[1])>0},_is_right_turn:function(t,e,i){return(e[0]-t[0])*(i[1]-t[1])-(i[0]-t[0])*(e[1]-t[1])<0},_point_inside:function(t,e,i,r){var s=this._is_left_turn(t,e,r),o=this._is_left_turn(e,i,r),n=this._is_left_turn(i,t,r);if(s&&o&&n)return!0;var a=this._is_right_turn(t,e,r),h=this._is_right_turn(e,i,r),u=this._is_right_turn(i,t,r);return!!(a&&h&&u)},_triangulate_cut_ear:function(t,e){for(var i,r,s,o=this._clock_wise_pts(t),n=[];e.size()>3;){var a,h,u=-1,l=0;do{if(l++,h=e.size(),l>=h)return console.log("bad input."),null;if(u++,i=e.get(u%h),r=e.get((u+1)%h),s=e.get((u+2)%h),a=this._is_left_turn(i,r,s)^o)for(var c=e.getIter();c.hasNext();){var d=c.getNext();if(this._point_inside(i,r,s,d)){a=!1;break}}}while(!a);n.push(i),n.push(r),n.push(s),e.remove((u+1)%h)}return 3==e.size()&&(n.push(e.get(0)),n.push(e.get(1)),n.push(e.get(2))),n}},FloorTextureRect.prototype={constructor:FloorTextureRect,texName:["noName","noName"],setHeight:function(t){this.height=t},render:function(t){if(this.loaded){var e=this.region.getTexture(FloorTextureRect.prototype.texName[this.number]);null!==e&&(t.setColorFlag(0),t.bindTexture(e.tex),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL),t.drawTriangles(this.textureRectVBO,this.textureRectSize),this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.BLEND))}},addTextureRect:function(t){t[0][2]=this.height,t[1][2]=this.height,t[2][2]=this.height,t[3][2]=this.height,this.textureRectVarray.push(t[0]),this.textureRectVarray.push(this.tex[0]),this.textureRectVarray.push(t[1]),this.textureRectVarray.push(this.tex[1]),this.textureRectVarray.push(t[2]),this.textureRectVarray.push(this.tex[2]),this.textureRectVarray.push(t[0]),this.textureRectVarray.push(this.tex[0]),this.textureRectVarray.push(t[2]),this.textureRectVarray.push(this.tex[2]),this.textureRectVarray.push(t[3]),this.textureRectVarray.push(this.tex[3])},buildTextureRect:function(){this.textureRectVarray.length<=0||(this.cleanTextureRect(),this.textureRectVBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.textureRectVBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(this.textureRectVarray,4),this.gl.STATIC_DRAW),this.textureRectSize=this.textureRectVarray.length/2,this.textureRectVarray=[],this.loaded=!0)},cleanTextureRect:function(){if(null!==this.textureRectVBO){var t=this.textureRectVBO,e=this.gl;this.textureRectVBO=null,this.loaded=!1,setTimeout(function(){e.deleteBuffer(t)},2e3)}}},FloorTrajectory.prototype={constructor:FloorTrajectory,setHeight:function(t){this.height=t},render:function(){var t,e=this.meshList.length;if(e>0){var i=this.region.gl,r=this.region.trajectoryShader,s=this.region.texturePool.getTexture("trajectory_tex");if(null!=s){r.useProgram(),r.setMapHeight(this.floor.mapHeight),r.setPVRMat(this.region.renderParam.pvrMat),r.setFloorMat(this.floor.floorMat),r.setTime(this.time),r.bindTexture(s.tex),i.enable(i.BLEND),i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA);for(var o=0;o<e;o++)t=this.meshList[o],r.drawTriangleStrip(t);i.disable(i.BLEND),this.time-=.01}}},addTrajectory:function(t){var e=this._makeSegList(t);null!==e&&this.meshList.push(this._makeSegsMesh(e))},cleanTrajectory:function(){for(var t=0,e=this.meshList.length;t<e;t++)this.meshList[t].recycle();this.meshList=[]},_makeSeg:function(t,e,i,r,s,o){var n=YFM.Math.Vector,a={};return a.start=n.pos(e,i),a.end=n.pos(r,s),a.vec=n.sub(a.end,a.start),a.tan=n.vec(o[0],o[1]),a.len=n.norm3(a.vec),a.global_mileage=t,a},_updateSegEnd:function(t,e,i){var r=YFM.Math.Vector;t.end=r.pos(e,i),t.vec=r.sub(t.end,t.start),t.tan=r.normalize(t.vec),t.len=r.norm3(t.vec)},_makeSegList:function(t){var e,i,r,s,o,n,a,h,u,l,c,d=YFM.Math.Vector,g=[];if((i=t.length/2)-1<=0)return null;for(a=0,e=0;e<i-1;e++)r=t[2*e+0],s=t[2*e+1],o=t[2*e+2],n=t[2*e+3],u=d.vec(o-r,n-s),u=d.normalize(u),g.length<=0?(l=this._makeSeg(a,r,s,o,n,u),g.push(l),a+=l.len):(c=g.pop(),h=d.dot3(u,c.tan),Math.abs(h-1)<1e-5?(a-=c.len,this._updateSegEnd(c,o,n),g.push(l),a+=c.len):(g.push(l),l=this._makeSeg(a,r,s,o,n,u),g.push(l),a+=l.len));return g},_makeSegsMesh:function(t){var e,i,r,s,o,n,a,h,u,l,c,d,g,p,M,f,m,v,x,F;s=4*(r=t.length);var _=Array(2*s),y=Array(3*s);o=3*(4*r-2);var R=Array(o);for(i=0;i<r;i++)u=(F=t[i]).start[0],l=F.start[1],c=F.end[0],d=F.end[1],h=F.len,v=(f=F.global_mileage)/32,x=(m=f+h)/32,g=F.tan[0],p=2*F.tan[1],M=2*g,_[8*i+0]=u-p,_[8*i+1]=l+M,_[8*i+2]=u+p,_[8*i+3]=l-M,_[8*i+4]=c-p,_[8*i+5]=d+M,_[8*i+6]=c+p,_[8*i+7]=d-M,y[12*i+0]=1,y[12*i+1]=v,y[12*i+2]=f,y[12*i+3]=0,y[12*i+4]=v,y[12*i+5]=f,y[12*i+6]=1,y[12*i+7]=x,y[12*i+8]=m,y[12*i+9]=0,y[12*i+10]=x,y[12*i+11]=m,n=4*i,i>0?(R[(a=6+12*(i-1))+0]=n-2,R[a+1]=n-1,R[a+2]=n+0,R[a+3]=n-1,R[a+4]=n+1,R[a+5]=n+0,R[a+6]=n+0,R[a+7]=n+1,R[a+8]=n+2,R[a+9]=n+1,R[a+10]=n+3,R[a+11]=n+2):(R[0]=n+0,R[1]=n+1,R[2]=n+2,R[3]=n+1,R[4]=n+3,R[5]=n+2);return(e=new VAttribs(this.gl)).addAttributeFlat("pos",_,2,!1),e.addAttributeFlat("uv",y,3,!1),e.addAttributeElementFlat("index",R),e}},YFM.Map.ANIM_TYPE_PITCH=0,YFM.Map.ANIM_TYPE_LOOKAT=1,YFM.Map.ANIM_TYPE_LOOKDISTANCE=2,YFM.Map.ANIM_TYPE_LOOKAZIMUTH=3,YFM.Map.ANIM_TYPE_ROTATE_MAP=4,YFM.Map.ANIM_DEFAULT_FRAME=12,AnimationMgr.prototype={constructor:AnimationMgr,pitchLimit:80,update:function(){if(null===this.current&&(this.current=this.seq.removeHigh(),null!==this.current&&(this.touchMgr.setEnable(!1),this.listener.onAnimStart(this.current))),null!==this.current){var t=this.current.step/this.current.frame,e=YFM.Math.lerp;switch(this.current.step+=1,this.current.type){case YFM.Map.ANIM_TYPE_PITCH:r=this.current.step==this.current.frame?this.current.to:e(this.current.from,this.current.to,t),this.camera.setPitch(r),this.current.overlook?0!==r&&(this.region._onOverlook(!1),this.current.overlook=!1,this.touchMgr._setOverlook(!1)):0===r&&(this.region._onOverlook(!0),this.current.overlook=!0,this.touchMgr._setOverlook(!0));break;case YFM.Map.ANIM_TYPE_LOOKDISTANCE:s=this.current.step==this.current.frame?this.current.to:e(this.current.from,this.current.to,t),this.camera.setLookOffset(0,0,s),this.camera.resetLookOffsetTan();break;case YFM.Map.ANIM_TYPE_LOOKAZIMUTH:o=this.current.step==this.current.frame?this.current.to:e(this.current.from,this.current.to,t),this.camera.setAzimuth(o);break;case YFM.Map.ANIM_TYPE_ROTATE_MAP:var i=this.current.to/this.current.frame;this.region.postRotate(i);break;case YFM.Map.ANIM_TYPE_LOOKAT:1==this.current.step&&(this.mover.setLocation(this.current.from[0],this.current.from[1],this.current.from[2]),this.camera.resetLookOffsetTan()),this.mover.arrive(this.current.to,2)?(this.current.step=this.current.frame,this.mover.setLocation(this.current.to[0],this.current.to[1],this.current.to[2])):this.mover.update();n=this.mover.getLocation();this.camera.setLookAt(n[0],n[1],n[2]);break;case YFM.Map.ANIM_TYPE_MERGE:if(this.current.pitch){var r;r=this.current.step==this.current.frame?this.current.pitch.to:e(this.current.pitch.from,this.current.pitch.to,t),this.camera.setPitch(r),this.current.overlook?0!==r&&(this.region._onOverlook(!1),this.current.overlook=!1,this.touchMgr._setOverlook(!1)):0===r&&(this.region._onOverlook(!0),this.current.overlook=!0,this.touchMgr._setOverlook(!0))}if(this.current.distance){var s;s=this.current.step==this.current.frame?this.current.distance.to:e(this.current.distance.from,this.current.distance.to,t),this.camera.setLookOffset(0,0,s),this.camera.resetLookOffsetTan()}if(this.current.azimuth){var o;o=this.current.step==this.current.frame?this.current.azimuth.to:e(this.current.azimuth.from,this.current.azimuth.to,t),this.camera.setAzimuth(o)}if(this.current.lookAt){var n;if(this.current.step==this.current.frame)n=this.current.lookAt.to;else{var a=YFM.Math.Vector;n=a.add(this.current.lookAt.from,a.scale(this.current.lookAt.direction,this.current.step*this.current.lookAt.interval))}this.camera.setLookAt(n[0],n[1],n[2])}}this.current.step>=this.current.frame&&(this.listener.onAnimFinish(this.current),this.current=null,this.touchMgr.setEnable(!0))}},animPitch:function(t,e,i,r){var s=YFM.Math.clamp(t,0,AnimationMgr.prototype.pitchLimit),o=e||null,n=i||YFM.Map.ANIM_DEFAULT_FRAME;(r||!1)&&(this.seq.clean(),null!==this.current&&this.listener.onAnimCancel(this.current),this.current=null);var a=new Animation(o,YFM.Map.ANIM_TYPE_PITCH,n);a.from=this.camera.getPitch(),a.to=-s,a.overlook=0===a.from,this.seq.addLow(a)},animLookDistance:function(t,e,i,r){var s=t,o=e||null,n=i||YFM.Map.ANIM_DEFAULT_FRAME;(r||!1)&&(this.seq.clean(),null!==this.current&&this.listener.onAnimCancel(this.current),this.current=null);var a=new Animation(o,YFM.Map.ANIM_TYPE_LOOKDISTANCE,n);a.from=this.camera.getLookOffsetNormal(),a.to=-s,this.seq.addLow(a)},animLookAzimuth:function(t,e,i,r,s){var o=YFM.Math.deg2Radian(t),n=e||null,a=i||!1,h=r||YFM.Map.ANIM_DEFAULT_FRAME;(s||!1)&&(this.seq.clean(),null!==this.current&&this.listener.onAnimCancel(this.current),this.current=null);var u=new Animation(n,YFM.Map.ANIM_TYPE_LOOKAZIMUTH,h);u.from=this.camera.getAzimuth(),u.to=a?-o:u.from-o,this.seq.addLow(u)},animRotateMap:function(t,e,i){var r=e||null;(i||!1)&&(this.seq.clean(),null!==this.current&&this.listener.onAnimCancel(this.current),this.current=null);var s=new Animation(r,YFM.Map.ANIM_TYPE_ROTATE_MAP,24);s.from=0,s.to=t,this.seq.addLow(s)},animLookAt:function(t,e,i){var r=e||null;(i||!1)&&(this.seq.clean(),null!==this.current&&this.listener.onAnimCancel(this.current),this.current=null);var s=new Animation(r,YFM.Map.ANIM_TYPE_LOOKAT,1024);s.from=this.camera.getLookAt(),s.to=t,this.seq.addLow(s)},animMerge:function(t,e,i,r){var s=e||null,o=i||24;(r||!1)&&(this.seq.clean(),null!==this.current&&this.listener.onAnimCancel(this.current),this.current=null);var n=new Animation(s,YFM.Map.ANIM_TYPE_MERGE,o);if((t.pitch||0===t.pitch)&&(n.pitch={},n.pitch.from=this.camera.getPitch(),n.pitch.to=-YFM.Math.clamp(t.pitch,0,AnimationMgr.prototype.pitchLimit),n.pitch.overlook=0===n.from),t.distance&&(n.distance={},n.distance.from=this.camera.getLookOffsetNormal(),n.distance.to=-t.distance),t.azimuth&&(n.azimuth={},n.azimuth.from=this.camera.getAzimuth(),n.abs?n.azimuth.to=-YFM.Math.deg2Radian(t.azimuth):n.azimuth.to=n.azimuth.from-YFM.Math.deg2Radian(t.azimuth)),t.lookAt){var a=YFM.Math.Vector;n.lookAt={},n.lookAt.from=this.camera.getLookAt(),n.lookAt.to=t.lookAt,n.lookAt.direction=a.normalize(a.sub(n.lookAt.to,n.lookAt.from)),n.lookAt.interval=a.distance(n.lookAt.from,n.lookAt.to)/o,this.camera.resetLookOffsetTan()}this.seq.addLow(n)}},Region.prototype={constructor:Region,setMarkerAnim:function(t,e,i){var r=YFM.Math.Vector,s=YFM.WebGL.Color;this.markerAnim.waveColor=r.vec(s.hexColorRed(t),s.hexColorGreen(t),s.hexColorBlue(t),s.hexColorAlpha(t)),this.markerAnim.waveMax=e,this.markerAnim.waveMin=i},setMarkerAnimId:function(t){this.markerAnim.id=t},cleanMarkerAnimId:function(){this.markerAnim.id=-1},setAmbient:function(t){this.ambient[0]=t,this.ambient[1]=t,this.ambient[2]=t},setDiffuse:function(t){this.diffuse[0]=t,this.diffuse[1]=t,this.diffuse[2]=t},release:function(){this.gl.getExtension("WEBGL_lose_context").loseContext(),YFM.gGL=null,YFM.gRegion=null},enableRouteMover:function(t,e){this.route.enableRouteMover(t,e)},setThumbnailVisibility:function(t){this.regionThumbnail.setVisibility(t)},thumbnailPersistence:function(){return this.regionThumbnail.persistence()},setThumbnailParam:function(t){this.regionThumbnail.setParam(t)},startThumbnailSetting:function(){var t=this.glCanvas.width/2,e=this.glCanvas.height/2;this.regionThumbnail.cleanStatus(),this.camera.setOrthographic(-t,t,-e,e,-1e4,1e5),RegionTouchMgr.prototype.PITCH_LIMIT=-80,this.regionThumbnailFlag=!0},endThumbnailSetting:function(){var t=this.glCanvas.width/2,e=this.glCanvas.height/2;this.regionThumbnail.saveStatus(),this.camera.setPerspective(60,t/e,60,2e4),RegionTouchMgr.prototype.PITCH_LIMIT=-60,this.regionThumbnailFlag=!1},setThumbnailScaleRate:function(t){this.regionThumbnail.setScaleRate(t)},addRay:function(t,e){},setCustomFloorHeight:function(t){this.customFloorHeight=t},setClearColor:function(t){this.clearColor=YFM.WebGL.Color.getRGBVec(t)},setAzimuth:function(t){this.azimuth=t},setZoomConstraint:function(t,e){this.touchMgr.setZoomMin(t),this.touchMgr.setZoomMax(e)},setDrawAllUnit:function(t){this.drawAllUnit=t},setTouchEnable:function(t){this.touchMgr.setEnable(t)},locateLaunch:function(){this.locMarker.locateLaunch()},setLocMarkerParam:function(t,e,i,r){this.locMarker.set2DMarkerParam(t,e,i,r)},setAlwaysDrawUnit:function(t){this.drawUnitTextAlways=t},setUIScaleRate:function(t){this.touchMgr.setUIScaleRate(t)},getId:function(){return this.id},startRender:function(){YFM.gRegion=this,YFM.gRegion._grender()},displayFloor:function(t){if(!(t>=0||t<this.floors.length))throw new Error("Rgeion.js [displayFloor] Floor index out of range:"+t);this.displayFloorIndex=t;var e=this.floors[t].getAspect();this.lookAtMapLoc(t,e.w/2,e.h/2),this.route.setDisplayFloor(t)},getFloorZ:function(t){return this.floors[t].vOffset},displayRegion:function(){this.displayFloorIndex=-1,this.route.setDisplayFloor(-1)},setFontType:function(t){this.ctx2d.font=t,this.fontHeight=this._determineFontHeight("font: "+this.ctx2d.font+";")},setFontColor:function(t){this.ctx2d.fillStyle=t},setStatus:function(t){if(t!==this.status){switch(t){case YFM.Map.STATUS_TOUCH:YFM.Map.STATUS_SENSOR===this.status&&this.camera.disconnect(),this.status=t;break;case YFM.Map.STATUS_SENSOR:YFM.Map.STATUS_SENSOR!==this.status&&this.camera.connect(),this.status=t,this.camera.resetLookOffsetTan(),this.locMarker.updateLocation();break;case YFM.Map.STATUS_TRACE:YFM.Map.STATUS_SENSOR===this.status&&this.camera.disconnect(),this.status=t,this.camera.resetLookOffsetTan(),this.locMarker.updateLocation();break;case YFM.Map.STATUS_NAVIGATE:YFM.Map.STATUS_SENSOR===this.status&&this.camera.disconnect(),this.status=t,this.camera.resetLookOffsetTan(),this.locMarker.updateLocation(),this.locMarker.updateLocation()}this.listener&&this.listener.onStatusChange(this.status)}},getStatus:function(){return this.status},addFloorsURL:function(t){var e,i,r,s=this,o={onLoadFinish:function(t){for(var e=!0,i=0;i<s.floors.length;i++)if(!s.floors[i].isLoaded()){e=!1;break}s.listener&&(s.listener.onLoadFinish(t.id,t.index),e&&(s._restructure(),s.listener.onAllFloorLoadFinish())),e&&s.touchMgr.onRegionLoadFinish()},onLoadFailed:function(t){this.listener&&this.listener.onLoadFailed(t.id,t.index)}};for(i=t.length,r=0;r<i;r++)e=t[r],this.floors.push(new Floor(this.gl,e.id,e.url,e.deflection,this,r,o))},addFloorsSVG:function(t){var e,i,r;for(i=t.length,r=0;r<i;r++)e=t[r],this.floors.push(new Floor(this.gl,e.id,e.svg,e.deflection,this,r,null));this._restructure(),this.listener.onAllFloorLoadFinish(),this.touchMgr.onRegionLoadFinish()},addTexture:function(t,e){this.texturePool.addTexture(t,e)},addTextureBase64:function(t,e){this.texturePool.addTextureBase64(t,e)},addTextureMip:function(t,e){this.texturePool.addTextureMip(t,e)},getTexture:function(t){return this.texturePool.getTexture(t)},getFloorCount:function(){return this.floors.length},getFloorAspect:function(t){return this.floors[t].getAspect()},getFloorLoc:function(){return this.locMarker.getFloorLoc()},getRegionLoc:function(){return this.locMarker.getRegionLoc()},setNavigateProj:function(t){this.route.setUpdateNSFlag(t)},updateNaviStatus:function(t,e){this.route.updateNaviStatus(t,e)},cleanLocation:function(){this.locMarker.cleanLocation()},setLocation:function(t,e,i){this.locMarker.setLocation(t,e,i)},postTranslate:function(t,e){this.touchMgr.postTranslate(t,e)},postRotate:function(t){this.touchMgr.postRotate(t)},animTo:function(t,e,i){this.locMarker.animTo(t,e,i)},lookAtMapLoc:function(t,e,i){var r=this.floors[t].floorPos2Region(e,i);this.lookAtRegionLoc(r[0],r[1],r[2])},lookAtWorldLoc:function(t,e,i){this.camera.resetLookOffsetTan(),this.camera.setLookAt(t,e,i)},lookAtRegionLoc:function(t,e,i){var r=YFM.Math.Vector.pos(t,e,i),s=YFM.Math.Matrix.mulVec(this.matRegion,r);this.camera.resetLookOffsetTan(),this.camera.setLookAt(s[0],s[1],s[2])},animRotateMap:function(t){this.animMgr.animRotateMap(t)},animLookAt:function(t,e,i,r){var s=this.floors[t].floorPos2Region(e,i),o=YFM.Math.Matrix.mulVec(this.matRegion,s);this.animMgr.animLookAt(o,r)},animLookAtWorld:function(t,e){this.animMgr.animLookAt(t,e)},animLookDistance:function(t,e){this.animMgr.animLookDistance(t,e)},getLookDistance:function(){return-this.camera.getLookOffsetNormal()},animLookAzimuth:function(t,e){this.animMgr.animLookAzimuth(t,e)},animPitch:function(t,e){this.animMgr.animPitch(t,e)},overlookMap:function(){if(-1===this.displayFloorIndex){if(this.obb){var t=this.obb.center,e=YFM.Math.Matrix.mulVec(this.matRegion,t),i=this.obb.hr,r=this.obb.hs,s=this.obb.ht,o=2*Math.sqrt(i*i+r*r+s*s),n=this.obb.r,a=-(c=YFM.Math.Matrix.eulerParamExtractZ(this.matRegion))+(l=this.camera.getAzimuth())+this._makeAzimuth(n);this.animMgr.animMerge({distance:1.8*o,azimuth:YFM.Math.radian2Deg(this._clampMinorArc(a)),lookAt:e},null,48)}}else{var h=this.floors[this.displayFloorIndex],u=h.floorPos2Region(h.mapWidth/2,h.mapHeight/2),e=YFM.Math.Matrix.mulVec(this.matRegion,u),l=this.camera.getAzimuth(),c=YFM.Math.Matrix.eulerParamExtractZ(this.matRegion),a=-c+l+YFM.Math.deg2Radian(h.deflection),d=h.mapWidth>h.mapHeight?h.mapWidth:h.mapHeight;this.animMgr.animMerge({distance:d,azimuth:YFM.Math.radian2Deg(this._clampMinorArc(a)),lookAt:e},null,32)}},getFloorAngle:function(t){var e=this.floors[t],i=this.camera.getAzimuth(),r=-YFM.Math.Matrix.eulerParamExtractZ(this.matRegion)+i+YFM.Math.deg2Radian(e.deflection);return YFM.Math.radian2Deg(this._clampMinorArc(r))},getFloorDeflection:function(t){return this.floors[t].deflection},setRoute:function(t){this.route.setRoute(t)},cleanRoute:function(){this.route.cleanRoute()},overlookRoute:function(t){var e=this.route.getRouteCenter(this.displayFloorIndex);if(null!==e){var i=YFM.Math.Matrix.mulVec(this.matRegion,e),r=this.route.getRouteRAxis(),s=-YFM.Math.Matrix.eulerParamExtractZ(this.matRegion)+this.camera.getAzimuth()+this._makeAzimuth(r);this.animMgr.animMerge({distance:1.8*this.route.getRouteOBBLength(this.displayFloorIndex),azimuth:YFM.Math.radian2Deg(this._clampMinorArc(s)),lookAt:i,pitch:t},null,48)}},getNaviStatus:function(){return this.route.getNaviStatus()},addTrajectory:function(t,e){this.floors[t].addTrajectory(e)},cleanTrajectory:function(t){this.floors[t].cleanTrajectory()},setFloorObjectColor:function(t,e,i,r){this.floors[t].setObjectColor(e,i,r)},resetFloorObjectColor:function(t,e,i){this.floors[t].resetObjectColor(e,i)},resetObjectColorAll:function(t,e){this.floors[t].resetObjectColorAll(e)},insertUnit:function(t,e){this.floors[e].insertUnit(t)},insertIcon:function(t,e,i,r){this.floors[e].insertIcon(t,i,r)},insertIconPlus:function(t,e,i,r){this.floors[e].insertIconPlus(t,i,r)},insertModel:function(t,e,i,r,s,o,n){return this.floors[t].insertModel(e,i,r,s,o,n)},removeModel:function(t){var e=this._calcModelFloor(t);return this.floors[e].removeModel(t)},addTextureRect:function(t,e){this.floors[t].texRect.addTextureRect(e)},buildTextureRectAll:function(){for(var t=0;t<this.floors.length;t++)this.floors[t].texRect.buildTextureRect()},buildTextureRectFloor:function(t){this.floors[t].texRect.buildTextureRect()},cleanTextureRectAll:function(){for(var t=0;t<this.floors.length;t++)this.floors[t].texRect.cleanTextureRect()},cleanTextureRectFloor:function(t){this.floors[t].texRect.cleanTextureRect()},setTextureRectTex:function(t){FloorTextureRect.prototype.texName[0]=t},addTextureRectSpec:function(t,e){this.floors[t].texRectSpec.addTextureRect(e)},buildTextureRectAllSpec:function(){for(var t=0;t<this.floors.length;t++)this.floors[t].texRectSpec.buildTextureRect()},buildTextureRectFloorSpec:function(t){this.floors[t].texRectSpec.buildTextureRect()},cleanTextureRectAllSpec:function(){for(var t=0;t<this.floors.length;t++)this.floors[t].texRectSpec.cleanTextureRect()},cleanTextureRectFloorSpec:function(t){this.floors[t].texRectSpec.cleanTextureRect()},setTextureRectTexSpec:function(t){FloorTextureRect.prototype.texName[1]=t},addTextureRectUltra:function(t,e){this.floors[t].texRectUltra.addTextureRect(e)},buildTextureRectAllUltra:function(){for(var t=0;t<this.floors.length;t++)this.floors[t].texRectUltra.buildTextureRect()},buildTextureRectFloorUltra:function(t){this.floors[t].texRectUltra.buildTextureRect()},cleanTextureRectAllUltra:function(){for(var t=0;t<this.floors.length;t++)this.floors[t].texRectUltra.cleanTextureRect()},cleanTextureRectFloorUltra:function(t){this.floors[t].texRectUltra.cleanTextureRect()},setTextureRectTexUltra:function(t){FloorTextureRect.prototype.texName[2]=t},addQuickPolygon:function(t,e,i){this.floors[t].quickPolygon.addQuickPolygon(e,i)},buildQuickPolygonAll:function(){for(var t=0;t<this.floors.length;t++)this.floors[t].quickPolygon.buildQuickPolygon()},buildQuickPolygonFloor:function(t){this.floors[t].quickPolygon.buildQuickPolygon()},cleanQuickPolygonAll:function(){for(var t=0;t<this.floors.length;t++)this.floors[t].quickPolygon.cleanQuickPolygon()},cleanQuickPolygonFloor:function(t){this.floors[t].quickPolygon.cleanQuickPolygon()},insertGeometryMarker:function(t,e,i,r,s,o,n){return this.floors[r].markers.insertGeometryMarker(t,e,i,s,o,n)},insertTextureMarker:function(t,e,i,r,s,o,n){return this.floors[e].markers.insertTextureMarker(t,i,r,s,o,n)},removeMarker:function(t){var e=this._calcMarkerFloor(t);return null!==this.floors[e].markers.removeMarker(t)},updateMarkerLocation:function(t,e,i,r){var s=-1,o=this._calcMarkerFloor(t),n=this.floors[o].markers.removeMarker(t);return null!==n&&(s=this.floors[e].markers.insertMarker(n,i,r)),s},searchModel:function(t,e){var i=this.touchMgr.getFocusFloorIndex();if(-1!=i){var r=this.touchMgr.getTouchRayPlus(t,e);return this.floors[i].searchModel(r,!1)}return[]},searchUnit:function(t,e){var i=this.touchMgr.getFocusFloorIndex();if(-1!=i){var r=this.touchMgr.getTouchRayPlus(t,e);return this.floors[i].searchUnit(r,!1)}return[]},searchIcon:function(t,e,i,r){var s=this.touchMgr.getFocusFloorIndex(),o=i||80,n=r||!1;if(-1!=s){var a=this.touchMgr.getTouchRayPlus(t,e);return this.floors[s].searchIcon(a,o,n)}return[]},searchIconPlus:function(t,e){var i=this.touchMgr.getFocusFloorIndex();if(-1!=i){var r=this.touchMgr.getTouchRayPlus(t,e);return this.floors[i].searchIconPlus(r,!1)}return[]},searchMarker:function(t,e){for(var i=null,r=Number.MAX_VALUE,s=0;s<this.floors.length;s++)if(-1!==this.floors[s].BBCheck){var o=this.floors[s].markers.findMarker(t,e);null!==o&&r>o.dist&&(i=o,r=o.dist)}return null!==i?i.id:-1},getTouchPosMapLoc:function(t,e){return this.touchMgr._screen_to_map(t,e)},getTouchPosWorldLoc:function(t,e){return this.touchMgr._pos_in_world_space(t,e)},regionPos2Screen:function(t){var e=YFM.Math.Matrix.mul(this.camera.getPVMat(),this.matRegion),i=YFM.Math.Matrix.mulVec(e,t);return i[0]/=i[3],i[1]/=i[3],i[2]/=i[3],i[3]/=i[3],i[0]=i[0]*this.hw+this.hw,i[1]=-i[1]*this.hh+this.hh,i},regionPos2ScreenGL:function(t){var e=YFM.Math.Matrix.mul(this.camera.getPVMat(),this.matRegion),i=YFM.Math.Matrix.mulVec(e,t);return i[0]/=i[3],i[1]/=i[3],i[2]/=i[3],i[3]/=i[3],i[0]*=this.hw,i[1]*=this.hh,i},floorPos2RegionPos:function(t,e,i){if(t<0||t>=this.floors.length)throw new Error("floor index out of bounds");return this.floors[t].floorPos2Region(e,i)},_onOverlook:function(t){this.overlook=t,this.extrudeLight=t?this.extrudeLightOver:this.extrudeLightNormal},_getRegionMat:function(){return this.matRegion},_setRegionMat:function(t){this.matRegion=t},_traceLoc:function(t,e,i){var r=YFM.Math.Vector.pos(t,e,i),s=YFM.Math.Matrix.mulVec(this.matRegion,r);if(YFM.Map.STATUS_NAVIGATE===this.status){var o=0,n=this.getNaviStatus();if(n.validate){var a=YFM.Math.Matrix.eulerParamExtractZ(this.matRegion);o=n.azimuth+a}this.camera.setLookAtAzimuth(o,s[0],s[1],s[2])}else this.camera.setLookAt(s[0],s[1],s[2])},_getFloorMat:function(t){if(t<0||t>=this.floors.length)throw new Error("floor index out of bounds");return this.floors[t].getFloorMat()},_intersectionLine:function(t){var e,i,r=[];for(e=this.floors.length,i=0;i<e;i++)r.push(this.floors[i].intersectionLine(t));return r},_render:function(){var t,e;t=this.floors.length,this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.clearColor&&this.gl.clearColor(this.clearColor[0],this.clearColor[1],this.clearColor[2],1),this.regionThumbnailFlag&&this.regionThumbnail.saveStatus(),this.animMgr.update(),this._cleanText(),this.tqct.reset(),this.renderParam.projMat=this.camera.getProjectionMat(),this.renderParam.viewMat=this.camera.getViewMat(),this.renderParam.regionMat=this.matRegion,this.renderParam.vrMat=YFM.Math.Matrix.mul(this.renderParam.viewMat,this.matRegion),this.renderParam.pvrMat=YFM.Math.Matrix.mul(this.camera.getPVMat(),this.matRegion),this.renderParam.itvrMat=YFM.Math.Matrix.invert(YFM.Math.Matrix.transpose(this.renderParam.vrMat)),this.renderParam.ivrMat=YFM.Math.Matrix.invert(this.renderParam.vrMat),this.renderParam.eyePos=YFM.Math.Matrix.mulVec(this.renderParam.ivrMat,this.orgPos);var i=YFM.Math.Matrix.matClone(this.renderParam.vrMat);i[12]=0,i[13]=0,i[14]=0;var r=YFM.Math.Matrix.invert(i),s=YFM.Math.Matrix.scale(15,0,0,0);s=YFM.Math.Matrix.postRotate3d(s,this.camera.getRoll()-90,0,0,1),this.renderParam.bivrMat=YFM.Math.Matrix.mul(r,s),this.frustum.update(this.renderParam.pvrMat);var o=[];if(-1===this.displayFloorIndex){h=this.touchMgr.getFocusFloorIndex();for(e=0;e<t;e++){var n=this.floors[e].frustumCheck(this.frustum);this.floors[e].BBCheck=n,this._renderFloor(e,n,h),o.push(n)}}else{for(e=0;e<t;e++)this.floors[e].BBCheck=-1;this.floors[this.displayFloorIndex].BBCheck=1,this._renderFloor(this.displayFloorIndex,n,this.displayFloorIndex)}var a=this.frustum.containCheckPoint(this.locMarker.getRegionLoc());if(-1!==this.displayFloorIndex&&this.displayFloorIndex!==this.getFloorLoc().floor&&(a=!1),this.route.render(this.renderParam),a&&(this.marker2DShader.useProgram(),this.marker2DShader.setProjectionMatrix(this.orthMat),this.color2DShader.useProgram(),this.color2DShader.setProjectionMatrix(this.orthMat)),this.locMarker.render(this.color2DShader,this.marker2DShader,a,this.renderParam.pvrMat),-1===this.displayFloorIndex){var h=this.touchMgr.getFocusFloorIndex();for(e=0;e<t;e++)-1!==o[e]&&this._renderFloor2DMarker(e)}else this._renderFloor2DMarker(this.displayFloorIndex);this.regionThumbnail.render()},_getFloorVOffset:function(t){return t*this.vPitch},_renderFloor2DMarker:function(t,e){this.marker2DShader.useProgram(),this.marker2DShader.setProjectionMatrix(this.orthMat),this.color2DShader.useProgram(),this.color2DShader.setProjectionMatrix(this.orthMat),this.floors[t].renderMarkers(this.frustum,this.color2DShader,this.marker2DShader,this.renderParam.pvrMat,this.renderParam.eyePos)},_renderFloor:function(t,e,i){if(-1!=e){this.baseColorShader.useProgram(),this.baseColorShader.setProjectionMatrix(this.renderParam.projMat),this.baseColorShader.setViewMatrix(this.renderParam.viewMat),this.baseColorShader.setRegionMatrix(this.matRegion),this.floors[t].renderBase(this.baseColorShader,this.touchMgr.getTouchFloor()==t);var r=this.overlook;YFM.Map.STATUS_SENSOR===this.status&&(r=!1);var s=!this.overlook;YFM.Map.STATUS_SENSOR===this.status&&(s=!0),this.basePhongShader.useProgram(),this.basePhongShader.setPVRMatrix(this.renderParam.pvrMat),this.basePhongShader.setAmbient(this.ambient),this.basePhongShader.setDiffuse(this.diffuse),this.basePhongShader.setLightPos(this.extrudeLight),this.basePhongShader.setNormalMatrix(this.renderParam.itvrMat),this.floors[t].renderExtrude(this.basePhongShader,s),this.baseColorShader.useProgram(),this.floors[t].renderTextureRect(this.baseColorShader),(this.drawUnitTextAlways||r&&t==i)&&(this.marker2DShader.useProgram(),this.marker2DShader.setProjectionMatrix(this.orthMat),this.floors[t].renderUnit(this.frustum,this.marker2DShader)),this.billboardIconShader.useProgram(),this.billboardIconShader.setProjectionMatrix(this.renderParam.projMat),this.billboardIconShader.setViewMatrix(this.renderParam.viewMat),this.billboardIconShader.setRegionMatrix(this.matRegion),this.billboardIconShader.setIViewMatrix(this.renderParam.bivrMat),this.floors[t].renderIcons(this.frustum,this.billboardIconShader),this.modelPhongShader.useProgram(),this.modelPhongShader.setProjectionMatrix(this.renderParam.projMat),this.modelPhongShader.setViewMatrix(this.renderParam.viewMat),this.modelPhongShader.setRegionMatrix(this.matRegion),this.floors[t].renderModels(this.frustum,this.modelPhongShader,this.renderParam.vrMat,this.modelLight),this.floors[t].renderTrajectory()}},_restructure:function(){var t,e,i,r;for(e=0,r=this.floors.length,i=0;i<r;i++)null!=(t=this.floors[i].getSize())&&t>e&&(e=t);for(this.maxSize=e,this.customFloorHeight?this.vPitch=this.customFloorHeight:this.vPitch=e/3,i=0;i<r;i++)this.floors[i].setVOffset(this.vPitch,i);this._makeBuildingOBB();var s=r*this.vPitch,o=Math.sqrt(s*s+e*e);this.touchMgr.setZoomMax(5*o)},_makeBuildingOBB:function(){var t,e,i,r=[],s=this.floors.length;for(t=0;t<s;t++)e=this.floors[t].mapHeight,i=this.floors[t].mapWidth,r.push(this.floorPos2RegionPos(t,0,0)),r.push(this.floorPos2RegionPos(t,i,0)),r.push(this.floorPos2RegionPos(t,0,e)),r.push(this.floorPos2RegionPos(t,i,e));this.obb=new OBB(r)},_grender:function(){YFM.gRegion&&(YFM.gRegion._render(),requestAnimFrame(YFM.gRegion._grender))},_makeAzimuth:function(t){var e=YFM.Math.Vector.vec(0,1,0),i=YFM.Math.Vector.normalize(t),r=YFM.Math.Vector.dot3(i,e);return Math.acos(r)},_clampMinorArc:function(t){var e=2*Math.PI,i=t%e;return i>0&&i>Math.PI?i-=e:i<0&&i<-Math.PI&&(i+=e),i},_calcMarkerFloor:function(t){return t%FloorMarkers.prototype.shift},_calcModelFloor:function(t){return t%FloorQuadTree.prototype.shift},_drawText:function(t,e,i){this.ctx2d.fillText(t,e,i)},_cleanText:function(){this.ctx2d.clearRect(0,0,this.txtCanvas.width,this.txtCanvas.height)},_determineFontHeight:function(t){var e=document.getElementsByTagName("body")[0],i=document.createElement("div"),r=document.createTextNode("M");i.appendChild(r),i.setAttribute("style",t),e.appendChild(i);var s=i.offsetHeight;return e.removeChild(i),s},_initMarkerAnim:function(){var t=[],e=2*Math.PI;t.push(YFM.Math.Vector.pos(0,0,15));for(var i=0;i<e;i+=.1)t.push(YFM.Math.Vector.pos(Math.cos(i),Math.sin(i),15));var r,s,o=[];for(r=1,s=t.length-1;r<s;r++)o.push(t[r]),o.push(t[0]),o.push(t[r+1]);o.push(t[r]),o.push(t[0]),o.push(t[1]),this.markerAnim.circleVBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.markerAnim.circleVBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(o,3),this.gl.STATIC_DRAW),this.markerAnim.circleSize=o.length,this.markerAnim.waveRadius=YFM.Math.Vector.vec(12,12),this.markerAnim.waveMax=48,this.markerAnim.waveMin=12,this.markerAnim.waveStep=(this.markerAnim.waveMax-this.markerAnim.waveMin)/56,this.markerAnim.waveColor=YFM.Math.Vector.vec(0,0,.8,.5),this.markerAnim.id=-1}},RegionLocMarker.prototype={constructor:RegionLocMarker,locateLaunch:function(){this.waveRadius[0]=this.waveMax,this.waveRadius[1]=this.waveMax},set2DMarkerParam:function(t,e,i,r){var s=YFM.Math.Vector,o=YFM.WebGL.Color;this.locMarkerTexName=t,this.locMarker=null,this.waveColor=s.vec(o.hexColorRed(e),o.hexColorGreen(e),o.hexColorBlue(e),o.hexColorAlpha(e)),this.waveMax=i,this.waveMin=r,this.waveStep=(this.waveMax-this.waveMin)/56},getRegionLoc:function(){return YFM.Math.Vector.vecClone(this.regionLoc)},getFloorLoc:function(){return{floor:this.floorLoc.floor,x:this.floorLoc.x,y:this.floorLoc.y}},getSize:function(){return this.size},updateLocation:function(){-1!==this.floorLoc.floor&&(this.regionLoc=this.region.floorPos2RegionPos(this.floorLoc.floor,this.floorLoc.x,this.floorLoc.y),YFM.Map.STATUS_TOUCH!=this.region.getStatus()&&this.region._traceLoc(this.regionLoc[0],this.regionLoc[1],this.regionLoc[2]),this.region.updateNaviStatus(this.floorLoc,this.regionLoc))},cleanLocation:function(){this.floorLoc.floor=-1,this.floorLoc.x=0,this.floorLoc.y=0},setLocation:function(t,e,i){this.floorLoc.floor=t,this.floorLoc.x=e,this.floorLoc.y=i,this.regionLoc=this.region.floorPos2RegionPos(t,e,i),YFM.Map.STATUS_TOUCH!=this.region.getStatus()&&this.region._traceLoc(this.regionLoc[0],this.regionLoc[1],this.regionLoc[2]),this.region.updateNaviStatus(this.floorLoc,this.regionLoc)},animTo:function(t,e,i){t!=this.floorLoc.floor?(this.anim.flag=!1,this.setLocation(t,e,i)):(this.anim.floor=t,this.anim.flag=!0,this.anim.target=YFM.Math.Vector.pos(e,i,0),this.anim.mover.setLocation(this.floorLoc.x,this.floorLoc.y,0))},render:function(t,e,i,r){if(this._updateAnim(),i&&!(this.floorLoc.floor<0)){if(!this.locMarker&&this.locMarkerTexName){var s=this.region.getTexture(this.locMarkerTexName);null!==s&&(this.locMarker={tex:s.tex,texSize:YFM.Math.Vector.vec(s.w/2,s.h/2)})}if(this.locMarker){var o,n,a,h,u=YFM.Math.Matrix.mulVec(r,this.regionLoc);a=this.region.glCanvas.width/2,h=this.region.glCanvas.height/2,u[0]/=u[3],u[1]/=u[3],u[2]/=u[3],u[3]/=u[3],u[0]*=a,u[1]*=h,this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),o=YFM.Math.Matrix.scaleXYZ(this.waveRadius,0,0,0),n=YFM.Math.Matrix.postTranslate(o,u[0],u[1],0),t.setModelMatrix(n),t.drawTriangles(this.circleVBO,this.waveColor,0,this.circleSize),this.waveRadius[0]>this.waveMin?(this.waveRadius[0]-=this.waveStep,this.waveRadius[1]-=this.waveStep):(this.waveRadius[0]=this.waveMin,this.waveRadius[1]=this.waveMin),e.useProgram(),e.bindTexture(this.locMarker.tex);var l=this.region.getFloorDeflection(this.floorLoc.floor)-(this.region.azimuth+this.region.getFloorAngle(this.floorLoc.floor));o=YFM.Math.Matrix.scaleXYZ(this.locMarker.texSize,0,0,0),o=YFM.Math.Matrix.postTranslate(YFM.Math.Matrix.postRotateXY(o,l,0,0),u[0],u[1],0),e.setModelMatrix(o),e.drawTriangles(this.quadVBO,6,0),this.gl.disable(this.gl.BLEND)}}},_updateAnim:function(){if(this.anim.flag)if(this.anim.mover.arrive(this.anim.target,this.anim.dist))this.anim.flag=!1,this.setLocation(this.anim.floor,this.anim.target[0],this.anim.target[1]);else{this.anim.mover.update();var t=this.anim.mover.getLocation();this.setLocation(this.anim.floor,t[0],t[1])}},_init:function(t,e){var i=YFM.Math.Vector,r=2.5*e,s=[];s.push(i.pos(0,0,0)),s.push(i.pos(0,e,r)),s.push(i.pos(e,0,r)),s.push(i.pos(0,-e,r)),s.push(i.pos(-e,0,r));var o=[];o.push(s[4]),o.push(s[2]),o.push(s[1]),o.push(s[2]),o.push(s[4]),o.push(s[3]),o.push(s[0]),o.push(s[4]),o.push(s[1]),o.push(s[0]),o.push(s[1]),o.push(s[2]),o.push(s[0]),o.push(s[2]),o.push(s[3]),o.push(s[0]),o.push(s[3]),o.push(s[4]),o.push(s[0]),o.push(s[1]),o.push(s[0]),o.push(s[2]),o.push(s[0]),o.push(s[3]),o.push(s[0]),o.push(s[4]),o.push(s[1]),o.push(s[2]),o.push(s[2]),o.push(s[3]),o.push(s[3]),o.push(s[4]),o.push(s[4]),o.push(s[1]),this.trianglesVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.trianglesVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(o,3),t.STATIC_DRAW);var n=[],a=2*Math.PI;n.push(i.pos(0,0,15));for(var h=0;h<a;h+=.1)n.push(i.pos(Math.cos(h),Math.sin(h),15));var u,l,c=[];for(u=1,l=n.length-1;u<l;u++)c.push(n[u]),c.push(n[0]),c.push(n[u+1]);c.push(n[u]),c.push(n[0]),c.push(n[1]),this.circleVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.circleVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(c,3),t.STATIC_DRAW),this.circleSize=c.length;var d=[],g=[],p=[];p.push(YFM.Math.Vector.vec(0,1)),p.push(YFM.Math.Vector.vec(1,1)),p.push(YFM.Math.Vector.vec(1,0)),p.push(YFM.Math.Vector.vec(0,0)),g.push(YFM.Math.Vector.pos(-1,-1,0)),g.push(YFM.Math.Vector.pos(1,-1,0)),g.push(YFM.Math.Vector.pos(1,1,0)),g.push(YFM.Math.Vector.pos(-1,1,0)),d.push(g[0]),d.push(p[0]),d.push(g[1]),d.push(p[1]),d.push(g[2]),d.push(p[2]),d.push(g[0]),d.push(p[0]),d.push(g[2]),d.push(p[2]),d.push(g[3]),d.push(p[3]),this.quadVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.quadVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(d,3),t.STATIC_DRAW)}},RegionThumbnail.prototype={constructor:RegionThumbnail,setVisibility:function(t){this.visibility=t},persistence:function(){var t=YFM.Math.Matrix,e={};return e.projMat=t.matClone(this.renderParam.projMat),e.viewMat=t.matClone(this.renderParam.viewMat),e.regionMat=t.matClone(this.renderParam.regionMat),e},getPVRMat:function(){return YFM.Math.Matrix.matClone(this.renderParam.pvrMat)},isEnable:function(){return!!this.renderParam},cleanStatus:function(){this.renderParam=null},setParam:function(t){var e=YFM.Math.Matrix;this.renderParam={},this.renderParam.regionMat=e.matClone(t.regionMat),this.renderParam.projMat=e.matClone(t.projMat),this.renderParam.viewMat=e.matClone(t.viewMat),this.renderParam.vrMat=e.mul(this.renderParam.viewMat,this.renderParam.regionMat),this.renderParam.itvrMat=YFM.Math.Matrix.invert(YFM.Math.Matrix.transpose(this.renderParam.vrMat)),this.renderParam.pvrMat=e.mul(e.mul(this.renderParam.projMat,this.renderParam.viewMat),this.renderParam.regionMat)},setScaleRate:function(t){this.scaleRate=t},saveStatus:function(){var t=YFM.Math.Matrix;this.renderParam={},this.renderParam.regionMat=t.postScale(this.region._getRegionMat(),this.scaleRate,0,0,0),this.renderParam.projMat=t.matClone(this.region.camera.getProjectionMat()),this.renderParam.viewMat=t.matClone(this.region.camera.getViewMat()),this.renderParam.vrMat=YFM.Math.Matrix.mul(this.renderParam.viewMat,this.renderParam.regionMat),this.renderParam.pvrMat=YFM.Math.Matrix.mul(this.region.camera.getPVMat(),this.renderParam.regionMat)},render:function(){if(this.visibility&&this.renderParam){var t,e,i;for(t=this.region.floors.length,(i=this.region.gl).clear(i.DEPTH_BUFFER_BIT),this.region.frustum.update(this.renderParam.pvrMat),e=0;e<t;e++)this._renderFloor(e);this.region.route.renderThumbnail()}},_renderFloor:function(t){this.region.baseColorShader.useProgram(),this.region.baseColorShader.setProjectionMatrix(this.renderParam.projMat),this.region.baseColorShader.setViewMatrix(this.renderParam.viewMat),this.region.baseColorShader.setRegionMatrix(this.renderParam.regionMat),this.region.floors[t].renderBase(this.region.baseColorShader,!1,!0),this.region.basePhongShader.useProgram(),this.region.basePhongShader.setPVRMatrix(this.renderParam.pvrMat),this.region.basePhongShader.setNormalMatrix(this.renderParam.itvrMat),this.region.floors[t].renderExtrude(this.region.basePhongShader,this.renderParam.vrMat,this.extrudeLight,!0)}},RegionTouchMgr.prototype={constructor:RegionTouchMgr,PITCH_LIMIT:-60,setUIScaleRate:function(t){this.uiScaleRate=t},getViewOffsetMax:function(){return this.viewZoom.max},getViewOffsetMin:function(){return this.viewZoom.min},setEnable:function(t){this.enable=t},onRegionLoadFinish:function(){this.focusFloorDirty=!0},getTouchFloor:function(){return this.touchFloorIndex},getFocusFloorIndex:function(){if(-1!==this.region.displayFloorIndex)return this.region.displayFloorIndex;if(!this.focusFloorDirty)return this.focusFloorIndex;var t,e,i,r,s,o,n=-1;for(i=-1e8,o=-1,s=-1,e=(t=this._floors_collision(this.canvas.width/2,this.canvas.height/2)).length,r=0;r<e;r++)t[r]<0&&t[r]>i&&(i=t[r],o=r),0==t[r]&&(s=r);return s>=0?n=s:o>=0&&(n=o),this.focusFloorIndex=n,this.focusFloorDirty=!1,this.focusFloorIndex},setZoomMax:function(t){this.viewZoom.max=t},setZoomMin:function(t){this.viewZoom.min=t},postTranslate:function(t,e){var i=YFM.Math.Matrix.matClone(this.region._getRegionMat()),r=YFM.Math.Matrix.postTranslate(i,t,e,0);this._mapConstraint(this.camera.getPVMat(),r)||(this.region._setRegionMat(r),this._onScroll(t,e),this.focusFloorDirty=!0)},postRotate:function(t){var e=this._pos_in_world_space(this.region.hw,this.region.hh),i=YFM.Math.Matrix.matClone(this.region._getRegionMat()),r=YFM.Math.Matrix.postRotateXY(i,t,e[0],e[1]);this._mapConstraint(this.camera.getPVMat(),r)||(this.region._setRegionMat(r),this.focusFloorDirty=!0)},getTouchRayPlus:function(t,e){var i,r,s,o,n,a,h,u;return i=t/this.canvas.width*2-1,r=-(e/this.canvas.height*2-1),s=YFM.Math.Vector.pos(i,r,-1),o=YFM.Math.Vector.pos(i,r,1),h=YFM.Math.Matrix.mul(this.camera.getPVMat(),this.region.matRegion),u=YFM.Math.Matrix.invert(h),n=YFM.Math.Matrix.mulVec(u,s),a=YFM.Math.Matrix.mulVec(u,o),n[0]/=n[3],n[1]/=n[3],n[2]/=n[3],n[3]/=n[3],a[0]/=a[3],a[1]/=a[3],a[2]/=a[3],a[3]/=a[3],YFM.Math.Line.linePP(n,a)},_onMouseDown:function(t,e){},_onScroll:function(t,e){null!==this.listener&&this.listener.onScroll(t,e)},_onClick:function(t,e){null!==this.listener&&this.listener.onClick(t,e)},_onDClick:function(t,e){null!==this.listener&&this.listener.onDClick(t,e)},_on2FClick:function(t,e){null!==this.listener&&this.listener.on2FClick(t,e)},_onLongPressUp:function(t,e){null!==this.listener&&this.listener.onLongPressUp(t,e)},_spacingScreenSpace:function(t,e,i,r){var s=i-t,o=r-e;return Math.sqrt(s*s+o*o)},_spacingViewSpace:function(t,e,i,r){var s=this._pos_in_view_space(t,e),o=this._pos_in_view_space(i,r),n=o[0]-s[0],a=o[1]-s[1];return{z:(s[2]+o[2])/2,spacing:Math.sqrt(n*n+a*a)}},_midpoint:function(t,e,i,r){var s,o;return s=(t+i)/2,o=(e+r)/2,this.touchRec.midX=s,this.touchRec.midY=o,this.touchRec.dy0=e-o,this.touchRec.dy1=r-o,this._pos_in_world_space(s,o)},_calc_angle:function(t){var e=this._pos_in_world_space(this.touchRec.layer0x,this.touchRec.layer0y),i=this._pos_in_world_space(this.touchRec.layer1x,this.touchRec.layer1y);return Math.atan2(i[1]-e[1],i[0]-e[0])},_pitch_calc:function(t){return YFM.Math.radian2Deg(YFM.Math.Matrix.eulerParamExtractX(t))},_pitch_detect_continue:function(t){if(t.touches.length<2)return!1;var e,i;return e=this.touchRec.layer0y-this.touchRec.start0y,i=this.touchRec.layer1y-this.touchRec.start1y,e*i>0?this.touchRec.pitchCnt++:this.touchRec.pitchCnt--,this.touchRec.pitchCnt>36},_touch_plane_height:function(t,e){if(-1!==this.region.displayFloorIndex)return this.touchFloorIndex=this.region.displayFloorIndex,this.region._getFloorVOffset(this.region.displayFloorIndex);var i,r,s,o,n,a,h=-1;for(s=-1e8,a=-1,n=-1,r=(i=this._floors_collision(t,e)).length,o=0;o<r;o++)i[o]<0&&i[o]>s&&(s=i[o],a=o),0==i[o]&&(n=o);return n>=0?h=n:a>=0&&(h=a),this.touchFloorIndex=h,this.region._getFloorVOffset(h)},_floors_collision:function(t,e){var i=this.getTouchRayPlus(t,e);return this.region._intersectionLine(i)},_pitch_detect_first:function(t){if(t.touches.length<2)return!1;var e,i,r;return i=mgr.touchRec.layer0y-this.touchRec.midY-this.touchRec.dy0,r=mgr.touchRec.layer1y-this.touchRec.midY-this.touchRec.dy1,this.touchRec.pitchCnt=0,e=!1,i*r>0&&(e=!0),e},_pos_in_world_space:function(t,e){var i,r,s,o,n,a,h,u,l,c;return r=t/this.canvas.width*2-1,s=-(e/this.canvas.height*2-1),o=YFM.Math.Vector.pos(r,s,-1),n=YFM.Math.Vector.pos(r,s,1),u=this.camera.getIPVMat(),a=YFM.Math.Matrix.mulVec(u,o),h=YFM.Math.Matrix.mulVec(u,n),a[0]/=a[3],a[1]/=a[3],a[2]/=a[3],a[3]/=a[3],h[0]/=h[3],h[1]/=h[3],h[2]/=h[3],h[3]/=h[3],c=YFM.Math.Line.linePP(a,h),l=YFM.Math.Plane.plane(0,0,this.planeRec.planeHeight,0,0,1),i=YFM.Math.Plane.intersectionLine(l,c),YFM.Math.Line.getPoint(c,i)},_pos_in_view_space:function(t,e){var i=this._pos_in_world_space(t,e);return this._world_to_view(i)},_world_to_view:function(t){return YFM.Math.Matrix.mulVec(this.camera.getViewMat(),t)},_setOverlook:function(t){this.overlook=t},_screen_to_map:function(t,e){if(this.touchFloorIndex>=0){var i=this._pos_in_world_space(t,e),r=this.region._getFloorMat(this.touchFloorIndex),s=this.region._getRegionMat(),o=YFM.Math.Matrix.mul(s,r),n=YFM.Math.Matrix.invert(o),a=YFM.Math.Matrix.mulVec(n,i);return{floor:this.touchFloorIndex,x:a[0],y:this.region.getFloorAspect(this.touchFloorIndex).h-a[1]}}return null},_updateEventLayerPos:function(t){t.touches&&t.touches.length>=1?(this.touchRec.layer0x=(t.touches[0].pageX-this.box.left)/this.uiScaleRate,this.touchRec.layer0y=(t.touches[0].pageY-this.box.top)/this.uiScaleRate,t.touches.length>=2?(this.touchRec.layer1x=(t.touches[1].pageX-this.box.left)/this.uiScaleRate,this.touchRec.layer1y=(t.touches[1].pageY-this.box.top)/this.uiScaleRate):(this.touchRec.layer1x=0,this.touchRec.layer1y=0)):(this.touchRec.layer0x=t.layerX/this.uiScaleRate,this.touchRec.layer0y=t.layerY/this.uiScaleRate)},_mapConstraint:function(t,e){var i,r,s,o,n,a,h,u,l=YFM.Math.Matrix,c=YFM.Math.Vector;i=c.pos(0,0,-1),r=c.pos(0,0,1),n=l.mul(t,this.region.matRegion),a=l.invert(n),s=l.mulVec(a,i),o=l.mulVec(a,r),s[0]/=s[3],s[1]/=s[3],s[2]/=s[3],s[3]/=s[3],o[0]/=o[3],o[1]/=o[3],o[2]/=o[3],o[3]/=o[3],h=YFM.Math.Line.linePP(s,o),n=l.mul(this.camera.getPVMat(),e),a=l.invert(n),s=l.mulVec(a,i),o=l.mulVec(a,r),s[0]/=s[3],s[1]/=s[3],s[2]/=s[3],s[3]/=s[3],o[0]/=o[3],o[1]/=o[3],o[2]/=o[3],o[3]/=o[3],u=YFM.Math.Line.linePP(s,o);var d;d=this.touchFloorIndex<0?this.region.displayFloorIndex:this.touchFloorIndex;var g=this.region.floors[d],p=g.intersectionLine(h);return g.intersectionLine(u)<p},_isMobileBrowser:function(){var t=navigator.userAgent.toLowerCase(),e="ipad"==t.match(/ipad/i),i="iphone os"==t.match(/iphone os/i),r="midp"==t.match(/midp/i),s="rv:1.2.3.4"==t.match(/rv:1.2.3.4/i),o="ucweb"==t.match(/ucweb/i),n="android"==t.match(/android/i),a="windows ce"==t.match(/windows ce/i),h="windows mobile"==t.match(/windows mobile/i);return e||i||r||s||o||n||a||h}},SSRoute.prototype={constructor:SSRoute,enableRouteMover:function(t,e){this.routeMover.enable=t,t&&(this.routeMover.callback=e)},setDisplayFloor:function(t){this.displayFloor=t,this.dataLoad&&this._buildVBOFromSeglist()},getNaviStatus:function(){return this.naviStatus.validate?{validate:this.naviStatus.validate,projDist:this.naviStatus.projDist,goalDist:this.naviStatus.goalDist,globalDist:this.naviStatus.globalDist,serialDist:this.naviStatus.serialDist,nextSerialDist:this.naviStatus.nextSerialDist,azimuth:this.naviStatus.azimuth,sug:this.naviStatus.sug,nextSug:this.naviStatus.nextSug}:{validate:!1}},getRouteCenter:function(t){return t>=0?this.floorRouteList[t].box?YFM.Math.Vector.vecClone(this.floorRouteList[t].box.center):null:this.obb?YFM.Math.Vector.vecClone(this.obb.center):null},getRouteRAxis:function(t){return t>=0?this.floorRouteList[t].box?YFM.Math.Vector.vecClone(this.floorRouteList[t].box.r):null:this.obb?YFM.Math.Vector.vecClone(this.obb.r):null},getRouteOBBLength:function(t){if(t>=0){if(this.floorRouteList[t].box){var e=this.floorRouteList[t].box.hr,i=this.floorRouteList[t].box.hs;return 2*Math.sqrt(e*e+i*i)}return 0}if(this.obb){var e=this.obb.hr,i=this.obb.hs,r=this.obb.ht;return 2*Math.sqrt(e*e+i*i+r*r)}return 0},setRoute:function(t){this.routeData=t,this.cleanRoute();var e,i,r,s,o,n,a,h,u,l,c=[];for(n=this.region.getFloorCount(),this.floorRouteList=[],this.globalSegList=[],u=0;u<n;u++)this.floorRouteList.push(new FloorRoute(u,this.region,this));for(a=t.length,u=0;u<a;u++)s=t[u],(r=this.region.floorPos2RegionPos(s.floor,s.x,s.y))[2]+=this.routeHeight,c.push(r);for(this.obb=new OBB(c),l=t[0].floor,u=0;u<a-1;u++)s=t[u],(o=t[u+1]).floor===l?this.floorRouteList[l].addSeg(c[u],c[u+1]):l=o.floor;for(u=0;u<n;++u)this.floorRouteList[u].makeBox();h=0;var d;for(u=this.globalSegList.length-1;u>=0;--u)(d=this.globalSegList[u]).updateFolowLen(h),h+=d.len;this._buildVBOFromSeglist(),this.region.regionThumbnail.isEnable()&&this._buildRouteThumbnail(this.region.regionThumbnail.getPVRMat()),-1!=(e=this.region.getFloorLoc()).floor&&(i=this.region.getRegionLoc(),this.updateNaviStatus(e,i)),this.dataLoad=!0},cleanRoute:function(){this.floorRouteList=null,this.globalSegList=null,this._clean(),this.dataLoad=!1},addGlobalSeg:function(t,e){e&&this.globalSegList.pop(),this.globalSegList.push(t)},setUpdateNSFlag:function(t){var e=!this.updateNSFlag&&t,i=this.updateNSFlag&&!t;if(e){this.updateNSFlag=!0;var r=this.region.getFloorLoc();if(-1!==r.floor){var s=this.region.getRegionLoc();this.updateNaviStatus(r,s)}}else i&&(this.updateNSFlag=!1,this.naviStatus.validate=!1)},updateNaviStatus:function(t,e){this.updateNSFlag&&(this.floorRouteList?-1===t.floor?this.naviStatus.validate=!1:this.floorRouteList[t.floor].makeNaviStatus(this.naviStatus,e):this.naviStatus.validate=!1)},renderThumbnail:function(){if(this.polylineThumbnail){var t=this.region.gl,e=this.region.ssrShader,i=this.region.texturePool;e.useProgram(),e.setTime(this.timeThumbnail);var r=i.getTexture("route_tex");null!=r&&(e.bindTexture(r.tex),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),e.setTranFlag(1),e.drawTriangleStrip(this.polylineThumbnail,0),t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),e.setTranFlag(0),e.drawTriangleStrip(this.polylineThumbnail,0),t.disable(t.DEPTH_TEST),t.disable(t.BLEND),this.timeThumbnail-=.01)}},render:function(t){if(this.polylineZ){this._update(t);var e=this.region.gl,i=this.region.ssrShader,r=this.region.texturePool;i.useProgram(),i.setTime(this.time);var s=0,o=r.getTexture("route_tex"),n=!0;if(null!=o&&(i.bindTexture(o.tex),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),-1!==this.displayFloor&&this.displayFloor!==this.region.getFloorLoc().floor&&(n=!1),this.naviStatus.validate&&this.updateNSFlag&&n&&(s=6*this.naviStatus.miniOffset),i.setTranFlag(1),i.drawTriangleStrip(this.polylineZ,s),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),i.setTranFlag(0),i.drawTriangleStrip(this.polylineZ,s),this.naviStatus.validate&&n&&this._renderTail(t),e.disable(e.DEPTH_TEST),e.disable(e.BLEND),this.time-=.01,this.routeMover.enable&&this.routeMover.callback)){var a=this.region.regionPos2Screen(this.routeMover.position);this.routeMover.callback(a)}}},_initTail:function(){this.tailMesh=new IcosahedronMesh(this.region.gl,4)},_renderTail:function(t){var e=this.region.regionPhongShader;e.useProgram(),e.setProjectionMatrix(t.projMat),e.setViewMatrix(t.viewMat),e.setRegionMatrix(t.regionMat),e.setColor(this.tailColor);var i=YFM.Math.Matrix.transpose(t.vrMat),r=YFM.Math.Matrix.invert(i);e.setLightPos(this.light),e.setNormalMatrix(r);var s,o,n,a,h,u,l;for(n=this.naviStatus.projection,a=YFM.Math.Vector.normalize(YFM.Math.Vector.sub(this.region.getRegionLoc(),n)),h=this.naviStatus.projDist,u=4*this.tailSize,l=0,s=YFM.Math.Matrix.scale(this.tailSize,0,0,0);l<h;)o=YFM.Math.Vector.add(n,YFM.Math.Vector.scale(a,l)),e.setModelMatrix(YFM.Math.Matrix.postTranslate(s,o[0],o[1],o[2]+this.tailSize)),e.drawTriangles(this.tailMesh.getMeshVBO(),this.tailMesh.getMeshBufSize(),0),l+=u},_buildRouteThumbnail:function(t){var e,i,r,s=[];for(r=this.globalSegList.length,currentFloor=this.globalSegList[0].floor,a=0;a<r;a++)e=this.globalSegList[a],a<r-1?(i=this.globalSegList[a+1]).floor===currentFloor?s.push(e.start):(currentFloor=i.floor,s.push(e.start),s.push(e.end)):(s.push(e.start),s.push(e.end));this.polylineThumbnail&&(this.polylineThumbnail.recycle(),this.polylineThumbnail=null);var o,n,a,h,u,l,c,d=YFM.Math.Matrix,g=YFM.Math.Vector,p=[],M=[],f=[],m=[],v=[],x=[],F=g.pos(0),_=g.pos(0),y=(g.pos(0),g.pos(0)),R=g.vec(0),T=g.vec(0),b=g.vec(0);for(o=0,lineDist=0,a=0,h=s.length;a<h-1;a++)this._pos2ScreenTo(F,s[a],t,this.region.hw,this.region.hh),this._pos2ScreenTo(y,s[a+1],t,this.region.hw,this.region.hh),g.midTo(_,F,y),g.subTo(R,y,F),n=g.norm3(R),g.normalizeTo(R),d.mulVecTo(this.rotateLeft,R,T),g.scaleTo(T,this.width),d.mulVecTo(this.rotateRight,R,b),g.scaleTo(b,this.width),u=o/this.stepLen,l=(o+n/2)/this.stepLen,c=(o+n)/this.stepLen,o+=n,p.push(g.add(F,T)),M.push(g.pos(0,u)),f.push(g.add(F,b)),m.push(g.pos(1,u)),p.push(g.add(_,T)),M.push(g.pos(0,l)),f.push(g.add(_,b)),m.push(g.pos(1,l)),p.push(g.add(y,T)),M.push(g.pos(0,c)),f.push(g.add(y,b)),m.push(g.pos(1,c));for(h=p.length,a=0;a<h;a++)v.push(f[a]),x.push(m[a]),v.push(p[a]),x.push(M[a]);this.polylineThumbnail=new VAttribs(this.region.gl),this.polylineThumbnail.addAttribute("position",v,3,!1),this.polylineThumbnail.addAttribute("uv",x,2,!1)},_buildVBOFromSeglist:function(){var t,e,r,s=[];if(-1===this.displayFloor){for(r=this.globalSegList.length,currentFloor=this.globalSegList[0].floor,i=0;i<r;i++)t=this.globalSegList[i],i<r-1?(e=this.globalSegList[i+1]).floor===currentFloor?s.push(t.start):(currentFloor=e.floor,s.push(t.start),s.push(t.end)):(s.push(t.start),s.push(t.end));this._build(s)}else{var o=this.floorRouteList[this.displayFloor].segList;if(o.length<=0)this._clean();else{for(r=o.length,i=0;i<r;i++)t=o[i],i<r-1?s.push(t.start):(s.push(t.start),s.push(t.end));this._build(s)}}},_build:function(t){this.handledPts=t,this.polylineZ&&(this.polylineZ.recycle(),this.polylineZ=null);var e=YFM.Math.Matrix,i=YFM.Math.Vector;this.vArrayL=[],this.tArrayL=[],this.vArrayR=[],this.tArrayR=[],this.vArrayZ=[],this.tArrayZ=[];var r,s,o,n,a,h,u,l=i.pos(0),c=i.pos(0),d=(i.pos(0),i.pos(0)),g=i.vec(0),p=i.vec(0),M=i.vec(0);for(r=0,lineDist=0,o=0,n=this.handledPts.length;o<n-1;o++)i.midTo(c,l,d),i.subTo(g,d,l),s=i.norm3(g),i.normalizeTo(g),e.mulVecTo(this.rotateLeft,g,p),i.scaleTo(p,this.width),e.mulVecTo(this.rotateRight,g,M),i.scaleTo(M,this.width),a=r/this.stepLen,h=(r+s/2)/this.stepLen,u=(r+s)/this.stepLen,r+=s,this.vArrayL.push(i.add(l,p)),this.tArrayL.push(i.pos(0,a)),this.vArrayR.push(i.add(l,M)),this.tArrayR.push(i.pos(1,a)),this.vArrayL.push(i.add(c,p)),this.tArrayL.push(i.pos(0,h)),this.vArrayR.push(i.add(c,M)),this.tArrayR.push(i.pos(1,h)),this.vArrayL.push(i.add(d,p)),this.tArrayL.push(i.pos(0,u)),this.vArrayR.push(i.add(d,M)),this.tArrayR.push(i.pos(1,u));for(n=this.vArrayL.length,o=0;o<n;o++)this.vArrayZ.push(this.vArrayR[o]),this.tArrayZ.push(this.tArrayR[o]),this.vArrayZ.push(this.vArrayL[o]),this.tArrayZ.push(this.tArrayL[o]);this.polylineZ=new VAttribs(this.region.gl),this.polylineZ.addAttribute("position",this.vArrayZ,3,!1),this.polylineZ.addAttribute("uv",this.tArrayZ,2,!1),this.routeMover.enable&&(this.routeMover.ppolyline=new PPolyline(this.handledPts),this.routeMover.index=0,this.routeMover.t=0,this.routeMover.direction=1,this.routeMover.vt=this.routeMover.velocity/this.routeMover.ppolyline.getSumLength())},_projection:function(t,e,i,r){var s=YFM.Math.Vector.sub(t,e),o=YFM.Math.Vector.sub(i,e),n=YFM.Math.Vector.dot3(o,o),a=YFM.Math.Vector.dot3(s,o)/n;a<=0?a=0:a>=1&&(a=1),r.pos=YFM.Math.Vector.add(e,YFM.Math.Vector.scale(o,a)),r.t=a},_update:function(t){var e,i,r,s,o,n,a,h,u,l,c=YFM.Math.Matrix,d=YFM.Math.Vector,g=d.pos(0),p=d.pos(0),M=d.pos(0),f=d.vec(0),m=d.vec(0),v=d.vec(0),x=t.pvrMat,F=this.region.getRegionLoc(),_={pos:null,t:0};u=Number.MAX_VALUE,e=0;var y=!0;if(-1!==this.displayFloor&&this.displayFloor!==this.region.getFloorLoc().floor&&(y=!1),this.naviStatus.validate&&y)for(r=0,s=this.handledPts.length;r<s-1;r++)this._projection(F,this.handledPts[r],this.handledPts[r+1],_),(h=YFM.Math.Vector.distanceSQ(F,_.pos))<=u&&(u=h,l=_.pos,this.naviStatus.miniOffset=r);else this.naviStatus.miniOffset=0;for(r=this.naviStatus.miniOffset,s=this.handledPts.length;r<s-1;r++)this.naviStatus.validate&&r==this.naviStatus.miniOffset&&y?this._pos2ScreenTo(g,l,x,this.region.hw,this.region.hh):this._pos2ScreenTo(g,this.handledPts[r],x,this.region.hw,this.region.hh),this._pos2ScreenTo(M,this.handledPts[r+1],x,this.region.hw,this.region.hh),d.midTo(p,g,M),d.subTo(f,M,g),i=d.norm3(f),d.normalizeTo(f),c.mulVecTo(this.rotateLeft,f,m),d.scaleTo(m,this.width),c.mulVecTo(this.rotateRight,f,v),d.scaleTo(v,this.width),o=e/this.stepLen,n=(e+i/2)/this.stepLen,a=(e+i)/this.stepLen,e+=i,d.addTo(this.vArrayL[3*r+0],g,m),this.tArrayL[3*r+0][1]=o,d.addTo(this.vArrayR[3*r+0],g,v),this.tArrayR[3*r+0][1]=o,d.addTo(this.vArrayL[3*r+1],p,m),this.tArrayL[3*r+1][1]=n,d.addTo(this.vArrayR[3*r+1],p,v),this.tArrayR[3*r+1][1]=n,d.addTo(this.vArrayL[3*r+2],M,m),this.tArrayL[3*r+2][1]=a,d.addTo(this.vArrayR[3*r+2],M,v),this.tArrayR[3*r+2][1]=a;this.polylineZ.updateAttribute("position",this.vArrayZ),this.polylineZ.updateAttribute("uv",this.tArrayZ),this.routeMover.enable&&this._updateRouteMover()},_updateRouteMover:function(){this.routeMover.t+=this.routeMover.vt,this.routeMover.t>1&&(this.routeMover.t=0);var t=this.routeMover.ppolyline.getPoint(this.routeMover.index,this.routeMover.t);this.routeMover.position=t.pos,this.routeMover.index=t.seg.index},_clean:function(){this.polylineZ&&(this.polylineZ.recycle(),this.polylineZ=null),this.handledPts=null},_pos2Screen:function(t,e,i,r){var s=YFM.Math.Matrix.mulVec(e,t);return s[0]/=s[3],s[1]/=s[3],s[2]/=s[3],s[3]/=s[3],s[0]=s[0]*i,s[1]=s[1]*r,s},_pos2ScreenTo:function(t,e,i,r,s){YFM.Math.Matrix.mulVecTo(i,e,t),t[3]>0?(t[0]/=t[3],t[1]/=t[3],t[2]/=t[3],t[3]/=t[3]):t[3]<0&&(t[0]/=-t[3],t[1]/=-t[3],t[2]/=-t[3],t[3]/=-t[3]),t[0]=t[0]*r,t[1]=t[1]*s},_radiusPointPlus:function(t,e,i){var r=t.length;if(i<=0||i>=r-1)e.push(t[i]);else{var s,o,n,a,h,u,l,c,d,g,p,M,f,m,v,x=YFM.Math.Matrix,F=YFM.Math.Vector;e[e.length-1];if(n=t[i-1],s=t[i],o=t[i+1],Math.abs(s[2]-n[2])>1||Math.abs(s[2]-o[2])>1)e.push(s);else{a=F.normalize(F.sub(n,s)),h=F.normalize(F.sub(o,s)),u=F.normalize(F.add(a,h)),l=F.scale(u,-1*this.width),c=F.sub(s,n),d=F.sub(o,s),m=F.cross(c,d),p=1.5708463-(g=Math.acos(F.dot3(u,h))),M=this.width/Math.sin(g),f=this.width/Math.tan(g),v=F.add(s,F.scale(u,M));var _=[],y=x.rotateXY(-p,v[0],v[1],!0),R=p/3,T=x.rotateXY(R,v[0],v[1],!0);l=x.mulVec(y,l),_.push(F.add(s,F.scale(a,f))),l=x.mulVec(T,l),_.push(F.add(v,l)),l=x.mulVec(T,l),_.push(F.add(v,l)),l=x.mulVec(T,l),_.push(F.add(v,l)),l=x.mulVec(T,l),_.push(F.add(v,l)),l=x.mulVec(T,l),_.push(F.add(v,l)),l=x.mulVec(T,l),_.push(F.add(s,F.scale(h,f))),m[2]>0?(e.push(_[0]),e.push(_[1]),e.push(_[2]),e.push(_[3]),e.push(_[4]),e.push(_[5]),e.push(_[6])):(e.push(_[0]),e.push(_[5]),e.push(_[4]),e.push(_[3]),e.push(_[2]),e.push(_[1]),e.push(_[6]))}}}},RouteSeg.prototype={constructor:RouteSeg,updateFolowLen:function(t){this.followLen=t},updateEnd:function(t){this.end=t,this.segVec=YFM.Math.Vector.sub(this.end,this.start),this.lenSQ=YFM.Math.Vector.dot3(this.segVec,this.segVec),this.len=Math.sqrt(this.lenSQ),this.azimuth=this._makeAzimuth()},getPoint:function(t){return YFM.Math.Vector.add(this.start,YFM.Math.Vector.scale(this.segVec,t))},projection:function(t){var e=YFM.Math.Vector.sub(t,this.start),i=YFM.Math.Vector.dot3(e,this.segVec)/this.lenSQ;return i<=0?0:i>=1?1:i},_makeAzimuth:function(){var t=YFM.Math.Vector.vec(0,1,0),e=YFM.Math.Vector.normalize(this.segVec),i=YFM.Math.Vector.dot3(e,t),r=Math.acos(i);return e[0]>0&&(r=2*Math.PI-r),r}},FloorRoute.prototype={constructor:FloorRoute,makeBox:function(){this.lastPos&&(this.posList.push(this.lastPos),this.box=new OBB(this.posList))},addSeg:function(t,e){this.posList.push(t),this.lastPos=e;var i,r,s=new RouteSeg(t,e,this.floor),o=YFM.Math.Vector.normalize(s.segVec);null!=this.lastSegVec?(i=YFM.Math.Vector.dot3(o,this.lastSegVec),Math.abs(i-1)<1e-5?((r=this.segList.pop()).updateEnd(e),this.segList.push(r),this.route.addGlobalSeg(r,!0)):(this.segList.push(s),this.route.addGlobalSeg(s,!1))):(this.segList.push(s),this.route.addGlobalSeg(s,!1)),this.lastSegVec=o},makeNaviStatus:function(t,e){var i,r,s,o,n,a,h,u,l=this.segList.length;if(l<=0)t.validate=!1;else{t.validate=!0,n=Number.MAX_VALUE;var c=l;if(c<=0)return void(t.validate=!1);for(a=0;a<c;a++)i=this.segList[a].projection(e),r=this.segList[a].getPoint(i),(o=YFM.Math.Vector.distanceSQ(e,r))<=n&&(n=o,s=r,h=a,i);for(t.projection=s,YFM.Math.Vector.distance(t.projection,this.segList[h].start),t.projDist=YFM.Math.Vector.distance(t.projection,e),t.serialDist=YFM.Math.Vector.distance(t.projection,this.segList[h].end),h+1<l?(t.nextSerialDist=this.segList[h+1].len,(u=this.segList[h+1].azimuth-this.segList[h].azimuth)<0&&(u+=2*Math.PI),u<=.175||u>=6.11?t.nextSug=YFM.Map.Navigate.NextSuggestion.FRONT:u<Math.PI?t.nextSug=YFM.Map.Navigate.NextSuggestion.LEFT:t.nextSug=YFM.Map.Navigate.NextSuggestion.RIGHT):(t.nextSerialDist=0,t.nextSug=YFM.Map.Navigate.NextSuggestion.ARRIVE),t.goalDist=t.serialDist,a=h+1;a<l;a++)t.goalDist+=this.segList[a].len;t.globalDist=t.goalDist+this.segList[l-1].followLen,t.azimuth=this.segList[h].azimuth,t.sug=this.makeCurrentSug(this.region.azimuth,t.azimuth)}},makeCurrentSug:function(t,e){var i;return(i=e-t)<0&&(i=360+i),i>337.5&&i<=0||i>0&&i<=22.5?YFM.Map.Navigate.Suggestion.FRONT:i>22.5&&i<=67.5?YFM.Map.Navigate.Suggestion.FRONT:i>67.5&&i<=112.5?YFM.Map.Navigate.Suggestion.RIGHT:i>112.5&&i<=157.5?YFM.Map.Navigate.Suggestion.BACKWARD:i>157.5&&i<=202.5?YFM.Map.Navigate.Suggestion.BACKWARD:i>202.5&&i<=247.5?YFM.Map.Navigate.Suggestion.BACKWARD:i>247.5&&i<=292.5?YFM.Map.Navigate.Suggestion.LEFT:YFM.Map.Navigate.Suggestion.FRONT},getLength:function(){return this.segList.length},getSeg:function(t){return this.segList[t]}},Euler.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"],Euler.DefaultOrder="ZXY",Euler.prototype={constructor:Euler,setFromMatrix:function(t,e,i){var r=YFM.Math.clamp,s=t[0],o=t[4],n=t[8],a=t[1],h=t[5],u=t[9],l=t[2],c=t[6],d=t[10];return"XYZ"===(e=e||this.order)?(this.y=Math.asin(r(n,-1,1)),Math.abs(n)<.99999?(this.x=Math.atan2(-u,d),this.z=Math.atan2(-o,s)):(this.x=Math.atan2(c,h),this.z=0)):"YXZ"===e?(this.x=Math.asin(-r(u,-1,1)),Math.abs(u)<.99999?(this.y=Math.atan2(n,d),this.z=Math.atan2(a,h)):(this.y=Math.atan2(-l,s),this.z=0)):"ZXY"===e?(this.x=Math.asin(r(c,-1,1)),Math.abs(c)<.99999?(this.y=Math.atan2(-l,d),this.z=Math.atan2(-o,h)):(this.y=0,this.z=Math.atan2(a,s))):"ZYX"===e?(this.y=Math.asin(-r(l,-1,1)),Math.abs(l)<.99999?(this.x=Math.atan2(c,d),this.z=Math.atan2(a,s)):(this.x=0,this.z=Math.atan2(-o,h))):"YZX"===e?(this.z=Math.asin(r(a,-1,1)),Math.abs(a)<.99999?(this.x=Math.atan2(-u,h),this.y=Math.atan2(-l,s)):(this.x=0,this.y=Math.atan2(n,d))):"XZY"===e?(this.z=Math.asin(-r(o,-1,1)),Math.abs(o)<.99999?(this.x=Math.atan2(c,h),this.y=Math.atan2(n,s)):(this.x=Math.atan2(-u,d),this.y=0)):console.warn("setFromRotationMatrix() given unsupported order: "+e),this.order=e,this}},LDS=function(){var t=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,57];return{halton:function(e,i){return function(t,e){var i,r,s;for(i=r=1/t,s=0;e>0;)s+=i*(e%t),i*=r,e=Math.floor(e/t);return s}(function(e){if(e<0||e>t.length)throw new Error("nthPrimeNumber index out of range");return t[e]}(e),i)}}}(),YFM.Math.Line=function(){var t=function(t,e){var i=[];return i.push(t[0]),i.push(t[1]),i.push(t[2]),i.push(1),i.push(e[0]),i.push(e[1]),i.push(e[2]),i.push(0),i},e=function(t,e){return YFM.Math.Vector.pos(t[0]+t[4]*e,t[1]+t[5]*e,t[2]+t[6]*e)},i=function(t,e,i,r){var s,o,n,a,h,u;return o=YFM.Math.Vector.pos(e,i,r),n=YFM.Math.Vector.sub(o,t),s=YFM.Math.Vector.vec(t[4],t[5],t[6]),h=YFM.Math.Vector.dot3(n,s),h*=h,a=YFM.Math.Vector.norm3SQ(n),u=YFM.Math.Vector.norm3SQ(s),a-h/u},r=function(t,e,r,s){return Math.sqrt(i(t,e,r,s))},s=function(t,e){var i,r,s,o,n,a,h,u,l,c,d=[],g=[],p=[];return l=YFM.Math.Vector.vec(t[4],t[5],t[6]),c=YFM.Math.Vector.vec(e[4],e[5],e[6]),s=YFM.Math.Vector.dot3(l,c),a=YFM.Math.Vector.norm3SQ(l),h=YFM.Math.Vector.norm3SQ(c),r=s*s-a*h,0==(i=YFM.Math.floatEquals(r,0))&&(u=YFM.Math.Vector.sub(e,t),o=YFM.Math.Vector.dot3(u,l),n=YFM.Math.Vector.dot3(u,c),g.push(o),g.push(n),d.push(-YFM.Math.Vector.norm3SQ(c)),d.push(-s),d.push(s),d.push(YFM.Math.Vector.norm3SQ(l)),p.push(g[0]*d[0]+g[1]*d[2]),p.push(g[0]*d[1]+g[1]*d[3]),p[0]/=r,p[1]/=r),{parallel:i,t:p}};return{line:function(t,e,i,r,s,o){var n=[];return n.push(t),n.push(e),n.push(i),n.push(1),n.push(r),n.push(s),n.push(o),n.push(0),n},lineSV:t,linePP:function(t,e){var i=[];return i.push(t[0]),i.push(t[1]),i.push(t[2]),i.push(1),i.push(e[0]-t[0]),i.push(e[1]-t[1]),i.push(e[2]-t[2]),i.push(0),i},getPoint:e,projection:function(t,e){var i=YFM.Math.Vector.pos(t[0],t[1],t[2]),r=YFM.Math.Vector.vec(t[4],t[5],t[6]),s=YFM.Math.Vector.sub(e,i),o=YFM.Math.Vector.dot3(s,r)/YFM.Math.Vector.dot3(r,r);return o<=0?i:o>=1?YFM.Math.Vector.add(i,r):YFM.Math.Vector.pos(t[0]+t[4]*o,t[1]+t[5]*o,t[2]+t[6]*o)},distancePointSQ:i,distancePoint:r,distanceLinesRaw:s,distanceLines:function(t,i){var o,n,a,h;return(n=s(t,i)).parallel?o=r(t,i[0],i[1],i[2]):(a=e(t,n.t[0]),h=e(i,n.t[1]),o=YFM.Math.Vector.distance(a,h)),{parallel:void 0,distance:o}},transform:function(e,i){var r=YFM.Math.Vector.pos(e[0],e[1],e[2]),s=YFM.Math.Vector.vec(e[4],e[5],e[6]);return t(YFM.Math.Matrix.mul(i,r),YFM.Math.Matrix.mul(i,s))}}}(),YFM.Math.Matrix=function(){var t=function(){var t=[];return t.push(1),t.push(0),t.push(0),t.push(0),t.push(0),t.push(1),t.push(0),t.push(0),t.push(0),t.push(0),t.push(1),t.push(0),t.push(0),t.push(0),t.push(0),t.push(1),t},e=function(e,i,r,s,o){var n,a,h,u=t();if(n=o?e:YFM.Math.deg2Radian(e),a=Math.cos(n),h=Math.sin(n),u[3]=0,u[7]=0,u[11]=0,u[12]=0,u[13]=0,u[14]=0,u[15]=1,1==i&&0==r&&0==s)u[5]=a,u[10]=a,u[6]=h,u[9]=-h,u[1]=0,u[2]=0,u[4]=0,u[8]=0,u[0]=1;else if(0==i&&1==r&&0==s)u[0]=a,u[10]=a,u[8]=h,u[2]=-h,u[1]=0,u[4]=0,u[6]=0,u[9]=0,u[5]=1;else if(0==i&&0==r&&1==s)u[0]=a,u[5]=a,u[1]=h,u[4]=-h,u[2]=0,u[6]=0,u[8]=0,u[9]=0,u[10]=1;else{var l=Math.sqrt(i*i+r*r+s*s);if(1!=l){var c=1/l;i*=c,r*=c,s*=c}var d=1-a,g=i*r,p=r*s,M=s*i,f=i*h,m=r*h,v=s*h;u[0]=i*i*d+a,u[4]=g*d-v,u[8]=M*d+m,u[1]=g*d+v,u[5]=r*r*d+a,u[9]=p*d-f,u[2]=M*d-m,u[6]=p*d+f,u[10]=s*s*d+a}return u},i=function(t,e,i,r){var s,o,n,a=[];return s=r?t:YFM.Math.deg2Radian(t),o=Math.cos(s),n=Math.sin(s),a.push(o),a.push(n),a.push(0),a.push(0),a.push(-n),a.push(o),a.push(0),a.push(0),a.push(0),a.push(0),a.push(1),a.push(0),a.push(e*(1-o)+i*n),a.push(i*(1-o)-e*n),a.push(0),a.push(1),a},r=function(t,e,i){var r=[];return r.push(1),r.push(0),r.push(0),r.push(0),r.push(0),r.push(1),r.push(0),r.push(0),r.push(0),r.push(0),r.push(1),r.push(0),r.push(t),r.push(e),r.push(i),r.push(1),r},s=function(t,e,i,r){var s=[];return s.push(t),s.push(0),s.push(0),s.push(0),s.push(0),s.push(t),s.push(0),s.push(0),s.push(0),s.push(0),s.push(t),s.push(0),s.push(e*(1-t)),s.push(i*(1-t)),s.push(r*(1-t)),s.push(1),s},o=function(t,e){var i,r,s,o,n,a,h,u=[];for(a=t.slice(0),h=e.slice(0),n=0;n<4;n++)i=h[4*n+0],r=h[4*n+1],s=h[4*n+2],o=h[4*n+3],u.push(i*a[0]+r*a[4]+s*a[8]+o*a[12]),u.push(i*a[1]+r*a[5]+s*a[9]+o*a[13]),u.push(i*a[2]+r*a[6]+s*a[10]+o*a[14]),u.push(i*a[3]+r*a[7]+s*a[11]+o*a[15]);return u};return{mat:t,matClone:function(t){return t.slice(0)},rotate3d:e,rotateXY:i,translate:r,rotateAxis:function(t,e,i){var r,s,o,n,a,h,u,l=[];return r=i?t:YFM.Math.deg2Radian(t),s=Math.cos(r),o=Math.sin(r),n=1-s,l.push(NaN*n+s),l.push(NaN*n+u*o),l.push(NaN*n-h*o),l.push(0),l.push(NaN*n-u*o),l.push(NaN*n+s),l.push(NaN*n+a*o),l.push(0),l.push(NaN*n+h*o),l.push(NaN*n-a*o),l.push(NaN*n+s),l.push(0),l.push(0),l.push(0),l.push(0),l.push(1),l},scale:s,scaleXYZ:function(t,e,i,r){var s=[];return s.push(t[0]),s.push(0),s.push(0),s.push(0),s.push(0),s.push(t[1]),s.push(0),s.push(0),s.push(0),s.push(0),s.push(t[2]),s.push(0),s.push(e*(1-t[0])),s.push(i*(1-t[1])),s.push(r*(1-t[2])),s.push(1),s},mul:o,mulVec:function(t,e){var i,r,s,o,n=[];return i=e[0],r=e[1],s=e[2],o=e[3],n.push(i*t[0]+r*t[4]+s*t[8]+o*t[12]),n.push(i*t[1]+r*t[5]+s*t[9]+o*t[13]),n.push(i*t[2]+r*t[6]+s*t[10]+o*t[14]),n.push(i*t[3]+r*t[7]+s*t[11]+o*t[15]),n},mulVecTo:function(t,e,i){i[0]=e[0]*t[0]+e[1]*t[4]+e[2]*t[8]+e[3]*t[12],i[1]=e[0]*t[1]+e[1]*t[5]+e[2]*t[9]+e[3]*t[13],i[2]=e[0]*t[2]+e[1]*t[6]+e[2]*t[10]+e[3]*t[14],i[3]=e[0]*t[3]+e[1]*t[7]+e[2]*t[11]+e[3]*t[15]},postTranslate:function(t,e,i,s){var n=r(e,i,s);return o(n,t)},postRotateXY:function(t,e,r,s,n){var a=i(e,r,s,n);return o(a,t)},postRotate3d:function(t,i,r,s,n,a){var h=e(i,r,s,n,a);return o(h,t)},postScale:function(t,e,i,r,n){var a=s(e,i,r,n);return o(a,t)},preTranslate:function(t,e,i,s){var n=r(e,i,s);return o(t,n)},preRotateXY:function(t,e,r,s,n){var a=i(e,r,s,n);return o(t,a)},preRotate3d:function(t,i,r,s,n,a){var h=e(i,r,s,n,a);return o(t,h)},preScale:function(t,e,i,r,n){var a=s(e,i,r,n);return o(t,a)},transpose:function(t){var e=[];return e.push(t[0]),e.push(t[4]),e.push(t[8]),e.push(t[12]),e.push(t[1]),e.push(t[5]),e.push(t[9]),e.push(t[13]),e.push(t[2]),e.push(t[6]),e.push(t[10]),e.push(t[14]),e.push(t[3]),e.push(t[7]),e.push(t[11]),e.push(t[15]),e},invert:function(t){var e=t[0],i=t[1],r=t[2],s=t[3],o=t[4],n=t[5],a=t[6],h=t[7],u=t[8],l=t[9],c=t[10],d=t[11],g=t[12],p=t[13],M=t[14],f=t[15],m=e*n-i*o,v=e*a-r*o,x=e*h-s*o,F=i*a-r*n,_=i*h-s*n,y=r*h-s*a,R=u*p-l*g,T=u*M-c*g,b=u*f-d*g,S=l*M-c*p,A=l*f-d*p,Y=c*f-d*M,P=m*Y-v*A+x*S+F*b-_*T+y*R;if(0!=P){var L=[];return L.push((n*Y-a*A+h*S)/P),L.push((r*A-i*Y-s*S)/P),L.push((p*y-M*_+f*F)/P),L.push((c*_-l*y-d*F)/P),L.push((a*b-o*Y-h*T)/P),L.push((e*Y-r*b+s*T)/P),L.push((M*x-g*y-f*v)/P),L.push((u*y-c*x+d*v)/P),L.push((o*A-n*b+h*R)/P),L.push((i*b-e*A-s*R)/P),L.push((g*_-p*x+f*m)/P),L.push((l*x-u*_-d*m)/P),L.push((n*T-o*S-a*R)/P),L.push((e*S-i*T+r*R)/P),L.push((p*v-g*F-M*m)/P),L.push((u*F-l*v+c*m)/P),L}return null},orthographic:function(e,i,r,s,o,n){var a=t(),h=1/(i-e),u=1/(s-r),l=1/(n-o),c=2*h,d=2*u,g=-2*l,p=-(i+e)*h,M=-(s+r)*u,f=-(n+o)*l;return a[0]=c,a[5]=d,a[10]=g,a[12]=p,a[13]=M,a[14]=f,a[15]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[11]=0,a},perspective:function(t,e,i,r){var s=[],o=1/Math.tan(t*(Math.PI/360)),n=1/(i-r);return s.push(o/e),s.push(0),s.push(0),s.push(0),s.push(0),s.push(o),s.push(0),s.push(0),s.push(0),s.push(0),s.push((r+i)*n),s.push(-1),s.push(0),s.push(0),s.push(2*r*i*n),s.push(0),s},setTranslateZ:function(t,e){t[14]=e},covariance3x3:function(t){var e,i,r,s,o,n,a,h,u,l,c,d,g,p,M=[];for(h=t.length,s=0,o=0,n=0,a=0;a<h;a++)s+=t[a][0],o+=t[a][1],n+=t[a][2];for(s/=h,o/=h,n/=h,u=0,l=0,c=0,d=0,g=0,p=0,a=0;a<h;a++)u+=((e=t[a][0])-s)*(e-s),l+=((i=t[a][1])-o)*(i-o),c+=((r=t[a][2])-n)*(r-n),d+=(e-s)*(i-o),g+=(e-s)*(r-n),p+=(i-o)*(r-n);return u/=h,l/=h,c/=h,d/=h,g/=h,p/=h,M.push(u),M.push(d),M.push(g),M.push(d),M.push(l),M.push(p),M.push(g),M.push(p),M.push(c),M},eig3x3:function(t){var e,i,r,s=[],o=[];if(t[3]!=t[1]||t[6]!=t[2]||t[7]!=t[5])throw new Error("matrix is not symmetric");return(e=[]).push(new Array(t[0],t[3],t[6])),e.push(new Array(t[1],t[4],t[7])),e.push(new Array(t[2],t[5],t[8])),i=new Array(0,0,0),r=new Array(0,0,0),function(t,e,i,r){var s,o,n;for(o=0;o<t;o++)e[o]=r[t-1][o];for(s=t-1;s>0;s--){var a=0,h=0;for(n=0;n<s;n++)a+=Math.abs(e[n]);if(0==a)for(i[s]=e[s-1],o=0;o<s;o++)e[o]=r[s-1][o],r[s][o]=0,r[o][s]=0;else{for(n=0;n<s;n++)e[n]/=a,h+=e[n]*e[n];var u=e[s-1],l=Math.sqrt(h);for(u>0&&(l=-l),i[s]=a*l,h-=u*l,e[s-1]=u-l,o=0;o<s;o++)i[o]=0;for(o=0;o<s;o++){for(u=e[o],r[o][s]=u,l=i[o]+r[o][o]*u,n=o+1;n<=s-1;n++)l+=r[n][o]*e[n],i[n]+=r[n][o]*u;i[o]=l}for(u=0,o=0;o<s;o++)i[o]/=h,u+=i[o]*e[o];var c=u/(h+h);for(o=0;o<s;o++)i[o]-=c*e[o];for(o=0;o<s;o++){for(u=e[o],l=i[o],n=o;n<=s-1;n++)r[n][o]-=u*i[n]+l*e[n];e[o]=r[s-1][o],r[s][o]=0}}e[s]=h}for(s=0;s<t-1;s++){if(r[t-1][s]=r[s][s],r[s][s]=1,0!=(h=e[s+1])){for(n=0;n<=s;n++)e[n]=r[n][s+1]/h;for(o=0;o<=s;o++){for(l=0,n=0;n<=s;n++)l+=r[n][s+1]*r[n][o];for(n=0;n<=s;n++)r[n][o]-=l*e[n]}}for(n=0;n<=s;n++)r[n][s+1]=0}for(o=0;o<t;o++)e[o]=r[t-1][o],r[t-1][o]=0;r[t-1][t-1]=1,i[0]=0}(3,i,r,e),function(t,e,i,r){var s,o,n,a,h,u;for(s=1;s<t;s++)i[s-1]=i[s];i[t-1]=0;var l=0,c=0,d=Math.pow(2,-52);for(a=0;a<t;a++){for(c=Math.max(c,Math.abs(e[a])+Math.abs(i[a])),h=a;h<t&&!(Math.abs(i[h])<=d*c);)h++;if(h>a){u=0;do{if((u+=1)>=7)break;var g=e[a],p=(e[a+1]-g)/(2*i[a]),M=Math.hypot(p,1);p<0&&(M=-M),e[a]=i[a]/(p+M),e[a+1]=i[a]*(p+M);var f=e[a+1],m=g-e[a];for(s=a+2;s<t;s++)e[s]-=m;l+=m,p=e[h];var v=1,x=v,F=v,_=i[a+1],y=0,R=0;for(s=h-1;s>=a;s--)for(F=x,x=v,R=y,g=v*i[s],m=v*p,M=Math.hypot(p,i[s]),i[s+1]=y*M,y=i[s]/M,p=(v=p/M)*e[s]-y*g,e[s+1]=m+y*(v*g+y*e[s]),n=0;n<t;n++)m=r[n][s+1],r[n][s+1]=y*r[n][s]+v*m,r[n][s]=v*r[n][s]-y*m;p=-y*R*F*_*i[a]/f,i[a]=y*p,e[a]=v*p}while(Math.abs(i[a])>d*c)}e[a]=e[a]+l,i[a]=0}for(s=0;s<t-1;s++){for(n=s,p=e[s],o=s+1;o<t;o++)e[o]<p&&(n=o,p=e[o]);if(n!=s)for(e[n]=e[s],e[s]=p,o=0;o<t;o++)p=r[o][s],r[o][s]=r[o][n],r[o][n]=p}}(3,i,r,e),s.push(i[0]),s.push(i[1]),s.push(i[2]),o.push(e[0][0]),o.push(e[1][0]),o.push(e[2][0]),o.push(e[0][1]),o.push(e[1][1]),o.push(e[2][1]),o.push(e[0][2]),o.push(e[1][2]),o.push(e[2][2]),{value:s,vec:o}},eulerParamExtract:function(t){var e,i,r;return e=Math.atan2(-t[2],t[10]),i=Math.asin(t[6]),r=Math.atan2(-t[4],t[5]),new Euler(i,e,r)},eulerParamExtractX:function(t){return Math.asin(t[6])},eulerParamExtractY:function(t){return Math.atan2(-t[2],t[10])},eulerParamExtractZ:function(t){return Math.atan2(-t[4],t[5])},rotationFromQuaternion:function(e){var i=t(),r=e.x,s=e.y,o=e.z,n=e.w,a=r+r,h=s+s,u=o+o,l=r*a,c=r*h,d=r*u,g=s*h,p=s*u,M=o*u,f=n*a,m=n*h,v=n*u;return i[0]=1-(g+M),i[1]=c-v,i[2]=d+m,i[3]=0,i[4]=c+v,i[5]=1-(l+M),i[6]=p-f,i[7]=0,i[8]=d-m,i[9]=p+f,i[10]=1-(l+g),i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}}}(),PPolyline.prototype={constructor:PPolyline,getSumLength:function(){return this.sumLength},getPoint:function(t,e){var i,r,s=this.segList.length;if(t<0||t>=s)throw new Error("PPolyline getPoint index outof bound:"+t);if(this.segList[t].t0<=e&&e<=this.segList[t].t1)r=t;else if(this.segList[t].t0>e){for(i=t;i>=0;i--)if(this.segList[i].t0<=e&&e<=this.segList[i].t1){r=i;break}}else if(e>this.segList[t].t1)for(i=t;i<s;i++)if(this.segList[i].t0<=e&&e<=this.segList[i].t1){r=i;break}var o=this.segList[r];if(!o)throw new Error("PPolyline getPoint targetIndex outof bound:"+r);var n=(e-o.t0)/o.tlen;return{pos:YFM.Math.Vector.add(o.start,YFM.Math.Vector.scale(o.vec,n)),seg:o}},_addSeg:function(t,e){var i={};return i.index=this.segList.length,i.start=t,i.end=e,i.vec=YFM.Math.Vector.sub(e,t),i.len=Math.sqrt(YFM.Math.Vector.dot3(i.vec,i.vec)),this.segList.push(i),i.len},_handleSeg:function(t,e,i){return t.t0=i?i.t1:e/this.sumLength,t.t1=(e+t.len)/this.sumLength,t.tlen=t.t1-t.t0,t.len}},YFM.Math.Plane=function(){var t=function(t,e,i,r,s,o){var n=YFM.Math.Vector.pos(t,e,i),a=YFM.Math.Vector.normalize(YFM.Math.Vector.vec(r,s,o)),h=-YFM.Math.Vector.dot3(a,n);return a[3]=h,a};return{plane:t,planePN:function(e,i){return t(e[0],e[1],e[2],i[0],i[1],i[2])},planeRaw:function(t,e,i,r){return YFM.Math.Vector.vec(t,e,i,r)},transform:function(t,e){var i,r=YFM.Math.Matrix.invert(e);if(null==r)throw new Error("transform a plane with a singular matrix");return i=YFM.Math.Matrix.transpose(r),YFM.Math.Matrix.mulVec(i,t)},distance:function(t,e,i,r){var s=YFM.Math.Vector.pos(e,i,r);return YFM.Math.Vector.dot4(t,s)},intersectionLine:function(t,e){var i,r,s=YFM.Math.Vector.pos(e[0],e[1],e[2]),o=YFM.Math.Vector.vec(e[4],e[5],e[6]);if(i=YFM.Math.Vector.dot4(t,s),r=YFM.Math.Vector.dot4(t,o),YFM.Math.floatEquals(r,0))throw new Error("Calc intersection of a line parallel to a plane");return-i/r},intersectionPlane:function(t,e){var i,r,s,o,n;if(o=YFM.Math.Vector.cross(t,e),i=Math.floatEquals(0,YFM.Math.Vector.norm3(o)))return{parallel:i};if((r=[]).push(t[0]),r.push(e[0]),r.push(o[0]),r.push(0),r.push(t[1]),r.push(e[1]),r.push(o[1]),r.push(0),r.push(t[2]),r.push(e[2]),r.push(o[2]),r.push(0),r.push(0),r.push(0),r.push(0),r.push(1),null==(s=YFM.Math.Matrix.invert(r)))throw new Error("nv matrix is singular");return n=YFM.Math.Matrix.mulVec(s,YFM.Math.Vector.pos(-t[3],-e[3],0)),{parallel:i,line:YFM.Math.Line.lineSV(n,o)}},intersectionTriplePlane:function(t,e,i){var r,s,o;return(r=[]).push(t[0]),r.push(e[0]),r.push(i[0]),r.push(0),r.push(t[1]),r.push(e[1]),r.push(i[1]),r.push(0),r.push(t[2]),r.push(e[2]),r.push(i[2]),r.push(0),r.push(0),r.push(0),r.push(0),r.push(1),null==(s=YFM.Math.Matrix.invert(r))?{atAPoint:!1}:(o=YFM.Math.Matrix.mulVec(s,YFM.Math.Vector.pos(-t[3],-e[3],-i[3])),{atAPoint:!0,point:o})}}}(),Quaternion.prototype={constructor:Quaternion,toString:function(t){var e="(";return e=e+this.x.toFixed(t)+", ",e=e+this.y.toFixed(t)+", ",e=e+this.z.toFixed(t)+", ",e=e+this.w.toFixed(t)+")"},clone:function(){return new this.constructor(this.x,this.y,this.z,this.w)},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},setFromEuler:function(t){var e=t.x,i=t.y,r=t.z,s=t.order,o=Math.cos,n=Math.sin,a=o(e/2),h=o(i/2),u=o(r/2),l=n(e/2),c=n(i/2),d=n(r/2);return"XYZ"===s?(this.x=l*h*u+a*c*d,this.y=a*c*u-l*h*d,this.z=a*h*d+l*c*u,this.w=a*h*u-l*c*d):"YXZ"===s?(this.x=l*h*u+a*c*d,this.y=a*c*u-l*h*d,this.z=a*h*d-l*c*u,this.w=a*h*u+l*c*d):"ZXY"===s?(this.x=l*h*u-a*c*d,this.y=a*c*u+l*h*d,this.z=a*h*d+l*c*u,this.w=a*h*u-l*c*d):"ZYX"===s?(this.x=l*h*u-a*c*d,this.y=a*c*u+l*h*d,this.z=a*h*d-l*c*u,this.w=a*h*u+l*c*d):"YZX"===s?(this.x=l*h*u+a*c*d,this.y=a*c*u+l*h*d,this.z=a*h*d-l*c*u,this.w=a*h*u-l*c*d):"XZY"===s&&(this.x=l*h*u-a*c*d,this.y=a*c*u-l*h*d,this.z=a*h*d+l*c*u,this.w=a*h*u+l*c*d),this},setFromAxisAngle:function(t,e){var i=e/2,r=Math.sin(i);return this.x=t[0]*r,this.y=t[1]*r,this.z=t[2]*r,this.w=Math.cos(i),this},setFromRotationMatrix:function(t){var e,i=t[0],r=t[4],s=t[8],o=t[1],n=t[5],a=t[9],h=t[2],u=t[6],l=t[10],c=i+n+l;return c>0?(e=.5/Math.sqrt(c+1),this.w=.25/e,this.x=(u-a)*e,this.y=(s-h)*e,this.z=(o-r)*e):i>n&&i>l?(e=2*Math.sqrt(1+i-n-l),this.w=(u-a)/e,this.x=.25*e,this.y=(r+o)/e,this.z=(s+h)/e):n>l?(e=2*Math.sqrt(1+n-i-l),this.w=(s-h)/e,this.x=(r+o)/e,this.y=.25*e,this.z=(a+u)/e):(e=2*Math.sqrt(1+l-i-n),this.w=(o-r)/e,this.x=(s+h)/e,this.y=(a+u)/e,this.z=.25*e),this},inverse:function(){return this.conjugate().normalize()},conjugate:function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},normalize:function(){var t=this.length();return 0===t?(this.x=0,this.y=0,this.z=0,this.w=1):(t=1/t,this.x=this.x*t,this.y=this.y*t,this.z=this.z*t,this.w=this.w*t),this},multiply:function(t){return this.multiplyQuaternions(this,t)},premultiply:function(t){return this.multiplyQuaternions(t,this)},multiplyQuaternions:function(t,e){var i=t.x,r=t.y,s=t.z,o=t.w,n=e.x,a=e.y,h=e.z,u=e.w;return this.x=i*u+o*n+r*h-s*a,this.y=r*u+o*a+s*n-i*h,this.z=s*u+o*h+i*a-r*n,this.w=o*u-i*n-r*a-s*h,this},slerp:function(t,e){if(0===e)return this;if(1===e)return this.copy(t);var i=this.x,r=this.y,s=this.z,o=this.w,n=o*t.w+i*t.x+r*t.y+s*t.z;if(n<0?(this.w=-t.w,this.x=-t.x,this.y=-t.y,this.z=-t.z,n=-n):this.copy(t),n>=1)return this.w=o,this.x=i,this.y=r,this.z=s,this;var a=Math.sqrt(1-n*n);if(Math.abs(a)<.001)return this.w=.5*(o+this.w),this.x=.5*(i+this.x),this.y=.5*(r+this.y),this.z=.5*(s+this.z),this;var h=Math.atan2(a,n),u=Math.sin((1-e)*h)/a,l=Math.sin(e*h)/a;return this.w=o*u+this.w*l,this.x=i*u+this.x*l,this.y=r*u+this.y*l,this.z=s*u+this.z*l,this}},YFM.Math.Vector=function(){var t=function(t,e){var i=[];return i.push(t[0]-e[0]),i.push(t[1]-e[1]),i.push(t[2]-e[2]),i.push(t[3]-e[3]),i},e=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},i=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]};return{pos:function(){var t=YFM.Math.argumentsToArray(arguments);switch(t.length){case 0:t.push(0);case 1:t.push(0);case 2:t.push(0);case 3:t.push(1)}return t.splice(0,4)},vec:function(){var t=YFM.Math.argumentsToArray(arguments);switch(t.length){case 0:t.push(0);case 1:t.push(0);case 2:t.push(0);case 3:t.push(0)}return t.splice(0,4)},vecClone:function(t){return t.slice(0)},add:function(t,e){var i=[];return i.push(t[0]+e[0]),i.push(t[1]+e[1]),i.push(t[2]+e[2]),i.push(t[3]+e[3]),i},addTo:function(t,e,i){t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t[3]=e[3]+i[3]},sub:t,subTo:function(t,e,i){t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t[3]=e[3]-i[3]},scale:function(t,e){var i=[];return i.push(e*t[0]),i.push(e*t[1]),i.push(e*t[2]),i.push(e*t[3]),i},scaleTo:function(t,e){t[0]*=e,t[1]*=e,t[2]*=e,t[3]*=e},dot3:e,dot4:i,cross:function(t,e){var i=[];return i.push(-e[1]*t[2]+e[2]*t[1]),i.push(e[0]*t[2]-e[2]*t[0]),i.push(-e[0]*t[1]+e[1]*t[0]),i.push(0),i},norm3:function(t){return Math.sqrt(e(t,t))},norm4:function(t){return Math.sqrt(i(t,t))},norm3SQ:function(t){return e(t,t)},norm4SQ:function(t){return i(t,t)},normalize:function(t){var e=[],i=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);return i>0?(e.push(t[0]/i),e.push(t[1]/i),e.push(t[2]/i),e.push(t[3])):(e.push(0),e.push(0),e.push(0),e.push(t[3])),e},normalizeTo:function(t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);e>0?(t[0]=t[0]/e,t[1]=t[1]/e,t[2]=t[2]/e):(t[0]=0,t[1]=0,t[2]=0)},limitTo:function(t,i){var r=e(t,t);if(r>i*i){var s=Math.sqrt(r);t[0]/=s,t[1]/=s,t[2]/=s,t[0]*=i,t[1]*=i,t[2]*=i}},limitToRange:function(t,i,r){var s,o=e(t,t);o>r*r?(s=Math.sqrt(o),t[0]/=s,t[1]/=s,t[2]/=s,t[0]*=r,t[1]*=r,t[2]*=r):o<i*i&&(s=Math.sqrt(o),t[0]/=s,t[1]/=s,t[2]/=s,t[0]*=r,t[1]*=r,t[2]*=r)},mix:function(t,e,i){var r=[];return r.push((1-i)*t[0]+i*e[0]),r.push((1-i)*t[1]+i*e[1]),r.push((1-i)*t[2]+i*e[2]),r.push((1-i)*t[3]+i*e[3]),r},mid:function(t,e){var i=[];return i.push((t[0]+e[0])/2),i.push((t[1]+e[1])/2),i.push((t[2]+e[2])/2),i.push(1),i},midTo:function(t,e,i){t[0]=(e[0]+i[0])/2,t[1]=(e[1]+i[1])/2,t[2]=(e[2]+i[2])/2,t[3]=1},distanceSQ:function(i,r){var s=t(r,i);return e(s,s)},distance:function(i,r){var s=t(r,i);return Math.sqrt(e(s,s))}}}(),PlanePolygon.prototype={constructor:PlanePolygon,intersectionLine:function(t,e){var i,r,s,o,n,a,h;do{if(o=0,(n=YFM.Math.Plane.intersectionLine(this.plane,t))<0){o=1024;break}for(a=YFM.Math.Line.getPoint(t,n),h=YFM.Math.Matrix.invert(e),a=YFM.Math.Matrix.mulVec(h,a),i=this.barrier.length,r=0;r<i;r++)(s=YFM.Math.Plane.distance(this.barrier[r],a[0],a[1],a[2]))<o&&(o=s)}while(!1);return o},_makePlanePts:function(t){var e,i,r,s,o,n;if((n=t.length)<3)throw new Error("polygon pts count < 3");o=0;do{if(i=YFM.Math.Vector.sub(t[(o+1)%n],t[o%n]),s=YFM.Math.Vector.sub(t[(o+2)%n],t[(o+1)%n]),e=YFM.Math.Vector.cross(i,s),!YFM.Math.floatEquals(YFM.Math.Vector.norm3SQ(e),0))break;o++}while(o<n);if(YFM.Math.floatEquals(YFM.Math.Vector.norm3SQ(e),0))throw new Error("polygon degenerate");e=YFM.Math.Vector.normalize(e),o=0;do{i=YFM.Math.Vector.sub(t[(o+1)%n],t[o%n]),r=YFM.Math.Vector.cross(e,i),r=YFM.Math.Vector.normalize(r),this.barrier.push(YFM.Math.Plane.planePN(t[o],r)),o++}while(o<n);return YFM.Math.Plane.planePN(t[0],e)}},Mover.prototype={constructor:Mover,DEFAULT_MASS:1,DEFAULT_MAX_FORCE:4,DEFAULT_MAX_SPEED:4,setMass:function(t){this.mass=t},setMaxForce:function(t){this.maxForce=t},setMaxSpeed:function(t){this.maxSpeed=t},setLocation:function(t,e,i){this.location[0]=t,this.location[1]=e,this.location[2]=i},getLocation:function(){return this.location},update:function(){YFM.Math.Vector.addTo(this.velocity,this.velocity,this.acceleration),YFM.Math.Vector.limitTo(this.velocity,this.maxSpeed),YFM.Math.Vector.addTo(this.location,this.location,this.velocity),this.acceleration[0]=0,this.acceleration[1]=0,this.acceleration[2]=0},applyForce:function(t){var e=YFM.Math.Vector.scale(t,1/this.mass);YFM.Math.Vector.addTo(this.acceleration,this.acceleration,e)},seek:function(t){var e,i;e=YFM.Math.Vector.normalize(YFM.Math.Vector.sub(t,this.location)),YFM.Math.Vector.scaleTo(this.maxSpeed),i=YFM.Math.Vector.limitTo(YFM.Math.Vector.sub(e,this.velocity),this.maxForce),this.applyForce(i)},flee:function(t){var e,i;e=YFM.Math.Vector.normalize(YFM.Math.Vector.sub(t,this.location)),YFM.Math.Vector.scaleTo(-this.maxSpeed),i=YFM.Math.Vector.limitTo(YFM.Math.Vector.sub(e,this.velocity),this.maxForce),this.applyForce(i)},arrive:function(t,e){var i,r,s,o;return i=YFM.Math.Vector.sub(t,this.location),(s=YFM.Math.Vector.norm3(i))<=e||(i=YFM.Math.Vector.normalize(i),s<100?(o=YFM.Math.map(s,0,100,0,this.maxSpeed),YFM.Math.Vector.scaleTo(i,o)):YFM.Math.Vector.scaleTo(i,this.maxSpeed),r=YFM.Math.Vector.sub(i,this.velocity),YFM.Math.Vector.limitTo(r,this.maxForce),this.applyForce(r),!1)}},FloorQuadTree.prototype={constructor:FloorQuadTree,cursor:0,shift:1e4,removeObject:function(t){var e=this.objMap[t.toString()];if(e){for(var i,r=e.node,s=[],o=0,n=r.objectList.length;o<n;o++)e!==(i=r.objectList[o])&&s.push(i);r.objectList=s,r.objectList.length<=0&&r.shrink()}return e},insertObject:function(t,e,i,r,s){var o=FloorQuadTree.prototype.cursor*FloorQuadTree.prototype.shift+this.floor.index;FloorQuadTree.prototype.cursor+=1;var n=this.floor.floorPos2Region(i,r);n[2]+=s;var a={id:o,obj:t,pos:n,floor:e,x:i,y:r,z:s};return this.objMap[o.toString()]=a,this.root.insertObject(a),o},insertObjectOBB:function(t,e){var i=FloorQuadTree.prototype.cursor*FloorQuadTree.prototype.shift+this.floor.index;FloorQuadTree.prototype.cursor+=1;var r={id:i,obj:t,pos:e};return this.objMap[i.toString()]=r,this.root.insertObject(r),i},insertObjectOBBCenter:function(t,e,i){var r=FloorQuadTree.prototype.cursor*FloorQuadTree.prototype.shift+this.floor.index,s=this.floor.floorPos2Region(i[0],i[1]);FloorQuadTree.prototype.cursor+=1;var o={id:r,obj:t,pos:e,center:s};return this.objMap[r.toString()]=o,this.root.insertObject(o),r},frustumCheck:function(t){return this.root.frustumCheck(t)},rayCheck:function(t,e,i){var r=[];return this.root.rayCheck(t,e*e,r,i),r},rayCheckOBB:function(t,e,i){var e=[],r=YFM.Math.Line.transform(t,YFM.Math.Matrix.invert(this.floor.floorMat));return this.root.rayCheckOBB(t,r,e,i),e},render:function(t,e,i,r){this.root.renderCheck(t,e,i,r)},getContainLevel:function(t){var e;return null!=(e=this.root.containCheck(t))?e.level:1024}},FloorQuadNode.prototype={constructor:FloorQuadNode,shrink:function(){this.isNodeEmpty()&&(this.children[0]=null,this.children[1]=null,this.children[2]=null,this.children[3]=null,this.splited=!1,null!==this.parentNode&&this.parentNode.shrink())},isNodeEmpty:function(){return!(this.objectList.length>0)&&(!(null!==this.children[0]&&!this.children[0].isNodeEmpty())&&(!(null!==this.children[1]&&!this.children[1].isNodeEmpty())&&(!(null!==this.children[2]&&!this.children[2].isNodeEmpty())&&!(null!==this.children[3]&&!this.children[3].isNodeEmpty()))))},rayCheckOBB:function(t,e,r,s){if(this.obb.lineCheck(t)){var o,n=this.objectList.length;for(i=0;i<n;i++)if((o=this.objectList[i].pos).isOBB&&o.lineCheck(t)&&(r.push(this.objectList[i]),s))return!0;if(null!==this.children[0]&&this.children[0].rayCheckOBB(t,e,r,s))return!0;if(null!==this.children[1]&&this.children[1].rayCheckOBB(t,e,r,s))return!0;if(null!==this.children[2]&&this.children[2].rayCheckOBB(t,e,r,s))return!0;if(null!==this.children[3]&&this.children[3].rayCheckOBB(t,e,r,s))return!0}return!1},rayCheck:function(t,e,r,s){if(this.obb.lineCheck(t)){var o,n,a=this.objectList.length;for(i=0;i<a;i++)if(n=this.objectList[i].pos,o=YFM.Math.Line.distancePointSQ(t,n[0],n[1],n[2]),0===e){if(o<=this.objectList[i].radiusSQ&&(r.push(this.objectList[i]),s))return!0}else if(o<=e&&(r.push(this.objectList[i]),s))return!0;if(null!==this.children[0]&&this.children[0].rayCheck(t,e,r,s))return!0;if(null!==this.children[1]&&this.children[1].rayCheck(t,e,r,s))return!0;if(null!==this.children[2]&&this.children[2].rayCheck(t,e,r,s))return!0;if(null!==this.children[3]&&this.children[3].rayCheck(t,e,r,s))return!0}return!1},containCheck:function(t){var e=this.obb.frustumCheck(t);if(-1==e)return null;if(1==e)return this;if(0==e&&null!==this.children[0]){var r=[];r.push(this.children[0].containCheck(t)),r.push(this.children[1].containCheck(t)),r.push(this.children[2].containCheck(t)),r.push(this.children[3].containCheck(t));var s=1024,o=null;for(i=0;i<4;i++)null!==r[i]&&r[i].level<s&&(o=r[i],s=r[i].level);return o}return null},renderEver:function(t,e,i){var r,s;if(0!=(s=this.level>i+1?0:this.level>i?1:1024)){for(r=0;r<4;r++)null!==this.children[r]&&this.children[r].renderEver(t,e,i);for(s>this.objectList.length&&(s=this.objectList.length),r=0;r<s;r++)t(this.objectList[r],e)}},renderCheck:function(t,e,i,r){var s,o;if(0!=(o=this.level>r+1?0:this.level>r?1:1024)){var n=this.obb.frustumCheck(t);if(-1!=n){if(1==n)for(s=0;s<4;s++)null!==this.children[s]&&this.children[s].renderEver(e,i,r);else if(0==n&&this.level<=r)for(s=0;s<4;s++)null!==this.children[s]&&this.children[s].renderCheck(t,e,i,r);for(o>this.objectList.length&&(o=this.objectList.length),s=0;s<o;s++)t.containCheckPoint(this.objectList[s].pos)&&e(this.objectList[s],i)}}},insertObject:function(t){!this.splited&&this.objectList.length<this.THRESHOLD?this._insert2ObjList(t):(this.splited||this._spliteSpace(),this._insertToSubSpace(t))},frustumCheck:function(t){return this.obb.frustumCheck(t)},_insert2ObjList:function(t){t.node=this,this.objectList.push(t)},_spliteSpace:function(){var t,e,i;if(this.splited=!0,!(this.level>=6)){for(this.children[this.NODE_0]=new FloorQuadNode(this,this.floor,this.xmin,(this.xmin+this.xmax)/2,this.ymin,(this.ymin+this.ymax)/2,this.height,this.mask+"0",this.level+1),this.children[this.NODE_1]=new FloorQuadNode(this,this.floor,(this.xmin+this.xmax)/2,this.xmax,this.ymin,(this.ymin+this.ymax)/2,this.height,this.mask+"1",this.level+1),this.children[this.NODE_2]=new FloorQuadNode(this,this.floor,(this.xmin+this.xmax)/2,this.xmax,(this.ymin+this.ymax)/2,this.ymax,this.height,this.mask+"2",this.level+1),this.children[this.NODE_3]=new FloorQuadNode(this,this.floor,this.xmin,(this.xmin+this.xmax)/2,(this.ymin+this.ymax)/2,this.ymax,this.height,this.mask+"3",this.level+1),i=[];this.objectList.length>0;){t=this.objectList.pop();var r=[];for(r.push(this.children[0].obb.pointCheck(t.pos)),r.push(this.children[1].obb.pointCheck(t.pos)),r.push(this.children[2].obb.pointCheck(t.pos)),r.push(this.children[3].obb.pointCheck(t.pos)),e=0;e<4;e++)if(1==r[e]){this.children[e].insertObject(t);break}4==e&&i.push(t)}this.objectList=i}},_insertToSubSpace:function(t){var e=[];if(null!==this.children[0]){e.push(this.children[0].obb.pointCheck(t.pos)),e.push(this.children[1].obb.pointCheck(t.pos)),e.push(this.children[2].obb.pointCheck(t.pos)),e.push(this.children[3].obb.pointCheck(t.pos));for(var i=0;i<4;i++)if(1==e[i])return void this.children[i].insertObject(t)}this._insert2ObjList(t)},THRESHOLD:4,NODE_0:0,NODE_1:1,NODE_2:2,NODE_3:3,LEVEL_COLOR:new Array(YFM.Math.Vector.pos(1,0,0),YFM.Math.Vector.pos(1,.5,0),YFM.Math.Vector.pos(1,1,0),YFM.Math.Vector.pos(0,1,0),YFM.Math.Vector.pos(0,1,1),YFM.Math.Vector.pos(0,0,1),YFM.Math.Vector.pos(.5,0,1),YFM.Math.Vector.pos(0,0,0))},FrustumWorldSpace.prototype={constructor:FrustumWorldSpace,update:function(t){this.left[0]=t[3]+t[0],this.left[1]=t[7]+t[4],this.left[2]=t[11]+t[8],this.left[3]=t[15]+t[12],this.right[0]=t[3]-t[0],this.right[1]=t[7]-t[4],this.right[2]=t[11]-t[8],this.right[3]=t[15]-t[12],this.bottom[0]=t[3]+t[1],this.bottom[1]=t[7]+t[5],this.bottom[2]=t[11]+t[9],this.bottom[3]=t[15]+t[13],this.top[0]=t[3]-t[1],this.top[1]=t[7]-t[5],this.top[2]=t[11]-t[9],this.top[3]=t[15]-t[13],this.near[0]=t[3]+t[2],this.near[1]=t[7]+t[6],this.near[2]=t[11]+t[10],this.near[3]=t[15]+t[14],this.far[0]=t[3]-t[2],this.far[1]=t[7]-t[6],this.far[2]=t[11]-t[10],this.far[3]=t[15]-t[14]},containCheckPoint:function(t){if(t.isOBB)return-1!==t.frustumCheck(this);var e=!1;do{if(YFM.Math.Vector.dot4(this.near,t)<0)break;if(YFM.Math.Vector.dot4(this.far,t)<0)break;if(YFM.Math.Vector.dot4(this.left,t)<0)break;if(YFM.Math.Vector.dot4(this.right,t)<0)break;if(YFM.Math.Vector.dot4(this.bottom,t)<0)break;if(YFM.Math.Vector.dot4(this.top,t)<0)break;e=!0}while(!1);return e}},OBB.prototype={constructor:OBB,transform:function(t){var e=YFM.Math.Matrix,i=YFM.Math.Vector,r=YFM.Math.Matrix.invert(t),s=YFM.Math.Matrix.transpose(r);this.center=e.mulVec(t,this.center),this.r=this._reserse3(e.mulVec(t,this.r)),this.s=this._reserse3(e.mulVec(t,this.s)),this.t=this._reserse3(e.mulVec(t,this.t)),this.R=this._reserse3(e.mulVec(t,this.R)),this.S=this._reserse3(e.mulVec(t,this.S)),this.T=this._reserse3(e.mulVec(t,this.T)),this.r_max=e.mulVec(s,this.r_min),this.r_min=e.mulVec(s,this.r_max),this.s_max=e.mulVec(s,this.s_min),this.s_min=e.mulVec(s,this.s_max),this.t_max=e.mulVec(s,this.t_min),this.t_min=e.mulVec(s,this.t_max),this.r_half=this._reserse4(e.mulVec(s,this.r_half)),this.s_half=this._reserse4(e.mulVec(s,this.s_half)),this.t_half=this._reserse4(e.mulVec(s,this.t_half)),this.hr=i.norm3(this.R)/2,this.hs=i.norm3(this.S)/2,this.ht=i.norm3(this.T)/2},pointCheck:function(t){if(t.isOBB)return this.obbCheck(t);var e,i,r;e=0,i=0;do{if((r=YFM.Math.Plane.distance(this.r_min,t))<0){e++;break}if(r>0?i++:0,(r=YFM.Math.Plane.distance(this.r_max,t))<0){e++;break}if(r>0?i++:0,(r=YFM.Math.Plane.distance(this.s_min,t))<0){e++;break}if(r>0?i++:0,(r=YFM.Math.Plane.distance(this.s_max,t))<0){e++;break}if(r>0?i++:0,(r=YFM.Math.Plane.distance(this.t_min,t))<0){e++;break}if(r>0?i++:0,(r=YFM.Math.Plane.distance(this.t_max,t))<0){e++;break}r>0?i++:0,ret=!0}while(!1);return 6==i?1:e>0?-1:0},lineCheck:function(t){var e,i,r,s,o,n,a,h,u,l;if(s=Number.MAX_VALUE,o=-Number.MAX_VALUE,e=YFM.Math.Vector.pos(t[0],t[1],t[2]),i=YFM.Math.Vector.normalize(YFM.Math.Vector.vec(t[4],t[5],t[6])),r=YFM.Math.Vector.sub(this.center,e),h=YFM.Math.Vector.dot3(this.r,r),u=YFM.Math.Vector.dot3(this.r,i),YFM.Math.floatNotZero(u)){if(n=(h+this.hr)/u,a=(h-this.hr)/u,n>a&&(l=a,a=n,n=l),n>o&&(o=n),a<s&&(s=a),o>s)return!1;if(s<0)return!1}else if(-h-this.hr>0||-h+this.hr<0)return!1;if(h=YFM.Math.Vector.dot3(this.s,r),u=YFM.Math.Vector.dot3(this.s,i),YFM.Math.floatNotZero(u)){if(n=(h+this.hs)/u,a=(h-this.hs)/u,n>a&&(l=a,a=n,n=l),n>o&&(o=n),a<s&&(s=a),o>s)return!1;if(s<0)return!1}else if(-h-this.hs>0||-h+this.hs<0)return!1;if(h=YFM.Math.Vector.dot3(this.t,r),u=YFM.Math.Vector.dot3(this.t,i),YFM.Math.floatNotZero(u)){if(n=(h+this.ht)/u,a=(h-this.ht)/u,n>a&&(l=a,a=n,n=l),n>o&&(o=n),a<s&&(s=a),o>s)return!1;if(s<0)return!1}else if(-h-this.ht>0||-h+this.ht<0)return!1;return!0},obbCheck:function(t){var e,i,r,s;e=0,i=0;do{if(r=t.effectiveRadius(this.r_min),(s=YFM.Math.Plane.distance(this.r_min,t.center))<-r){e++;break}if(s>r?i++:0,r=t.effectiveRadius(this.r_max),(s=YFM.Math.Plane.distance(this.r_max,t.center))<-r){e++;break}if(s>r?i++:0,r=t.effectiveRadius(this.s_min),(s=YFM.Math.Plane.distance(this.s_min,t.center))<-r){e++;break}if(s>r?i++:0,r=t.effectiveRadius(this.s_max),(s=YFM.Math.Plane.distance(this.s_max,t.center))<-r?e++:s>r?i++:0,r=t.effectiveRadius(this.t_min),(s=YFM.Math.Plane.distance(this.t_min,t.center))<-r){e++;break}if(s>r?i++:0,r=t.effectiveRadius(this.t_max),(s=YFM.Math.Plane.distance(this.t_max,t.center))<-r){e++;break}s>r?i++:0}while(!1);return 6==i?1:e>0?-1:0},frustumCheck:function(t){var e,i,r,s;e=0,i=0;do{if(r=this.effectiveRadius(t.near),(s=YFM.Math.Plane.distance(t.near,this.center))<-r){e++;break}if(s>r?i++:0,r=this.effectiveRadius(t.far),(s=YFM.Math.Plane.distance(t.far,this.center))<-r){e++;break}if(s>r?i++:0,r=this.effectiveRadius(t.left),(s=YFM.Math.Plane.distance(t.left,this.center))<-r){e++;break}if(s>r?i++:0,r=this.effectiveRadius(t.right),(s=YFM.Math.Plane.distance(t.right,this.center))<-r?e++:s>r?i++:0,r=this.effectiveRadius(t.bottom),(s=YFM.Math.Plane.distance(t.bottom,this.center))<-r){e++;break}if(s>r?i++:0,r=this.effectiveRadius(t.top),(s=YFM.Math.Plane.distance(t.top,this.center))<-r){e++;break}s>r?i++:0}while(!1);return 6==i?1:e>0?-1:0},effectiveRadius:function(t){return(Math.abs(YFM.Math.Vector.dot3(this.R,t))+Math.abs(YFM.Math.Vector.dot3(this.S,t))+Math.abs(YFM.Math.Vector.dot3(this.T,t)))/2},_reserse3:function(t){return t[0]=-t[0],t[1]=-t[1],t[2]=-t[2],t},_reserse4:function(t){return t[0]=-t[0],t[1]=-t[1],t[2]=-t[2],t[3]=-t[3],t},_calc_bounding:function(t){var e,i,r,s,o,n,a,h,u,l,c,d,g,p,M,f;for(n=Number.MAX_VALUE,a=-Number.MAX_VALUE,h=Number.MAX_VALUE,u=-Number.MAX_VALUE,l=Number.MAX_VALUE,c=-Number.MAX_VALUE,i=t.length,e=0;e<i;e++)M=t[e],r=YFM.Math.Vector.dot3(M,this.r),s=YFM.Math.Vector.dot3(M,this.s),o=YFM.Math.Vector.dot3(M,this.t),r>a&&(a=r),r<n&&(n=r),s>u&&(u=s),s<h&&(h=s),o>c&&(c=o),o<l&&(l=o);if(this.r_min=YFM.Math.Plane.planeRaw(this.r[0],this.r[1],this.r[2],-n),this.r_max=YFM.Math.Plane.planeRaw(-this.r[0],-this.r[1],-this.r[2],a),this.s_min=YFM.Math.Plane.planeRaw(this.s[0],this.s[1],this.s[2],-h),this.s_max=YFM.Math.Plane.planeRaw(-this.s[0],-this.s[1],-this.s[2],u),this.t_min=YFM.Math.Plane.planeRaw(this.t[0],this.t[1],this.t[2],-l),this.t_max=YFM.Math.Plane.planeRaw(-this.t[0],-this.t[1],-this.t[2],c),d=(n+a)/2,g=(h+u)/2,p=(l+c)/2,this.r_half=YFM.Math.Plane.planeRaw(this.r[0],this.r[1],this.r[2],-d),this.s_half=YFM.Math.Plane.planeRaw(this.s[0],this.s[1],this.s[2],-g),this.t_half=YFM.Math.Plane.planeRaw(this.t[0],this.t[1],this.t[2],-p),this.hr=(a-n)/2,this.hs=(u-h)/2,this.ht=(c-l)/2,this.R=YFM.Math.Vector.scale(this.r,a-n),this.S=YFM.Math.Vector.scale(this.s,u-h),this.T=YFM.Math.Vector.scale(this.t,c-l),!(f=YFM.Math.Plane.intersectionTriplePlane(this.r_half,this.s_half,this.t_half)).atAPoint)throw new Error("obb calc center failed");this.center=f.point}},TextBlockQuickCheckTree.prototype={constructor:TextBlockQuickCheckTree,reset:function(){this.blockPool=this.blockList,this.blockList=[],this.root.reset()},check:function(t,e,i,r){var s=this.root.check(t,e,i,r);return s||this.root.insert(t,e,i,r),s}},AABBNode.prototype={constructor:AABBNode,reset:function(){this.objList=[],this.children&&(this.children[0].reset(),this.children[1].reset(),this.children[2].reset(),this.children[3].reset())},insert:function(t,e,i,r){if(this._containBox(this.rect,t,e,i,r)){if(this.children){var s=!1;do{if(this.children[0].insert(t,e,i,r))break;if(this.children[1].insert(t,e,i,r))break;if(this.children[2].insert(t,e,i,r))break;if(this.children[3].insert(t,e,i,r))break;s=!0}while(!1);s&&this._insertBlock(t,e,i,r)}else this._insertBlock(t,e,i,r);return!0}return!1},check:function(t,e,i,r){if(!this._intersectBox(this.rect,t,e,i,r))return!1;for(var s=0,o=this.objList.length;s<o;s++)if(this._intersectBox(this.objList[s],t,e,i,r))return!0;if(this.children){if(this.children[0].check(t,e,i,r))return!0;if(this.children[1].check(t,e,i,r))return!0;if(this.children[2].check(t,e,i,r))return!0;if(this.children[3].check(t,e,i,r))return!0}return!1},_insertBlock:function(t,e,i,r){var s;this.tree.blockPool.length>0?((s=this.tree.blockPool.pop())[0]=t,s[1]=e,s[2]=i,s[3]=r):s=new Array(t,e,i,r),this.objList.push(s),this.tree.blockList.push(s)},_intersectBox:function(t,e,i,r,s){return!(e>t[2]||r<t[0]||i>t[3]||s<t[1])},_containBox:function(t,e,i,r,s){return e>=t[0]&&i>=t[1]&&r<=t[2]&&s<=t[3]},_splite:function(){this.children=new Array(4);var t=(this.rect[0]+this.rect[2])/2,e=(this.rect[1]+this.rect[3])/2;this.children[0]=new AABBNode(this.tree,this.mask+"0",this.rect[0],this.rect[1],t,e),this.children[1]=new AABBNode(this.tree,this.mask+"1",t,this.rect[1],this.rect[2],e),this.children[2]=new AABBNode(this.tree,this.mask+"2",t,e,this.rect[2],this.rect[3]),this.children[3]=new AABBNode(this.tree,this.mask+"3",this.rect[0],e,t,this.rect[3])}},MtlItem.prototype={constructor:MtlItem,setNs:function(t){this.Ns=t},setKa:function(t,e,i){this.Ka[0]=t,this.Ka[1]=e,this.Ka[2]=i},setKd:function(t,e,i){this.Kd[0]=t,this.Kd[1]=e,this.Kd[2]=i},setKs:function(t,e,i){this.Ks[0]=t,this.Ks[1]=e,this.Ks[2]=i},setMapKd:function(t){this.mapKd=t},getNs:function(){return this.Ns},getKa:function(){return this.Ka},getKd:function(){return this.Kd},getKs:function(){return this.Ks},getMapKd:function(){return this.mapKd}},YFM.Mesh.ObjModel={},YFM.Mesh.ObjModel.VPattern=/v( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,YFM.Mesh.ObjModel.NPattern=/vn( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,YFM.Mesh.ObjModel.UVPattern=/vt( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,YFM.Mesh.ObjModel.FacePattern1=/f( +-?\d+)( +-?\d+)( +-?\d+)( +-?\d+)?/,YFM.Mesh.ObjModel.FacePattern2=/f( +(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+))?/,YFM.Mesh.ObjModel.FacePattern3=/f( +(-?\d+)\/(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+)\/(-?\d+))?/,YFM.Mesh.ObjModel.FacePattern4=/f( +(-?\d+)\/\/(-?\d+))( +(-?\d+)\/\/(-?\d+))( +(-?\d+)\/\/(-?\d+))( +(-?\d+)\/\/(-?\d+))?/,YFM.Mesh.ObjModel.NsPattern=/Ns( +[\d|\.|\+|\-|e|E]+)/,YFM.Mesh.ObjModel.KaPattern=/Ka( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,YFM.Mesh.ObjModel.KdPattern=/Kd( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,YFM.Mesh.ObjModel.KsPattern=/Ks( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,ObjModel.prototype={constructor:ObjModel,setFloor:function(t){this.floor=t},setModelMatrix:function(t){this.modelMatrix=t;var e=YFM.Math.Matrix.mul(this.floor.getFloorMat(),this.modelMatrix);this.obb.transform(e)},render:function(t,e){var i=YFM.Math.Matrix.mul(e,this.modelMatrix),r=YFM.Math.Matrix.transpose(i),s=YFM.Math.Matrix.invert(r);t.setNormalMatrix(s),t.setModelMatrix(this.modelMatrix);for(var o=0,n=this.objects.length;o<n;o++)this.hasMaterials&&this.objects[o].material.mtl?t.setMTL(this.objects[o].material.mtl,this.texturePool):t.setDefaultMTL(),t.drawTriangles(this.objects[o].mesh)},loadURLDir:function(t,e,i,r){this.baseUrl=t;var s,o,n=this;s=t+"/"+e+".mtl",o=t+"/"+e+".obj";var a=new XMLHttpRequest;a.open("GET",s,!0),a.responseType="text",a.onload=function(t){if(200==this.status){n._parseMtl(this.response);var e=new XMLHttpRequest;e.open("GET",o,!0),e.responseType="text",e.onload=function(t){200==this.status?(n._parseObj(this.response),i&&i(n),n.hasMaterials=!0):r&&r(this.status)},e.send()}else r&&r(this.status)},a.send()},loadURLWithMtl:function(t,e,i,r){this.baseUrl=e.substr(0,e.lastIndexOf("/")+1);var s=this,o=new XMLHttpRequest;o.open("GET",e,!0),o.responseType="text",o.onload=function(e){if(200==this.status){s._parseMtl(this.response);var o=new XMLHttpRequest;o.open("GET",t,!0),o.responseType="text",o.onload=function(t){200==this.status?(s._parseObj(this.response),i&&i(s),s.hasMaterials=!0):r&&r(this.status)},o.send()}else r&&r(this.status)},o.send()},loadURL:function(t,e,i){this.baseUrl=t.substr(0,t.lastIndexOf("/")+1);var r=this,s=new XMLHttpRequest;s.open("GET",t,!0),s.responseType="text",s.onload=function(t){200==this.status?(r._parseObj(this.response),e&&e(r)):i&&i(this.status)},s.send()},_parseMtl:function(t){for(var e,i=t.split("\n"),r=0;r<i.length;r++){var s,o=i[r];if(0!==(o=o.trim()).length&&"#"!==o.charAt(0))if(/^newmtl /.test(o)){var n=o.substring(7).trim();e=new MtlItem,this.materials[n]=e}else if(/^map_Kd /.test(o)){var a=o.substring(7).trim();e.setMapKd(a),this.texturePool.addTexture(a,this.baseUrl+"/"+a)}else null!==(s=YFM.Mesh.ObjModel.NsPattern.exec(o))?e.setNs(parseFloat(s[1])):null!==(s=YFM.Mesh.ObjModel.KaPattern.exec(o))?e.setKa(parseFloat(s[1]),parseFloat(s[2]),parseFloat(s[3])):null!==(s=YFM.Mesh.ObjModel.KdPattern.exec(o))?e.setKd(parseFloat(s[1]),parseFloat(s[2]),parseFloat(s[3])):null!==(s=YFM.Mesh.ObjModel.KsPattern.exec(o))&&e.setKs(parseFloat(s[1]),parseFloat(s[2]),parseFloat(s[3]))}},_parseObj:function(t){function e(t){var e=parseInt(t);return 3*(e>=0?e-1:e+c.length/3)}function i(t){var e=parseInt(t);return 3*(e>=0?e-1:e+d.length/3)}function r(t){var e=parseInt(t);return 2*(e>=0?e-1:e+g.length/2)}function s(t,e,i){u.vertices.push(c[t],c[t+1],c[t+2],c[e],c[e+1],c[e+2],c[i],c[i+1],c[i+2])}function o(t,e,i){u.normals.push(d[t],d[t+1],d[t+2],d[e],d[e+1],d[e+2],d[i],d[i+1],d[i+2])}function n(t,e,i){u.uvs.push(g[t],g[t+1],g[e],g[e+1],g[i],g[i+1])}function a(t,a,h,u,l,c,d,g,p,M,f,m){var v=e(t),x=e(a),F=e(h);if(void 0===u?s(v,x,F):(s(v,x,_=e(u)),s(x,F,_)),void 0!==l){var v=r(l),x=r(c),F=r(d);void 0===u?n(v,x,F):(n(v,x,_=r(g)),n(x,F,_))}if(void 0!==p){var v=i(p),x=i(M),F=i(f);if(void 0===u)o(v,x,F);else{var _=i(m);o(v,x,_),o(x,F,_)}}}var h,u,l,c=[],d=[],g=[];!1===/^o /gm.test(t)&&(h={name:"",geometry:u={vertices:[],normals:[],uvs:[]},material:l={name:""}},this.objects.push(h));for(var p=t.split("\n"),M=0;M<p.length;M++){var f,m=p[M];0!==(m=m.trim()).length&&"#"!==m.charAt(0)&&(null!==(f=YFM.Mesh.ObjModel.VPattern.exec(m))?c.push(parseFloat(f[1]),parseFloat(f[2]),parseFloat(f[3])):null!==(f=YFM.Mesh.ObjModel.NPattern.exec(m))?d.push(parseFloat(f[1]),parseFloat(f[2]),parseFloat(f[3])):null!==(f=YFM.Mesh.ObjModel.UVPattern.exec(m))?g.push(parseFloat(f[1]),parseFloat(f[2])):null!==(f=YFM.Mesh.ObjModel.FacePattern1.exec(m))?a(f[1],f[2],f[3],f[4]):null!==(f=YFM.Mesh.ObjModel.FacePattern2.exec(m))?a(f[2],f[5],f[8],f[11],f[3],f[6],f[9],f[12]):null!==(f=YFM.Mesh.ObjModel.FacePattern3.exec(m))?a(f[2],f[6],f[10],f[14],f[3],f[7],f[11],f[15],f[4],f[8],f[12],f[16]):null!==(f=YFM.Mesh.ObjModel.FacePattern4.exec(m))?a(f[2],f[5],f[8],f[11],void 0,void 0,void 0,void 0,f[3],f[6],f[9],f[12]):/^o /.test(m)?(u={vertices:[],normals:[],uvs:[]},l={name:""},h={name:m.substring(2).trim(),geometry:u,material:l},this.objects.push(h)):/^g /.test(m)||(/^usemtl /.test(m)?(l.name=m.substring(7).trim(),l.mtl=this.materials[l.name]):/^mtllib /.test(m)||/^s /.test(m)))}for(var M=0,v=this.objects.length;M<v;M++){var x=this.objects[M],F=x.geometry,_=new MeshBuffer(this.gl);_.addAttribute("position",F.vertices,3),F.normals.length>0&&_.addAttribute("normal",F.normals,3),F.uvs.length>0&&_.addAttribute("uv",F.uvs,2),x.mesh=_}for(var y=[],M=0,v=this.objects.length;M<v;M++){for(var R=0,T=(c=this.objects[M].geometry.vertices).length/3;R<T;R++)y.push(YFM.Math.Vector.pos(c[3*R+0],c[3*R+1],c[3*R+2]));delete this.objects[M].geometry}this.obb=new OBB(y)}},CameraRaw.prototype={constructor:CameraRaw,setPerspective:function(t,e,i,r){this.mat_projection=YFM.Math.Matrix.perspective(t,e,i,r),this.dirty=!0},setOrthographic:function(t,e,i,r,s,o){this.mat_projection=YFM.Math.Matrix.orthographic(t,e,i,r,s,o),this.dirty=!0},getProjectionMat:function(){return this.mat_projection},getPVMat:function(){return this.dirty&&(this.updateViewMat(),this.dirty=!1),this.mat_pv},getIPVMat:function(){return this.dirty&&(this.updateViewMat(),this.dirty=!1),this.mat_ipv},getViewMat:function(){return this.dirty&&(this.updateViewMat(),this.dirty=!1),this.mat_view},getIViewMat:function(){return this.dirty&&(this.updateViewMat(),this.dirty=!1),this.mat_iv},setViewOffset:function(t,e,i){this.mat_t_view=YFM.Math.Matrix.translate(t,e,i),this.dirty=!0},setViewBaseTranslate:function(t,e,i,r){var s=YFM.Math.Vector.vec(e,i,r),o=YFM.Math.Matrix.rotate3d(t,0,0,1);s=YFM.Math.Matrix.mulVec(o,s),this.mat_base_view=YFM.Math.Matrix.postTranslate(o,-s[0],-s[1],-s[2]),this.dirty=!0},setViewBaseTranslateQu:function(t,e,i,r){var s=YFM.Math.Vector.vec(e,i,r),o=YFM.Math.Matrix.rotationFromQuaternion(t);s=YFM.Math.Matrix.mulVec(o,s),this.mat_base_view=YFM.Math.Matrix.postTranslate(o,-s[0],-s[1],-s[2]),this.dirty=!0},postViewTranslate:function(t,e,i){this.mat_t_view=YFM.Math.Matrix.postTranslate(this.mat_t_view,t,e,i),this.dirty=!0},postViewRotate:function(t,e,i,r){this.mat_r_view=YFM.Math.Matrix.postRotate3d(this.mat_r_view,t,e,i,r),this.dirty=!0},postViewPitch:function(t,e){var i=YFM.Math.Matrix.postTranslate(YFM.Math.Matrix.postRotate3d(YFM.Math.Matrix.translate(-e[0],-e[1],-e[2]),t,1,0,0),e[0],e[1],e[2]);this.mat_r_view=YFM.Math.Matrix.mul(this.mat_r_view,i),this.dirty=!0},updateViewMat:function(){this.mat_view=YFM.Math.Matrix.mul(this.mat_t_view,YFM.Math.Matrix.mul(this.mat_r_view,this.mat_base_view)),this.mat_pv=YFM.Math.Matrix.mul(this.mat_projection,this.mat_view),this.mat_ipv=YFM.Math.Matrix.invert(this.mat_pv),this.mat_iv=YFM.Math.Matrix.invert(this.mat_view),this.mat_iv[12]=0,this.mat_iv[13]=0,this.mat_iv[14]=0,this.dirty=!1}},DeviceOrientationCamera.prototype={constructor:DeviceOrientationCamera,DEFAULT_PITCH:-30,setPerspective:function(t,e,i,r){this.mat_projection=YFM.Math.Matrix.perspective(t,e,i,r),this.dirty=!0},setOrthographic:function(t,e,i,r,s,o){this.mat_projection=YFM.Math.Matrix.orthographic(t,e,i,r,s,o),this.dirty=!0},getProjectionMat:function(){return this.mat_projection},getProjectionMatWithLDS:function(t,e){var i=YFM.Math.Matrix.matClone(this.mat_projection),r=LDS.halton(2,this.ldsIndex),s=LDS.halton(3,this.ldsIndex);return i[8]+=(r-.5)/t,i[9]+=(s-.5)/e,this.ldsIndex+=1,this.ldsIndex>this.ldsN&&(this.ldsIndex=0),i},getProjectionMatWithRGSS:function(t,e,i){var r=YFM.Math.Matrix.matClone(this.mat_projection),s=this.rgss[t][0],o=this.rgss[t][1];return r[8]+=(2*s-1)/e,r[9]+=(2*o-1)/i,r},getPVMat:function(){return this.dirty&&this._updateViewMat(),this.mat_pv},getIPVMat:function(){return this.dirty&&this._updateViewMat(),this.mat_ipv},getViewMat:function(){return this.dirty&&this._updateViewMat(),this.mat_view},getRoll:function(){return this.roll},getPitch:function(){return this.pitch},setPitch:function(t){this.pitch=t,this.dirty=!0},getEyePos:function(){return this.eyePos},getLookAt:function(){return YFM.Math.Vector.vecClone(this.lookAt)},getAzimuth:function(){var t=YFM.Math.Matrix.rotationFromQuaternion(this.quaternion);return-YFM.Math.Matrix.eulerParamExtractZ(t)},setAzimuth:function(t){this.quaternion.setFromAxisAngle(this.zee,t),this.dirty=!0},setLookAtAzimuth:function(t,e,i,r){this.quaternion.setFromAxisAngle(this.zee,t),this.lookAt[0]=e,this.lookAt[1]=i,this.lookAt[2]=r,this.dirty=!0},setLookAt:function(t,e,i){this.lookAt[0]=t,this.lookAt[1]=e,this.lookAt[2]=i,this.dirty=!0},getLookAt:function(){return YFM.Math.Vector.vecClone(this.lookAt)},getLookOffset:function(){return YFM.Math.Vector.vecClone(this.lookOffset)},getLookOffsetNormal:function(){return this.lookOffset[2]},setLookOffset:function(t,e,i){this.lookOffset[0]=t,this.lookOffset[1]=e,this.lookOffset[2]=i,this.dirty=!0},resetLookOffsetTan:function(){this.lookOffset[0]=0,this.lookOffset[1]=0,this.dirty=!0},_updaeQuaternion:function(){if(!1!==this.enabled&&null!=this.deviceOrientation){var t=YFM.Math.deg2Radian,e=this.deviceOrientation.alpha?t(this.deviceOrientation.alpha)+this.alphaOffsetAngle:0,i=this.deviceOrientation.beta?t(this.deviceOrientation.beta):0,r=this.deviceOrientation.gamma?t(this.deviceOrientation.gamma):0,s=this.screenOrientation?t(this.screenOrientation):0,o=new Euler(i,e,-r,"YXZ");this.q2.setFromAxisAngle(this.zee,-s),this.quaternion.setFromEuler(o),this.quaternion.premultiply(this.q0),this.quaternion.multiply(this.q1),this.quaternion.multiply(this.q2),this.roll=this.deviceOrientation.gamma?this.deviceOrientation.gamma:0}},_updateViewMat:function(){this._updaeQuaternion();var t=YFM.Math.Matrix.rotationFromQuaternion(this.quaternion),e=YFM.Math.Matrix.mulVec(t,this.lookAt);t=YFM.Math.Matrix.postTranslate(t,-e[0],-e[1],-e[2]);var i=YFM.Math.Matrix.translate(this.lookOffset[0],this.lookOffset[1],this.lookOffset[2]);if(this.pitchEnable){var r=YFM.Math.Matrix.rotate3d(this.pitch,1,0,0);this.mat_view=YFM.Math.Matrix.mul(i,YFM.Math.Matrix.mul(r,t))}else this.mat_view=YFM.Math.Matrix.mul(i,t);this.mat_pv=YFM.Math.Matrix.mul(this.mat_projection,this.mat_view),this.mat_ipv=YFM.Math.Matrix.invert(this.mat_pv),this.dirty=!1}},BaseColorProgram.prototype={constructor:BaseColorProgram,useProgram:function(){this.gl.useProgram(this.program),this.gl.bindTexture(this.gl.TEXTURE_2D,this.dummyTex)},bindTexture:function(t){this.gl.activeTexture(this.gl.TEXTURE0),this.gl.uniform1i(this.uTex,0),this.gl.bindTexture(this.gl.TEXTURE_2D,t)},setColorFlag:function(t){this.gl.uniform1i(this.uColorFlag,t)},drawTriangles:function(t,e){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,4,this.gl.FLOAT,!1,32,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aColor,4,this.gl.FLOAT,!1,32,16),this.gl.enableVertexAttribArray(this.aColor),this.gl.drawArrays(this.gl.TRIANGLES,0,e)},drawTrianglesPlus:function(t,e,i){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,4,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,e),this.gl.vertexAttribPointer(this.aColor,4,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.aColor),this.gl.drawArrays(this.gl.TRIANGLES,0,i),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null)},drawPoints:function(t,e){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,24,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aColor,3,this.gl.FLOAT,!1,24,12),this.gl.enableVertexAttribArray(this.aColor),this.gl.drawArrays(this.gl.POINTS,0,e),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null)},drawLines:function(t,e,i){null!=i&&this.gl.lineWidth(i),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,4,this.gl.FLOAT,!1,32,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aColor,4,this.gl.FLOAT,!1,32,16),this.gl.enableVertexAttribArray(this.aColor),this.gl.drawArrays(this.gl.LINES,0,e),null!=i&&this.gl.lineWidth(1)},getProgram:function(){return this.program},setMapHeight:function(t){this.gl.uniform1f(this.uMapHeight,t)},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uViewMat,!1,YFM.Math.flatten(t))},setRegionMatrix:function(t){this.gl.uniformMatrix4fv(this.uRegionMat,!1,YFM.Math.flatten(t))},setFloorMatrix:function(t){this.gl.uniformMatrix4fv(this.uFloorMat,!1,YFM.Math.flatten(t))},setModelMatrix:function(t){this.gl.uniformMatrix4fv(this.uModelMat,!1,YFM.Math.flatten(t))},vshader:"attribute  vec4 aPosition;\nattribute  vec4 aColor;\nuniform mat4 uModelMat;\nuniform mat4 uFloorMat;\nuniform mat4 uRegionMat;\nuniform mat4 uViewMat;\nuniform mat4 uProjectionMat;\nuniform float uMapHeight;\nvarying vec4 vColor;\nvoid main()\n{\n\tvec4 pos = vec4(aPosition.x, uMapHeight-aPosition.y, aPosition.z, 1.0);\n\tgl_Position = uProjectionMat*uViewMat*uRegionMat*uFloorMat*uModelMat*pos;\n   gl_PointSize = 4.0;\n\tvColor = aColor;\n}\n",fshader:"precision mediump float;\nuniform int        uColorFlag;\nuniform sampler2D  uTex;\nvarying vec4 vColor;\nvoid main()\n{\n       if(1 == uColorFlag)\n           gl_FragColor = vColor;\n       else\n           gl_FragColor = texture2D(uTex, vColor.xy);\n}\n"},BasePhongProgram.prototype={constructor:BasePhongProgram,useProgram:function(){this.gl.useProgram(this.program)},drawTriangles:function(t,e,i){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,4,this.gl.FLOAT,!1,32,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aNormal,4,this.gl.FLOAT,!1,32,16),this.gl.enableVertexAttribArray(this.aNormal),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,e),this.gl.vertexAttribPointer(this.aColor,4,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.aColor),this.gl.drawArrays(this.gl.TRIANGLES,0,i)},drawLines:function(t,e,i){null!=i&&this.gl.lineWidth(i),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!0,36,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aColor,3,this.gl.FLOAT,!1,36,12),this.gl.enableVertexAttribArray(this.aColor),this.gl.vertexAttribPointer(this.aNormal,3,this.gl.FLOAT,!1,36,24),this.gl.enableVertexAttribArray(this.aNormal),this.gl.drawArrays(this.gl.LINES,0,e),null!=i&&this.gl.lineWidth(1)},getProgram:function(){return this.program},setLightPos:function(t){this.gl.uniform4fv(this.uLightPos,t)},setAmbient:function(t){this.gl.uniform4fv(this.uAmbient,t)},setDiffuse:function(t){this.gl.uniform4fv(this.uDiffuse,t)},setLighting:function(t){this.gl.uniform1i(this.uLighting,t)},setMapHeight:function(t){this.gl.uniform1f(this.uMapHeight,t)},setHeightScale:function(t){this.gl.uniform1f(this.uHeightScale,t)},setNormalMatrix:function(t){this.gl.uniformMatrix4fv(this.uNormalMat,!1,YFM.Math.flatten(t))},setPVRMatrix:function(t){this.gl.uniformMatrix4fv(this.uPVRMat,!1,YFM.Math.flatten(t))},setFloorMatrix:function(t){this.gl.uniformMatrix4fv(this.uFloorMat,!1,YFM.Math.flatten(t))},vshader:"attribute vec4 aPosition;  \nattribute vec4 aNormal;    \nattribute vec4 aColor;     \nuniform int    uLighting;  \nuniform vec4   uAmbient;   \nuniform vec4   uDiffuse;   \nuniform float  uSelectArg; \nuniform float  uMapHeight; \nuniform float  uHeightScale;\nuniform mat4   uFloorMat;  \nuniform mat4   uPVRMat;    \nuniform mat4   uNormalMat; \nuniform vec4   uLightPos;  \nvarying vec4   vColor;     \n                           \nvoid main(){               \n   vec4 tPos = vec4(aPosition.x, uMapHeight-aPosition.y, aPosition.z*uHeightScale+1.0, 1.0);\n   vec4 color;                                                     \n   if(1 == uLighting){\n       vec3 L = normalize(uLightPos.xyz);                  \n       vec3 N = normalize((uNormalMat*aNormal).xyz);       \n       float Kd = max( dot(L, N), 0.0 );                   \n       vec4 diffuse = Kd*uDiffuse;                         \n       vColor = aColor*uAmbient+aColor*diffuse;            \n   }else{                                                  \n       vColor = aColor;                                    \n   }                                                       \n   gl_Position = uPVRMat * uFloorMat * tPos;               \n}\n",fshader:"precision mediump float;                                   \nvarying vec4                   vColor;                     \nvoid main() {                                              \n       gl_FragColor = vColor;                              \n}\n"},BillboardIconProgram.prototype={constructor:BillboardIconProgram,useProgram:function(){this.gl.useProgram(this.program)},bindTexture:function(t){this.gl.activeTexture(this.gl.TEXTURE0),this.gl.uniform1i(this.uTex,0),this.gl.bindTexture(this.gl.TEXTURE_2D,t)},drawTriangles:function(t,e,i){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!0,24,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aTexCoord,3,this.gl.FLOAT,!1,24,12),this.gl.enableVertexAttribArray(this.aTexCoord),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.drawArrays(this.gl.TRIANGLES,i,e),this.gl.disable(this.gl.BLEND)},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uViewMat,!1,YFM.Math.flatten(t))},setIViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uiViewMat,!1,YFM.Math.flatten(t))},setRegionMatrix:function(t){this.gl.uniformMatrix4fv(this.uRegionMat,!1,YFM.Math.flatten(t))},setModelMatrix:function(t){this.gl.uniformMatrix4fv(this.uModelMat,!1,YFM.Math.flatten(t))},vshader:"attribute vec4  aPosition; \nattribute vec3  aTexCoord; \nvarying vec3 vTexCoord;    \nuniform mat4   uModelMat;  \nuniform mat4   uRegionMat; \nuniform mat4   uiViewMat;  \nuniform mat4   uViewMat;   \nuniform mat4   uProjMat;   \nvoid main( void ) {                            \n    vTexCoord = aTexCoord;                     \n    gl_Position = uProjMat*uViewMat*uRegionMat*uModelMat*uiViewMat*aPosition;\n}\n",fshader:"precision mediump float;                       \nvarying vec3 vTexCoord;                        \nuniform sampler2D uTex;                        \nvoid main() {                                  \n   gl_FragColor = texture2D(uTex, vTexCoord.xy);  \n}\n"},Color2DProgram.prototype={constructor:Color2DProgram,useProgram:function(){this.gl.useProgram(this.program)},drawTriangles:function(t,e,i,r){this.gl.uniform4fv(this.uColor,YFM.Math.flatten(e)),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,12,i),this.gl.enableVertexAttribArray(this.aPosition),this.gl.drawArrays(this.gl.TRIANGLES,0,r)},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setModelMatrix:function(t){this.gl.uniformMatrix4fv(this.uModelMat,!1,YFM.Math.flatten(t))},vshader:"attribute vec4 aPosition;\nuniform mat4   uModelMat;\nuniform mat4   uProjMat;\nuniform vec4   uColor;\nvarying vec4   vColor;\nvoid main( void ) {                            \n    gl_Position = uProjMat*uModelMat*aPosition;\n    vColor = uColor;                           \n}\n",fshader:"precision mediump float;                       \nvarying vec4   vColor;                         \nvoid main() {                                  \n   gl_FragColor = vColor;                      \n}\n"},Marker2DProgram.prototype={constructor:Marker2DProgram,useProgram:function(){this.gl.useProgram(this.program)},bindTexture:function(t){this.gl.activeTexture(this.gl.TEXTURE0),this.gl.uniform1i(this.uTex,0),this.gl.bindTexture(this.gl.TEXTURE_2D,t)},drawTriangles:function(t,e,i){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,24,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aTexCoord,3,this.gl.FLOAT,!1,24,12),this.gl.enableVertexAttribArray(this.aTexCoord),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.drawArrays(this.gl.TRIANGLES,i,e),this.gl.disable(this.gl.BLEND)},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setModelMatrix:function(t){this.gl.uniformMatrix4fv(this.uModelMat,!1,YFM.Math.flatten(t))},vshader:"attribute vec4  aPosition; \nattribute vec3  aTexCoord; \nuniform mat4   uModelMat;  \nuniform mat4   uProjMat;   \nvarying vec3   vTexCoord;  \nvoid main( void ) {                            \n    vTexCoord = aTexCoord;                     \n    gl_Position = uProjMat*uModelMat*aPosition;\n}\n",fshader:"precision mediump float;                       \nvarying vec3 vTexCoord;                        \nuniform sampler2D uTex;                        \nvoid main() {                                  \n   gl_FragColor = texture2D(uTex, vTexCoord.xy);  \n}\n"},ModelPhongProgram.prototype={constructor:ModelPhongProgram,useProgram:function(){this.gl.useProgram(this.program)},drawLines:function(t,e,i,r){this.gl.uniform1f(this.uNs,this.defaultNs),this.gl.uniform4fv(this.uKa,this.defaultKa),this.gl.uniform4fv(this.uKd,this.defaultKd),this.gl.uniform4fv(this.uKs,this.defaultKs),this.gl.uniform1i(this.uTexFlag,0),this.gl.uniform1i(this.uColorFlag,1),this.gl.uniform4fv(this.uColor,e),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!0,12,i),this.gl.enableVertexAttribArray(this.aPosition),this.gl.drawArrays(this.gl.LINES,0,r)},drawTriangles:function(t){var e,i,r;e=t.getAttribute("position"),i=t.getAttribute("normal"),r=t.getAttribute("uv"),null!==e?(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,e.vbo),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,12,0),this.gl.enableVertexAttribArray(this.aPosition)):this.gl.disableVertexAttribArray(this.aPosition),null!=i?(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,i.vbo),this.gl.vertexAttribPointer(this.aNormal,3,this.gl.FLOAT,!1,12,0),this.gl.enableVertexAttribArray(this.aNormal)):this.gl.disableVertexAttribArray(this.aNormal),null!=r?(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,r.vbo),this.gl.vertexAttribPointer(this.aTexCoord,2,this.gl.FLOAT,!1,8,0),this.gl.enableVertexAttribArray(this.aTexCoord)):this.gl.disableVertexAttribArray(this.aTexCoord),this.gl.drawArrays(this.gl.TRIANGLES,0,e.length)},setTexFlag:function(t){this.gl.uniform1i(this.uTexFlag,t)},bindTexture:function(t){this.gl.activeTexture(this.gl.TEXTURE0),this.gl.uniform1i(this.uTex,0),this.gl.bindTexture(this.gl.TEXTURE_2D,t)},setMTL:function(t,e){if(this.gl.uniform1f(this.uNs,t.getNs()),this.gl.uniform4fv(this.uKa,YFM.Math.flatten(t.getKa())),this.gl.uniform4fv(this.uKd,YFM.Math.flatten(t.getKd())),this.gl.uniform4fv(this.uKs,YFM.Math.flatten(t.getKs())),null!==t.getMapKd()){var i=e.getTexture(t.getMapKd());if(null!=i)return this.gl.uniform1i(this.uTexFlag,1),this.gl.uniform1i(this.uColorFlag,0),void this.bindTexture(i.tex)}this.gl.uniform1i(this.uTexFlag,0),this.gl.uniform1i(this.uColorFlag,1),this.gl.uniform4fv(this.uColor,this.defaultColor)},setDefaultMTL:function(){this.gl.uniform1f(this.uNs,this.defaultNs),this.gl.uniform4fv(this.uKa,this.defaultKa),this.gl.uniform4fv(this.uKd,this.defaultKd),this.gl.uniform4fv(this.uKs,this.defaultKs),this.gl.uniform1i(this.uTexFlag,0),this.gl.uniform1i(this.uColorFlag,1),this.gl.uniform4fv(this.uColor,this.defaultColor)},setColorFlag:function(t){this.gl.uniform1i(this.uColorFlag,t)},setColor:function(t){this.gl.uniform4fv(this.uColor,t)},setLightPos:function(t){this.gl.uniform4fv(this.uLightPos,t)},setNormalMatrix:function(t){this.gl.uniformMatrix4fv(this.uNormalMat,!1,YFM.Math.flatten(t))},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uViewMat,!1,YFM.Math.flatten(t))},setRegionMatrix:function(t){this.gl.uniformMatrix4fv(this.uRegionMat,!1,YFM.Math.flatten(t))},setFloorMatrix:function(t){this.gl.uniformMatrix4fv(this.uFloorMat,!1,YFM.Math.flatten(t))},setModelMatrix:function(t){this.gl.uniformMatrix4fv(this.uModelMat,!1,YFM.Math.flatten(t))},vshader:"attribute vec4 aPosition;  \nattribute vec4 aNormal;    \nattribute vec3 aTexCoord;  \nuniform int    uTexFlag;   \nuniform float  uNs;        \nuniform vec4   uKa;        \nuniform vec4   uKd;        \nuniform vec4   uKs;        \nuniform mat4   uModelMat;  \nuniform mat4   uFloorMat;  \nuniform mat4   uRegionMat; \nuniform mat4   uViewMat;   \nuniform mat4   uProjMat;   \nuniform mat4   uNormalMat; \nuniform vec4   uLightPos;  \nvarying vec3   vTexCoord;  \nvarying vec4   vAmbient;   \nvarying vec4   vDiffuse;   \nvarying vec4   vSpecular;  \n                           \nvoid main(){               \n   mat4 modelViewMatrix = uViewMat*uRegionMat*uFloorMat*uModelMat;\n   vec3 pos = (modelViewMatrix * aPosition).xyz;           \n   vec3 L = normalize((uViewMat*uLightPos).xyz);           \n   vec3 E = -normalize(pos );                              \n   vec3 H = normalize(L + E );                             \n   vec3 N = normalize((uNormalMat*aNormal).xyz);           \n   vAmbient = uKa;                                         \n   vDiffuse = max(dot(L,N), 0.0)*uKd;                      \n   vec4 specular = pow(max(dot(N, H), 0.0), uNs)*uKs;      \n   if(dot(L, N) < 0.0) {                                   \n       specular = vec4(0.0, 0.0, 0.0, 1.0);                \n   }                                                       \n   vSpecular = specular;                                   \n   if(1 == uTexFlag)                                       \n       vTexCoord = aTexCoord;                              \n   else                                                    \n       vTexCoord = vec3(0.0, 0.0, 0.0);                    \n   gl_Position = uProjMat * modelViewMatrix * aPosition;   \n}\n",fshader:"precision mediump float;       \nuniform int        uColorFlag; \nuniform vec4       uColor;     \nuniform sampler2D  uTex;       \nvarying vec3       vTexCoord;  \nvarying vec4       vAmbient;   \nvarying vec4       vDiffuse;   \nvarying vec4       vSpecular;  \nvoid main() {                  \n       vec4 color;                                                     \n       if(1 == uColorFlag)                                             \n           color = uColor;                                             \n       else                                                            \n           color = texture2D(uTex, vTexCoord.xy);                      \n       gl_FragColor = color*vAmbient+color*vDiffuse+color*vSpecular;   \n}\n"},PointSpiritProgram.prototype={constructor:PointSpiritProgram,useProgram:function(){this.gl.useProgram(this.program)},bindTexture:function(t){this.gl.activeTexture(this.gl.TEXTURE0),this.gl.uniform1i(this.uTex,0),this.gl.bindTexture(this.gl.TEXTURE_2D,t)},drawPoints:function(t,e){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.drawArrays(this.gl.POINTS,0,e),this.gl.disable(this.gl.BLEND)},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uViewMat,!1,YFM.Math.flatten(t))},setRegionMatrix:function(t){this.gl.uniformMatrix4fv(this.uRegionMat,!1,YFM.Math.flatten(t))},vshader:"attribute vec4  aPosition; \nuniform mat4   uRegionMat; \nuniform mat4   uViewMat;   \nuniform mat4   uProjMat;   \nvoid main( void ) {                            \n    gl_Position = uProjMat*uViewMat*uRegionMat*aPosition;\n    gl_PointSize = 24.0;                        \n}\n",fshader:"precision mediump float;                       \nuniform sampler2D uTex;                        \nvoid main() {                                  \n   gl_FragColor = texture2D(uTex, gl_PointCoord);\n}\n"},RawPanoramaProgram.prototype={constructor:RawPanoramaProgram,useProgram:function(){this.gl.useProgram(this.program)},drawTriangles:function(t,e){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,12,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.drawArrays(this.gl.TRIANGLES,0,e)},getProgram:function(){return this.program},bindTexture:function(t){this.gl.activeTexture(this.gl.TEXTURE0),this.gl.uniform1i(this.uTexMap,0),this.gl.bindTexture(this.gl.TEXTURE_CUBE_MAP,t)},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uViewMat,!1,YFM.Math.flatten(t))},setModelMatrix:function(t){this.gl.uniformMatrix4fv(this.uModelMat,!1,YFM.Math.flatten(t))},vshader:"attribute  vec4 aPosition;\nuniform mat4 uModelMat;\nuniform mat4 uViewMat;\nuniform mat4 uProjectionMat;\nvarying vec3 V;\nvoid main()\n{\n\tgl_Position = uProjectionMat*uViewMat*uModelMat*aPosition;\n   V = normalize(vec3(aPosition.x, aPosition.y, aPosition.z));\n}\n",fshader:"precision mediump float;\nuniform samplerCube uTexMap;\nvarying vec3 V;\nvoid main()\n{\n\tgl_FragColor = textureCube(uTexMap, V);\n}\n"},RegionPhongProgram.prototype={constructor:RegionPhongProgram,useProgram:function(){this.gl.useProgram(this.program)},drawTriangles:function(t,e,i){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,24,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aNormal,3,this.gl.FLOAT,!1,24,12),this.gl.enableVertexAttribArray(this.aNormal),this.gl.drawArrays(this.gl.TRIANGLES,i,e-i)},drawTrianglesPlus:function(t,e,i){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,24,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aNormal,3,this.gl.FLOAT,!1,24,12),this.gl.enableVertexAttribArray(this.aNormal),this.gl.drawArrays(this.gl.TRIANGLES,e,i-e)},drawLines:function(t,e,i){null!=i&&this.gl.lineWidth(i),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!0,24,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aNormal,3,this.gl.FLOAT,!1,24,12),this.gl.enableVertexAttribArray(this.aNormal),this.gl.drawArrays(this.gl.LINES,0,e),null!=i&&this.gl.lineWidth(1)},setColor:function(t){this.gl.uniform4fv(this.uColor,t)},setLightPos:function(t){this.gl.uniform4fv(this.uLightPos,t)},setNormalMatrix:function(t){this.gl.uniformMatrix4fv(this.uNormalMat,!1,YFM.Math.flatten(t))},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uViewMat,!1,YFM.Math.flatten(t))},setRegionMatrix:function(t){this.gl.uniformMatrix4fv(this.uRegionMat,!1,YFM.Math.flatten(t))},setModelMatrix:function(t){this.gl.uniformMatrix4fv(this.uModelMat,!1,YFM.Math.flatten(t))},vshader:"attribute vec4 aPosition;  \nattribute vec4 aNormal;    \nuniform vec4   uColor;     \nuniform mat4   uModelMat;  \nuniform mat4   uRegionMat; \nuniform mat4   uViewMat;   \nuniform mat4   uProjMat;   \nuniform mat4   uNormalMat; \nuniform vec4   uLightPos;  \nvarying vec4   vColor;     \n                           \nvoid main(){               \n   float shininess = 320.0;                                \n   vec4 ambient, diffuse, specular;                        \n   vec4 ambientProduct = vec4(0.5, 0.5, 0.5, 1.0 );        \n   vec4 diffuseProduct = vec4(1.0, 1.0, 1.0, 1.0 );        \n   vec4 specularProduct= vec4(0.2, 0.2, 0.2, 1.0 );        \n                                                           \n   mat4 modelViewMatrix = uViewMat*uRegionMat*uModelMat;   \n   vec3 pos = (modelViewMatrix * aPosition).xyz;           \n   vec3 L = normalize((uViewMat*uLightPos).xyz);           \n   vec3 E = -normalize(pos );                              \n   vec3 H = normalize(L + E );                             \n   vec3 N = normalize((uNormalMat*aNormal).xyz);           \n   ambient = ambientProduct;                               \n   float Kd = max( dot(L, N), 0.0 );                       \n   diffuse = Kd*diffuseProduct;                            \n   float Ks = pow(max(dot(N, H), 0.0), shininess);         \n   specular = Ks * specularProduct;                        \n   if(dot(L, N) < 0.0) {                                   \n       specular = vec4(0.0, 0.0, 0.0, 1.0);                \n   }                                                       \n   gl_Position = uProjMat * modelViewMatrix * aPosition;   \n   vColor = uColor*ambient+uColor*diffuse+uColor*specular; \n}\n",fshader:"precision mediump float;                                   \nvarying vec4                   vColor;                     \nvoid main() {                                              \n       gl_FragColor = vColor;                              \n}\n"},SSRProgram.prototype={constructor:SSRProgram,useProgram:function(){this.gl.useProgram(this.program)},bindTexture:function(t){this.gl.activeTexture(this.gl.TEXTURE0),this.gl.uniform1i(this.uTex,0),this.gl.bindTexture(this.gl.TEXTURE_2D,t)},drawTriangleStrip:function(t,e,i){var r=t.getAttribute("position"),s=t.getAttribute("uv");if(null!==r){if(r.length<=0)return;if(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,r.vbo),this.gl.vertexAttribPointer(this.aPosition,r.size,this.gl.FLOAT,!1,4*r.size,0),this.gl.enableVertexAttribArray(this.aPosition),null!==s){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,s.vbo),this.gl.vertexAttribPointer(this.aTexCoord,2,this.gl.FLOAT,!1,8,0),this.gl.enableVertexAttribArray(this.aTexCoord);var o=i||r.length-e;this.gl.drawArrays(this.gl.TRIANGLE_STRIP,e,o)}}},setTime:function(t){this.gl.uniform1f(this.uTime,t)},setHH:function(t){this.gl.uniform1f(this.uHH,t)},setHW:function(t){this.gl.uniform1f(this.uHW,t)},setTranFlag:function(t){this.gl.uniform1i(this.uTranFlag,t)},vshader:"attribute  vec4 aPosition; \nattribute vec3  aTexCoord; \nuniform float uTime;       \nuniform float uHH;         \nuniform float uHW;         \nvarying vec3   vTexCoord;  \nvoid main(){               \n   gl_Position = vec4(aPosition.x/uHW, aPosition.y/uHH, aPosition.z, 1.0);\n   vTexCoord = vec3(aTexCoord.x, aTexCoord.y + uTime, 0.0);\n}\n",fshader:"precision mediump float;   \nvarying vec3 vTexCoord;    \nuniform int   uTranFlag;   \nuniform sampler2D uTex;    \nvoid main(){\n   vec4 c = texture2D(uTex, vTexCoord.xy);     \n   if(1 == uTranFlag)                          \n       gl_FragColor = c*vec4(0.3,0.3,0.3,0.3); \n   else                                        \n       gl_FragColor = c;                       \n}\n"},SelectColorProgram.prototype={constructor:SelectColorProgram,useProgram:function(){this.gl.useProgram(this.program)},drawTriangles:function(t,e,i,r){this.gl.uniform4fv(this.uColor,YFM.Math.flatten(e)),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,12,i),this.gl.enableVertexAttribArray(this.aPosition),this.gl.drawArrays(this.gl.TRIANGLES,0,r)},drawLines:function(t,e,i,r){this.gl.uniform4fv(this.uColor,YFM.Math.flatten(e)),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!0,12,i),this.gl.enableVertexAttribArray(this.aPosition),this.gl.drawArrays(this.gl.LINES,0,r)},setColor:function(t){this.gl.uniform4fv(this.uColor,YFM.Math.flatten(t))},drawLinesPlus:function(t,e){var i=t.getAttribute("position");if(null!==i){if(i.length<=0)return;this.gl.bindBuffer(this.gl.ARRAY_BUFFER,i.vbo),this.gl.vertexAttribPointer(this.aPosition,i.size,this.gl.FLOAT,!1,4*i.size,0),this.gl.enableVertexAttribArray(this.aPosition),e&&this.gl.lineWidth(e),this.gl.drawArrays(this.gl.LINES,0,i.length),e&&this.gl.lineWidth(1)}},drawLineStripPlus:function(t,e){var i=t.getAttribute("position");if(null!==i){if(i.length<=0)return;this.gl.bindBuffer(this.gl.ARRAY_BUFFER,i.vbo),this.gl.vertexAttribPointer(this.aPosition,i.size,this.gl.FLOAT,!1,4*i.size,0),this.gl.enableVertexAttribArray(this.aPosition),e&&this.gl.lineWidth(e),this.gl.drawArrays(this.gl.LINE_STRIP,0,i.length),e&&this.gl.lineWidth(1)}},getProgram:function(){return this.program},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uViewMat,!1,YFM.Math.flatten(t))},setRegionMatrix:function(t){this.gl.uniformMatrix4fv(this.uRegionMat,!1,YFM.Math.flatten(t))},setModelMatrix:function(t){this.gl.uniformMatrix4fv(this.uModelMat,!1,YFM.Math.flatten(t))},vshader:"attribute  vec4 aPosition;\nuniform vec4 uColor;\nuniform mat4 uModelMat;\nuniform mat4 uRegionMat;\nuniform mat4 uViewMat;\nuniform mat4 uProjectionMat;\nvarying vec4 vColor;\nvoid main()\n{\n\tgl_Position = uProjectionMat*uViewMat*uRegionMat*uModelMat*aPosition;\n\tvColor = uColor;\n}\n",fshader:"precision mediump float;\nvarying vec4 vColor;\nvoid main()\n{\n\tgl_FragColor = vColor;\n}\n"},TrajectoryProgram.prototype={constructor:TrajectoryProgram,useProgram:function(){this.gl.useProgram(this.program)},bindTexture:function(t){this.gl.activeTexture(this.gl.TEXTURE0),this.gl.uniform1i(this.uTex,0),this.gl.bindTexture(this.gl.TEXTURE_2D,t)},drawTriangleStrip:function(t){var e=t.getAttribute("pos"),i=t.getAttribute("uv"),r=t.getAttribute("index");if(null!==e){if(e.length<=0)return;this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,r.vbo),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,e.vbo),this.gl.vertexAttribPointer(this.aPosition,e.size,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,i.vbo),this.gl.vertexAttribPointer(this.aTexCoord,i.size,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.aTexCoord),this.gl.drawElements(this.gl.TRIANGLE_STRIP,r.length,this.gl.UNSIGNED_SHORT,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,null)}},setPVRMat:function(t){this.gl.uniformMatrix4fv(this.uPVRMat,!1,YFM.Math.flatten(t))},setFloorMat:function(t){this.gl.uniformMatrix4fv(this.uFloorMat,!1,YFM.Math.flatten(t))},setTime:function(t){this.gl.uniform1f(this.uTime,t)},setMapHeight:function(t){this.gl.uniform1f(this.uMapHeight,t)},vshader:"attribute vec2 aPosition;  \nattribute vec3 aTexCoord;  \nuniform mat4 uPVRMat;      \nuniform mat4 uFloorMat;    \nuniform float uMapHeight;  \nuniform float uTime;       \nvarying vec3 vTexCoord;    \nvoid main(){               \n   vec4 pos = vec4(aPosition.x, uMapHeight-aPosition.y, 1.0, 1.0);\n\tgl_Position = uPVRMat*uFloorMat*pos; \n   vTexCoord = vec3(aTexCoord.x, aTexCoord.y + uTime, aTexCoord.z);\n}\n",fshader:"precision mediump float;   \nuniform sampler2D uTex;    \nvarying vec3 vTexCoord;    \nvoid main(){               \n   gl_FragColor = texture2D(uTex, vTexCoord.xy);         \n}\n"},TexturePool.prototype={constructor:TexturePool,addTexture:function(t,e){if(null!=this.pool[t])return!1;var i=new Image,r=new TextureWrap(t,e,i),s=this;i.crossOrigin="Anonymous",i.onload=function(){s._handleTextureLoaded(r)},i.src=e},addTextureBase64:function(t,e){if(null!=this.pool[t])return!1;var i=new Image,r=new TextureWrap(t,"data:base64",i),s=this;i.crossOrigin="Anonymous",i.onload=function(){s._handleTextureLoaded(r)},i.src=e},addTextureMip:function(t,e){if(null!=this.pool[t])return!1;var i=new Image,r=new TextureWrap(t,e,i),s=this;i.crossOrigin="Anonymous",i.onload=function(){s._handleTextureLoadedMip(r)},i.src=e},getTexture:function(t){var e=this.pool[t];return null!=e?{tex:e.tex,w:e.w,h:e.h}:null},_handleTextureLoaded:function(t){this.pool[t.name]=t;var e=this.gl.createTexture();this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.pixelStorei(this.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,t.img),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.bindTexture(this.gl.TEXTURE_2D,null),t.tex=e,t.w=t.img.width,t.h=t.img.height,delete t.img},_handleTextureLoadedMip:function(t){this.pool[t.name]=t;var e=this.gl.createTexture();this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.pixelStorei(this.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,t.img),this.gl.generateMipmap(this.gl.TEXTURE_2D),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR_MIPMAP_LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.REPEAT),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.REPEAT),this.gl.bindTexture(this.gl.TEXTURE_2D,null),t.tex=e,t.w=t.img.width,t.h=t.img.height,delete t.img}},Rays=function(t){this.region=t,this.rays=null,this.vArray=[]},Rays.prototype={constructor:Rays,addRay:function(t){var e=YFM.Math.Vector,i=e.pos(t[0],t[1],t[2]),r=e.vec(t[4],t[5],t[6]),s=e.add(i,r);this.vArray.push(i),this.vArray.push(s)},build:function(){this.rays=new VAttribs(this.region.gl),this.rays.addAttribute("position",this.vArray,3,!1)},clean:function(){this.rays=null,this.vArray=[],this.cArray=[]},render:function(t){if(this.rays){var e=this.region.gl;e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),t.drawLinesPlus(this.rays,2),e.disable(e.DEPTH_TEST)}}},VAttribs.prototype={constructor:VAttribs,persistence:function(){var t={};for(var e in this.attributes){var i=this.attributes[e];t[e]={rawArray:i.rawArray,size:i.size,length:i.length,normalized:i.normalized}}return t},addAttributeFlat:function(t,e,i,r){var s=this.gl,o=r||!1,n=new Float32Array(e),a=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,a),s.bufferData(s.ARRAY_BUFFER,n,s.STATIC_DRAW),s.bindBuffer(s.ARRAY_BUFFER,null),this.attributes[t]={vbo:a,size:i,length:e.length/i,normalized:o}},addAttributeElementFlat:function(t,e){var i=this.gl,r=new Uint16Array(e),s=i.createBuffer();i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,s),i.bufferData(i.ELEMENT_ARRAY_BUFFER,r,i.STATIC_DRAW),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),this.attributes[t]={vbo:s,length:e.length}},addAttribute:function(t,e,i,r){var s=this.gl,o=r||!1,n=s.createBuffer(),a=YFM.Math.flatten(e,i);s.bindBuffer(s.ARRAY_BUFFER,n),s.bufferData(s.ARRAY_BUFFER,a,s.STATIC_DRAW),s.bindBuffer(s.ARRAY_BUFFER,null),this.attributes[t]={vbo:n,size:i,length:e.length,normalized:o}},updateAttribute:function(t,e){var i=this.gl,r=this.attributes[t];if(r){var s=YFM.Math.flatten(e,r.size);i.bindBuffer(i.ARRAY_BUFFER,r.vbo),i.bufferData(i.ARRAY_BUFFER,s,i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,null)}},getAttribute:function(t){return this.attributes[t]},recycle:function(){for(var t in this.attributes){var e=this.attributes[t].vbo,i=this.gl;setTimeout(function(){i.deleteBuffer(e)},2e3)}}};