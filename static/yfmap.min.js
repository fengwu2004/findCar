var YFM={};YFM.Map={},YFM.Map.STATUS_TOUCH=0,YFM.Map.STATUS_SENSOR=1,YFM.Map.STATUS_NAVIGATE=2,YFM.Map.STATUS_TRACE=3,YFM.Map.Navigate={},YFM.Map.Navigate.Suggestion={NONE:"none",FRONT:"front",LEFT:"left",BACKWARD:"backward",RIGHT:"right"},YFM.Map.Navigate.NextSuggestion={NONE:"none",FRONT:"front",LEFT:"left",RIGHT:"right",ARRIVE:"arrive"},YFM.Math={clamp:function(t,e,i){return Math.max(e,Math.min(i,t))},map:function(t,e,i,s,r){return s+(t-e)/(i-e)*(r-s)},deg2Radian:function(t){return 2*t*Math.PI/360},radian2Deg:function(t){return 360*t/(2*Math.PI)},flatten:function(t,e){var i,s=t.length,r=!1;Array.isArray(t[0])&&(r=!0,null==e?(s*=t[0].length,i=t[0].length):(s*=e,i=e));var o=new Float32Array(s);if(r)for(var a=0,n=0;n<t.length;++n)for(var h=0;h<i;++h)o[a++]=t[n][h];else for(n=0;n<t.length;++n)o[n]=t[n];return o},argumentsToArray:function(t){return[].concat.apply([],Array.prototype.slice.apply(t))},floatEquals:function(t,e){return Math.abs(t-e)<=1e-5||(Math.abs(t)>Math.abs(e)?Math.abs((t-e)/t):Math.abs((t-e)/e))<=1e-8},floatNotZero:function(t){return Math.abs(t)>1e-20},vf2str:function(t,e){for(var i="[ ",s=t.length,r=0;r<s;r++)i+=t[r].toFixed(e),i+=", ";return i+="]"},lerp:function(t,e,i){return t+(e-t)*i}},YFM.Mesh={},YFM.Mesh.CATEGORY_TETRHEDRON="tetrahedron",YFM.Mesh.CATEGORY_HEXADEDRON="hexahedron",YFM.Mesh.CATEGORY_OCTAHEDRON="octahedron",YFM.Mesh.CATEGORY_DODECAHEDRON="dodecahedron",YFM.Mesh.CATEGORY_ICOSAHEDRON="icosahedron",YFM.Mesh.CATEGORY_SPHERE="SPHERE",YFM.Mesh.MeshBuffer=function(t){this.gl=t,this.attributes={}},YFM.Mesh.MeshBuffer.prototype={constructor:YFM.Mesh.MeshBuffer,addAttribute:function(t,e,i,s){var r=this.gl,o=new Float32Array(e),a=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,a),r.bufferData(r.ARRAY_BUFFER,o,r.STATIC_DRAW),r.bindBuffer(r.ARRAY_BUFFER,null),this.attributes[t]={vbo:a,size:i,length:e.length/i}},getAttribute:function(t){return this.attributes[t]}},YFM.Panorama=function(t,e){this.gl=t,this.region=e,this.cubeVBO=null,this.cubeSize=0,this.cubeMap=null,this._initCube(),this.modelMat=YFM.Math.Matrix.rotate3d(90,1,0,0)},YFM.Panorama.prototype={constructor:YFM.Panorama,render:function(t,e){null!==this.cubeMap&&(this.gl.enable(this.gl.CULL_FACE),this.gl.frontFace(this.gl.CW),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL),t.setModelMatrix(YFM.Math.Matrix.mul(e,this.modelMat)),t.bindTexture(this.cubeMap),t.drawTriangles(this.cubeVBO,this.cubeSize),this.gl.disable(this.gl.DEPTH_TEST),this.gl.frontFace(this.gl.CCW),this.gl.disable(this.gl.CULL_FACE))},setCubeTex:function(t,e,i,s,r,o){var a={imgList:new Array(6),imgCount:0},n=this;a.imgList[0]=new Image,a.imgList[0].onload=function(){n._handleTextureLoaded(0,a)},a.imgList[0].src=t,a.imgList[1]=new Image,a.imgList[1].onload=function(){n._handleTextureLoaded(1,a)},a.imgList[1].src=e,a.imgList[2]=new Image,a.imgList[2].onload=function(){n._handleTextureLoaded(2,a)},a.imgList[2].src=i,a.imgList[3]=new Image,a.imgList[3].onload=function(){n._handleTextureLoaded(3,a)},a.imgList[3].src=s,a.imgList[4]=new Image,a.imgList[4].onload=function(){n._handleTextureLoaded(4,a)},a.imgList[4].src=r,a.imgList[5]=new Image,a.imgList[5].onload=function(){n._handleTextureLoaded(5,a)},a.imgList[5].src=o},_initCube:function(){var t=this.gl,e=[],i=[YFM.Math.Vector.pos(-5e3,-5e3,5e3),YFM.Math.Vector.pos(-5e3,5e3,5e3),YFM.Math.Vector.pos(5e3,5e3,5e3),YFM.Math.Vector.pos(5e3,-5e3,5e3),YFM.Math.Vector.pos(-5e3,-5e3,-5e3),YFM.Math.Vector.pos(-5e3,5e3,-5e3),YFM.Math.Vector.pos(5e3,5e3,-5e3),YFM.Math.Vector.pos(5e3,-5e3,-5e3)];this._quad(i,e,1,0,3,2),this._quad(i,e,2,3,7,6),this._quad(i,e,3,0,4,7),this._quad(i,e,6,5,1,2),this._quad(i,e,4,5,6,7),this._quad(i,e,5,4,0,1),this.cubeVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.cubeVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(e,3),t.STATIC_DRAW),this.cubeSize=e.length},_quad:function(t,e,i,s,r,o){e.push(t[i]),e.push(t[s]),e.push(t[r]),e.push(t[i]),e.push(t[r]),e.push(t[o])},_makeCubeTex:function(t,e,i,s,r,o){var a=this.gl;null!==this.cubeMap&&a.deleteTexture(this.cubeMap),this.cubeMap=a.createTexture(),a.bindTexture(a.TEXTURE_CUBE_MAP,this.cubeMap),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,t),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_X,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,s),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_Y,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,e),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,r),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_Z,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,i),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,o),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_MIN_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE)},_handleTextureLoaded:function(t,e){e.imgCount+=1,6==e.imgCount&&this._makeCubeTex(e.imgList[0],e.imgList[1],e.imgList[2],e.imgList[3],e.imgList[4],e.imgList[5])}},YFM.SVG=function(){var t=function(t,e,i){return[t/255,e/255,i/255,1]},e={aliceblue:t(240,248,255),antiquewhite:t(250,235,215),aqua:t(0,255,255),aquamarine:t(127,255,212),azure:t(240,255,255),beige:t(245,245,220),bisque:t(255,228,196),black:t(0,0,0),blanchedalmond:t(255,235,205),blue:t(0,0,255),blueviolet:t(138,43,226),brown:t(165,42,42),burlywood:t(222,184,135),cadetblue:t(95,158,160),chartreuse:t(127,255,0),chocolate:t(210,105,30),coral:t(255,127,80),cornflowerblue:t(100,149,237),cornsilk:t(255,248,220),crimson:t(220,20,60),cyan:t(0,255,255),darkblue:t(0,0,139),darkcyan:t(0,139,139),darkgoldenrod:t(184,134,11),darkgray:t(169,169,169),darkgreen:t(0,100,0),darkgrey:t(169,169,169),darkkhaki:t(189,183,107),darkmagenta:t(139,0,139),darkolivegreen:t(85,107,47),darkorange:t(255,140,0),darkorchid:t(153,50,204),darkred:t(139,0,0),darksalmon:t(233,150,122),darkseagreen:t(143,188,143),darkslateblue:t(72,61,139),darkslategray:t(47,79,79),darkslategrey:t(47,79,79),darkturquoise:t(0,206,209),darkviolet:t(148,0,211),deeppink:t(255,20,147),deepskyblue:t(0,191,255),dimgray:t(105,105,105),dimgrey:t(105,105,105),dodgerblue:t(30,144,255),firebrick:t(178,34,34),floralwhite:t(255,250,240),forestgreen:t(34,139,34),fuchsia:t(255,0,255),gainsboro:t(220,220,220),ghostwhite:t(248,248,255),gold:t(255,215,0),goldenrod:t(218,165,32),gray:t(128,128,128),grey:t(128,128,128),green:t(0,128,0),greenyellow:t(173,255,47),honeydew:t(240,255,240),hotpink:t(255,105,180),indianred:t(205,92,92),indigo:t(75,0,130),ivory:t(255,255,240),khaki:t(240,230,140),lavender:t(230,230,250),lavenderblush:t(255,240,245),lawngreen:t(124,252,0),lemonchiffon:t(255,250,205),lightblue:t(173,216,230),lightcoral:t(240,128,128),lightcyan:t(224,255,255),lightgoldenrodyellow:t(250,250,210),lightgray:t(211,211,211),lightgreen:t(144,238,144),lightgrey:t(211,211,211),lightpink:t(255,182,193),lightsalmon:t(255,160,122),lightseagreen:t(32,178,170),lightskyblue:t(135,206,250),lightslategray:t(119,136,153),lightslategrey:t(119,136,153),lightsteelblue:t(176,196,222),lightyellow:t(255,255,224),lime:t(0,255,0),limegreen:t(50,205,50),linen:t(250,240,230),magenta:t(255,0,255),maroon:t(128,0,0),mediumaquamarine:t(102,205,170),mediumblue:t(0,0,205),mediumorchid:t(186,85,211),mediumpurple:t(147,112,219),mediumseagreen:t(60,179,113),mediumslateblue:t(123,104,238),mediumspringgreen:t(0,250,154),mediumturquoise:t(72,209,204),mediumvioletred:t(199,21,133),midnightblue:t(25,25,112),mintcream:t(245,255,250),mistyrose:t(255,228,225),moccasin:t(255,228,181),navajowhite:t(255,222,173),navy:t(0,0,128),oldlace:t(253,245,230),olive:t(128,128,0),olivedrab:t(107,142,35),orange:t(255,165,0),orangered:t(255,69,0),orchid:t(218,112,214),palegoldenrod:t(238,232,170),palegreen:t(152,251,152),paleturquoise:t(175,238,238),palevioletred:t(219,112,147),papayawhip:t(255,239,213),peachpuff:t(255,218,185),peru:t(205,133,63),pink:t(255,192,203),plum:t(221,160,221),powderblue:t(176,224,230),purple:t(128,0,128),red:t(255,0,0),rosybrown:t(188,143,143),royalblue:t(65,105,225),saddlebrown:t(139,69,19),salmon:t(250,128,114),sandybrown:t(244,164,96),seagreen:t(46,139,87),seashell:t(255,245,238),sienna:t(160,82,45),silver:t(192,192,192),skyblue:t(135,206,235),slateblue:t(106,90,205),slategray:t(112,128,144),slategrey:t(112,128,144),snow:t(255,250,250),springgreen:t(0,255,127),steelblue:t(70,130,180),tan:t(210,180,140),teal:t(0,128,128),thistle:t(216,191,216),tomato:t(255,99,71),turquoise:t(64,224,208),violet:t(238,130,238),wheat:t(245,222,179),white:t(255,255,255),whitesmoke:t(245,245,245),yellow:t(255,255,0),yellowgreen:t(154,205,50)},i=function(t,e){return function(t,e,i,s){return[t/255,e/255,i/255,s]}(parseInt(t.slice(0,2),16),parseInt(t.slice(2,4),16),parseInt(t.slice(4,6),16),e)},s=function(t){return t.concat(t)};return{fillColor:function(t,r){var o;if(o=null===r||void 0===r?1:parseFloat(r),t){if("none"===t)return null;if(0==t.indexOf("#"))return 7==t.length?t=t.slice(1):4==t.length&&(t=(t=t.slice(1)).split("").map(s).join("")),i(t,o);var a=e[t];return a?[a[0],a[1],a[2],o]:void 0}},strokeColor:function(t,r){var o;if(o=null===r||void 0===r?1:parseFloat(r),t){if("none"===t)return null;if(0==t.indexOf("#"))return 7==t.length?t=t.slice(1):4==t.length&&(t=(t=t.slice(1)).split("").map(s).join("")),i(t,o);var a=e[t];return a?[a[0],a[1],a[2],o]:void 0}}}}(),YFM.SVG.SVGParser=function(t,e,i,s){this.floor=t,this.region=e,this.extrude=i,this.boundary=s,this.gl=this.region.gl,this.regUnit=/^unit/g,this.regIcon=/^icon/g,this.regText=/^text/g,this.regExtrude=/_ex/,this.regBoundary=/^boundary/,this.extrudeValue=/_ex(\d*)/,this.pathCommand=/([a-z])[\s,]*((-?\d*\.?\d*(?:e[\-+]?\d+)?[\s]*,?[\s]*)+)/gi,this.pathValues=/(-?\d*\.?\d*(?:e[\-+]?\d+)?)[\s]*,?[\s]*/gi,this.tCommand=/(\w+\((\-?\d+\.?\d*e?\-?\d*,?)+\))+/gi,this.tValues=/[\w\.\-]+/gi,this.regTrim=/(^\s*)|(\s*$)/g,this.RECURSION_LIMIT=4,this.FLT_EPSILON=1.1920929e-7,this.PATH_DISTANCE_EPSILON=.4,this.distanceTolerance=this.PATH_DISTANCE_EPSILON*this.PATH_DISTANCE_EPSILON,this.TWO_PI=2*Math.PI,this.transformStack=new YFM.SVG.SVGTransformStack},YFM.SVG.SVGParser.prototype={constructor:YFM.SVG.SVGParser,GROUP_TYPE_EXTRUDE:1,GROUP_TYPE_ICON:2,GROUP_TYPE_BOUNDARY:3,imgCursor:0,readSVG:function(t,e){var i=parseInt(t.getAttribute("width")),s=parseInt(t.getAttribute("height"));if(!i||!s)throw new Error("read svg failed");this.transformStack.clean();for(var r=0;r<t.childNodes.length;r++){var o=t.childNodes.item(r);"g"===o.nodeName&&this._readGroup(o,e,0,1)}return{width:i,height:s}},_readStyle:function(t){var e={},i=t.getAttribute("style");if(i){for(var s,r,o,a=i.split(";"),n=0,h=a.length;n<h;n++)2===(s=a[n].split(":")).length&&(r=s[0].replace(this.regTrim,""),o=s[1].replace(this.regTrim,""),e[r]=o);e.fill=YFM.SVG.fillColor(e.fill,e["fill-opacity"]),e.stroke=YFM.SVG.strokeColor(e.stroke,e["stroke-opacity"]),"evenodd"===e["fill-rule"]?e.fill_rule=YFM.Tess2.WINDING_ODD:e.fill_rule=YFM.Tess2.WINDING_NONZERO,e["stroke-width"]&&(e.stroke_width=parseFloat(e["stroke-width"]))}else{var l=t.getAttribute("fill"),u=t.getAttribute("stroke"),c=t.getAttribute("fill-rule"),M=t.getAttribute("fill-opacity"),d=t.getAttribute("stroke-opacity"),p=t.getAttribute("stroke-width");e.fill=YFM.SVG.fillColor(l,M),e.stroke=YFM.SVG.strokeColor(u,d),e.fill_rule="evenodd"===c?YFM.Tess2.WINDING_ODD:YFM.Tess2.WINDING_NONZERO,p&&(e.stroke_width=parseFloat(p))}return e},_mergeStyle:function(t,e){return{fill:null===e.fill?null:e.fill||t.fill,fill_rule:e.fill_rule||0===e.fill_rule?e.fill_rule:t.fill_rule,stroke:null===e.stroke?null:e.stroke||t.stroke,stroke_width:e.stroke_width||t.stroke_width}},_readGroup:function(t,e,i,s){var r=t.getAttribute("id"),o=0,a=this._readStyle(t);if(r&&s<=1){if(i)o=i;else if(this.regExtrude.test(r)){var n;r.replace(this.extrudeValue,function(t,e){return n=parseFloat(e)||20,e}),this.extrude.setHeight(n),this.regUnit.test(r)&&this.floor.setUnitHeight(n),o=YFM.SVG.SVGParser.prototype.GROUP_TYPE_EXTRUDE}else{if(this.regIcon.test(r)||this.regText.test(r))return void(o=YFM.SVG.SVGParser.prototype.GROUP_TYPE_ICON);this.regBoundary.test(r)&&(o=YFM.SVG.SVGParser.prototype.GROUP_TYPE_BOUNDARY)}this.currentGroup={id:r,type:o,varray:[],carray:[]},e.push(this.currentGroup)}else this.currentGroup?o=i:(this.currentGroup={id:r,type:o,varray:[],carray:[]},e.push(this.currentGroup));var h=t.getAttribute("transform");h&&this.transformStack.pushTransform(h);for(var l=0;l<t.childNodes.length;l++){var u=t.childNodes.item(l);1==u.nodeType&&("g"==u.nodeName?this._readGroup(u,e,o,s+1):this._readObject(u,o,a))}h&&this.transformStack.popTransform()},_readObject:function(t,e,i){var s=this._mergeStyle(i,this._readStyle(t)),r=t.getAttribute("transform");r&&this.transformStack.pushTransform(r),"rect"==t.nodeName?this._addRect(t,e,s):"image"===t.nodeName?this._addImage(t):"polyline"===t.nodeName?this._addPoly(t,e,s,!1):"polygon"===t.nodeName?this._addPoly(t,e,s,!0):"line"===t.nodeName?this._addLine(t,s):"circle"===t.nodeName?this._addEllipse(t,s,e):"ellipse"===t.nodeName?this._addEllipse(t,s,e):"path"===t.nodeName&&this._addPath(t,s,e),r&&this.transformStack.popTransform()},_addRect:function(t,e,i){var s=parseFloat(t.getAttribute("width")),r=parseFloat(t.getAttribute("height")),o=parseFloat(t.getAttribute("x"))||0,a=parseFloat(t.getAttribute("y"))||0,n=[],h=this.transformStack.getCurrentMat();if(h){var l=this._multVec3(h,this._pos2(o,a)),u=this._multVec3(h,this._pos2(o+s,a)),c=this._multVec3(h,this._pos2(o+s,a+r)),M=this._multVec3(h,this._pos2(o,a+r));n.push(l[0]),n.push(l[1]),n.push(u[0]),n.push(u[1]),n.push(c[0]),n.push(c[1]),n.push(M[0]),n.push(M[1])}else n.push(o),n.push(a),n.push(o+s),n.push(a),n.push(o+s),n.push(a+r),n.push(o),n.push(a+r);this._addShape(n,i,e,!0,null)},_addLine:function(t,e){if(e.stroke){var i=t.getAttribute("x1"),s=t.getAttribute("y1"),r=t.getAttribute("x2"),o=t.getAttribute("y2"),a=parseFloat(i),n=parseFloat(s),h=parseFloat(r),l=parseFloat(o),u=this.transformStack.getCurrentMat();if(u){var c=this._multVec3(u,this._pos2(a,n)),M=this._multVec3(u,this._pos2(h,l));a=c[0],n=c[1],h=M[0],l=M[1]}this._addSegAdapt(e,a,n,h,l)}},_addPoly:function(t,e,i,s){for(var r,o,a,n=[],h=t.getAttribute("points").replace(/\s+/," ").split(" "),l=0;l<h.length;l++)2===(r=h[l].split(",")).length&&(o=parseFloat(r[0]),a=parseFloat(r[1]),n.push(o),n.push(a));this._addShape(n,i,e,s,this.transformStack.getCurrentMat())},_addSeg:function(t,e,i,s,r,o){var a;a=t.stroke_width?.5*t.stroke_width:.5;var n=s-e,h=r-i,l=Math.sqrt(n*n+h*h);if(0===l)return null;var u,c,M,d,p=(h/=l)*a,g=(n/=l)*a,f=e-p,m=s-p,F=i+g,v=r+g,x=e+p,Y=s+p,T=i-g,b=r-g,_=t.stroke;return o?(u=o.left,c=o.right,M=YFM.Math.Vector.pos(f,F),d=YFM.Math.Vector.pos(x,T),this.currentGroup.varray.push(u),this.currentGroup.carray.push(_),this.currentGroup.varray.push(c),this.currentGroup.carray.push(_),this.currentGroup.varray.push(M),this.currentGroup.carray.push(_),this.currentGroup.varray.push(c),this.currentGroup.carray.push(_),this.currentGroup.varray.push(d),this.currentGroup.carray.push(_),this.currentGroup.varray.push(M),this.currentGroup.carray.push(_),u=M,c=d):(u=YFM.Math.Vector.pos(f,F),c=YFM.Math.Vector.pos(x,T)),M=YFM.Math.Vector.pos(m,v),d=YFM.Math.Vector.pos(Y,b),this.currentGroup.varray.push(u),this.currentGroup.carray.push(_),this.currentGroup.varray.push(c),this.currentGroup.carray.push(_),this.currentGroup.varray.push(M),this.currentGroup.carray.push(_),this.currentGroup.varray.push(c),this.currentGroup.carray.push(_),this.currentGroup.varray.push(d),this.currentGroup.carray.push(_),this.currentGroup.varray.push(M),this.currentGroup.carray.push(_),{left:M,right:d}},_addSegAdapt:function(t,e,i,s,r){var o;o=t.stroke_width?.5*t.stroke_width:.5;for(var a,n,h=s-e,l=r-i,u=Math.sqrt(h*h+l*l),c=(l/=u)*o,M=(h/=u)*o,d=1/Math.ceil(u/20),p=[],g=[],f=0;f<1;f+=d)a=h*f,n=l*f,p.push(YFM.Math.Vector.pos(e+a-c,i+n+M)),g.push(YFM.Math.Vector.pos(e+a+c,i+n-M));p.push(YFM.Math.Vector.pos(s-c,r+M)),g.push(YFM.Math.Vector.pos(s+c,r-M));for(var m=t.stroke,F=0,v=p.length-1;F<v;F++)this.currentGroup.varray.push(p[F]),this.currentGroup.carray.push(m),this.currentGroup.varray.push(g[F]),this.currentGroup.carray.push(m),this.currentGroup.varray.push(p[F+1]),this.currentGroup.carray.push(m),this.currentGroup.varray.push(g[F]),this.currentGroup.carray.push(m),this.currentGroup.varray.push(g[F+1]),this.currentGroup.carray.push(m),this.currentGroup.varray.push(p[F+1]),this.currentGroup.carray.push(m)},_addEllipse:function(t,e,i){if(e.fill||e.stroke){var s,r,o;if((o=t.getAttribute("r"))?s=r=parseFloat(o)||0:(s=parseFloat(t.getAttribute("rx"))||0,r=parseFloat(t.getAttribute("ry"))||0),!(s<=0||r<=0)){var a,n,h,l,u=parseFloat(t.getAttribute("cx"))||0,c=parseFloat(t.getAttribute("cy"))||0,M=[],d=[],p=[],g=[],f=this.transformStack.getCurrentMat(),m=10/Math.max(s,r),F=this.TWO_PI/32;if(m>F&&(m=F),f){for(l=this._multVec3(f,this._pos2(u,c)),a=0;a<this.TWO_PI;a+=m)if(A=this._multVec3(f,this._pos2(u+s*Math.cos(a),c+r*Math.sin(a))),M.push(A[0]),M.push(A[1]),d.push(YFM.Math.Vector.pos(A[0],A[1])),e.stroke){b=e.stroke_width?.5*e.stroke_width:.5;var v=A[0]-l[0],x=A[1]-l[1],Y=(v/=_=Math.sqrt(v*v+x*x))*b,T=(x/=_)*b;p.push(YFM.Math.Vector.pos(A[0]-Y,A[1]-T)),g.push(YFM.Math.Vector.pos(A[0]+Y,A[1]+T))}}else for(l=this._pos2(u,c),a=0;a<this.TWO_PI;a+=m)if(n=u+s*Math.cos(a),h=c+r*Math.sin(a),M.push(n),M.push(h),d.push(YFM.Math.Vector.pos(n,h)),e.stroke){var b;b=e.stroke_width?.5*e.stroke_width:.5;var v=(A=this._pos2(n,h))[0]-l[0],x=A[1]-l[1],_=Math.sqrt(v*v+x*x),Y=(v/=_)*b,T=(x/=_)*b;p.push(YFM.Math.Vector.pos(A[0]-Y,A[1]-T)),g.push(YFM.Math.Vector.pos(A[0]+Y,A[1]+T))}if(e.fill){var y=[];y.push(M);var R=[];R.push(d),this._tesselate(e.fill,y,R,i,e.fill_rule)}if(e.stroke)if(YFM.SVG.SVGParser.prototype.GROUP_TYPE_EXTRUDE===i){var A,S,L=d.length;for(V=0;V<L;V++){if(A=d[V],V==L-1){if(!close)break;S=d[0]}else S=d[V+1];this.extrude.addBorder(YFM.Math.Vector.pos(A[0],A[1],0),YFM.Math.Vector.pos(S[0],S[1],0),e.stroke)}}else{for(var P=e.stroke,V=0,w=p.length-1;V<w;V++)this.currentGroup.varray.push(p[V]),this.currentGroup.carray.push(P),this.currentGroup.varray.push(g[V]),this.currentGroup.carray.push(P),this.currentGroup.varray.push(p[V+1]),this.currentGroup.carray.push(P),this.currentGroup.varray.push(g[V]),this.currentGroup.carray.push(P),this.currentGroup.varray.push(g[V+1]),this.currentGroup.carray.push(P),this.currentGroup.varray.push(p[V+1]),this.currentGroup.carray.push(P);this.currentGroup.varray.push(p[V]),this.currentGroup.carray.push(P),this.currentGroup.varray.push(g[V]),this.currentGroup.carray.push(P),this.currentGroup.varray.push(p[0]),this.currentGroup.carray.push(P),this.currentGroup.varray.push(g[V]),this.currentGroup.carray.push(P),this.currentGroup.varray.push(g[0]),this.currentGroup.carray.push(P),this.currentGroup.varray.push(p[0]),this.currentGroup.carray.push(P)}}}},_randomColor:function(){var t=[];return t.push(Math.random()),t.push(Math.random()),t.push(Math.random()),t.push(1),t},_addImage:function(t){var e=[],i=[],s=parseFloat(t.getAttribute("width")),r=parseFloat(t.getAttribute("height")),o=parseFloat(t.getAttribute("top"))||0,a=parseFloat(t.getAttribute("x"))||0,n=parseFloat(t.getAttribute("y"))||0,h=t.getAttribute("xlink:href"),l=[],u=this.transformStack.getCurrentMat();if(u){var c=this._multVec3(u,this._pos2(a,n)),M=this._multVec3(u,this._pos2(a+s,n)),d=this._multVec3(u,this._pos2(a+s,n+r)),p=this._multVec3(u,this._pos2(a,n+r));l.push(YFM.Math.Vector.pos(c[0],c[1],o)),l.push(YFM.Math.Vector.pos(M[0],M[1],o)),l.push(YFM.Math.Vector.pos(d[0],d[1],o)),l.push(YFM.Math.Vector.pos(p[0],p[1],o))}else l.push(YFM.Math.Vector.pos(a,n,o)),l.push(YFM.Math.Vector.pos(a+s,n,o)),l.push(YFM.Math.Vector.pos(a+s,n+r,o)),l.push(YFM.Math.Vector.pos(a,n+r,o));e.push(YFM.Math.Vector.vec(0,0)),e.push(YFM.Math.Vector.vec(1,0)),e.push(YFM.Math.Vector.vec(1,1)),e.push(YFM.Math.Vector.vec(0,1)),i.push(l[0]),i.push(e[0]),i.push(l[1]),i.push(e[1]),i.push(l[2]),i.push(e[2]),i.push(l[0]),i.push(e[0]),i.push(l[2]),i.push(e[2]),i.push(l[3]),i.push(e[3]);var g=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,g),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(i,4),this.gl.STATIC_DRAW);var f="svgimg_"+YFM.SVG.SVGParser.prototype.imgCursor;YFM.SVG.SVGParser.prototype.imgCursor+=1,this.currentGroup.imgList||(this.currentGroup.imgList=[]),this.currentGroup.imgList.push({quad:g,texName:f}),this.region.addTexture(f,h)},_addShape:function(t,e,i,s,r){var o,a,n,h,l,u,c=[],M=t.length/2,d=[];for(o=0;o<M;o++)a=t[2*o+0],n=t[2*o+1],r?(h=this._multVec3(r,this._pos2(a,n)),c.push(YFM.Math.Vector.pos(h[0],h[1])),d.push(h[0]),d.push(h[1])):(c.push(YFM.Math.Vector.pos(a,n)),d.push(a),d.push(n));if(e.fill){var p=[];p.push(d);var g=[];g.push(c),this._tesselate(e.fill,p,g,i,e.fill_rule)}var f=!1;if(e.stroke)for(o=0;o<M;o++){if(a=d[2*o+0],n=d[2*o+1],o==M-1){if(!s)break;l=d[0],u=d[1]}else l=d[2*(o+1)+0],u=d[2*(o+1)+1];if(YFM.SVG.SVGParser.prototype.GROUP_TYPE_EXTRUDE===i)this.extrude.addBorder(YFM.Math.Vector.pos(a,n,0),YFM.Math.Vector.pos(l,u,0),e.stroke);else if(null===(f=this._addSeg(e,a,n,l,u,f)))break}},_addPath:function(t,e,i){var s=t.getAttribute("d"),r=new String(s),o=YFM.Math.Vector,a=this,n={a:7,c:6,o:2,h:1,l:2,m:2,r:4,q:4,s:4,t:2,v:1,u:3,z:0},h=[];r.replace(a.pathCommand,function(t,e,i){var s=[],r=e.toLowerCase();if(i.replace(a.pathValues,function(t,e){e&&s.push(+e)}),"m"==r&&s.length>2&&(h.push([e].concat(s.splice(0,2))),r="l",e="m"==e?"l":"L"),"o"==r&&1==s.length&&h.push([e,s[0]]),"r"==r)h.push([e].concat(s));else for(;s.length>=n[r]&&(h.push([e].concat(s.splice(0,n[r]))),n[r]););});var l,u,c,M,d,p,g,f,m,F,v=this.transformStack.getCurrentMat(),x=[],Y=null;for(l=0,u=h.length;l<u;l++){if("M"===(c=h[l])[0])Y&&0!==Y.pts.length&&(Y.close=!1,x.push(Y)),M=o.pos(c[1],c[2]),Y={pts:[],close:!1},this._moveTo(Y.pts,M,v);else if("m"===c[0])Y&&0!==Y.pts.length&&(Y.close=!1,x.push(Y)),M=M?o.pos(M[0]+c[1],M[1]+c[2]):o.pos(c[1],c[2]),Y={pts:[],close:!1},this._moveTo(Y.pts,M,v);else if("z"===c[0]||"Z"===c[0])Y.close=!0,x.push(Y),Y=null;else if("L"===c[0])M=o.pos(c[1],c[2]),this._lineTo(Y.pts,M,v);else if("l"===c[0])M=o.pos(M[0]+c[1],M[1]+c[2]),this._lineTo(Y.pts,M,v);else if("H"===c[0])M=o.pos(c[1],M[1]),this._lineTo(Y.pts,M,v);else if("h"===c[0])M=o.pos(M[0]+c[1],M[1]),this._lineTo(Y.pts,M,v);else if("V"===c[0])M=o.pos(M[0],c[1]),this._lineTo(Y.pts,M,v);else if("v"===c[0])M=o.pos(M[0],M[1]+c[1]),this._lineTo(Y.pts,M,v);else if("Q"===c[0])g=M,f=o.pos(c[1],c[2]),m=o.pos(c[3],c[4]),this._qBerzier(Y.pts,g,f,m,v),M=m;else if("q"===c[0])g=M,f=o.pos(M[0]+c[1],M[1]+c[2]),m=o.pos(M[0]+c[3],M[1]+c[4]),this._qBerzier(Y.pts,g,f,m,v),M=m;else if("T"===c[0]){if("Q"!==d&&"q"!==d&&"T"!==d&&"t"!==d)throw console.log(r),console.log(h),new Error("Berzier no preorder Q/q cmd:"+l);g=m,f=o.add(g,o.sub(m,f)),m=o.pos(c[1],c[2]),this._qBerzier(Y.pts,g,f,m,v),M=m}else if("t"===c[0]){if("Q"!==d&&"q"!==d&&"T"!==d&&"t"!==d)throw console.log(r),console.log(h),new Error("Berzier no preorder Q/q cmd:"+l);g=m,f=o.add(g,o.sub(m,f)),m=o.pos(M[0]+c[1],M[1]+c[2]),this._qBerzier(Y.pts,g,f,m,v),M=m}else if("C"===c[0])g=M,f=o.pos(c[1],c[2]),m=o.pos(c[3],c[4]),F=o.pos(c[5],c[6]),this._cBersizer(Y.pts,g,f,m,F,v),M=F;else if("c"===c[0])g=M,f=o.pos(M[0]+c[1],M[1]+c[2]),m=o.pos(M[0]+c[3],M[1]+c[4]),F=o.pos(M[0]+c[5],M[1]+c[6]),this._cBersizer(Y.pts,g,f,m,F,v),M=F;else if("S"===c[0]){if("C"!==d&&"c"!==d&&"S"!==d&&"s"!==d)throw console.log(r),console.log(h),new Error("Berzier no preorder C/c cmd:"+l);g=F,f=o.add(g,o.sub(F,m)),m=o.pos(c[1],c[2]),F=o.pos(c[3],c[4]),this._cBersizer(Y.pts,g,f,m,F,v),M=F}else if("s"===c[0]){if("C"!==d&&"c"!==d&&"S"!==d&&"s"!==d)throw console.log(r),console.log(h),new Error("Berzier no preorder C/c cmd:"+l);g=F,f=o.add(g,o.sub(F,m)),m=o.pos(M[0]+c[1],M[1]+c[2]),F=o.pos(M[0]+c[3],M[1]+c[4]),this._cBersizer(Y.pts,g,f,m,F,v),M=F}else"A"===c[0]?(p=o.pos(c[6],c[7]),this._arc(Y.pts,M,p,c[1],c[2],c[3],c[4],c[5],v),M=p):"a"===c[0]&&(p=o.pos(M[0]+c[6],M[1]+c[7]),this._arc(Y.pts,M,p,c[1],c[2],c[3],c[4],c[5],v),M=p);d=c[0]}Y&&0!==Y.pts.length&&(Y.close=!1,x.push(Y)),this._pathEnd(x,e,i,s)},_moveTo:function(t,e,i){i&&(e=this._multVec3(i,this._pos2(e[0],e[1]))),t.push(e)},_lineTo:function(t,e,i){i&&(e=this._multVec3(i,this._pos2(e[0],e[1]))),t.push(e)},_arc:function(t,e,i,s,r,o,a,n,h){var l=this._convertArc(e[0],e[1],s,r,o,a,n,i[0],i[1]),u=10/Math.max(l.rx,l.ry),c=Math.floor(Math.abs(l.angleExtent)/u);c<16&&(c=16);var M,d,p,g=l.angleExtent/c;if(h)for(M=0,d=l.angleStart;M<c;M++)d=l.angleStart+M*g,p=this._multVec3(h,this._pos2(l.cx+l.rx*Math.cos(d),l.cy+l.ry*Math.sin(d))),t.push(YFM.Math.Vector.pos(p[0],p[1]));else for(M=0,d=l.angleStart;M<c;M++)d=l.angleStart+M*g,t.push(YFM.Math.Vector.pos(l.cx+l.rx*Math.cos(d),l.cy+l.ry*Math.sin(d)));h&&(i=this._multVec3(h,this._pos2(i[0],i[1]))),t.push(i)},_convertArc:function(t,e,i,s,r,o,a,n,h){var l=(t-n)/2,u=(e-h)/2,r=Math.PI*(r%360)/180,c=Math.cos(r),M=Math.sin(r),d=c*l+M*u,p=-M*l+c*u,g=(i=Math.abs(i))*i,f=(s=Math.abs(s))*s,m=d*d,F=p*p,v=m/g+F/f;v>1&&(g=(i=Math.sqrt(v)*i)*i,f=(s=Math.sqrt(v)*s)*s);var x=o==a?-1:1,Y=(g*f-g*F-f*m)/(g*F+f*m);Y=Y<0?0:Y;var T,b,_=x*Math.sqrt(Y),y=_*(i*p/s),R=_*(-s*d/i),A=(t+n)/2+(c*y-M*R),S=(e+h)/2+(M*y+c*R),L=(d-y)/i,P=(p-R)/s,V=(-d-y)/i,w=(-p-R)/s;b=Math.sqrt(L*L+P*P),T=L;var E=(x=P<0?-1:1)*Math.acos(T/b);b=Math.sqrt((L*L+P*P)*(V*V+w*w)),T=L*V+P*w;var k=(x=L*w-P*V<0?-1:1)*Math.acos(T/b);return!a&&k>0?k-=2*Math.PI:a&&k<0&&(k+=2*Math.PI),k%=2*Math.PI,E%=2*Math.PI,{cx:A,cy:S,rx:i,ry:s,angleStart:E,angleExtent:k,xAngle:r}},_qBerzier:function(t,e,i,s,r){r&&(e=this._multVec3(r,this._pos2(e[0],e[1])),i=this._multVec3(r,this._pos2(i[0],i[1])),s=this._multVec3(r,this._pos2(s[0],s[1]))),t.push(e),this._qBersizerDivPlus(t,e,i,s,0),t.push(s)},_cBersizer:function(t,e,i,s,r,o){o&&(e=this._multVec3(o,this._pos2(e[0],e[1])),i=this._multVec3(o,this._pos2(i[0],i[1])),s=this._multVec3(o,this._pos2(s[0],s[1])),r=this._multVec3(o,this._pos2(r[0],r[1]))),t.push(e),this._cBersizerDivPlus(t,e,i,s,r,0),t.push(r)},_qBersizerDivPlus:function(t,e,i,s,r){if(!(r>this.RECURSION_LIMIT)){var o=YFM.Math.Vector,a=o.mid(e,i),n=o.mid(i,s),h=o.mid(a,n),l=s[0]-e[0],u=s[1]-e[1],c=Math.abs((i[0]-s[0])*u-(i[1]-s[1])*l);if(c>this.FLT_EPSILON){if(c*c<=this.distanceTolerance*(l*l+u*u))return void t.push(h)}else if(l=h[0]-.5*(e[0]+s[0]),u=h[1]-.5*(e[1]+s[1]),l*l+u*u<=this.distanceTolerance)return void t.push(h);this._qBersizerDivPlus(t,e,a,h,r+1),this._qBersizerDivPlus(t,h,n,s,r+1)}},_cBersizerDivPlus:function(t,e,i,s,r,o){if(!(o>this.RECURSION_LIMIT)){var a=YFM.Math.Vector,n=a.mid(e,i),h=a.mid(i,s),l=a.mid(s,r),u=a.mid(n,h),c=a.mid(h,l),M=a.mid(u,c);if(o>0){var d=r[0]-e[0],p=r[1]-e[1],g=Math.abs((i[0]-r[0])*p-(i[1]-r[1])*d),f=Math.abs((s[0]-r[0])*p-(s[1]-r[1])*d);if(g>this.FLT_EPSILON&&f>this.FLT_EPSILON){if((g+f)*(g+f)<=this.distanceTolerance*(d*d+p*p))return void t.push(M)}else if(g>this.FLT_EPSILON){if(g*g<=this.distanceTolerance*(d*d+p*p))return void t.push(M)}else if(f>this.FLT_EPSILON){if(f*f<=this.distanceTolerance*(d*d+p*p))return void t.push(M)}else if(d=M[0]-.5*(e[0]+r[0]),p=M[1]-.5*(e[1]+r[1]),d*d+p*p<=this.distanceTolerance)return void t.push(M)}this._cBersizerDivPlus(t,e,n,u,M,o+1),this._cBersizerDivPlus(t,M,c,l,r,o+1)}},_pathEnd:function(t,e,i,s){var r,o,a,n,h,l,u,c;if(e.stroke)for(r=0,o=t.length;r<o;r++)if((h=t[r].pts).length>5e4)console.log("shapeEnd liule:%s",s);else for(a=0,n=h.length;a<n;a++){if(l=YFM.Math.Vector.pos(h[a][0],h[a][1]),a==n-1){if(!t[r].close)break;u=YFM.Math.Vector.pos(h[0][0],h[0][1])}else u=YFM.Math.Vector.pos(h[a+1][0],h[a+1][1]);YFM.SVG.SVGParser.prototype.GROUP_TYPE_EXTRUDE===i?this.extrude.addBorder(l,u,e.stroke):c=this._addSeg(e,l[0],l[1],u[0],u[1],c)}if(e.fill){var M,d=[],p=[];for(r=0,o=t.length;r<o;r++)if(e.fill||t[r].close){if((h=t[r].pts).length>3e4)continue;for(M=[],a=0,n=h.length;a<n;a++)M.push(h[a][0]),M.push(h[a][1]);d.push(M),p.push(h)}d.length>0&&this._tesselate(e.fill,d,p,i,e.fill_rule)}},_multVec3:function(t,e){var i,s,r,o=[];return i=e[0],s=e[1],r=e[2],o.push(i*t[0]+s*t[3]+r*t[6]),o.push(i*t[1]+s*t[4]+r*t[7]),o.push(i*t[2]+s*t[5]+r*t[8]),o},_pos2:function(t,e){var i=[];return i.push(t),i.push(e),i.push(1),i},_add:function(t,e){var i=[];return i.push(t[0]+e[0]),i.push(t[1]+e[1]),i.push(t[2]+e[2]),i},_sub:function(t,e){var i=[];return i.push(t[0]-e[0]),i.push(t[1]-e[1]),i.push(t[2]-e[2]),i},_norm:function(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1])},_normalize:function(t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]),i=[];return i.push(t[0]/e),i.push(t[1]/e),i.push(t[2]),i},_scale:function(t,e){var i=[];return i.push(t[0]*e),i.push(t[1]*e),i.push(t[2]*e),i},_tesselate:function(t,e,i,s,r){void 0===r&&(r=YFM.Tess2.WINDING_NONZERO);var o,a=[],n={contours:e,windingRule:r,elementType:YFM.Tess2.POLYGONS,polySize:3,vertexSize:2};try{o=YFM.Tess2.tesselate(n)}catch(t){return void console.log("error opt:%o",n)}var h,l,u,c,M,d=[];for(h=0,l=o.vertices.length;h<l;h+=2)d.push(YFM.Math.Vector.pos(o.vertices[h],o.vertices[h+1]));this.currentGroup.carray.length;for(h=0,l=o.elements.length;h<l;h+=3)u=o.elements[h],c=o.elements[h+1],M=o.elements[h+2],0!==s&&(a.push(d[u]),a.push(d[c]),a.push(d[M])),0!==s&&YFM.SVG.SVGParser.prototype.GROUP_TYPE_BOUNDARY!==s||(this.currentGroup.varray.push(d[u]),this.currentGroup.carray.push(t),this.currentGroup.varray.push(d[c]),this.currentGroup.carray.push(t),this.currentGroup.varray.push(d[M]),this.currentGroup.carray.push(t));return YFM.SVG.SVGParser.prototype.GROUP_TYPE_EXTRUDE===s?this.extrude.addExtrude(i,a,t):YFM.SVG.SVGParser.prototype.GROUP_TYPE_BOUNDARY===s&&this.boundary.addExtrude(i,a,t),!0}},YFM.SVG.SVGTransformStack=function(){this.transformCmd=/(\w+\((\-?\d+\.?\d*e?\-?\d*[,\s]?)+\))+/gi,this.transformVal=/[\w\.\-]+/gi,this.matStack=[],this.currentMat=null},YFM.SVG.SVGTransformStack.prototype={constructor:YFM.SVG.SVGTransformStack,pushTransform:function(t){this.matStack.push(this._parseTransform(t));for(var e=this._mat(),i=0,s=this.matStack.length;i<s;i++)e=this._matMul(e,this.matStack[i]);this.currentMat=e},popTransform:function(){if(this.matStack.length>0&&this.matStack.pop(),this.matStack.length>0){for(var t=this._mat(),e=0,i=this.matStack.length;e<i;e++)t=this._matMul(t,this.matStack[e]);this.currentMat=t}else this.currentMat=null},clean:function(){this.matStack=[],this.currentMat=null},getCurrentMat:function(){return this.currentMat},_parseMatrix:function(t){var e=[];if("matrix"===t[0])e.push(parseFloat(t[1])),e.push(parseFloat(t[2])),e.push(0),e.push(parseFloat(t[3])),e.push(parseFloat(t[4])),e.push(0),e.push(parseFloat(t[5])),e.push(parseFloat(t[6])),e.push(1);else if("translate"===t[0])e.push(1),e.push(0),e.push(0),e.push(0),e.push(1),e.push(0),e.push(parseFloat(t[1])),e.push(parseFloat(t[2])),e.push(1);else if("scale"===t[0]){var i,s;2===t.length?i=s=parseFloat(t[1]):(i=parseFloat(t[1]),s=parseFloat(t[2])),e.push(i),e.push(0),e.push(0),e.push(0),e.push(s),e.push(0),e.push(0),e.push(0),e.push(1)}else if("rotate"===t[0]){var r,o,a,n,h;r=YFM.Math.deg2Radian(parseFloat(t[1])),o=Math.cos(r),a=Math.sin(r),e.push(o),e.push(a),e.push(0),e.push(-a),e.push(o),e.push(0),2===t.length?(e.push(0),e.push(0),e.push(1)):(n=parseFloat(t[2]),h=parseFloat(t[3]),e.push(n*(1-o)+h*a),e.push(h*(1-o)-n*a),e.push(1))}return e},_parseTransform:function(t){if(!t)return null;var e,i,s,r,o=t.match(this.transformCmd);r=this._mat();for(e in o)i=o[e].match(this.transformVal),s=this._parseMatrix(i),r=this._matMul(r,s);return r},_matMul:function(t,e){var i,s,r,o,a=[];for(o=0;o<3;o++)i=e[3*o+0],s=e[3*o+1],r=e[3*o+2],a.push(i*t[0]+s*t[3]+r*t[6]),a.push(i*t[1]+s*t[4]+r*t[7]),a.push(i*t[2]+s*t[5]+r*t[8]);return a},_mat:function(){var t=[];return t.push(1),t.push(0),t.push(0),t.push(0),t.push(1),t.push(0),t.push(0),t.push(0),t.push(1),t}},YFM.Tess2={},YFM.Tess2.WINDING_ODD=0,YFM.Tess2.WINDING_NONZERO=1,YFM.Tess2.WINDING_POSITIVE=2,YFM.Tess2.WINDING_NEGATIVE=3,YFM.Tess2.WINDING_ABS_GEQ_TWO=4,YFM.Tess2.POLYGONS=0,YFM.Tess2.CONNECTED_POLYGONS=1,YFM.Tess2.BOUNDARY_CONTOURS=2,YFM.Tess2.tesselate=function(t){for(var e=t.debug||!1,i=new YFM.Tess2.Tesselator,s=0;s<t.contours.length;s++)i.addContour(t.vertexSize||2,t.contours[s]);return i.tesselate(t.windingRule||YFM.Tess2.WINDING_ODD,t.elementType||YFM.Tess2.POLYGONS,t.polySize||3,t.vertexSize||2,t.normal||[0,0,1]),{vertices:i.vertices,vertexIndices:i.vertexIndices,vertexCount:i.vertexCount,elements:i.elements,elementCount:i.elementCount,mesh:e?i.mesh:void 0}};var assert=function(t){if(!t)throw Error("Assertion Failed!")};YFM.Tess2.TESSvertex=function(){this.next=null,this.prev=null,this.anEdge=null,this.coords=[0,0,0],this.s=0,this.t=0,this.pqHandle=0,this.n=0,this.idx=0},YFM.Tess2.TESSface=function(){this.next=null,this.prev=null,this.anEdge=null,this.trail=null,this.n=0,this.marked=!1,this.inside=!1},YFM.Tess2.TESShalfEdge=function(t){this.next=null,this.Sym=null,this.Onext=null,this.Lnext=null,this.Org=null,this.Lface=null,this.activeRegion=null,this.winding=0,this.side=t},YFM.Tess2.TESShalfEdge.prototype={get Rface(){return this.Sym.Lface},set Rface(t){this.Sym.Lface=t},get Dst(){return this.Sym.Org},set Dst(t){this.Sym.Org=t},get Oprev(){return this.Sym.Lnext},set Oprev(t){this.Sym.Lnext=t},get Lprev(){return this.Onext.Sym},set Lprev(t){this.Onext.Sym=t},get Dprev(){return this.Lnext.Sym},set Dprev(t){this.Lnext.Sym=t},get Rprev(){return this.Sym.Onext},set Rprev(t){this.Sym.Onext=t},get Dnext(){return this.Sym.Onext.Sym},set Dnext(t){this.Sym.Onext.Sym=t},get Rnext(){return this.Sym.Lnext.Sym},set Rnext(t){this.Sym.Lnext.Sym=t}},YFM.Tess2.TESSmesh=function(){var t=new YFM.Tess2.TESSvertex,e=new YFM.Tess2.TESSface,i=new YFM.Tess2.TESShalfEdge(0),s=new YFM.Tess2.TESShalfEdge(1);t.next=t.prev=t,t.anEdge=null,e.next=e.prev=e,e.anEdge=null,e.trail=null,e.marked=!1,e.inside=!1,i.next=i,i.Sym=s,i.Onext=null,i.Lnext=null,i.Org=null,i.Lface=null,i.winding=0,i.activeRegion=null,s.next=s,s.Sym=i,s.Onext=null,s.Lnext=null,s.Org=null,s.Lface=null,s.winding=0,s.activeRegion=null,this.vHead=t,this.fHead=e,this.eHead=i,this.eHeadSym=s},YFM.Tess2.TESSmesh.prototype={makeEdge_:function(t){var e=new YFM.Tess2.TESShalfEdge(0),i=new YFM.Tess2.TESShalfEdge(1);t.Sym.side<t.side&&(t=t.Sym);var s=t.Sym.next;return i.next=s,s.Sym.next=e,e.next=t,t.Sym.next=i,e.Sym=i,e.Onext=e,e.Lnext=i,e.Org=null,e.Lface=null,e.winding=0,e.activeRegion=null,i.Sym=e,i.Onext=i,i.Lnext=e,i.Org=null,i.Lface=null,i.winding=0,i.activeRegion=null,e},splice_:function(t,e){var i=t.Onext,s=e.Onext;i.Sym.Lnext=e,s.Sym.Lnext=t,t.Onext=s,e.Onext=i},makeVertex_:function(t,e,i){var s=t;assert(null!==s);var r=i.prev;s.prev=r,r.next=s,s.next=i,i.prev=s,s.anEdge=e;var o=e;do{o.Org=s,o=o.Onext}while(o!==e)},makeFace_:function(t,e,i){var s=t;assert(null!==s);var r=i.prev;s.prev=r,r.next=s,s.next=i,i.prev=s,s.anEdge=e,s.trail=null,s.marked=!1,s.inside=i.inside;var o=e;do{o.Lface=s,o=o.Lnext}while(o!==e)},killEdge_:function(t){t.Sym.side<t.side&&(t=t.Sym);var e=t.next,i=t.Sym.next;e.Sym.next=i,i.Sym.next=e},killVertex_:function(t,e){var i=t.anEdge,s=i;do{s.Org=e,s=s.Onext}while(s!==i);var r=t.prev,o=t.next;o.prev=r,r.next=o},killFace_:function(t,e){var i=t.anEdge,s=i;do{s.Lface=e,s=s.Lnext}while(s!==i);var r=t.prev,o=t.next;o.prev=r,r.next=o},makeEdge:function(){var t=new YFM.Tess2.TESSvertex,e=new YFM.Tess2.TESSvertex,i=new YFM.Tess2.TESSface,s=this.makeEdge_(this.eHead);return this.makeVertex_(t,s,this.vHead),this.makeVertex_(e,s.Sym,this.vHead),this.makeFace_(i,s,this.fHead),s},splice:function(t,e){var i=!1,s=!1;if(t!==e){if(e.Org!==t.Org&&(s=!0,this.killVertex_(e.Org,t.Org)),e.Lface!==t.Lface&&(i=!0,this.killFace_(e.Lface,t.Lface)),this.splice_(e,t),!s){var r=new YFM.Tess2.TESSvertex;this.makeVertex_(r,e,t.Org),t.Org.anEdge=t}if(!i){var o=new YFM.Tess2.TESSface;this.makeFace_(o,e,t.Lface),t.Lface.anEdge=t}}},delete:function(t){var e=t.Sym,i=!1;if(t.Lface!==t.Rface&&(i=!0,this.killFace_(t.Lface,t.Rface)),t.Onext===t)this.killVertex_(t.Org,null);else if(t.Rface.anEdge=t.Oprev,t.Org.anEdge=t.Onext,this.splice_(t,t.Oprev),!i){var s=new YFM.Tess2.TESSface;this.makeFace_(s,t,t.Lface)}e.Onext===e?(this.killVertex_(e.Org,null),this.killFace_(e.Lface,null)):(t.Lface.anEdge=e.Oprev,e.Org.anEdge=e.Onext,this.splice_(e,e.Oprev)),this.killEdge_(t)},addEdgeVertex:function(t){var e=this.makeEdge_(t),i=e.Sym;this.splice_(e,t.Lnext),e.Org=t.Dst;var s=new YFM.Tess2.TESSvertex;return this.makeVertex_(s,i,e.Org),e.Lface=i.Lface=t.Lface,e},splitEdge:function(t,e){var i=this.addEdgeVertex(t).Sym;return this.splice_(t.Sym,t.Sym.Oprev),this.splice_(t.Sym,i),t.Dst=i.Org,i.Dst.anEdge=i.Sym,i.Rface=t.Rface,i.winding=t.winding,i.Sym.winding=t.Sym.winding,i},connect:function(t,e){var i=!1,s=this.makeEdge_(t),r=s.Sym;if(e.Lface!==t.Lface&&(i=!0,this.killFace_(e.Lface,t.Lface)),this.splice_(s,t.Lnext),this.splice_(r,e),s.Org=t.Dst,r.Org=e.Org,s.Lface=r.Lface=t.Lface,t.Lface.anEdge=r,!i){var o=new YFM.Tess2.TESSface;this.makeFace_(o,s,t.Lface)}return s},zapFace:function(t){var e,i,s,r,o,a=t.anEdge;i=a.Lnext;do{i=(e=i).Lnext,e.Lface=null,null===e.Rface&&(e.Onext===e?this.killVertex_(e.Org,null):(e.Org.anEdge=e.Onext,this.splice_(e,e.Oprev)),(s=e.Sym).Onext===s?this.killVertex_(s.Org,null):(s.Org.anEdge=s.Onext,this.splice_(s,s.Oprev)),this.killEdge_(e))}while(e!=a);r=t.prev,(o=t.next).prev=r,r.next=o},countFaceVerts_:function(t){var e=t.anEdge,i=0;do{i++,e=e.Lnext}while(e!==t.anEdge);return i},mergeConvexFaces:function(t){var e,i,s,r,o;for(e=this.fHead.next;e!==this.fHead;e=e.next)if(e.inside)for(o=(i=e.anEdge).Org;;){if(s=i.Lnext,(r=i.Sym)&&r.Lface&&r.Lface.inside&&this.countFaceVerts_(e)+this.countFaceVerts_(r.Lface)-2<=t&&YFM.Tess2.Geom.vertCCW(i.Lprev.Org,i.Org,r.Lnext.Lnext.Org)&&YFM.Tess2.Geom.vertCCW(r.Lprev.Org,r.Org,i.Lnext.Lnext.Org)&&(s=r.Lnext,this.delete(r),i=null,r=null),i&&i.Lnext.Org===o)break;i=s}return!0},check:function(){var t,e,i,s,r,o,a=this.fHead,n=this.vHead,h=this.eHead;for(e=a,e=a;(t=e.next)!==a;e=t){assert(t.prev===e),r=t.anEdge;do{assert(r.Sym!==r),assert(r.Sym.Sym===r),assert(r.Lnext.Onext.Sym===r),assert(r.Onext.Sym.Lnext===r),assert(r.Lface===t),r=r.Lnext}while(r!==t.anEdge)}for(assert(t.prev===e&&null===t.anEdge),s=n,s=n;(i=s.next)!==n;s=i){assert(i.prev===s),r=i.anEdge;do{assert(r.Sym!==r),assert(r.Sym.Sym===r),assert(r.Lnext.Onext.Sym===r),assert(r.Onext.Sym.Lnext===r),assert(r.Org===i),r=r.Onext}while(r!==i.anEdge)}for(assert(i.prev===s&&null===i.anEdge),o=h,o=h;(r=o.next)!==h;o=r)assert(r.Sym.next===o.Sym),assert(r.Sym!==r),assert(r.Sym.Sym===r),assert(null!==r.Org),assert(null!==r.Dst),assert(r.Lnext.Onext.Sym===r),assert(r.Onext.Sym.Lnext===r);assert(r.Sym.next===o.Sym&&r.Sym===this.eHeadSym&&r.Sym.Sym===r&&null===r.Org&&null===r.Dst&&null===r.Lface&&null===r.Rface)}},YFM.Tess2.Geom={},YFM.Tess2.Geom.vertEq=function(t,e){return t.s===e.s&&t.t===e.t},YFM.Tess2.Geom.vertLeq=function(t,e){return t.s<e.s||t.s===e.s&&t.t<=e.t},YFM.Tess2.Geom.transLeq=function(t,e){return t.t<e.t||t.t===e.t&&t.s<=e.s},YFM.Tess2.Geom.edgeGoesLeft=function(t){return YFM.Tess2.Geom.vertLeq(t.Dst,t.Org)},YFM.Tess2.Geom.edgeGoesRight=function(t){return YFM.Tess2.Geom.vertLeq(t.Org,t.Dst)},YFM.Tess2.Geom.vertL1dist=function(t,e){return Math.abs(t.s-e.s)+Math.abs(t.t-e.t)},YFM.Tess2.Geom.edgeEval=function(t,e,i){assert(YFM.Tess2.Geom.vertLeq(t,e)&&YFM.Tess2.Geom.vertLeq(e,i));var s=e.s-t.s,r=i.s-e.s;return s+r>0?s<r?e.t-t.t+(t.t-i.t)*(s/(s+r)):e.t-i.t+(i.t-t.t)*(r/(s+r)):0},YFM.Tess2.Geom.edgeSign=function(t,e,i){assert(YFM.Tess2.Geom.vertLeq(t,e)&&YFM.Tess2.Geom.vertLeq(e,i));var s=e.s-t.s,r=i.s-e.s;return s+r>0?(e.t-i.t)*s+(e.t-t.t)*r:0},YFM.Tess2.Geom.transEval=function(t,e,i){assert(YFM.Tess2.Geom.transLeq(t,e)&&YFM.Tess2.Geom.transLeq(e,i));var s=e.t-t.t,r=i.t-e.t;return s+r>0?s<r?e.s-t.s+(t.s-i.s)*(s/(s+r)):e.s-i.s+(i.s-t.s)*(r/(s+r)):0},YFM.Tess2.Geom.transSign=function(t,e,i){assert(YFM.Tess2.Geom.transLeq(t,e)&&YFM.Tess2.Geom.transLeq(e,i));var s=e.t-t.t,r=i.t-e.t;return s+r>0?(e.s-i.s)*s+(e.s-t.s)*r:0},YFM.Tess2.Geom.vertCCW=function(t,e,i){return t.s*(e.t-i.t)+e.s*(i.t-t.t)+i.s*(t.t-e.t)>=0},YFM.Tess2.Geom.interpolate=function(t,e,i,s){return t=t<0?0:t,i=i<0?0:i,t<=i?0==i?(e+s)/2:e+t/(t+i)*(s-e):s+i/(t+i)*(e-s)},YFM.Tess2.Geom.intersect=function(t,e,i,s,r){var o,a,n;YFM.Tess2.Geom.vertLeq(t,e)||(n=t,t=e,e=n),YFM.Tess2.Geom.vertLeq(i,s)||(n=i,i=s,s=n),YFM.Tess2.Geom.vertLeq(t,i)||(n=t,t=i,i=n,n=e,e=s,s=n),YFM.Tess2.Geom.vertLeq(i,e)?YFM.Tess2.Geom.vertLeq(e,s)?((o=YFM.Tess2.Geom.edgeEval(t,i,e))+(a=YFM.Tess2.Geom.edgeEval(i,e,s))<0&&(o=-o,a=-a),r.s=YFM.Tess2.Geom.interpolate(o,i.s,a,e.s)):((o=YFM.Tess2.Geom.edgeSign(t,i,e))+(a=-YFM.Tess2.Geom.edgeSign(t,s,e))<0&&(o=-o,a=-a),r.s=YFM.Tess2.Geom.interpolate(o,i.s,a,s.s)):r.s=(i.s+e.s)/2,YFM.Tess2.Geom.transLeq(t,e)||(n=t,t=e,e=n),YFM.Tess2.Geom.transLeq(i,s)||(n=i,i=s,s=n),YFM.Tess2.Geom.transLeq(t,i)||(n=t,t=i,i=n,n=e,e=s,s=n),YFM.Tess2.Geom.transLeq(i,e)?YFM.Tess2.Geom.transLeq(e,s)?((o=YFM.Tess2.Geom.transEval(t,i,e))+(a=YFM.Tess2.Geom.transEval(i,e,s))<0&&(o=-o,a=-a),r.t=YFM.Tess2.Geom.interpolate(o,i.t,a,e.t)):((o=YFM.Tess2.Geom.transSign(t,i,e))+(a=-YFM.Tess2.Geom.transSign(t,s,e))<0&&(o=-o,a=-a),r.t=YFM.Tess2.Geom.interpolate(o,i.t,a,s.t)):r.t=(i.t+e.t)/2},YFM.Tess2.DictNode=function(){this.key=null,this.next=null,this.prev=null},YFM.Tess2.Dict=function(t,e){this.head=new YFM.Tess2.DictNode,this.head.next=this.head,this.head.prev=this.head,this.frame=t,this.leq=e},YFM.Tess2.Dict.prototype={min:function(){return this.head.next},max:function(){return this.head.prev},insert:function(t){return this.insertBefore(this.head,t)},search:function(t){var e=this.head;do{e=e.next}while(null!==e.key&&!this.leq(this.frame,t,e.key));return e},insertBefore:function(t,e){do{t=t.prev}while(null!==t.key&&!this.leq(this.frame,t.key,e));var i=new YFM.Tess2.DictNode;return i.key=e,i.next=t.next,t.next.prev=i,i.prev=t,t.next=i,i},delete:function(t){t.next.prev=t.prev,t.prev.next=t.next}},YFM.Tess2.PQnode=function(){this.handle=null},YFM.Tess2.PQhandleElem=function(){this.key=null,this.node=null},YFM.Tess2.PriorityQ=function(t,e){this.size=0,this.max=t,this.nodes=[],this.nodes.length=t+1;for(i=0;i<this.nodes.length;i++)this.nodes[i]=new YFM.Tess2.PQnode;this.handles=[],this.handles.length=t+1;for(var i=0;i<this.handles.length;i++)this.handles[i]=new YFM.Tess2.PQhandleElem;this.initialized=!1,this.freeList=0,this.leq=e,this.nodes[1].handle=1,this.handles[1].key=null},YFM.Tess2.PriorityQ.prototype={floatDown_:function(t){var e,i,s,r=this.nodes,o=this.handles;for(e=r[t].handle;;){if((s=t<<1)<this.size&&this.leq(o[r[s+1].handle].key,o[r[s].handle].key)&&++s,assert(s<=this.max),i=r[s].handle,s>this.size||this.leq(o[e].key,o[i].key)){r[t].handle=e,o[e].node=t;break}r[t].handle=i,o[i].node=t,t=s}},floatUp_:function(t){var e,i,s,r=this.nodes,o=this.handles;for(e=r[t].handle;;){if(s=t>>1,i=r[s].handle,0==s||this.leq(o[i].key,o[e].key)){r[t].handle=e,o[e].node=t;break}r[t].handle=i,o[i].node=t,t=s}},init:function(){for(var t=this.size;t>=1;--t)this.floatDown_(t);this.initialized=!0},min:function(){return this.handles[this.nodes[1].handle].key},isEmpty:function(){this.size},insert:function(t){var e,i;if(2*(e=++this.size)>this.max){this.max*=2;var s;s=this.nodes.length,this.nodes.length=this.max+1;for(r=s;r<this.nodes.length;r++)this.nodes[r]=new YFM.Tess2.PQnode;s=this.handles.length,this.handles.length=this.max+1;for(var r=s;r<this.handles.length;r++)this.handles[r]=new YFM.Tess2.PQhandleElem}return 0===this.freeList?i=e:(i=this.freeList,this.freeList=this.handles[i].node),this.nodes[e].handle=i,this.handles[i].node=e,this.handles[i].key=t,this.initialized&&this.floatUp_(e),i},extractMin:function(){var t=this.nodes,e=this.handles,i=t[1].handle,s=e[i].key;return this.size>0&&(t[1].handle=t[this.size].handle,e[t[1].handle].node=1,e[i].key=null,e[i].node=this.freeList,this.freeList=i,--this.size,this.size>0&&this.floatDown_(1)),s},delete:function(t){var e,i=this.nodes,s=this.handles;assert(t>=1&&t<=this.max&&null!==s[t].key),i[e=s[t].node].handle=i[this.size].handle,s[i[e].handle].node=e,--this.size,e<=this.size&&(e<=1||this.leq(s[i[e>>1].handle].key,s[i[e].handle].key)?this.floatDown_(e):this.floatUp_(e)),s[t].key=null,s[t].node=this.freeList,this.freeList=t}},YFM.Tess2.ActiveRegion=function(){this.eUp=null,this.nodeUp=null,this.windingNumber=0,this.inside=!1,this.sentinel=!1,this.dirty=!1,this.fixUpperEdge=!1},YFM.Tess2.Sweep={},YFM.Tess2.Sweep.regionBelow=function(t){return t.nodeUp.prev.key},YFM.Tess2.Sweep.regionAbove=function(t){return t.nodeUp.next.key},YFM.Tess2.Sweep.debugEvent=function(t){},YFM.Tess2.Sweep.addWinding=function(t,e){t.winding+=e.winding,t.Sym.winding+=e.Sym.winding},YFM.Tess2.Sweep.edgeLeq=function(t,e,i){var s=t.event,r=e.eUp,o=i.eUp;return r.Dst===s?o.Dst===s?YFM.Tess2.Geom.vertLeq(r.Org,o.Org)?YFM.Tess2.Geom.edgeSign(o.Dst,r.Org,o.Org)<=0:YFM.Tess2.Geom.edgeSign(r.Dst,o.Org,r.Org)>=0:YFM.Tess2.Geom.edgeSign(o.Dst,s,o.Org)<=0:o.Dst===s?YFM.Tess2.Geom.edgeSign(r.Dst,s,r.Org)>=0:YFM.Tess2.Geom.edgeEval(r.Dst,s,r.Org)>=YFM.Tess2.Geom.edgeEval(o.Dst,s,o.Org)},YFM.Tess2.Sweep.deleteRegion=function(t,e){e.fixUpperEdge&&assert(0===e.eUp.winding),e.eUp.activeRegion=null,t.dict.delete(e.nodeUp)},YFM.Tess2.Sweep.fixUpperEdge=function(t,e,i){assert(e.fixUpperEdge),t.mesh.delete(e.eUp),e.fixUpperEdge=!1,e.eUp=i,i.activeRegion=e},YFM.Tess2.Sweep.topLeftRegion=function(t,e){var i,s=e.eUp.Org;do{e=YFM.Tess2.Sweep.regionAbove(e)}while(e.eUp.Org===s);if(e.fixUpperEdge){if(null===(i=t.mesh.connect(YFM.Tess2.Sweep.regionBelow(e).eUp.Sym,e.eUp.Lnext)))return null;YFM.Tess2.Sweep.fixUpperEdge(t,e,i),e=YFM.Tess2.Sweep.regionAbove(e)}return e},YFM.Tess2.Sweep.topRightRegion=function(t){var e=t.eUp.Dst,t=null;do{t=YFM.Tess2.Sweep.regionAbove(t)}while(t.eUp.Dst===e);return t},YFM.Tess2.Sweep.addRegionBelow=function(t,e,i){var s=new YFM.Tess2.ActiveRegion;return s.eUp=i,s.nodeUp=t.dict.insertBefore(e.nodeUp,s),s.fixUpperEdge=!1,s.sentinel=!1,s.dirty=!1,i.activeRegion=s,s},YFM.Tess2.Sweep.isWindingInside=function(t,e){switch(t.windingRule){case YFM.Tess2.WINDING_ODD:return 0!=(1&e);case YFM.Tess2.WINDING_NONZERO:return 0!=e;case YFM.Tess2.WINDING_POSITIVE:return e>0;case YFM.Tess2.WINDING_NEGATIVE:return e<0;case YFM.Tess2.WINDING_ABS_GEQ_TWO:return e>=2||e<=-2}return assert(!1),!1},YFM.Tess2.Sweep.computeWinding=function(t,e){e.windingNumber=YFM.Tess2.Sweep.regionAbove(e).windingNumber+e.eUp.winding,e.inside=YFM.Tess2.Sweep.isWindingInside(t,e.windingNumber)},YFM.Tess2.Sweep.finishRegion=function(t,e){var i=e.eUp,s=i.Lface;s.inside=e.inside,s.anEdge=i,YFM.Tess2.Sweep.deleteRegion(t,e)},YFM.Tess2.Sweep.finishLeftRegions=function(t,e,i){for(var s,r=null,o=e,a=e.eUp;o!==i;){if(o.fixUpperEdge=!1,r=YFM.Tess2.Sweep.regionBelow(o),(s=r.eUp).Org!=a.Org){if(!r.fixUpperEdge){YFM.Tess2.Sweep.finishRegion(t,o);break}s=t.mesh.connect(a.Lprev,s.Sym),YFM.Tess2.Sweep.fixUpperEdge(t,r,s)}a.Onext!==s&&(t.mesh.splice(s.Oprev,s),t.mesh.splice(a,s)),YFM.Tess2.Sweep.finishRegion(t,o),a=r.eUp,o=r}return a},YFM.Tess2.Sweep.addRightEdges=function(t,e,i,s,r,o){var a,n,h,l,u=!0;h=i;do{assert(YFM.Tess2.Geom.vertLeq(h.Org,h.Dst)),YFM.Tess2.Sweep.addRegionBelow(t,e,h.Sym),h=h.Onext}while(h!==s);for(null===r&&(r=YFM.Tess2.Sweep.regionBelow(e).eUp.Rprev),n=e,l=r;a=YFM.Tess2.Sweep.regionBelow(n),(h=a.eUp.Sym).Org===l.Org;)h.Onext!==l&&(t.mesh.splice(h.Oprev,h),t.mesh.splice(l.Oprev,h)),a.windingNumber=n.windingNumber-h.winding,a.inside=YFM.Tess2.Sweep.isWindingInside(t,a.windingNumber),n.dirty=!0,!u&&YFM.Tess2.Sweep.checkForRightSplice(t,n)&&(YFM.Tess2.Sweep.addWinding(h,l),YFM.Tess2.Sweep.deleteRegion(t,n),t.mesh.delete(l)),u=!1,n=a,l=h;n.dirty=!0,assert(n.windingNumber-h.winding===a.windingNumber),o&&YFM.Tess2.Sweep.walkDirtyRegions(t,n)},YFM.Tess2.Sweep.spliceMergeVertices=function(t,e,i){t.mesh.splice(e,i)},YFM.Tess2.Sweep.vertexWeights=function(t,e,i){var s=YFM.Tess2.Geom.vertL1dist(e,t),r=YFM.Tess2.Geom.vertL1dist(i,t),o=.5*r/(s+r),a=.5*s/(s+r);t.coords[0]+=o*e.coords[0]+a*i.coords[0],t.coords[1]+=o*e.coords[1]+a*i.coords[1],t.coords[2]+=o*e.coords[2]+a*i.coords[2]},YFM.Tess2.Sweep.getIntersectData=function(t,e,i,s,r,o){e.coords[0]=e.coords[1]=e.coords[2]=0,e.idx=-1,YFM.Tess2.Sweep.vertexWeights(e,i,s),YFM.Tess2.Sweep.vertexWeights(e,r,o)},YFM.Tess2.Sweep.checkForRightSplice=function(t,e){var i=YFM.Tess2.Sweep.regionBelow(e),s=e.eUp,r=i.eUp;if(YFM.Tess2.Geom.vertLeq(s.Org,r.Org)){if(YFM.Tess2.Geom.edgeSign(r.Dst,s.Org,r.Org)>0)return!1;YFM.Tess2.Geom.vertEq(s.Org,r.Org)?s.Org!==r.Org&&(t.pq.delete(s.Org.pqHandle),YFM.Tess2.Sweep.spliceMergeVertices(t,r.Oprev,s)):(t.mesh.splitEdge(r.Sym),t.mesh.splice(s,r.Oprev),e.dirty=i.dirty=!0)}else{if(YFM.Tess2.Geom.edgeSign(s.Dst,r.Org,s.Org)<0)return!1;YFM.Tess2.Sweep.regionAbove(e).dirty=e.dirty=!0,t.mesh.splitEdge(s.Sym),t.mesh.splice(r.Oprev,s)}return!0},YFM.Tess2.Sweep.checkForLeftSplice=function(t,e){var i,s=YFM.Tess2.Sweep.regionBelow(e),r=e.eUp,o=s.eUp;if(assert(!YFM.Tess2.Geom.vertEq(r.Dst,o.Dst)),YFM.Tess2.Geom.vertLeq(r.Dst,o.Dst)){if(YFM.Tess2.Geom.edgeSign(r.Dst,o.Dst,r.Org)<0)return!1;YFM.Tess2.Sweep.regionAbove(e).dirty=e.dirty=!0,i=t.mesh.splitEdge(r),t.mesh.splice(o.Sym,i),i.Lface.inside=e.inside}else{if(YFM.Tess2.Geom.edgeSign(o.Dst,r.Dst,o.Org)>0)return!1;e.dirty=s.dirty=!0,i=t.mesh.splitEdge(o),t.mesh.splice(r.Lnext,o.Sym),i.Rface.inside=e.inside}return!0},YFM.Tess2.Sweep.checkForIntersect=function(t,e){var i,s,r,o,a=YFM.Tess2.Sweep.regionBelow(e),n=e.eUp,h=a.eUp,l=n.Org,u=h.Org,c=n.Dst,M=h.Dst,d=new YFM.Tess2.TESSvertex;if(assert(!YFM.Tess2.Geom.vertEq(M,c)),assert(YFM.Tess2.Geom.edgeSign(c,t.event,l)<=0),assert(YFM.Tess2.Geom.edgeSign(M,t.event,u)>=0),assert(l!==t.event&&u!==t.event),assert(!e.fixUpperEdge&&!a.fixUpperEdge),l===u)return!1;if(i=Math.min(l.t,c.t),s=Math.max(u.t,M.t),i>s)return!1;if(YFM.Tess2.Geom.vertLeq(l,u)){if(YFM.Tess2.Geom.edgeSign(M,l,u)>0)return!1}else if(YFM.Tess2.Geom.edgeSign(c,u,l)<0)return!1;return YFM.Tess2.Sweep.debugEvent(t),YFM.Tess2.Geom.intersect(c,l,M,u,d),assert(Math.min(l.t,c.t)<=d.t),assert(d.t<=Math.max(u.t,M.t)),assert(Math.min(M.s,c.s)<=d.s),assert(d.s<=Math.max(u.s,l.s)),YFM.Tess2.Geom.vertLeq(d,t.event)&&(d.s=t.event.s,d.t=t.event.t),r=YFM.Tess2.Geom.vertLeq(l,u)?l:u,YFM.Tess2.Geom.vertLeq(r,d)&&(d.s=r.s,d.t=r.t),YFM.Tess2.Geom.vertEq(d,l)||YFM.Tess2.Geom.vertEq(d,u)?(YFM.Tess2.Sweep.checkForRightSplice(t,e),!1):!YFM.Tess2.Geom.vertEq(c,t.event)&&YFM.Tess2.Geom.edgeSign(c,t.event,d)>=0||!YFM.Tess2.Geom.vertEq(M,t.event)&&YFM.Tess2.Geom.edgeSign(M,t.event,d)<=0?M===t.event?(t.mesh.splitEdge(n.Sym),t.mesh.splice(h.Sym,n),e=YFM.Tess2.Sweep.topLeftRegion(t,e),n=YFM.Tess2.Sweep.regionBelow(e).eUp,YFM.Tess2.Sweep.finishLeftRegions(t,YFM.Tess2.Sweep.regionBelow(e),a),YFM.Tess2.Sweep.addRightEdges(t,e,n.Oprev,n,n,!0),TRUE):c===t.event?(t.mesh.splitEdge(h.Sym),t.mesh.splice(n.Lnext,h.Oprev),a=e,e=YFM.Tess2.Sweep.topRightRegion(e),o=YFM.Tess2.Sweep.regionBelow(e).eUp.Rprev,a.eUp=h.Oprev,h=YFM.Tess2.Sweep.finishLeftRegions(t,a,null),YFM.Tess2.Sweep.addRightEdges(t,e,h.Onext,n.Rprev,o,!0),!0):(YFM.Tess2.Geom.edgeSign(c,t.event,d)>=0&&(YFM.Tess2.Sweep.regionAbove(e).dirty=e.dirty=!0,t.mesh.splitEdge(n.Sym),n.Org.s=t.event.s,n.Org.t=t.event.t),YFM.Tess2.Geom.edgeSign(M,t.event,d)<=0&&(e.dirty=a.dirty=!0,t.mesh.splitEdge(h.Sym),h.Org.s=t.event.s,h.Org.t=t.event.t),!1):(t.mesh.splitEdge(n.Sym),t.mesh.splitEdge(h.Sym),t.mesh.splice(h.Oprev,n),n.Org.s=d.s,n.Org.t=d.t,n.Org.pqHandle=t.pq.insert(n.Org),YFM.Tess2.Sweep.getIntersectData(t,n.Org,l,c,u,M),YFM.Tess2.Sweep.regionAbove(e).dirty=e.dirty=a.dirty=!0,!1)},YFM.Tess2.Sweep.walkDirtyRegions=function(t,e){for(var i,s,r=YFM.Tess2.Sweep.regionBelow(e);;){for(;r.dirty;)e=r,r=YFM.Tess2.Sweep.regionBelow(r);if(!e.dirty&&(r=e,null==(e=YFM.Tess2.Sweep.regionAbove(e))||!e.dirty))return;if(e.dirty=!1,i=e.eUp,s=r.eUp,i.Dst!==s.Dst&&YFM.Tess2.Sweep.checkForLeftSplice(t,e)&&(r.fixUpperEdge?(YFM.Tess2.Sweep.deleteRegion(t,r),t.mesh.delete(s),s=(r=YFM.Tess2.Sweep.regionBelow(e)).eUp):e.fixUpperEdge&&(YFM.Tess2.Sweep.deleteRegion(t,e),t.mesh.delete(i),i=(e=YFM.Tess2.Sweep.regionAbove(r)).eUp)),i.Org!==s.Org)if(i.Dst===s.Dst||e.fixUpperEdge||r.fixUpperEdge||i.Dst!==t.event&&s.Dst!==t.event)YFM.Tess2.Sweep.checkForRightSplice(t,e);else if(YFM.Tess2.Sweep.checkForIntersect(t,e))return;i.Org===s.Org&&i.Dst===s.Dst&&(YFM.Tess2.Sweep.addWinding(s,i),YFM.Tess2.Sweep.deleteRegion(t,e),t.mesh.delete(i),e=YFM.Tess2.Sweep.regionAbove(r))}},YFM.Tess2.Sweep.connectRightVertex=function(t,e,i){var s,r=i.Onext,o=YFM.Tess2.Sweep.regionBelow(e),a=e.eUp,n=o.eUp,h=!1;a.Dst!==n.Dst&&YFM.Tess2.Sweep.checkForIntersect(t,e),YFM.Tess2.Geom.vertEq(a.Org,t.event)&&(t.mesh.splice(r.Oprev,a),e=YFM.Tess2.Sweep.topLeftRegion(t,e),r=YFM.Tess2.Sweep.regionBelow(e).eUp,YFM.Tess2.Sweep.finishLeftRegions(t,YFM.Tess2.Sweep.regionBelow(e),o),h=!0),YFM.Tess2.Geom.vertEq(n.Org,t.event)&&(t.mesh.splice(i,n.Oprev),i=YFM.Tess2.Sweep.finishLeftRegions(t,o,null),h=!0),h?YFM.Tess2.Sweep.addRightEdges(t,e,i.Onext,r,r,!0):(s=YFM.Tess2.Geom.vertLeq(n.Org,a.Org)?n.Oprev:a,s=t.mesh.connect(i.Lprev,s),YFM.Tess2.Sweep.addRightEdges(t,e,s,s.Onext,s.Onext,!1),s.Sym.activeRegion.fixUpperEdge=!0,YFM.Tess2.Sweep.walkDirtyRegions(t,e))},YFM.Tess2.Sweep.connectLeftDegenerate=function(t,e,i){var s,r,o,a,n;return s=e.eUp,YFM.Tess2.Geom.vertEq(s.Org,i)?(assert(!1),void YFM.Tess2.Sweep.spliceMergeVertices(t,s,i.anEdge)):YFM.Tess2.Geom.vertEq(s.Dst,i)?(assert(!1),e=YFM.Tess2.Sweep.topRightRegion(e),r=a=(o=(n=YFM.Tess2.Sweep.regionBelow(e)).eUp.Sym).Onext,n.fixUpperEdge&&(assert(r!==o),YFM.Tess2.Sweep.deleteRegion(t,n),t.mesh.delete(o),o=r.Oprev),t.mesh.splice(i.anEdge,o),YFM.Tess2.Geom.edgeGoesLeft(r)||(r=null),void YFM.Tess2.Sweep.addRightEdges(t,e,o.Onext,a,r,!0)):(t.mesh.splitEdge(s.Sym),e.fixUpperEdge&&(t.mesh.delete(s.Onext),e.fixUpperEdge=!1),t.mesh.splice(i.anEdge,s),void YFM.Tess2.Sweep.sweepEvent(t,i))},YFM.Tess2.Sweep.connectLeftVertex=function(t,e){var i,s,r,o,a,n,h=new YFM.Tess2.ActiveRegion;h.eUp=e.anEdge.Sym,i=t.dict.search(h).key,(s=YFM.Tess2.Sweep.regionBelow(i))&&(o=i.eUp,a=s.eUp,0!==YFM.Tess2.Geom.edgeSign(o.Dst,e,o.Org)?(r=YFM.Tess2.Geom.vertLeq(a.Dst,o.Dst)?i:s,i.inside||r.fixUpperEdge?(n=r===i?t.mesh.connect(e.anEdge.Sym,o.Lnext):t.mesh.connect(a.Dnext,e.anEdge).Sym,r.fixUpperEdge?YFM.Tess2.Sweep.fixUpperEdge(t,r,n):YFM.Tess2.Sweep.computeWinding(t,YFM.Tess2.Sweep.addRegionBelow(t,i,n)),YFM.Tess2.Sweep.sweepEvent(t,e)):YFM.Tess2.Sweep.addRightEdges(t,i,e.anEdge,e.anEdge,null,!0)):YFM.Tess2.Sweep.connectLeftDegenerate(t,i,e))},YFM.Tess2.Sweep.sweepEvent=function(t,e){t.event=e,YFM.Tess2.Sweep.debugEvent(t);for(var i=e.anEdge;null===i.activeRegion;)if((i=i.Onext)==e.anEdge)return void YFM.Tess2.Sweep.connectLeftVertex(t,e);var s=YFM.Tess2.Sweep.topLeftRegion(t,i.activeRegion);assert(null!==s);var r=YFM.Tess2.Sweep.regionBelow(s),o=r.eUp,a=YFM.Tess2.Sweep.finishLeftRegions(t,r,null);a.Onext===o?YFM.Tess2.Sweep.connectRightVertex(t,s,a):YFM.Tess2.Sweep.addRightEdges(t,s,a.Onext,o,o,!0)},YFM.Tess2.Sweep.addSentinel=function(t,e,i,s){var r=new YFM.Tess2.ActiveRegion,o=t.mesh.makeEdge();o.Org.s=i,o.Org.t=s,o.Dst.s=e,o.Dst.t=s,t.event=o.Dst,r.eUp=o,r.windingNumber=0,r.inside=!1,r.fixUpperEdge=!1,r.sentinel=!0,r.dirty=!1,r.nodeUp=t.dict.insert(r)},YFM.Tess2.Sweep.initEdgeDict=function(t){t.dict=new YFM.Tess2.Dict(t,YFM.Tess2.Sweep.edgeLeq);var e=t.bmax[0]-t.bmin[0],i=t.bmax[1]-t.bmin[1],s=t.bmin[0]-e,r=t.bmax[0]+e,o=t.bmin[1]-i,a=t.bmax[1]+i;YFM.Tess2.Sweep.addSentinel(t,s,r,o),YFM.Tess2.Sweep.addSentinel(t,s,r,a)},YFM.Tess2.Sweep.doneEdgeDict=function(t){for(var e,i=0;null!==(e=t.dict.min().key);)e.sentinel||(assert(e.fixUpperEdge),assert(1==++i)),assert(0==e.windingNumber),YFM.Tess2.Sweep.deleteRegion(t,e)},YFM.Tess2.Sweep.removeDegenerateEdges=function(t){var e,i,s,r=t.mesh.eHead;for(e=r.next;e!==r;e=i)i=e.next,s=e.Lnext,YFM.Tess2.Geom.vertEq(e.Org,e.Dst)&&e.Lnext.Lnext!==e&&(YFM.Tess2.Sweep.spliceMergeVertices(t,s,e),t.mesh.delete(e),s=(e=s).Lnext),s.Lnext===e&&(s!==e&&(s!==i&&s!==i.Sym||(i=i.next),t.mesh.delete(s)),e!==i&&e!==i.Sym||(i=i.next),t.mesh.delete(e))},YFM.Tess2.Sweep.initPriorityQ=function(t){var e,i,s,r=0;for(i=(s=t.mesh.vHead).next;i!==s;i=i.next)r++;for(r+=8,e=t.pq=new YFM.Tess2.PriorityQ(r,YFM.Tess2.Geom.vertLeq),i=(s=t.mesh.vHead).next;i!==s;i=i.next)i.pqHandle=e.insert(i);return i===s&&(e.init(),!0)},YFM.Tess2.Sweep.donePriorityQ=function(t){t.pq=null},YFM.Tess2.Sweep.removeDegenerateFaces=function(t,e){var i,s,r;for(i=e.fHead.next;i!==e.fHead;i=s)s=i.next,r=i.anEdge,assert(r.Lnext!==r),r.Lnext.Lnext===r&&(YFM.Tess2.Sweep.addWinding(r.Onext,r),t.mesh.delete(r));return!0},YFM.Tess2.Sweep.computeInterior=function(t){var e,i;if(YFM.Tess2.Sweep.removeDegenerateEdges(t),!YFM.Tess2.Sweep.initPriorityQ(t))return!1;for(YFM.Tess2.Sweep.initEdgeDict(t);null!==(e=t.pq.extractMin());){for(;null!==(i=t.pq.min())&&YFM.Tess2.Geom.vertEq(i,e);)i=t.pq.extractMin(),YFM.Tess2.Sweep.spliceMergeVertices(t,e.anEdge,i.anEdge);YFM.Tess2.Sweep.sweepEvent(t,e)}return t.event=t.dict.min().key.eUp.Org,YFM.Tess2.Sweep.debugEvent(t),YFM.Tess2.Sweep.doneEdgeDict(t),YFM.Tess2.Sweep.donePriorityQ(t),!!YFM.Tess2.Sweep.removeDegenerateFaces(t,t.mesh)&&(t.mesh.check(),!0)},YFM.Tess2.Tesselator=function(){this.mesh=null,this.normal=[0,0,0],this.sUnit=[0,0,0],this.tUnit=[0,0,0],this.bmin=[0,0],this.bmax=[0,0],this.windingRule=YFM.Tess2.WINDING_ODD,this.dict=null,this.pq=null,this.event=null,this.vertexIndexCounter=0,this.vertices=[],this.vertexIndices=[],this.vertexCount=0,this.elements=[],this.elementCount=0},YFM.Tess2.Tesselator.prototype={dot_:function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},normalize_:function(t){var e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2];assert(e>0),e=Math.sqrt(e),t[0]/=e,t[1]/=e,t[2]/=e},longAxis_:function(t){var e=0;return Math.abs(t[1])>Math.abs(t[0])&&(e=1),Math.abs(t[2])>Math.abs(t[e])&&(e=2),e},computeNormal_:function(t){var e,i,s,r,o,a,n,h=[0,0,0],l=[0,0,0],u=[0,0,0],c=[0,0,0],M=[0,0,0],d=[null,null,null],p=[null,null,null],g=this.mesh.vHead;for(e=g.next,n=0;n<3;++n)r=e.coords[n],l[n]=r,p[n]=e,h[n]=r,d[n]=e;for(e=g.next;e!==g;e=e.next)for(n=0;n<3;++n)(r=e.coords[n])<l[n]&&(l[n]=r,p[n]=e),r>h[n]&&(h[n]=r,d[n]=e);if(n=0,h[1]-l[1]>h[0]-l[0]&&(n=1),h[2]-l[2]>h[n]-l[n]&&(n=2),l[n]>=h[n])return t[0]=0,t[1]=0,void(t[2]=1);for(a=0,i=p[n],s=d[n],u[0]=i.coords[0]-s.coords[0],u[1]=i.coords[1]-s.coords[1],u[2]=i.coords[2]-s.coords[2],e=g.next;e!==g;e=e.next)c[0]=e.coords[0]-s.coords[0],c[1]=e.coords[1]-s.coords[1],c[2]=e.coords[2]-s.coords[2],M[0]=u[1]*c[2]-u[2]*c[1],M[1]=u[2]*c[0]-u[0]*c[2],M[2]=u[0]*c[1]-u[1]*c[0],(o=M[0]*M[0]+M[1]*M[1]+M[2]*M[2])>a&&(a=o,t[0]=M[0],t[1]=M[1],t[2]=M[2]);a<=0&&(t[0]=t[1]=t[2]=0,t[this.longAxis_(u)]=1)},checkOrientation_:function(){var t,e,i,s,r=this.mesh.fHead,o=this.mesh.vHead;for(t=0,e=r.next;e!==r;e=e.next)if(!((s=e.anEdge).winding<=0))do{t+=(s.Org.s-s.Dst.s)*(s.Org.t+s.Dst.t),s=s.Lnext}while(s!==e.anEdge);if(t<0){for(i=o.next;i!==o;i=i.next)i.t=-i.t;this.tUnit[0]=-this.tUnit[0],this.tUnit[1]=-this.tUnit[1],this.tUnit[2]=-this.tUnit[2]}},projectPolygon_:function(){var t,e,i,s,r,o=this.mesh.vHead,a=[0,0,0],n=!1;for(a[0]=this.normal[0],a[1]=this.normal[1],a[2]=this.normal[2],0===a[0]&&0===a[1]&&0===a[2]&&(this.computeNormal_(a),n=!0),e=this.sUnit,i=this.tUnit,e[s=this.longAxis_(a)]=0,e[(s+1)%3]=1,e[(s+2)%3]=0,i[s]=0,i[(s+1)%3]=0,i[(s+2)%3]=a[s]>0?1:-1,t=o.next;t!==o;t=t.next)t.s=this.dot_(t.coords,e),t.t=this.dot_(t.coords,i);for(n&&this.checkOrientation_(),r=!0,t=o.next;t!==o;t=t.next)r?(this.bmin[0]=this.bmax[0]=t.s,this.bmin[1]=this.bmax[1]=t.t,r=!1):(t.s<this.bmin[0]&&(this.bmin[0]=t.s),t.s>this.bmax[0]&&(this.bmax[0]=t.s),t.t<this.bmin[1]&&(this.bmin[1]=t.t),t.t>this.bmax[1]&&(this.bmax[1]=t.t))},addWinding_:function(t,e){t.winding+=e.winding,t.Sym.winding+=e.Sym.winding},tessellateMonoRegion_:function(t,e){var i,s;for(i=e.anEdge,assert(i.Lnext!==i&&i.Lnext.Lnext!==i);YFM.Tess2.Geom.vertLeq(i.Dst,i.Org);i=i.Lprev);for(;YFM.Tess2.Geom.vertLeq(i.Org,i.Dst);i=i.Lnext);for(s=i.Lprev;i.Lnext!==s;)if(YFM.Tess2.Geom.vertLeq(i.Dst,s.Org)){for(;s.Lnext!==i&&(YFM.Tess2.Geom.edgeGoesLeft(s.Lnext)||YFM.Tess2.Geom.edgeSign(s.Org,s.Dst,s.Lnext.Dst)<=0);)s=(r=t.connect(s.Lnext,s)).Sym;s=s.Lprev}else{for(;s.Lnext!=i&&(YFM.Tess2.Geom.edgeGoesRight(i.Lprev)||YFM.Tess2.Geom.edgeSign(i.Dst,i.Org,i.Lprev.Org)>=0);)i=(r=t.connect(i,i.Lprev)).Sym;i=i.Lnext}for(assert(s.Lnext!==i);s.Lnext.Lnext!==i;){var r=t.connect(s.Lnext,s);s=r.Sym}return!0},tessellateInterior_:function(t){var e,i;for(e=t.fHead.next;e!==t.fHead;e=i)if(i=e.next,e.inside&&!this.tessellateMonoRegion_(t,e))return!1;return!0},discardExterior_:function(t){var e,i;for(e=t.fHead.next;e!==t.fHead;e=i)i=e.next,e.inside||t.zapFace(e)},setWindingNumber_:function(t,e,i){var s,r;for(s=t.eHead.next;s!==t.eHead;s=r)r=s.next,s.Rface.inside!==s.Lface.inside?s.winding=s.Lface.inside?e:-e:i?t.delete(s):s.winding=0},getNeighbourFace_:function(t){return t.Rface&&t.Rface.inside?t.Rface.n:-1},outputPolymesh_:function(t,e,i,s){var r,o,a,n,h,l=0,u=0;for(i>3&&t.mergeConvexFaces(i),r=t.vHead.next;r!==t.vHead;r=r.next)r.n=-1;for(o=t.fHead.next;o!=t.fHead;o=o.next)if(o.n=-1,o.inside){a=o.anEdge,n=0;do{-1===(r=a.Org).n&&(r.n=u,u++),n++,a=a.Lnext}while(a!==o.anEdge);assert(n<=i),o.n=l,++l}for(this.elementCount=l,e==YFM.Tess2.CONNECTED_POLYGONS&&(l*=2),this.elements=[],this.elements.length=l*i,this.vertexCount=u,this.vertices=[],this.vertices.length=u*s,this.vertexIndices=[],this.vertexIndices.length=u,r=t.vHead.next;r!==t.vHead;r=r.next)if(-1!=r.n){var c=r.n*s;this.vertices[c+0]=r.coords[0],this.vertices[c+1]=r.coords[1],s>2&&(this.vertices[c+2]=r.coords[2]),this.vertexIndices[r.n]=r.idx}var M=0;for(o=t.fHead.next;o!==t.fHead;o=o.next)if(o.inside){a=o.anEdge,n=0;do{r=a.Org,this.elements[M++]=r.n,n++,a=a.Lnext}while(a!==o.anEdge);for(h=n;h<i;++h)this.elements[M++]=-1;if(e==YFM.Tess2.CONNECTED_POLYGONS){a=o.anEdge;do{this.elements[M++]=this.getNeighbourFace_(a),a=a.Lnext}while(a!==o.anEdge);for(h=n;h<i;++h)this.elements[M++]=-1}}},outputContours_:function(t,e){var i,s,r,o=0,a=0;for(this.vertexCount=0,this.elementCount=0,i=t.fHead.next;i!==t.fHead;i=i.next)if(i.inside){r=s=i.anEdge;do{this.vertexCount++,s=s.Lnext}while(s!==r);this.elementCount++}this.elements=[],this.elements.length=2*this.elementCount,this.vertices=[],this.vertices.length=this.vertexCount*e,this.vertexIndices=[],this.vertexIndices.length=this.vertexCount;var n=0,h=0,l=0;for(o=0,i=t.fHead.next;i!==t.fHead;i=i.next)if(i.inside){a=0,r=s=i.anEdge;do{this.vertices[n++]=s.Org.coords[0],this.vertices[n++]=s.Org.coords[1],e>2&&(this.vertices[n++]=s.Org.coords[2]),this.vertexIndices[h++]=s.Org.idx,a++,s=s.Lnext}while(s!==r);this.elements[l++]=o,this.elements[l++]=a,o+=a}},addContour:function(t,e){var i,s;for(null===this.mesh&&(this.mesh=new YFM.Tess2.TESSmesh),t<2&&(t=2),t>3&&(t=3),i=null,s=0;s<e.length;s+=t)null==i?(i=this.mesh.makeEdge(),this.mesh.splice(i,i.Sym)):(this.mesh.splitEdge(i),i=i.Lnext),i.Org.coords[0]=e[s+0],i.Org.coords[1]=e[s+1],i.Org.coords[2]=t>2?e[s+2]:0,i.Org.idx=this.vertexIndexCounter++,i.winding=1,i.Sym.winding=-1},tesselate:function(t,e,i,s,r){if(this.vertices=[],this.elements=[],this.vertexIndices=[],this.vertexIndexCounter=0,r&&(this.normal[0]=r[0],this.normal[1]=r[1],this.normal[2]=r[2]),this.windingRule=t,s<2&&(s=2),s>3&&(s=3),!this.mesh)return!1;this.projectPolygon_(),YFM.Tess2.Sweep.computeInterior(this);var o=this.mesh;return e==YFM.Tess2.BOUNDARY_CONTOURS?this.setWindingNumber_(o,1,!0):this.tessellateInterior_(o),o.check(),e==YFM.Tess2.BOUNDARY_CONTOURS?this.outputContours_(o,s):this.outputPolymesh_(o,e,i,s),!0}},YFM.WebGL=function(){var t=function(t){return'<table style="background-color: #8CE; width: 100%; height: 100%;"><tr><td align="center"><div style="display: table-cell; vertical-align: middle;"><div style="">'+t+"</div></div></td></tr></table>"},e=function(t,e){for(var i=["webgl","experimental-webgl","webkit-3d","moz-webgl"],s=null,r=0;r<i.length;++r){try{s=t.getContext(i[r],e)}catch(t){}if(s)break}return s};return{create3DContext:e,setupWebGL:function(i,s){function r(e){var s=i.parentNode;s&&(s.innerHTML=t(e))}if(!window.WebGLRenderingContext)return r('This page requires a browser that supports WebGL.<br/><a href="http://get.webgl.org">Click here to upgrade your browser.</a>'),null;var o=e(i,s);return o||r('It doesn\'t appear your computer can support WebGL.<br/><a href="http://get.webgl.org/troubleshooting/">Click here for more information.</a>'),o},makeShader:function(t,e,i){var s,r;if(s=t.createShader(t.VERTEX_SHADER),t.shaderSource(s,e),t.compileShader(s),!t.getShaderParameter(s,t.COMPILE_STATUS))return a="Vertex shader failed to compile.  The error log is:<pre>"+t.getShaderInfoLog(s)+"</pre>",alert(a),-1;if(r=t.createShader(t.FRAGMENT_SHADER),t.shaderSource(r,i),t.compileShader(r),!t.getShaderParameter(r,t.COMPILE_STATUS))return a="Fragment shader failed to compile.  The error log is:<pre>"+t.getShaderInfoLog(r)+"</pre>",alert(a),-1;var o=t.createProgram();if(t.attachShader(o,s),t.attachShader(o,r),t.linkProgram(o),!t.getProgramParameter(o,t.LINK_STATUS)){var a="Shader program failed to link.  The error log is:<pre>"+t.getProgramInfoLog(o)+"</pre>";return alert(a),-1}return o}}}(),YFM.WebGL.Color=function(){var t=function(t){return((16711680&t)>>16)/255},e=function(t){return((65280&t)>>8)/255},i=function(t){return(255&t)/255},s=function(t){return((4278190080&t)>>>24)/255};return{hexColorRed:t,hexColorGreen:e,hexColorBlue:i,hexColorAlpha:s,randomHexRGB:function(){return 4278190080|Math.floor(255*Math.random())<<16|Math.floor(255*Math.random())<<8|Math.floor(255*Math.random())},getRGBVec:function(s){return YFM.Math.Vector.pos(t(s),e(s),i(s))},getRGBAVec:function(r){return YFM.Math.Vector.vec(t(r),e(r),i(r),s(r))}}}(),window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t,e){window.setTimeout(t,1e3/60)},YFM.Map.Floor=function(t,e,i,s,r,o,a){this.loaded=!1,this.gl=t,this.id=e,this.deflection=null!=s?s:0,this.region=r,this.index=o,this.loadListener=a,this.mapWidth=0,this.mapHeight=0,this.vOffset=0,this.unitHeight=0,this.extrude=new YFM.Map.FloorExtrude(t),this.boundary=new YFM.Map.FloorBoundary(t,20),this.quickPolygon=new YFM.Map.FloorQuickPolygon(t),this.quadTree=null,this.icons=null,this.callout=null,this.models=null,this.markers=new YFM.Map.FloorMarkers(this.gl,this.region,this),this.quickCallout=new YFM.Map.FloorQuickCallout(this.gl,this.region,this),this.texRectList=new YFM.Map.FloorTextureRectList(this.region,this.gl),this.texRect=new YFM.Map.FloorTextureRect(this.region,this.gl,0),this.texRectSpec=new YFM.Map.FloorTextureRect(this.region,this.gl,1),this.texRectUltra=new YFM.Map.FloorTextureRect(this.region,this.gl,2),this.trajectory=new YFM.Map.FloorTrajectory(this.region,this,this.gl),this.dummyUnitList=[],this.BBCheck=-1;var n=this;if(null===this.loadListener)n._load_svg(i);else{var h=new XMLHttpRequest;h.open("GET",i,!0),h.responseType="text",h.onload=function(t){200==this.status?(console.log("-ajax request ok"),n._load_svg(this.response),n.loadListener.onLoadFinish(n)):(n.loadListener.onLoadFailed(n,this.status),console.log("-ajax error:%d",this.status))},h.send()}null===YFM.Map.Floor.prototype.quadVBO&&this._initQuad(t),this.modelInstancePending=[]},YFM.Map.Floor.prototype={constructor:YFM.Map.Floor,quadVBO:null,setTrajectoryWidth:function(t){this.trajectory.setWidth(t)},selectUnit:function(t,e,i){this.extrude.selectUnit(t,e,i)},cleanSelect:function(){this.extrude.cleanSelect()},getSize:function(){return this.loaded?this.mapSize:null},getAspect:function(){return{w:this.mapWidth,h:this.mapHeight}},isLoaded:function(){return this.loaded},setUnitHeight:function(t){this.unitHeight=t,this.quickPolygon.setHeight(t+1),this.texRectList.setHeight(t+2),this.texRect.setHeight(t+2.5),this.texRectSpec.setHeight(t+2.5),this.texRectUltra.setHeight(t+2.5)},setVOffset:function(t,e){var i=t*e;YFM.Math.Matrix.setTranslateZ(this.floorMat,i),this.penddingVOffset=null;var s=[];s.push(YFM.Math.Vector.pos(0,0,i)),s.push(YFM.Math.Vector.pos(this.mapWidth,0,i)),s.push(YFM.Math.Vector.pos(this.mapWidth,this.mapHeight,i)),s.push(YFM.Math.Vector.pos(0,this.mapHeight,i)),this.planePolygon=new YFM.Math.PlanePolygon(s),this.icons=new YFM.Map.FloorIcons(this.gl,this.region,this),this.iconPlus=new YFM.Map.FloorIconPlus(this.gl,this.region,this),this.callout=new YFM.Map.FloorCallout(this.gl,this.region,this),this.quadTree=new YFM.Math.FloorQuadTree(this,100),this.vOffset=i},addTrajectory:function(t){this.trajectory.addTrajectory(t)},cleanTrajectory:function(){this.trajectory.cleanTrajectory()},insertUnit:function(t){for(var e,i,s=YFM.Math.Vector,r=[],o=0,a=t.pts.length;o<a;o++)e=t.pts[o][0],i=this.mapHeight-t.pts[o][1],r.push(s.pos(e,i,0)),r.push(s.pos(e,i,this.unitHeight));var n=new YFM.Math.OBB(r),h=s.pos(n.center[0],this.mapHeight-n.center[1],n.center[2]);n.transform(this.floorMat),n.adj_center=s.pos(n.center[0],n.center[1],n.center[2]+.5*this.unitHeight),this.quadTree.insertObjectOBBCenter(t,n,h)},insertIcon:function(t,e,i){this.icons.insertIcon(t,e,i,2)},insertIconPlus:function(t,e,i){this.iconPlus.insertIcon(t,e,i,2)},insertCallout:function(t,e,i,s,r){this.callout.insertCallout(t,e,i,0,s,r)},setCalloutVisibility:function(t){this.callout.setVisibility(t)},insertQuickCallout:function(t,e,i,s,r){this.quickCallout.insertCallout(t,e,i,s,r)},setQuickCalloutVisibility:function(t){this.quickCallout.setVisibility(t)},insertModelInstancePending:function(t,e,i,s,r,o){this.modelInstancePending.push({n:t,a:e,s:i,x:s,y:r,z:o})},insertModelInstance:function(t,e,i,s,r,o){return this.models.insertInstance(t,e,i,YFM.Math.Vector.pos(s,this.mapHeight-r,o))},removeModelInstance:function(t){this.models.removeInstance(t)},searchModel:function(t,e){},searchUnit:function(t,e){return null!=this.quadTree?this.quadTree.rayCheckOBB(t,e):[]},searchIcon:function(t,e,i){return null!=this.icons?this.icons.rayCheck(t,e,i):[]},searchIconPlus:function(t,e){return null!=this.iconPlus?this.iconPlus.rayCheck(t,e):[]},intersectionLine:function(t){return null==this.planePolygon?1024:this.planePolygon.intersectionLine(t,this.floorMat)},floorPos2Region:function(t,e){var i;return i=YFM.Math.Vector.pos(t,this.mapHeight-e,0),YFM.Math.Matrix.mulVec(this.floorMat,i)},getFloorMat:function(){return this.floorMat},frustumCheck:function(t){return null==this.quadTree?-1:this.quadTree.frustumCheck(t)},setObjectColor:function(t,e,i){var s=this.groupMap[t];if(s&&e>=0&&e<s.objarray.length)if(0===s.type&&s.colorVBO){for(var r=this.gl,o=s.objarray[e],a=YFM.WebGL.Color.getRGBAVec(i),n=[],h=0;h<o.len;h++)n.push(a);r.bindBuffer(r.ARRAY_BUFFER,s.colorVBO),r.bufferSubData(r.ARRAY_BUFFER,4*o.start*4,YFM.Math.flatten(n,4)),r.bindBuffer(r.ARRAY_BUFFER,null),o.setted=!0}else if(1===s.type){o=s.objarray[e];this.extrude.setObjectColor(o.top_start,o.top_len,o.side_start,o.side_len,i),o.setted=!0}},resetObjectColor:function(t,e){var i=this.groupMap[t];if(i&&e>=0&&e<i.objarray.length)if(0===i.type&&i.colorVBO){for(var s=this.gl,r=i.objarray[e],o=[],a=0;a<r.len;a++)o.push(r.color);s.bindBuffer(s.ARRAY_BUFFER,i.colorVBO),s.bufferSubData(s.ARRAY_BUFFER,4*r.start*4,YFM.Math.flatten(o,4)),s.bindBuffer(s.ARRAY_BUFFER,null),r.setted=!1}else if(1===i.type){r=i.objarray[e];this.extrude.setObjectColor(r.top_start,r.top_len,r.side_start,r.side_len,r.color),r.setted=!1}},resetObjectColorAll:function(t){var e=this.groupMap[t];if(e)if(0===e.type&&e.colorVBO)for(var i=this.gl,s=0,r=e.objarray.length;s<r;s++){for(var o=e.objarray[s],a=[],n=0;n<o.len;n++)a.push(o.color);i.bindBuffer(i.ARRAY_BUFFER,e.colorVBO),i.bufferSubData(i.ARRAY_BUFFER,4*o.start*4,YFM.Math.flatten(a,4)),i.bindBuffer(i.ARRAY_BUFFER,null),o.setted=!1}else if(1===e.type)for(var s=0,r=e.objarray.length;s<r;s++){o=e.objarray[s];this.extrude.setObjectColor(o.top_start,o.top_len,o.side_start,o.side_len,o.color),o.setted=!1}},renderBase:function(t,e,i){if(this.loaded){t.setMapHeight(this.mapHeight),t.setFloorMatrix(this.floorMat),t.setModelMatrix(YFM.Math.Matrix.mat()),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.ALWAYS);var s,r,o,a,n,h;for(s=0,r=this.groupList.length;s<r;s++)if(o=this.groupList[s],(i||YFM.SVG.SVGParser.prototype.GROUP_TYPE_ICON!==o.type)&&(t.setColorFlag(1),o.trianglesVBO&&o.trianglesSize>0&&t.drawTrianglesPlus(o.trianglesVBO,o.colorVBO,o.trianglesSize),o.imgList))for(t.setColorFlag(0),a=0,n=o.imgList.length;a<n;a++)null!==(h=this.region.getTexture(o.imgList[a].texName))&&(t.bindTexture(h.tex),t.drawTriangles(o.imgList[a].quad,6));this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.BLEND)}},renderExtrude:function(t,e){this.loaded&&(t.setMapHeight(this.mapHeight),t.setFloorMatrix(this.floorMat),this.extrude.render(t,e),this.boundary.render(t),this.quickPolygon.render(t))},renderModels:function(t,e){if(this.models.getInstanceCnt()>0){t.setFloorMatrix(this.floorMat),this.gl.enable(this.gl.CULL_FACE),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL);var i=YFM.Math.Matrix.mul(e,this.floorMat);this.models.render(t,i),this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.CULL_FACE)}},renderIcons:function(t,e){this.icons.renderIcons(t,e),this.iconPlus.renderIcons(t,e)},renderCallout:function(t,e){this.callout.renderCallout(t,e)},renderQuickCallout:function(t,e){this.quickCallout.renderCallout(t,e)},renderMarkers:function(t,e,i,s,r){this.markers.render(t,e,i,s,r)},renderTextureRect:function(t){this.texRectList.render(t),this.texRect.render(t),this.texRectSpec.render(t),this.texRectUltra.render(t)},renderUnit:function(t,e){if(this.loaded){if(this.dummyShader=e,this.gl.depthMask(!1),this.region.drawAllUnit)this.quadTree.render(t,this._renderUnit,this,1024);else{var i=this.quadTree.getContainLevel(t);this.quadTree.render(t,this._renderUnit,this,i)}this.gl.depthMask(!0)}},renderTrajectory:function(){this.trajectory.render()},_renderUnit:function(t,e){var i;i=t.pos.isOBB?e.region.regionPos2Screen(t.pos.adj_center):e.region.regionPos2Screen(t.pos);var s,r,o,a;if(!t.obj.block){u=e.region.ctx2d.measureText(t.obj.text);t.obj.block={hw:(u.width+4)/2,hh:e.region.fontHeight/2}}var n=0;if(t.obj.icon){var h=e.region.getTexture(t.obj.icon);null!==h&&(t.obj.tex={tex:h,texSize:YFM.Math.Vector.vec(h.w/2,h.h/2)},delete t.obj.icon)}if(t.obj.tex&&(n=t.obj.tex.tex.w/2),s=i[0]-t.obj.block.hw-n,r=i[1]-t.obj.block.hh,o=i[0]+t.obj.block.hw,a=i[1]+t.obj.block.hh,!e.region.tqct.check(s,r,o,a)&&(e.region._drawText(t.obj.text,i[0],i[1]),t.obj.tex)){var l;l=t.pos.isOBB?e.region.regionPos2ScreenGL(t.pos.center):e.region.regionPos2ScreenGL(t.pos);var u=YFM.Math.Matrix.scaleXYZ(t.obj.tex.texSize,0,0,0);YFM.Math.Matrix.postTranslate(u,l[0],l[1],0);l[0]-=t.obj.block.hw+n-8;var c=YFM.Math.Matrix.postRotateXY(YFM.Math.Matrix.postTranslate(YFM.Math.Matrix.scaleXYZ(t.obj.tex.texSize,0,0,0),l[0],l[1],0),e.region.camera.getRoll(),l[0],l[1]);e.dummyShader.setModelMatrix(c),e.dummyShader.bindTexture(t.obj.tex.tex.tex),e.dummyShader.drawTriangles(YFM.Map.Floor.prototype.quadVBO,6,0)}},_load_svg:function(t){var e=this.gl,i=(new DOMParser).parseFromString(t,"image/svg+xml"),s=new YFM.SVG.SVGParser(this,this.region,this.extrude,this.boundary);this.groupList=[],this.groupMap={};var r=s.readSVG(i.documentElement,this.groupList);this.mapWidth=r.width,this.mapHeight=r.height,this.mapSize=Math.sqrt(this.mapWidth*this.mapWidth,this.mapHeight*this.mapHeight);var o,a,n;for(a=0,n=this.groupList.length;a<n;a++)o=this.groupList[a],this.groupMap[o.id]=o,o.trianglesSize=o.varray.length,o.trianglesSize>0&&(o.trianglesVBO=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,o.trianglesVBO),e.bufferData(e.ARRAY_BUFFER,YFM.Math.flatten(o.varray,4),e.STATIC_DRAW),o.colorVBO=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,o.colorVBO),e.bufferData(e.ARRAY_BUFFER,YFM.Math.flatten(o.carray,4),e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,null)),delete o.varray,delete o.carray;this.floorMat=YFM.Math.Matrix.translate(-this.mapWidth/2,-this.mapHeight/2,0),this.floorMat=YFM.Math.Matrix.postRotate3d(this.floorMat,-this.deflection,0,0,1),this.extrude.buildExtrude(),this.boundary.buildExtrude(),this.loaded=!0},_initQuad:function(t){var e=[],i=[],s=[];s.push(YFM.Math.Vector.vec(0,1)),s.push(YFM.Math.Vector.vec(1,1)),s.push(YFM.Math.Vector.vec(1,0)),s.push(YFM.Math.Vector.vec(0,0)),i.push(YFM.Math.Vector.pos(-1,-1,0)),i.push(YFM.Math.Vector.pos(1,-1,0)),i.push(YFM.Math.Vector.pos(1,1,0)),i.push(YFM.Math.Vector.pos(-1,1,0)),e.push(i[0]),e.push(s[0]),e.push(i[1]),e.push(s[1]),e.push(i[2]),e.push(s[2]),e.push(i[0]),e.push(s[0]),e.push(i[2]),e.push(s[2]),e.push(i[3]),e.push(s[3]),YFM.Map.Floor.prototype.quadVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,YFM.Map.Floor.prototype.quadVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(e,3),t.STATIC_DRAW)}},YFM.Map.FloorBoundary=function(t,e){this.gl=t,this.height=e,this.boundarySideVBO=null,this.boundarySideCBO=null,this.boundarySideSize=0,this.boundarySideVarray=[],this.boundarySideCarray=[],this.loaded=!1},YFM.Map.FloorBoundary.prototype={constructor:YFM.Map.FloorBoundary,render:function(t){this.loaded&&null!=this.boundarySideVBO&&(this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL),t.setLighting(1),t.setHeightScale(1),t.drawTriangles(this.boundarySideVBO,this.boundarySideCBO,this.boundarySideSize),this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.BLEND))},addExtrude:function(t,e,i){var s,r,o,a,n,h,l;for(a=0,o=t.length;a<o;a++){for(r=(s=t[a]).length,n=0;n<r-1;n++)h=s[n],l=s[n+1],this._putSideQuad(l,h,i);h=s[n],l=s[0],this._putSideQuad(l,h,i)}},buildExtrude:function(){this.boundarySideSize=this.boundarySideVarray.length/2,0!==this.boundarySideSize?(this.boundarySideVBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.boundarySideVBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(this.boundarySideVarray,4),this.gl.STATIC_DRAW),this.boundarySideCBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.boundarySideCBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(this.boundarySideCarray,4),this.gl.STATIC_DRAW),this.boundarySideVarray=[],this.boundarySideCarray=[],this.loaded=!0):this.loaded=!1},_putSideQuad:function(t,e,i){var s,r,o,a,n,h=[],l=[];s=YFM.Math.Vector.pos(t[0],t[1],t[2]),r=YFM.Math.Vector.pos(e[0],e[1],e[2]),o=YFM.Math.Vector.pos(e[0],e[1],e[2]-this.height),a=YFM.Math.Vector.pos(t[0],t[1],t[2]-this.height),h.push(s),h.push(o),h.push(r),l.push(s),l.push(a),l.push(o),n=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(YFM.Math.Vector.sub(r,s),YFM.Math.Vector.sub(o,r))),this.boundarySideVarray.push(h[0]),this.boundarySideVarray.push(n),this.boundarySideVarray.push(h[1]),this.boundarySideVarray.push(n),this.boundarySideVarray.push(h[2]),this.boundarySideVarray.push(n),this.boundarySideVarray.push(l[0]),this.boundarySideVarray.push(n),this.boundarySideVarray.push(l[1]),this.boundarySideVarray.push(n),this.boundarySideVarray.push(l[2]),this.boundarySideVarray.push(n),this.boundarySideCarray.push(i),this.boundarySideCarray.push(i),this.boundarySideCarray.push(i),this.boundarySideCarray.push(i),this.boundarySideCarray.push(i),this.boundarySideCarray.push(i)}},YFM.Map.FloorCallout=function(t,e,i){this.gl=t,this.region=e,this.floor=i,this.quadTree=new YFM.Math.FloorQuadTree(i,100),this.sizeH=20,this.sizeW=30,this.visible=!0,this._initMesh()},YFM.Map.FloorCallout.prototype={constructor:YFM.Map.FloorCallout,setVisibility:function(t){this.visible=t},insertCallout:function(t,e,i,s,r,o){var a,n,h=this.floor.floorPos2Region(e,i);h[2]+=s,a=void 0==r?0:r,n=void 0==o?0:o,t.pos=h,t.spos={cx:0,cy:0,gx:0,gy:0},t.colorVec=YFM.WebGL.Color.getRGBAVec(t.color),t.dirty=!0,t.offset=[a,n],this.quadTree.insertObject(t,this.floor.index,e,i,s)},rayCheck:function(t,e,i){return this.quadTree.rayCheck(t,e,i)},renderCallout:function(t,e){!0===this.visible&&(this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA),this.shader=e,this.quadTree.render(t,this._renderCallout,this,1024),this.gl.disable(this.gl.BLEND))},_renderCallout:function(t,e){var i,s=t.obj;if(!1!==s.visible){s.block&&!0!==s.dirty||(s.block=e._makeTextBlock(s.text,e.region.ctx2d,e.region.fontHeight,e.sizeW,e.sizeH),s.dirty=!1),i=s.block,e.region.regionPos2ScreenPlus(s.pos,s.spos);var r=YFM.Math.Matrix.translate(s.spos.gx+s.offset[0],s.spos.gy+e.sizeH+s.offset[1],0);e.shader.setModelMatrix(r),e.shader.draw(e.anchorMesh,e.gl.TRIANGLES,s.colorVec),r=YFM.Math.Matrix.scaleXYZ(i.scale,0,0,0),r=YFM.Math.Matrix.postTranslate(r,s.spos.gx+s.offset[0],s.spos.gy+e.sizeH+i.phh+s.offset[1],0),e.shader.setModelMatrix(r),e.shader.draw(e.panleMesh,e.gl.TRIANGLES,s.colorVec);var o,a,n,h=s.spos.cy-e.sizeH/2-i.phh-i.bhh-s.offset[1];for(o=0,a=i.lines.length;o<a;o++)n=s.spos.cx+s.offset[0],e.region._drawText(i.lines[o],n,h),h+=e.region.fontHeight}},_makeTextBlock:function(t,e,i,s,r){for(var o,a,n,h,l,u=t.split(/\r?\n/),c=0,M=0,d=0;d<u.length;d++)M+=i/2,(l=(e.measureText(u[d]).width+4)/2)>c&&(c=l);return o=c+s/2,a=M+r/2,n=o/s,h=a/r,{lines:u,bhw:c,bhh:M,phw:o,phh:a,scale:[n,h,1]}},_initMesh:function(){var t=YFM.Math.Vector,e=[];e.push(t.pos(0,-this.sizeH)),e.push(t.pos(this.sizeW/2,0)),e.push(t.pos(-this.sizeW/2,1)),this.anchorMesh=new YFM.WebGL.VAttribs(this.gl),this.anchorMesh.addAttribute("position",e,3);var i=[];i.push(t.pos(-this.sizeW,this.sizeH)),i.push(t.pos(this.sizeW,-this.sizeH)),i.push(t.pos(this.sizeW,this.sizeH)),i.push(t.pos(-this.sizeW,this.sizeH)),i.push(t.pos(-this.sizeW,-this.sizeH)),i.push(t.pos(this.sizeW,-this.sizeH)),this.panleMesh=new YFM.WebGL.VAttribs(this.gl),this.panleMesh.addAttribute("position",i,3)}},YFM.Map.FloorExtrude=function(t){this.gl=t,this.height=0,this.extrudeTopVBO=null,this.extrudeTopCBO=null,this.extrudeTopSize=0,this.extrudeTopVarray=[],this.extrudeTopCarray=[],this.extrudeSideVBO=null,this.extrudeSideCBO=null,this.extrudeSideSize=0,this.extrudeSideVarray=[],this.extrudeSideCarray=[],this.borderVBO=null,this.borderSize=0,this.borderVarray=[],this.borderNormal=YFM.Math.Vector.vec(0,0,1),this.loaded=!1},YFM.Map.FloorExtrude.prototype={constructor:YFM.Map.FloorExtrude,setHeight:function(t){this.height=t},setObjectColor:function(t,e,i,s,r){var o,a,n=this.gl,h=[];for(a=r instanceof Array?r:YFM.WebGL.Color.getRGBAVec(r),o=0;o<e;o++)h.push(a);for(n.bindBuffer(n.ARRAY_BUFFER,this.extrudeTopCBO),n.bufferSubData(n.ARRAY_BUFFER,4*t*4,YFM.Math.flatten(h,4)),h=[],o=0;o<s;o++)h.push(a);n.bindBuffer(n.ARRAY_BUFFER,this.extrudeSideCBO),n.bufferSubData(n.ARRAY_BUFFER,4*i*4,YFM.Math.flatten(h,4)),n.bindBuffer(n.ARRAY_BUFFER,null)},render:function(t,e){this.loaded&&(null!=this.extrudeTopVBO&&(this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL),t.setLighting(1),t.setHeightScale(1),null!=this.extrudeSideVBO&&t.drawTriangles(this.extrudeSideVBO,this.extrudeSideCBO,this.extrudeSideSize),t.setLighting(0),t.drawTriangles(this.extrudeTopVBO,this.extrudeTopCBO,this.extrudeTopSize),this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.BLEND)),null!=this.borderVBO&&0!==this.borderSize&&(this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL),this.gl.lineWidth(2),t.drawLines(this.borderVBO,this.borderSize),this.gl.lineWidth(1),this.gl.disable(this.gl.DEPTH_TEST)))},addBorder:function(t,e,i){t[2]+=this.height,e[2]+=this.height,this.borderVarray.push(t),this.borderVarray.push(i),this.borderVarray.push(this.borderNormal),this.borderVarray.push(e),this.borderVarray.push(i),this.borderVarray.push(this.borderNormal)},addExtrude:function(t,e,i){var s,r,o,a,n,h,l,u,c,M,d=e.length/3,p=YFM.Math.Vector.vec(0,0,1);for(a=0;a<d;a++)u=e[3*a+0],c=e[3*a+1],M=e[3*a+2],this.extrudeTopVarray.push(YFM.Math.Vector.pos(u[0],u[1],u[2]+this.height)),this.extrudeTopVarray.push(p),this.extrudeTopVarray.push(YFM.Math.Vector.pos(M[0],M[1],M[2]+this.height)),this.extrudeTopVarray.push(p),this.extrudeTopVarray.push(YFM.Math.Vector.pos(c[0],c[1],c[2]+this.height)),this.extrudeTopVarray.push(p),this.extrudeTopCarray.push(i),this.extrudeTopCarray.push(i),this.extrudeTopCarray.push(i);for(a=0,o=t.length;a<o;a++){for(r=(s=t[a]).length,n=0;n<r-1;n++)h=s[n],l=s[n+1],this._putSideQuad(l,h,i);h=s[n],l=s[0],this._putSideQuad(l,h,i)}},buildExtrude:function(){this.extrudeTopVBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.extrudeTopVBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(this.extrudeTopVarray,4),this.gl.STATIC_DRAW),this.extrudeTopSize=this.extrudeTopVarray.length/2,this.extrudeTopVarray=[],this.extrudeTopCBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.extrudeTopCBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(this.extrudeTopCarray,4),this.gl.STATIC_DRAW),this.extrudeTopCarray=[],this.extrudeSideVBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.extrudeSideVBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(this.extrudeSideVarray,4),this.gl.STATIC_DRAW),this.extrudeSideSize=this.extrudeSideVarray.length/2,this.extrudeSideVarray=[],this.extrudeSideCBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.extrudeSideCBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(this.extrudeSideCarray,4),this.gl.STATIC_DRAW),this.extrudeSideCarray=[],this.borderVBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.borderVBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(this.borderVarray,3),this.gl.STATIC_DRAW),this.borderSize=this.borderVarray.length/3,this.borderVarray=[],0!==this.extrudeTopSize||0!==this.extrudeSideSize||0!==this.borderSize?this.loaded=!0:this.loaded=!1},_clock_wise_tri:function(t){var e=0;return e+=(t[1][0]-t[0][0])*(t[1][1]+t[0][1]),e+=(t[2][0]-t[1][0])*(t[2][1]+t[1][1]),(e+=(t[0][0]-t[2][0])*(t[0][1]+t[2][1]))>0},_clock_wise_pts:function(t){for(var e=0,i=t.length,s=0;s<i;s++)e+=(t[(s+1)%i][0]-t[s][0])*(t[(s+1)%i][1]+t[s][1]);return e>0},_putSideQuad:function(t,e,i){var s,r,o,a,n,h=[],l=[];s=YFM.Math.Vector.pos(t[0],t[1],t[2]),r=YFM.Math.Vector.pos(e[0],e[1],e[2]),o=YFM.Math.Vector.pos(e[0],e[1],e[2]+this.height),a=YFM.Math.Vector.pos(t[0],t[1],t[2]+this.height),h.push(s),h.push(o),h.push(r),l.push(s),l.push(a),l.push(o),n=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(YFM.Math.Vector.sub(r,s),YFM.Math.Vector.sub(o,r))),this.extrudeSideVarray.push(h[0]),this.extrudeSideVarray.push(n),this.extrudeSideVarray.push(h[1]),this.extrudeSideVarray.push(n),this.extrudeSideVarray.push(h[2]),this.extrudeSideVarray.push(n),this.extrudeSideVarray.push(l[0]),this.extrudeSideVarray.push(n),this.extrudeSideVarray.push(l[1]),this.extrudeSideVarray.push(n),this.extrudeSideVarray.push(l[2]),this.extrudeSideVarray.push(n),this.extrudeSideCarray.push(i),this.extrudeSideCarray.push(i),this.extrudeSideCarray.push(i),this.extrudeSideCarray.push(i),this.extrudeSideCarray.push(i),this.extrudeSideCarray.push(i)}},YFM.Map.FloorIconPlus=function(t,e,i){this.gl=t,this.region=e,this.floor=i,this.quadTree=new YFM.Math.FloorQuadTree(i,100),this._makeVBO()},YFM.Map.FloorIconPlus.prototype={constructor:YFM.Map.FloorIconPlus,insertIcon:function(t,e,i,s){this.quadTree.insertObject(t,this.floor.index,e,i,s)},rayCheck:function(t,e){return this.quadTree.rayCheck(t,0,e)},renderIcons:function(t,e){this.shader=e,this.quadTree.render(t,this._renderIcon,this,1024)},_renderIcon:function(t,e){var i=e.region.getTexture(t.obj.tex);if(i){if(e.shader.bindTexture(i.tex),!t.quadVBO){var s=t.obj.rate||1,r=i.w/2,o=i.h/2;t.quadVBO=e._makeVBO(s*r,s*o),t.radiusSQ=r*r+o*o}e.shader.setModelMatrix(YFM.Math.Matrix.translate(t.pos[0],t.pos[1],t.pos[2])),e.shader.drawTriangles(t.quadVBO,6,0)}},_makeVBO:function(t,e){var i=[];i.push(YFM.Math.Vector.pos(-e,-t,0)),i.push(YFM.Math.Vector.pos(e,-t,0)),i.push(YFM.Math.Vector.pos(e,t,0)),i.push(YFM.Math.Vector.pos(-e,t,0));var s=[];s.push(YFM.Math.Vector.vec(0,0)),s.push(YFM.Math.Vector.vec(0,1)),s.push(YFM.Math.Vector.vec(1,1)),s.push(YFM.Math.Vector.vec(1,0));var r=[];r.push(i[0]),r.push(s[0]),r.push(i[1]),r.push(s[1]),r.push(i[2]),r.push(s[2]),r.push(i[0]),r.push(s[0]),r.push(i[2]),r.push(s[2]),r.push(i[3]),r.push(s[3]);var o=this.gl.createBuffer();return this.gl.bindBuffer(this.gl.ARRAY_BUFFER,o),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(r,3),this.gl.STATIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null),o}},YFM.Map.FloorIcons=function(t,e,i){this.gl=t,this.region=e,this.floor=i,this.quadTree=new YFM.Math.FloorQuadTree(i,100),this.iconTex=null;var s=[];s.push(YFM.Math.Vector.pos(-1,-1,0)),s.push(YFM.Math.Vector.pos(1,-1,0)),s.push(YFM.Math.Vector.pos(1,1,0)),s.push(YFM.Math.Vector.pos(-1,1,0));var r,o=[];for(r=0;r<64;r++)this._calcTexCoords(o,s,r);this.quadVBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.quadVBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(o,3),this.gl.STATIC_DRAW),this.quadBufferSize=o.length/2},YFM.Map.FloorIcons.prototype={constructor:YFM.Map.FloorIcons,insertIcon:function(t,e,i,s){this.quadTree.insertObject(t,this.floor.index,e,i,s)},rayCheck:function(t,e,i){return this.quadTree.rayCheck(t,e,i)},renderIcons:function(t,e){if(this.shader=e,null===this.iconTex){var i=this.region.getTexture("pubIcons");null!=i&&(this.iconTex=i.tex)}null!==this.iconTex&&(this.shader.bindTexture(this.iconTex),this.quadTree.render(t,this._renderIcon,this,1024))},_renderIcon:function(t,e){null!==e.iconTex&&(e.shader.setModelMatrix(YFM.Math.Matrix.translate(t.pos[0],t.pos[1],t.pos[2])),e.shader.drawTriangles(e.quadVBO,6,6*t.obj.type))},_calcTexCoords:function(t,e,i){var s,r;s=Math.floor((i-1)/8),r=(i-1)%8;var o=[];o.push(YFM.Math.Vector.pos(1/8*r,1/8*s)),o.push(YFM.Math.Vector.pos(1/8*r,1/8*(s+1))),o.push(YFM.Math.Vector.pos(1/8*(r+1),1/8*(s+1))),o.push(YFM.Math.Vector.pos(1/8*(r+1),1/8*s)),t.push(e[0]),t.push(o[0]),t.push(e[1]),t.push(o[1]),t.push(e[2]),t.push(o[2]),t.push(e[0]),t.push(o[0]),t.push(e[2]),t.push(o[2]),t.push(e[3]),t.push(o[3])}},YFM.Map.FloorMarkers=function(t,e,i){this.gl=t,this.region=e,this.floor=i,this.markerArray=[],this.markerSorted=[],this.light=YFM.Math.Vector.vec(.5,.5,1),this._initQuad(t)},YFM.Map.FloorMarkers.prototype={constructor:YFM.Map.FloorMarkers,cursor:0,shift:1e4,removeMarker:function(t){for(var e=null,i=!1,s=[],r=0;r<this.markerArray.length;r++)t===this.markerArray[r].id?(i=!0,e=this.markerArray[r]):s.push(this.markerArray[r]);return i&&(this.markerArray=s),e},insertMarker:function(t,e,i){var s=YFM.Map.FloorMarkers.prototype.cursor*YFM.Map.FloorMarkers.prototype.shift+this.floor.index,r=this.floor.floorPos2Region(e,i);return r[2]+=t.height,t.id=s,t.pos=r,this.markerArray.push(t),YFM.Map.FloorMarkers.prototype.cursor++,s},insertTextureMarker:function(t,e,i,s,r,o){var a=this.floor.floorPos2Region(e,i);a[2]+=s;var n=YFM.Map.FloorMarkers.prototype.cursor*YFM.Map.FloorMarkers.prototype.shift+this.floor.index,h={type:1,id:n,texName:t,tex:null,texSize:YFM.Math.Vector.vec(10,10),envelop:YFM.Math.Vector.vec(0),pos:a,distSQ:0,height:s,offsetX:r,offsetY:o};return this.markerArray.push(h),YFM.Map.FloorMarkers.prototype.cursor++,n},render:function(t,e,i,s,r){var o,a;for(this.markerSorted=[],a=0;a<this.markerArray.length;a++)o=this.markerArray[a],t.containCheckPoint(o.pos)&&(o.distSQ=YFM.Math.Vector.distanceSQ(o.pos,r),this.markerSorted.push(o));for(this.markerSorted.sort(this._markerCompare),a=0;a<this.markerSorted.length;a++)o=this.markerSorted[a],this._renderTex(s,e,i,o)},findMarker:function(t,e){for(var i,s=0;s<this.markerSorted.length;s++)if(i=this.markerSorted[s],this._envelopCheck(i.envelop,t,e))return{id:i.id,dist:i.distSQ};return null},_markerCompare:function(t,e){return t.distSQ>e.distSQ?-1:t.distSQ<e.distSQ?1:0},_envelopCheck:function(t,e,i){return e>=t[0]&&e<=t[2]&&i>=t[1]&&i<=t[3]},_renderTex:function(t,e,i,s){if(null===s.tex){var r=this.region.getTexture(s.texName);null!==r&&(s.tex=r.tex,s.texSize[0]=r.w/2,s.texSize[1]=r.h/2)}if(null!==s.tex){var o,a,n=YFM.Math.Matrix.mulVec(t,s.pos);if(o=YFM.gRegion.glCanvas.width/2,a=YFM.gRegion.glCanvas.height/2,n[0]/=n[3],n[1]/=n[3],n[2]/=n[3],n[3]/=n[3],n[0]*=o,n[1]*=a,s.id===this.region.markerAnim.id){this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA);var h=this.region.markerAnim,l=YFM.Math.Matrix.scaleXYZ(h.waveRadius,0,0,0),u=YFM.Math.Matrix.postTranslate(l,n[0],n[1],0);e.useProgram(),e.setModelMatrix(u),e.drawTriangles(h.circleVBO,h.waveColor,0,h.circleSize),h.waveRadius[0]>h.waveMin?(h.waveRadius[0]-=h.waveStep,h.waveRadius[1]-=h.waveStep):(h.waveRadius[0]=h.waveMax,h.waveRadius[1]=h.waveMax),this.gl.disable(this.gl.BLEND)}i.useProgram(),i.bindTexture(s.tex),s.envelop[0]=o+n[0]-s.offsetX-s.texSize[0],s.envelop[1]=a-(n[1]+s.offsetY+s.texSize[1]),s.envelop[2]=o+n[0]+s.offsetX+s.texSize[0],s.envelop[3]=a-(n[1]+s.offsetY-s.texSize[1]),l=YFM.Math.Matrix.postRotateXY(YFM.Math.Matrix.postTranslate(YFM.Math.Matrix.scaleXYZ(s.texSize,0,0,0),n[0]-s.offsetX,n[1]+s.offsetY,0),this.region.camera.getRoll(),n[0],n[1]),i.setModelMatrix(l),this.gl.depthMask(!1),i.drawTriangles(this.quadVBO,6,0),this.gl.depthMask(!0)}},_initQuad:function(t){var e=[],i=[],s=[];s.push(YFM.Math.Vector.vec(0,1)),s.push(YFM.Math.Vector.vec(1,1)),s.push(YFM.Math.Vector.vec(1,0)),s.push(YFM.Math.Vector.vec(0,0)),i.push(YFM.Math.Vector.pos(-1,-1,0)),i.push(YFM.Math.Vector.pos(1,-1,0)),i.push(YFM.Math.Vector.pos(1,1,0)),i.push(YFM.Math.Vector.pos(-1,1,0)),e.push(i[0]),e.push(s[0]),e.push(i[1]),e.push(s[1]),e.push(i[2]),e.push(s[2]),e.push(i[0]),e.push(s[0]),e.push(i[2]),e.push(s[2]),e.push(i[3]),e.push(s[3]),this.quadVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.quadVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(e,3),t.STATIC_DRAW)}},YFM.Map.FloorModels=function(t,e,i,s){this.gl=t.region.gl,this.floorIndex=t.index,this.modelPool=t.region.modelPool,this.octTree=new YFM.Math.AAOctTree(0,e,0,i,-20,s),this.instanceGroupSet={},this.frustum=new YFM.Math.FrustumWorldSpace,this.cnt=0},YFM.Map.FloorModels.prototype={constructor:YFM.Map.FloorModels,removeInstance:function(t){if(t.id){var e=this.instanceGroupSet[name];if(!e){var i=e.indexOf(t);-1!==i&&(e.splice(i,1),this.octTree.removeObject(t.id),this.cnt-=1)}}},insertInstance:function(t,e,i,s){var r=-1,o=new YFM.Mesh.ObjModelInstance(this,this.modelPool,t);o.setModelArguments(e,i,s);var a=this.instanceGroupSet[t];return a||(a=[],this.instanceGroupSet[t]=a),a.push(o),r=this.octTree.insertObject(o,o.obb),o.id=r,o.index=this.floorIndex,this.cnt+=1,o},updateInstance:function(t,e,i,s){return t.setModelArguments(e,i,s),this.octTree.updateObjectObb(t.id,t.obb)},updateInstanceRaw:function(t){return this.octTree.updateObjectObb(t.id,t.obb)},getInstanceList:function(t){var e=this.instanceGroupSet[t];return e||(e=[]),e},getInstanceCnt:function(){return this.cnt},render:function(t,e){this.frustum.update(e),this.octTree.render(this.frustum,function(e){e&&e.obj.render(t)})}},YFM.Map.FloorQuickCallout=function(t,e,i){this.gl=t,this.region=e,this.floor=i,this.calloutArray=[],this.sizeH=20,this.sizeW=30,this.visible=!0,this._initMesh()},YFM.Map.FloorQuickCallout.prototype={constructor:YFM.Map.FloorQuickCallout,setVisibility:function(t){this.visible=t},insertCallout:function(t,e,i,s,r,o){var a,n,h=this.floor.floorPos2Region(e,i);h[2]+=s,a=void 0==r?0:r,n=void 0==o?0:o,t.pos=h,t.spos={cx:0,cy:0,gx:0,gy:0},t.colorVec=YFM.WebGL.Color.getRGBAVec(t.color),t.dirty=!0,t.delete=!1,t.offset=[a,n],this.calloutArray.push(t)},renderCallout:function(t,e){if(!0===this.visible){this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA),this.shader=e;for(var i=0,s=!0,r=this.calloutArray.length;i<r;s?i++:i){var o=this.calloutArray[i];o&&!0===o.delete?(s=!1,this.calloutArray.splice(i,1)):(s=!0,o&&t.containCheckPoint(o.pos)&&this._renderCallout(o,this))}this.gl.disable(this.gl.BLEND)}},_renderCallout:function(t,e){var i;if(!1!==t.visible){2===t.pos.length&&(t.pos=e.floor.floorPos2Region(t.pos[0],t.pos[1])),t.block&&!0!==t.dirty||(t.block=e._makeTextBlock(t.text,e.region.ctx2d,e.region.fontHeight,e.sizeW,e.sizeH),t.dirty=!1),i=t.block,e.region.regionPos2ScreenPlus(t.pos,t.spos);var s=YFM.Math.Matrix.translate(t.spos.gx+t.offset[0],t.spos.gy+e.sizeH+t.offset[1],0);e.shader.setModelMatrix(s),e.shader.draw(e.anchorMesh,e.gl.TRIANGLES,t.colorVec),s=YFM.Math.Matrix.scaleXYZ(i.scale,0,0,0),s=YFM.Math.Matrix.postTranslate(s,t.spos.gx+t.offset[0],t.spos.gy+e.sizeH+i.phh+t.offset[1],0),e.shader.setModelMatrix(s),e.shader.draw(e.panleMesh,e.gl.TRIANGLES,t.colorVec);var r,o,a,n=t.spos.cy-e.sizeH/2-i.phh-i.bhh-t.offset[1];for(r=0,o=i.lines.length;r<o;r++)a=t.spos.cx+t.offset[0],e.region._drawText(i.lines[r],a,n),n+=e.region.fontHeight}},_makeTextBlock:function(t,e,i,s,r){for(var o,a,n,h,l,u=t.split(/\r?\n/),c=0,M=0,d=0;d<u.length;d++)M+=i/2,(l=(e.measureText(u[d]).width+4)/2)>c&&(c=l);return o=c+s/2,a=M+r/2,n=o/s,h=a/r,{lines:u,bhw:c,bhh:M,phw:o,phh:a,scale:[n,h,1]}},_initMesh:function(){var t=YFM.Math.Vector,e=[];e.push(t.pos(0,-this.sizeH)),e.push(t.pos(this.sizeW/2,0)),e.push(t.pos(-this.sizeW/2,1)),this.anchorMesh=new YFM.WebGL.VAttribs(this.gl),this.anchorMesh.addAttribute("position",e,3);var i=[];i.push(t.pos(-this.sizeW,this.sizeH)),i.push(t.pos(this.sizeW,-this.sizeH)),i.push(t.pos(this.sizeW,this.sizeH)),i.push(t.pos(-this.sizeW,this.sizeH)),i.push(t.pos(-this.sizeW,-this.sizeH)),i.push(t.pos(this.sizeW,-this.sizeH)),this.panleMesh=new YFM.WebGL.VAttribs(this.gl),this.panleMesh.addAttribute("position",i,3)}},YFM.Map.FloorQuickPolygon=function(t){this.gl=t,this.height=1,this.quickPolygonVBO=null,this.quickPolygonCBO=null,this.quickPolygonSize=0,this.quickPolygonVarray=[],this.quickPolygonCarray=[],this.loaded=!1},YFM.Map.FloorQuickPolygon.prototype={constructor:YFM.Map.FloorQuickPolygon,setHeight:function(t){this.height=t},render:function(t){this.loaded&&null!==this.quickPolygonVBO&&(this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL),t.setLighting(1),t.drawTriangles(this.quickPolygonVBO,this.quickPolygonCBO,this.quickPolygonSize),this.gl.disable(this.gl.DEPTH_TEST))},addQuickPolygon:function(t,e){var i,s=YFM.Math.Vector.vec(0,0,1),r=YFM.WebGL.Color.getRGBVec(e),o=this._triangulate_cut_ear(t);if(null!==o){var a=o.length/3;for(i=0;i<a;i++){var n=[];n.push(o[3*i+0]),n.push(o[3*i+1]),n.push(o[3*i+2]),this.quickPolygonVarray.push(YFM.Math.Vector.pos(n[0][0],n[0][1],n[0][2]+this.height)),this.quickPolygonVarray.push(s),this.quickPolygonVarray.push(YFM.Math.Vector.pos(n[1][0],n[1][1],n[1][2]+this.height)),this.quickPolygonVarray.push(s),this.quickPolygonVarray.push(YFM.Math.Vector.pos(n[2][0],n[2][1],n[2][2]+this.height)),this.quickPolygonVarray.push(s),this.quickPolygonCarray.push(r),this.quickPolygonCarray.push(r),this.quickPolygonCarray.push(r)}}},buildQuickPolygon:function(){this.quickPolygonVarray.length<=0||(this.cleanQuickPolygon(),this.quickPolygonVBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.quickPolygonVBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(this.quickPolygonVarray,4),this.gl.STATIC_DRAW),this.quickPolygonSize=this.quickPolygonVarray.length/2,this.quickPolygonVarray=[],this.quickPolygonCBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.quickPolygonCBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(this.quickPolygonCarray,4),this.gl.STATIC_DRAW),this.quickPolygonCarray=[],this.loaded=!0)},cleanQuickPolygon:function(){if(null!==this.quickPolygonVBO){var t=this.quickPolygonVBO,e=this.gl;this.quickPolygonVBO=null,this.loaded=!1,setTimeout(function(){e.deleteBuffer(t)},2e3)}if(null!==this.quickPolygonCBO){var t=this.quickPolygonCBO,e=this.gl;this.quickPolygonCBO=null,this.loaded=!1,setTimeout(function(){e.deleteBuffer(t)},2e3)}},_clock_wise_tri:function(t){var e=0;return e+=(t[1][0]-t[0][0])*(t[1][1]+t[0][1]),e+=(t[2][0]-t[1][0])*(t[2][1]+t[1][1]),(e+=(t[0][0]-t[2][0])*(t[0][1]+t[2][1]))>0},_clock_wise_pts:function(t){for(var e=0,i=t.length,s=0;s<i;s++)e+=(t[(s+1)%i][0]-t[s][0])*(t[(s+1)%i][1]+t[s][1]);return e>0},_is_left_turn:function(t,e,i){return(e[0]-t[0])*(i[1]-t[1])-(i[0]-t[0])*(e[1]-t[1])>0},_is_right_turn:function(t,e,i){return(e[0]-t[0])*(i[1]-t[1])-(i[0]-t[0])*(e[1]-t[1])<0},_point_inside:function(t,e,i,s){var r=this._is_left_turn(t,e,s),o=this._is_left_turn(e,i,s),a=this._is_left_turn(i,t,s);if(r&&o&&a)return!0;var n=this._is_right_turn(t,e,s),h=this._is_right_turn(e,i,s),l=this._is_right_turn(i,t,s);return!!(n&&h&&l)},_triangulate_cut_ear:function(t){for(var e,i,s,r=this._clock_wise_pts(t),o=[],a=[],n=0,h=t.length;n<h;n++)a.push(t[n]);for(;a.length>3;){var l,u,c=-1,M=0;do{if(M++,u=a.length,M>=u)return console.log("bad input."),null;if(c++,e=a[c%u],i=a[(c+1)%u],s=a[(c+2)%u],l=this._is_left_turn(e,i,s)^r){var d;for(n=0,u=a.length;n<u;n++)if(d=a[n],this._point_inside(e,i,s,d)){l=!1;break}}}while(!l);o.push(e),o.push(i),o.push(s),a.splice((c+1)%u,1)}return 3==a.length&&(o.push(a[0]),o.push(a[1]),o.push(a[2])),o}},YFM.Map.FloorTextureRect=function(t,e,i){this.region=t,this.gl=e,this.height=2,this.textureRectVBO=null,this.textureRectSize=0,this.textureRectVarray=[],this.loaded=!1;var s=YFM.Math.Vector;this.tex=[],this.tex.push(s.vec(0,0)),this.tex.push(s.vec(1,0)),this.tex.push(s.vec(1,1)),this.tex.push(s.vec(0,1)),this.number=i},YFM.Map.FloorTextureRect.prototype={constructor:YFM.Map.FloorTextureRect,texName:["noName","noName"],setHeight:function(t){this.height=t},render:function(t){if(this.loaded){var e=this.region.getTexture(YFM.Map.FloorTextureRect.prototype.texName[this.number]);null!==e&&(t.setColorFlag(0),t.bindTexture(e.tex),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL),t.drawTriangles(this.textureRectVBO,this.textureRectSize),this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.BLEND))}},addTextureRect:function(t){t[0][2]=this.height,t[1][2]=this.height,t[2][2]=this.height,t[3][2]=this.height,this.textureRectVarray.push(t[0]),this.textureRectVarray.push(this.tex[0]),this.textureRectVarray.push(t[1]),this.textureRectVarray.push(this.tex[1]),this.textureRectVarray.push(t[2]),this.textureRectVarray.push(this.tex[2]),this.textureRectVarray.push(t[0]),this.textureRectVarray.push(this.tex[0]),this.textureRectVarray.push(t[2]),this.textureRectVarray.push(this.tex[2]),this.textureRectVarray.push(t[3]),this.textureRectVarray.push(this.tex[3])},buildTextureRect:function(){this.textureRectVarray.length<=0||(this.cleanTextureRect(),this.textureRectVBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.textureRectVBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(this.textureRectVarray,4),this.gl.STATIC_DRAW),this.textureRectSize=this.textureRectVarray.length/2,this.textureRectVarray=[],this.loaded=!0)},cleanTextureRect:function(){if(null!==this.textureRectVBO){var t=this.textureRectVBO,e=this.gl;this.textureRectVBO=null,this.loaded=!1,setTimeout(function(){e.deleteBuffer(t)},2e3)}}},YFM.Map.FloorTextureRectList=function(t,e){this.region=t,this.gl=e,this.height=2,this.list=[]},YFM.Map.FloorTextureRectList.prototype={constructor:YFM.Map.FloorTextureRectList,setHeight:function(t){this.height=t;var e,i;for(e=0,i=this.list.length;e<i;e++)this.list[e].setHeight(t)},render:function(t){var e,i;for(t.setColorFlag(0),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL),e=0,i=this.list.length;e<i;e++)this.list[e].render(t);this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.BLEND)},addTextureType:function(t){var e=this.list.length,i=new YFM.Map.FloorTextureRectPlus(this.region,this.gl,t);return this.list.push(i),i.setHeight(this.height),e},addTextureRect:function(t,e){var i=this.list[t];i&&i.addTextureRect(e)},buildTextureRect:function(t){var e=this.list[t];e&&e.buildTextureRect()},cleanTextureRect:function(t){var e=this.list[t];e&&e.cleanTextureRect()},buildAllTextureRect:function(){var t,e;for(t=0,e=this.list.length;t<e;t++)this.list[t].buildTextureRect()},cleanAllTextureRect:function(){var t,e;for(t=0,e=this.list.length;t<e;t++)this.list[t].cleanTextureRect()}},YFM.Map.FloorTextureRectPlus=function(t,e,i){this.region=t,this.gl=e,this.texName=i,this.height=2,this.textureRectVBO=null,this.textureRectSize=0,this.textureRectVarray=[],this.loaded=!1;var s=YFM.Math.Vector;this.tex=[],this.tex.push(s.vec(0,0)),this.tex.push(s.vec(1,0)),this.tex.push(s.vec(1,1)),this.tex.push(s.vec(0,1))},YFM.Map.FloorTextureRectPlus.prototype={constructor:YFM.Map.FloorTextureRectPlus,setHeight:function(t){this.height=t},render:function(t){if(this.loaded){var e=this.region.getTexture(this.texName);null!==e&&(t.bindTexture(e.tex),t.drawTriangles(this.textureRectVBO,this.textureRectSize))}},addTextureRect:function(t){t[0][2]=this.height,t[1][2]=this.height,t[2][2]=this.height,t[3][2]=this.height,this.textureRectVarray.push(t[0]),this.textureRectVarray.push(this.tex[0]),this.textureRectVarray.push(t[1]),this.textureRectVarray.push(this.tex[1]),this.textureRectVarray.push(t[2]),this.textureRectVarray.push(this.tex[2]),this.textureRectVarray.push(t[0]),this.textureRectVarray.push(this.tex[0]),this.textureRectVarray.push(t[2]),this.textureRectVarray.push(this.tex[2]),this.textureRectVarray.push(t[3]),this.textureRectVarray.push(this.tex[3])},buildTextureRect:function(){this.textureRectVarray.length<=0||(this.cleanTextureRect(),this.textureRectVBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.textureRectVBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(this.textureRectVarray,4),this.gl.STATIC_DRAW),this.textureRectSize=this.textureRectVarray.length/2,this.textureRectVarray=[],this.loaded=!0)},cleanTextureRect:function(){if(null!==this.textureRectVBO){var t=this.textureRectVBO,e=this.gl;this.textureRectVBO=null,this.loaded=!1,setTimeout(function(){e.deleteBuffer(t)},2e3)}}},YFM.Map.FloorTrajectory=function(t,e,i){this.region=t,this.floor=e,this.gl=i,this.height=1,this.meshList=[],this.time=0,this.seg_width=2,this.step_len=32},YFM.Map.FloorTrajectory.prototype={constructor:YFM.Map.FloorTrajectory,setWidth:function(t){this.seg_width=t,this.step_len=16*t},setHeight:function(t){this.height=t},render:function(){var t,e=this.meshList.length;if(e>0){var i=this.region.gl,s=this.region.trajectoryShader,r=this.region.texturePool.getTexture("trajectory_tex");if(null!=r){s.useProgram(),s.setMapHeight(this.floor.mapHeight),s.setPVRMat(this.region.renderParam.pvrMat),s.setFloorMat(this.floor.floorMat),s.setTime(this.time),s.bindTexture(r.tex),i.enable(i.BLEND),i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA);for(var o=0;o<e;o++)t=this.meshList[o],s.drawTriangleStrip(t);i.disable(i.BLEND),this.time-=.01}}},addTrajectory:function(t){var e=this._makeSegList(t);null!==e&&this.meshList.push(this._makeSegsMesh(e))},cleanTrajectory:function(){for(var t=0,e=this.meshList.length;t<e;t++)this.meshList[t].recycle();this.meshList=[]},_makeSeg:function(t,e,i,s,r,o){var a=YFM.Math.Vector,n={};return n.start=a.pos(e,i),n.end=a.pos(s,r),n.vec=a.sub(n.end,n.start),n.tan=a.vec(o[0],o[1]),n.len=a.norm3(n.vec),n.global_mileage=t,n},_updateSegEnd:function(t,e,i){var s=YFM.Math.Vector;t.end=s.pos(e,i),t.vec=s.sub(t.end,t.start),t.tan=s.normalize(t.vec),t.len=s.norm3(t.vec)},_makeSegList:function(t){var e,i,s,r,o,a,n,h,l,u,c,M=YFM.Math.Vector,d=[];if((i=t.length/2)-1<=0)return null;for(n=0,e=0;e<i-1;e++)s=t[2*e+0],r=t[2*e+1],o=t[2*e+2],a=t[2*e+3],l=M.vec(o-s,a-r),l=M.normalize(l),d.length<=0?(u=this._makeSeg(n,s,r,o,a,l),d.push(u),n+=u.len):(c=d.pop(),h=M.dot3(l,c.tan),Math.abs(h-1)<1e-5?(n-=c.len,this._updateSegEnd(c,o,a),d.push(u),n+=c.len):(d.push(u),u=this._makeSeg(n,s,r,o,a,l),d.push(u),n+=u.len));return d},_makeSegsMesh:function(t){var e,i,s,r,o,a,n,h,l,u,c,M,d,p,g,f,m,F,v,x;r=4*(s=t.length);var Y=Array(2*r),T=Array(3*r);o=3*(4*s-2);var b=Array(o);for(i=0;i<s;i++)l=(x=t[i]).start[0],u=x.start[1],c=x.end[0],M=x.end[1],h=x.len,m=(f=x.global_mileage)+h,F=f/this.step_len,v=m/this.step_len,d=x.tan[0],p=x.tan[1]*this.seg_width,g=d*this.seg_width,Y[8*i+0]=l-p,Y[8*i+1]=u+g,Y[8*i+2]=l+p,Y[8*i+3]=u-g,Y[8*i+4]=c-p,Y[8*i+5]=M+g,Y[8*i+6]=c+p,Y[8*i+7]=M-g,T[12*i+0]=1,T[12*i+1]=F,T[12*i+2]=f,T[12*i+3]=0,T[12*i+4]=F,T[12*i+5]=f,T[12*i+6]=1,T[12*i+7]=v,T[12*i+8]=m,T[12*i+9]=0,T[12*i+10]=v,T[12*i+11]=m,a=4*i,i>0?(b[(n=6+12*(i-1))+0]=a-2,b[n+1]=a-1,b[n+2]=a+0,b[n+3]=a-1,b[n+4]=a+1,b[n+5]=a+0,b[n+6]=a+0,b[n+7]=a+1,b[n+8]=a+2,b[n+9]=a+1,b[n+10]=a+3,b[n+11]=a+2):(b[0]=a+0,b[1]=a+1,b[2]=a+2,b[3]=a+1,b[4]=a+3,b[5]=a+2);return(e=new YFM.WebGL.VAttribs(this.gl)).addAttributeFlat("pos",Y,2,!1),e.addAttributeFlat("uv",T,3,!1),e.addAttributeElementFlat("index",b),e}},YFM.Map.AnimationMgr=function(t,e,i,s){this.region=t,this.camera=e,this.touchMgr=i,this.listener=s,this.seq=[],this.mover=new YFM.Math.Mover,this.mover.setMaxForce(16),this.mover.setMaxSpeed(16),this.current=null},YFM.Map.AnimationMgr.prototype={constructor:YFM.Map.AnimationMgr,ANIM_TYPE_PITCH:0,ANIM_TYPE_LOOKAT:1,ANIM_TYPE_LOOKDISTANCE:2,ANIM_TYPE_LOOKAZIMUTH:3,ANIM_TYPE_ROTATE_MAP:4,ANIM_DEFAULT_FRAME:12,pitchLimit:80,update:function(){if(this.current||(this.current=this.seq.shift(),this.current&&(this.touchMgr.setEnable(!1),this.listener.onAnimStart(this.current))),this.current){var t=this.current.step/this.current.frame,e=YFM.Math.lerp;switch(this.current.step+=1,this.current.type){case YFM.Map.AnimationMgr.prototype.ANIM_TYPE_PITCH:s=this.current.step==this.current.frame?this.current.to:e(this.current.from,this.current.to,t),this.camera.setPitch(s),this.current.overlook?0!==s&&(this.region._onOverlook(!1),this.current.overlook=!1,this.touchMgr._setOverlook(!1)):0===s&&(this.region._onOverlook(!0),this.current.overlook=!0,this.touchMgr._setOverlook(!0));break;case YFM.Map.AnimationMgr.prototype.ANIM_TYPE_LOOKDISTANCE:r=this.current.step==this.current.frame?this.current.to:e(this.current.from,this.current.to,t),this.camera.setLookOffset(0,0,r),this.camera.resetLookOffsetTan();break;case YFM.Map.AnimationMgr.prototype.ANIM_TYPE_LOOKAZIMUTH:o=this.current.step==this.current.frame?this.current.to:e(this.current.from,this.current.to,t),this.camera.setAzimuth(o);break;case YFM.Map.AnimationMgr.prototype.ANIM_TYPE_ROTATE_MAP:var i=this.current.to/this.current.frame;this.region.postRotate(i);break;case YFM.Map.AnimationMgr.prototype.ANIM_TYPE_LOOKAT:1==this.current.step&&(this.mover.setLocation(this.current.from[0],this.current.from[1],this.current.from[2]),this.camera.resetLookOffsetTan()),this.mover.arrive(this.current.to,2)?(this.current.step=this.current.frame,this.mover.setLocation(this.current.to[0],this.current.to[1],this.current.to[2])):this.mover.update();a=this.mover.getLocation();this.camera.setLookAt(a[0],a[1],a[2]);break;case YFM.Map.ANIM_TYPE_MERGE:if(this.current.pitch){var s;s=this.current.step==this.current.frame?this.current.pitch.to:e(this.current.pitch.from,this.current.pitch.to,t),this.camera.setPitch(s),this.current.overlook?0!==s&&(this.region._onOverlook(!1),this.current.overlook=!1,this.touchMgr._setOverlook(!1)):0===s&&(this.region._onOverlook(!0),this.current.overlook=!0,this.touchMgr._setOverlook(!0))}if(this.current.distance){var r;r=this.current.step==this.current.frame?this.current.distance.to:e(this.current.distance.from,this.current.distance.to,t),this.camera.setLookOffset(0,0,r),this.camera.resetLookOffsetTan()}if(this.current.azimuth){var o;o=this.current.step==this.current.frame?this.current.azimuth.to:e(this.current.azimuth.from,this.current.azimuth.to,t),this.camera.setAzimuth(o)}if(this.current.lookAt){var a;if(this.current.step==this.current.frame)a=this.current.lookAt.to;else{var n=YFM.Math.Vector;a=n.add(this.current.lookAt.from,n.scale(this.current.lookAt.direction,this.current.step*this.current.lookAt.interval))}this.camera.setLookAt(a[0],a[1],a[2])}}this.current.step>=this.current.frame&&(this.listener.onAnimFinish(this.current),this.current=null,this.touchMgr.setEnable(!0))}},animPitch:function(t,e,i,s){var r=YFM.Math.clamp(t,0,YFM.Map.AnimationMgr.prototype.pitchLimit),o=e||null,a=i||YFM.Map.AnimationMgr.prototype.ANIM_DEFAULT_FRAME;(s||!1)&&(this.seq=[],null!==this.current&&this.listener.onAnimCancel(this.current),this.current=null);var n=new YFM.Map.AnimationMgr.prototype.Animation(o,YFM.Map.AnimationMgr.prototype.ANIM_TYPE_PITCH,a);n.from=this.camera.getPitch(),n.to=-r,n.overlook=0===n.from,this.seq.push(n)},animLookDistance:function(t,e,i,s){var r=t,o=e||null,a=i||YFM.Map.AnimationMgr.prototype.ANIM_DEFAULT_FRAME;(s||!1)&&(this.seq=[],null!==this.current&&this.listener.onAnimCancel(this.current),this.current=null);var n=new YFM.Map.AnimationMgr.prototype.Animation(o,YFM.Map.AnimationMgr.prototype.ANIM_TYPE_LOOKDISTANCE,a);n.from=this.camera.getLookOffsetNormal(),n.to=-r,this.seq.push(n)},animLookAzimuth:function(t,e,i,s,r){var o=YFM.Math.deg2Radian(t),a=e||null,n=i||!1,h=s||YFM.Map.AnimationMgr.prototype.ANIM_DEFAULT_FRAME;(r||!1)&&(this.seq=[],null!==this.current&&this.listener.onAnimCancel(this.current),this.current=null);var l=new YFM.Map.AnimationMgr.prototype.Animation(a,YFM.Map.AnimationMgr.prototype.ANIM_TYPE_LOOKAZIMUTH,h);l.from=this.camera.getAzimuth(),l.to=n?-o:l.from-o,this.seq.push(l)},animRotateMap:function(t,e,i){var s=e||null;(i||!1)&&(this.seq=[],null!==this.current&&this.listener.onAnimCancel(this.current),this.current=null);var r=new YFM.Map.AnimationMgr.prototype.Animation(s,YFM.Map.AnimationMgr.prototype.ANIM_TYPE_ROTATE_MAP,24);r.from=0,r.to=t,this.seq.push(r)},animLookAt:function(t,e,i){var s=e||null;(i||!1)&&(this.seq=[],null!==this.current&&this.listener.onAnimCancel(this.current),this.current=null);var r=new YFM.Map.AnimationMgr.prototype.Animation(s,YFM.Map.AnimationMgr.prototype.ANIM_TYPE_LOOKAT,1024);r.from=this.camera.getLookAt(),r.to=t,this.seq.push(r)},animMerge:function(t,e,i,s){var r=e||null,o=i||24;(s||!1)&&(this.seq=[],null!==this.current&&this.listener.onAnimCancel(this.current),this.current=null);var a=new YFM.Map.AnimationMgr.prototype.Animation(r,YFM.Map.ANIM_TYPE_MERGE,o);if((t.pitch||0===t.pitch)&&(a.pitch={},a.pitch.from=this.camera.getPitch(),a.pitch.to=-YFM.Math.clamp(t.pitch,0,YFM.Map.AnimationMgr.prototype.pitchLimit),a.pitch.overlook=0===a.from),t.distance&&(a.distance={},a.distance.from=this.camera.getLookOffsetNormal(),a.distance.to=-t.distance),t.azimuth&&(a.azimuth={},a.azimuth.from=this.camera.getAzimuth(),a.abs?a.azimuth.to=-YFM.Math.deg2Radian(t.azimuth):a.azimuth.to=a.azimuth.from-YFM.Math.deg2Radian(t.azimuth)),t.lookAt){var n=YFM.Math.Vector;a.lookAt={},a.lookAt.from=this.camera.getLookAt(),a.lookAt.to=t.lookAt,a.lookAt.direction=n.normalize(n.sub(a.lookAt.to,a.lookAt.from)),a.lookAt.interval=n.distance(a.lookAt.from,a.lookAt.to)/o,this.camera.resetLookOffsetTan()}this.seq.push(a)}},YFM.Map.AnimationMgr.prototype.Animation=function(t,e,i){this.tag=t,this.type=e,this.frame=i,this.step=0},YFM.Map.Region=function(t,e,i,s){this.id=t,this.matRegion=YFM.Math.Matrix.mat(),this.glCanvas=e,this.gl=YFM.WebGL.setupWebGL(e),this.gl.viewport(0,0,e.width,e.height),this.gl.clearColor(.9,.9,.9,1),YFM.gGL=this.gl,this.hh=e.height/2,this.hw=e.width/2,this.tqct=new YFM.Math.TextBlockQuickCheckTree(i.width,i.height),this.txtCanvas=i,this.ctx2d=i.getContext("2d"),this.ctx2d.font="24px Microsoft YaHei",this.ctx2d.fillStyle="#FF0000",this.ctx2d.textAlign="center",this.ctx2d.textBaseline="middle",this.fontHeight=this._determineFontHeight("font: "+this.ctx2d.font+";"),this.camera=new YFM.WebGL.Camera,this.camera.setPerspective(60,e.width/e.height,60,2e4),this.camera.setLookOffset(0,0,-400),this.orthMat=YFM.Math.Matrix.orthographic(-e.width/2,e.width/2,-e.height/2,e.height/2,-1,1),this.renderParam={projMat:null,viewMat:null,regionMat:null,vrMat:null,bivrMat:null,pvrMat:null},this.listener=s,this.floors=[],this.baseColorShader=new YFM.WebGL.BaseColorProgram(this.gl),this.basePhongShader=new YFM.WebGL.BasePhongProgram(this.gl),this.selectColorShader=new YFM.WebGL.SelectColorProgram(this.gl),this.regionPhongShader=new YFM.WebGL.RegionPhongProgram(this.gl),this.billboardIconShader=new YFM.WebGL.BillboardIconProgram(this.gl),this.marker2DShader=new YFM.WebGL.Marker2DProgram(this.gl),this.color2DShader=new YFM.WebGL.Color2DProgram(this.gl),this.ssrShader=new YFM.WebGL.SSRProgram(this.gl,this),this.trajectoryShader=new YFM.WebGL.TrajectoryProgram(this.gl),this.maxSize=0,this.vPitch=0,this.displayFloorIndex=-1,this.azimuth=0;var r=this;this.touchMgr=new YFM.Map.RegionTouchMgr(this.camera,i,this.ctx2d,this,{onClick:function(t,e){r.listener&&r.listener.onClick&&r.listener.onClick(t,e)},onDClick:function(t,e){r.listener&&r.listener.onDClick&&r.listener.onDClick(t,e)},on2FClick:function(t,e){r.listener&&r.listener.on2FClick&&r.listener.on2FClick(t,e)},onLongPressUp:function(t,e){r.listener&&r.listener.onLongPressUp&&r.listener.onLongPressUp(t,e)},onScroll:function(t,e){r.listener&&r.listener.onScroll&&r.listener.onScroll(t,e)}}),this.animMgr=new YFM.Map.AnimationMgr(this,this.camera,this.touchMgr,{onAnimStart:function(t){r.listener&&r.listener.onAnimStart(t)},onAnimFinish:function(t){r.listener&&r.listener.onAnimFinish(t)},onAnimCancle:function(t){r.listener&&r.listener.onAnimCancel(t)}}),this.locMarker=new YFM.Map.RegionLocMarker(this.gl,20,2152900137,3992977408,this),this.frustum=new YFM.Math.FrustumWorldSpace,this.route=new YFM.Map.SSRoute(this),this.texturePool=new YFM.WebGL.TexturePool(this.gl),this.extrudeLightNormal=YFM.Math.Vector.normalize(YFM.Math.Vector.vec(0,1,1)),this.extrudeLightOver=YFM.Math.Vector.normalize(YFM.Math.Vector.vec(0,1,1)),this.extrudeLight=this.extrudeLightNormal,this.modelLight=YFM.Math.Vector.normalize(YFM.Math.Vector.vec(.5,.5,1)),this.overlook=!1,this.drawUnitTextAlways=!1,this.drawAllUnit=!1,this.customFloorHeight=null,this.regionThumbnail=new YFM.Map.RegionThumbnail(this),this.regionThumbnailFlag=!1,this.modelsVisibility=!1,this.status=YFM.Map.STATUS_TOUCH,this.listener&&this.listener.onStatusChange(this.status),this.ambient=YFM.Math.Vector.pos(.9,.9,.9),this.diffuse=YFM.Math.Vector.pos(.2,.2,.2),this.orgPos=YFM.Math.Vector.pos(0,0,0),this.markerAnim={},this._initMarkerAnim()},YFM.Map.Region.prototype={constructor:YFM.Map.Region,setModelsVisibility:function(t){this.modelsVisibility=t},setTrajectoryWidth:function(t){for(var e=0,i=this.floors.length;e<i;e++)this.floors[e].setTrajectoryWidth(t)},setMarkerAnim:function(t,e,i){var s=YFM.Math.Vector,r=YFM.WebGL.Color;this.markerAnim.waveColor=s.vec(r.hexColorRed(t),r.hexColorGreen(t),r.hexColorBlue(t),r.hexColorAlpha(t)),this.markerAnim.waveMax=e,this.markerAnim.waveMin=i},setMarkerAnimId:function(t){this.markerAnim.id=t},cleanMarkerAnimId:function(){this.markerAnim.id=-1},setAmbient:function(t){this.ambient[0]=t,this.ambient[1]=t,this.ambient[2]=t},setDiffuse:function(t){this.diffuse[0]=t,this.diffuse[1]=t,this.diffuse[2]=t},release:function(){this.gl.getExtension("WEBGL_lose_context").loseContext(),YFM.gGL=null,YFM.gRegion=null},enableRouteMover:function(t,e){this.route.enableRouteMover(t,e)},setThumbnailVisibility:function(t){this.regionThumbnail.setVisibility(t)},thumbnailPersistence:function(){return this.regionThumbnail.persistence()},setThumbnailParam:function(t){this.regionThumbnail.setParam(t)},startThumbnailSetting:function(){var t=this.glCanvas.width/2,e=this.glCanvas.height/2;this.regionThumbnail.cleanStatus(),this.camera.setOrthographic(-t,t,-e,e,-1e4,1e5),YFM.Map.RegionTouchMgr.prototype.PITCH_LIMIT=-80,this.regionThumbnailFlag=!0},endThumbnailSetting:function(){var t=this.glCanvas.width/2,e=this.glCanvas.height/2;this.regionThumbnail.saveStatus(),this.camera.setPerspective(60,t/e,60,2e4),YFM.Map.RegionTouchMgr.prototype.PITCH_LIMIT=-60,this.regionThumbnailFlag=!1},setThumbnailScaleRate:function(t){this.regionThumbnail.setScaleRate(t)},addRay:function(t,e){},setCustomFloorHeight:function(t){this.customFloorHeight=t},setClearColor:function(t){this.clearColor=YFM.WebGL.Color.getRGBVec(t)},setAzimuth:function(t){this.azimuth=t},setZoomConstraint:function(t,e){this.touchMgr.setZoomMin(t),this.touchMgr.setZoomMax(e)},setDrawAllUnit:function(t){this.drawAllUnit=t},setTouchEnable:function(t){this.touchMgr.setEnable(t)},locateLaunch:function(){this.locMarker.locateLaunch()},setLocMarkerParam:function(t,e,i,s){this.locMarker.set2DMarkerParam(t,e,i,s)},setAlwaysDrawUnit:function(t){this.drawUnitTextAlways=t},setUIScaleRate:function(t){this.touchMgr.setUIScaleRate(t)},getId:function(){return this.id},startRender:function(){YFM.gRegion=this,YFM.gRegion._grender()},displayFloor:function(t){if(!(t>=0||t<this.floors.length))throw new Error("Rgeion.js [displayFloor] Floor index out of range:"+t);this.displayFloorIndex=t;var e=this.floors[t].getAspect();this.lookAtMapLoc(t,e.w/2,e.h/2),this.route.setDisplayFloor(t)},getFloorZ:function(t){return this.floors[t].vOffset},displayRegion:function(){this.displayFloorIndex=-1,this.route.setDisplayFloor(-1)},setFontType:function(t){this.ctx2d.font=t,this.fontHeight=this._determineFontHeight("font: "+this.ctx2d.font+";")},setFontColor:function(t){this.ctx2d.fillStyle=t},setStatus:function(t){if(t!==this.status){switch(t){case YFM.Map.STATUS_TOUCH:YFM.Map.STATUS_SENSOR===this.status&&this.camera.disconnect(),this.status=t;break;case YFM.Map.STATUS_SENSOR:YFM.Map.STATUS_SENSOR!==this.status&&this.camera.connect(),this.status=t,this.camera.resetLookOffsetTan(),this.locMarker.updateLocation();break;case YFM.Map.STATUS_TRACE:YFM.Map.STATUS_SENSOR===this.status&&this.camera.disconnect(),this.status=t,this.camera.resetLookOffsetTan(),this.locMarker.updateLocation();break;case YFM.Map.STATUS_NAVIGATE:YFM.Map.STATUS_SENSOR===this.status&&this.camera.disconnect(),this.status=t,this.camera.resetLookOffsetTan(),this.locMarker.updateLocation(),this.locMarker.updateLocation()}this.listener&&this.listener.onStatusChange(this.status)}},getStatus:function(){return this.status},addFloorsURL:function(t){var e,i,s,r=this,o={onLoadFinish:function(t){for(var e=!0,i=0;i<r.floors.length;i++)if(!r.floors[i].isLoaded()){e=!1;break}r.listener&&(r.listener.onLoadFinish(t.id,t.index),e&&(r._restructure(),r.listener.onAllFloorLoadFinish())),e&&r.touchMgr.onRegionLoadFinish()},onLoadFailed:function(t){this.listener&&this.listener.onLoadFailed(t.id,t.index)}};for(i=t.length,s=0;s<i;s++)e=t[s],this.floors.push(new YFM.Map.Floor(this.gl,e.id,e.url,e.deflection,this,s,o))},addFloorsSVG:function(t){var e,i,s;for(i=t.length,s=0;s<i;s++)e=t[s],this.floors.push(new YFM.Map.Floor(this.gl,e.id,e.svg,e.deflection,this,s,null));this._restructure(),this.listener.onAllFloorLoadFinish(),this.touchMgr.onRegionLoadFinish()},addTexture:function(t,e){this.texturePool.addTexture(t,e)},addTextureBase64:function(t,e){this.texturePool.addTextureBase64(t,e)},addTextureMip:function(t,e){this.texturePool.addTextureMip(t,e)},getTexture:function(t){return this.texturePool.getTexture(t)},getFloorCount:function(){return this.floors.length},getFloorAspect:function(t){return this.floors[t].getAspect()},getFloorLoc:function(){return this.locMarker.getFloorLoc()},getRegionLoc:function(){return this.locMarker.getRegionLoc()},setNavigateProj:function(t){this.route.setUpdateNSFlag(t)},updateNaviStatus:function(t,e){this.route.updateNaviStatus(t,e)},cleanLocation:function(){this.locMarker.cleanLocation()},setLocation:function(t,e,i){this.locMarker.setLocation(t,e,i)},postTranslate:function(t,e){this.touchMgr.postTranslate(t,e)},postRotate:function(t){this.touchMgr.postRotate(t)},animTo:function(t,e,i){this.locMarker.animTo(t,e,i)},lookAtMapLoc:function(t,e,i){var s=this.floors[t].floorPos2Region(e,i);this.lookAtRegionLoc(s[0],s[1],s[2])},lookAtWorldLoc:function(t,e,i){this.camera.resetLookOffsetTan(),this.camera.setLookAt(t,e,i)},lookAtRegionLoc:function(t,e,i){var s=YFM.Math.Vector.pos(t,e,i),r=YFM.Math.Matrix.mulVec(this.matRegion,s);this.camera.resetLookOffsetTan(),this.camera.setLookAt(r[0],r[1],r[2])},animRotateMap:function(t){this.animMgr.animRotateMap(t)},animLookAt:function(t,e,i,s){var r=this.floors[t].floorPos2Region(e,i),o=YFM.Math.Matrix.mulVec(this.matRegion,r);this.animMgr.animLookAt(o,s)},animLookAtWorld:function(t,e){this.animMgr.animLookAt(t,e)},animLookDistance:function(t,e){this.animMgr.animLookDistance(t,e)},setLookAtDistance:function(t){this.camera.setLookOffset(0,0,-t)},getLookDistance:function(){return-this.camera.getLookOffsetNormal()},animLookAzimuth:function(t,e){this.animMgr.animLookAzimuth(t,e)},animPitch:function(t,e){this.animMgr.animPitch(t,e)},overlookMap:function(){if(-1===this.displayFloorIndex){if(this.obb){var t=this.obb.center,e=YFM.Math.Matrix.mulVec(this.matRegion,t),i=this.obb.hr,s=this.obb.hs,r=this.obb.ht,o=2*Math.sqrt(i*i+s*s+r*r),a=this.obb.r,n=-(c=YFM.Math.Matrix.eulerParamExtractZ(this.matRegion))+(u=this.camera.getAzimuth())+this._makeAzimuth(a);this.animMgr.animMerge({distance:1.8*o,azimuth:YFM.Math.radian2Deg(this._clampMinorArc(n)),lookAt:e},null,48)}}else{var h=this.floors[this.displayFloorIndex],l=h.floorPos2Region(h.mapWidth/2,h.mapHeight/2),e=YFM.Math.Matrix.mulVec(this.matRegion,l),u=this.camera.getAzimuth(),c=YFM.Math.Matrix.eulerParamExtractZ(this.matRegion),n=-c+u+YFM.Math.deg2Radian(h.deflection),M=h.mapWidth>h.mapHeight?h.mapWidth:h.mapHeight;this.animMgr.animMerge({distance:M,azimuth:YFM.Math.radian2Deg(this._clampMinorArc(n)),lookAt:e},null,32)}},getFloorAngle:function(t){var e=this.floors[t],i=this.camera.getAzimuth(),s=-YFM.Math.Matrix.eulerParamExtractZ(this.matRegion)+i+YFM.Math.deg2Radian(e.deflection);return YFM.Math.radian2Deg(this._clampMinorArc(s))},getFloorDeflection:function(t){return this.floors[t].deflection},setRoute:function(t){this.route.setRoute(t)},cleanRoute:function(){this.route.cleanRoute()},overlookRoute:function(t){var e=this.route.getRouteCenter(this.displayFloorIndex);if(null!==e){var i=YFM.Math.Matrix.mulVec(this.matRegion,e),s=this.route.getRouteRAxis(),r=-YFM.Math.Matrix.eulerParamExtractZ(this.matRegion)+this.camera.getAzimuth()+this._makeAzimuth(s);this.animMgr.animMerge({distance:1.8*this.route.getRouteOBBLength(this.displayFloorIndex),azimuth:YFM.Math.radian2Deg(this._clampMinorArc(r)),lookAt:i,pitch:t},null,48)}},getNaviStatus:function(){return this.route.getNaviStatus()},addTrajectory:function(t,e){this.floors[t].addTrajectory(e)},cleanTrajectory:function(t){this.floors[t].cleanTrajectory()},setFloorObjectColor:function(t,e,i,s){this.floors[t].setObjectColor(e,i,s)},resetFloorObjectColor:function(t,e,i){this.floors[t].resetObjectColor(e,i)},resetObjectColorAll:function(t,e){this.floors[t].resetObjectColorAll(e)},insertUnit:function(t,e){this.floors[e].insertUnit(t)},insertIcon:function(t,e,i,s){this.floors[e].insertIcon(t,i,s)},insertIconPlus:function(t,e,i,s){this.floors[e].insertIconPlus(t,i,s)},insertCallout:function(t,e,i,s,r,o){this.floors[e].insertCallout(t,i,s,r,o)},setCalloutVisibility:function(t,e){this.floors[t].setCalloutVisibility(e)},insertQuickCallout:function(t,e,i,s,r,o){this.floors[e].insertQuickCallout(t,i,s,r,o)},setQuickCalloutVisibility:function(t,e){this.floors[t].setQuickCalloutVisibility(e)},loadModel2Pool:function(t,e,i,s){var r=this;new YFM.Mesh.ObjModel(this,t,e,function(t){r.modelPool.addModel(t.name,t),i&&i(t)},function(t){console.log("load model %s failed status:%o",e,t),s&&s(t)})},insertModelInstance:function(t,e,i,s,r,o,a){return this.floors[t].insertModelInstance(e,i,s,r,o,a)},removeModelInstance:function(t){this.floors[t.index].removeModelInstance(t)},addTRLType:function(t){for(var e,i=0;i<this.floors.length;i++)e=this.floors[i].texRectList.addTextureType(t);return e},addTRLRect:function(t,e,i){this.floors[t].texRectList.addTextureRect(e,i)},buildTRLRect:function(t,e){this.floors[t].texRectList.buildTextureRect(e)},cleanTRLRect:function(t,e){this.floors[t].texRectList.cleanTextureRect(e)},buildAllTRLRect:function(t){this.floors[t].texRectList.buildAllTextureRect()},cleanAllTRLRect:function(t){this.floors[t].texRectList.cleanAllTextureRect()},addTextureRect:function(t,e){this.floors[t].texRect.addTextureRect(e)},buildTextureRectAll:function(){for(var t=0;t<this.floors.length;t++)this.floors[t].texRect.buildTextureRect()},buildTextureRectFloor:function(t){this.floors[t].texRect.buildTextureRect()},cleanTextureRectAll:function(){for(var t=0;t<this.floors.length;t++)this.floors[t].texRect.cleanTextureRect()},cleanTextureRectFloor:function(t){this.floors[t].texRect.cleanTextureRect()},setTextureRectTex:function(t){YFM.Map.FloorTextureRect.prototype.texName[0]=t},addTextureRectSpec:function(t,e){this.floors[t].texRectSpec.addTextureRect(e)},buildTextureRectAllSpec:function(){for(var t=0;t<this.floors.length;t++)this.floors[t].texRectSpec.buildTextureRect()},buildTextureRectFloorSpec:function(t){this.floors[t].texRectSpec.buildTextureRect()},cleanTextureRectAllSpec:function(){for(var t=0;t<this.floors.length;t++)this.floors[t].texRectSpec.cleanTextureRect()},cleanTextureRectFloorSpec:function(t){this.floors[t].texRectSpec.cleanTextureRect()},setTextureRectTexSpec:function(t){YFM.Map.FloorTextureRect.prototype.texName[1]=t},addTextureRectUltra:function(t,e){this.floors[t].texRectUltra.addTextureRect(e)},buildTextureRectAllUltra:function(){for(var t=0;t<this.floors.length;t++)this.floors[t].texRectUltra.buildTextureRect()},buildTextureRectFloorUltra:function(t){this.floors[t].texRectUltra.buildTextureRect()},cleanTextureRectAllUltra:function(){for(var t=0;t<this.floors.length;t++)this.floors[t].texRectUltra.cleanTextureRect()},cleanTextureRectFloorUltra:function(t){this.floors[t].texRectUltra.cleanTextureRect()},setTextureRectTexUltra:function(t){YFM.Map.FloorTextureRect.prototype.texName[2]=t},addQuickPolygon:function(t,e,i){this.floors[t].quickPolygon.addQuickPolygon(e,i)},buildQuickPolygonAll:function(){for(var t=0;t<this.floors.length;t++)this.floors[t].quickPolygon.buildQuickPolygon()},buildQuickPolygonFloor:function(t){this.floors[t].quickPolygon.buildQuickPolygon()},cleanQuickPolygonAll:function(){for(var t=0;t<this.floors.length;t++)this.floors[t].quickPolygon.cleanQuickPolygon()},cleanQuickPolygonFloor:function(t){this.floors[t].quickPolygon.cleanQuickPolygon()},insertTextureMarker:function(t,e,i,s,r,o,a){return this.floors[e].markers.insertTextureMarker(t,i,s,r,o,a)},removeMarker:function(t){var e=this._calcMarkerFloor(t);return null!==this.floors[e].markers.removeMarker(t)},updateMarkerLocation:function(t,e,i,s){var r=-1,o=this._calcMarkerFloor(t),a=this.floors[o].markers.removeMarker(t);return null!==a&&(r=this.floors[e].markers.insertMarker(a,i,s)),r},searchModel:function(t,e){var i=this.touchMgr.getFocusFloorIndex();if(-1!=i){var s=this.touchMgr.getTouchRayPlus(t,e);return this.floors[i].searchModel(s,!1)}return[]},searchUnit:function(t,e){var i=this.touchMgr.getFocusFloorIndex();if(-1!=i){var s=this.touchMgr.getTouchRayPlus(t,e);return this.floors[i].searchUnit(s,!1)}return[]},searchIcon:function(t,e,i,s){var r=this.touchMgr.getFocusFloorIndex(),o=i||80,a=s||!1;if(-1!=r){var n=this.touchMgr.getTouchRayPlus(t,e);return this.floors[r].searchIcon(n,o,a)}return[]},searchIconPlus:function(t,e){var i=this.touchMgr.getFocusFloorIndex();if(-1!=i){var s=this.touchMgr.getTouchRayPlus(t,e);return this.floors[i].searchIconPlus(s,!1)}return[]},searchMarker:function(t,e){for(var i=null,s=Number.MAX_VALUE,r=0;r<this.floors.length;r++)if(-1!==this.floors[r].BBCheck){var o=this.floors[r].markers.findMarker(t,e);null!==o&&s>o.dist&&(i=o,s=o.dist)}return null!==i?i.id:-1},getTouchPosMapLoc:function(t,e){return this.touchMgr._screen_to_map(t,e)},getTouchPosWorldLoc:function(t,e){return this.touchMgr._pos_in_world_space(t,e)},regionPos2Screen:function(t){var e=YFM.Math.Matrix.mul(this.camera.getPVMat(),this.matRegion),i=YFM.Math.Matrix.mulVec(e,t);return i[0]/=i[3],i[1]/=i[3],i[2]/=i[3],i[3]/=i[3],i[0]=i[0]*this.hw+this.hw,i[1]=-i[1]*this.hh+this.hh,i},regionPos2ScreenGL:function(t){var e=YFM.Math.Matrix.mul(this.camera.getPVMat(),this.matRegion),i=YFM.Math.Matrix.mulVec(e,t);return i[0]/=i[3],i[1]/=i[3],i[2]/=i[3],i[3]/=i[3],i[0]*=this.hw,i[1]*=this.hh,i},regionPos2ScreenPlus:function(t,e){var i=YFM.Math.Matrix.mul(this.camera.getPVMat(),this.matRegion),s=YFM.Math.Matrix.mulVec(i,t);s[0]/=s[3],s[1]/=s[3],s[2]/=s[3],s[3]/=s[3],e.cx=s[0]*this.hw+this.hw,e.cy=-s[1]*this.hh+this.hh,e.gx=s[0]*this.hw,e.gy=s[1]*this.hh},floorPos2RegionPos:function(t,e,i){if(t<0||t>=this.floors.length)throw new Error("floor index out of bounds");return this.floors[t].floorPos2Region(e,i)},_onOverlook:function(t){this.overlook=t,this.extrudeLight=t?this.extrudeLightOver:this.extrudeLightNormal},_getRegionMat:function(){return this.matRegion},_setRegionMat:function(t){this.matRegion=t},_traceLoc:function(t,e,i){var s=YFM.Math.Vector.pos(t,e,i),r=YFM.Math.Matrix.mulVec(this.matRegion,s);if(YFM.Map.STATUS_NAVIGATE===this.status){var o=0,a=this.getNaviStatus();if(a.validate){var n=YFM.Math.Matrix.eulerParamExtractZ(this.matRegion);o=a.azimuth+n}this.camera.setLookAtAzimuth(o,r[0],r[1],r[2])}else this.camera.setLookAt(r[0],r[1],r[2])},_getFloorMat:function(t){if(t<0||t>=this.floors.length)throw new Error("floor index out of bounds");return this.floors[t].getFloorMat()},_intersectionLine:function(t){var e,i,s=[];for(e=this.floors.length,i=0;i<e;i++)s.push(this.floors[i].intersectionLine(t));return s},_render:function(){var t,e;t=this.floors.length,this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.clearColor&&this.gl.clearColor(this.clearColor[0],this.clearColor[1],this.clearColor[2],1),this.regionThumbnailFlag&&this.regionThumbnail.saveStatus(),this.animMgr.update(),this._cleanText(),this.tqct.reset(),this.renderParam.projMat=this.camera.getProjectionMat(),this.renderParam.viewMat=this.camera.getViewMat(),this.renderParam.regionMat=this.matRegion,this.renderParam.vrMat=YFM.Math.Matrix.mul(this.renderParam.viewMat,this.matRegion),this.renderParam.pvrMat=YFM.Math.Matrix.mul(this.camera.getPVMat(),this.matRegion),this.renderParam.itvrMat=YFM.Math.Matrix.invert(YFM.Math.Matrix.transpose(this.renderParam.vrMat)),this.renderParam.ivrMat=YFM.Math.Matrix.invert(this.renderParam.vrMat),this.renderParam.eyePos=YFM.Math.Matrix.mulVec(this.renderParam.ivrMat,this.orgPos);var i=YFM.Math.Matrix.matClone(this.renderParam.vrMat);i[12]=0,i[13]=0,i[14]=0;var s=YFM.Math.Matrix.invert(i),r=YFM.Math.Matrix.scale(15,0,0,0);r=YFM.Math.Matrix.postRotate3d(r,this.camera.getRoll()-90,0,0,1),this.renderParam.bivrMat=YFM.Math.Matrix.mul(s,r),this.frustum.update(this.renderParam.pvrMat);var o=[];if(-1===this.displayFloorIndex){h=this.touchMgr.getFocusFloorIndex();for(e=0;e<t;e++){var a=this.floors[e].frustumCheck(this.frustum);this.floors[e].BBCheck=a,this._renderFloor(e,a,h),o.push(a)}}else{for(e=0;e<t;e++)this.floors[e].BBCheck=-1;this.floors[this.displayFloorIndex].BBCheck=1,this._renderFloor(this.displayFloorIndex,a,this.displayFloorIndex)}var n=this.frustum.containCheckPoint(this.locMarker.getRegionLoc());if(-1!==this.displayFloorIndex&&this.displayFloorIndex!==this.getFloorLoc().floor&&(n=!1),this.route.render(this.renderParam),n&&(this.marker2DShader.useProgram(),this.marker2DShader.setProjectionMatrix(this.orthMat),this.color2DShader.useProgram(),this.color2DShader.setProjectionMatrix(this.orthMat)),this.locMarker.render(this.color2DShader,this.marker2DShader,n,this.renderParam.pvrMat),-1===this.displayFloorIndex){var h=this.touchMgr.getFocusFloorIndex();for(e=0;e<t;e++)-1!==o[e]&&this._renderFloor2DMarker(e)}else this._renderFloor2DMarker(this.displayFloorIndex);this.regionThumbnail.render()},_getFloorVOffset:function(t){return t*this.vPitch},_renderFloor2DMarker:function(t,e){this.marker2DShader.useProgram(),this.marker2DShader.setProjectionMatrix(this.orthMat),this.color2DShader.useProgram(),this.color2DShader.setProjectionMatrix(this.orthMat),this.floors[t].renderMarkers(this.frustum,this.color2DShader,this.marker2DShader,this.renderParam.pvrMat,this.renderParam.eyePos)},_renderFloor:function(t,e,i){if(-1!=e){this.baseColorShader.useProgram(),this.baseColorShader.setProjectionMatrix(this.renderParam.projMat),this.baseColorShader.setViewMatrix(this.renderParam.viewMat),this.baseColorShader.setRegionMatrix(this.matRegion),this.floors[t].renderBase(this.baseColorShader,this.touchMgr.getTouchFloor()==t);var s=this.overlook;YFM.Map.STATUS_SENSOR===this.status&&(s=!1);var r=!this.overlook;YFM.Map.STATUS_SENSOR===this.status&&(r=!0),this.basePhongShader.useProgram(),this.basePhongShader.setPVRMatrix(this.renderParam.pvrMat),this.basePhongShader.setAmbient(this.ambient),this.basePhongShader.setDiffuse(this.diffuse),this.basePhongShader.setLightPos(this.extrudeLight),this.basePhongShader.setNormalMatrix(this.renderParam.itvrMat),this.floors[t].renderExtrude(this.basePhongShader,r),this.baseColorShader.useProgram(),this.floors[t].renderTextureRect(this.baseColorShader),(this.drawUnitTextAlways||s&&t==i)&&(this.marker2DShader.useProgram(),this.marker2DShader.setProjectionMatrix(this.orthMat),this.floors[t].renderUnit(this.frustum,this.marker2DShader)),this.billboardIconShader.useProgram(),this.billboardIconShader.setProjectionMatrix(this.renderParam.projMat),this.billboardIconShader.setViewMatrix(this.renderParam.viewMat),this.billboardIconShader.setRegionMatrix(this.matRegion),this.billboardIconShader.setIViewMatrix(this.renderParam.bivrMat),this.floors[t].renderIcons(this.frustum,this.billboardIconShader),this.color2DShader.useProgram(),this.color2DShader.setProjectionMatrix(this.orthMat),this.floors[t].renderCallout(this.frustum,this.color2DShader),this.floors[t].renderQuickCallout(this.frustum,this.color2DShader),this.floors[t].renderTrajectory()}},_restructure:function(){var t,e,i,s;for(e=0,s=this.floors.length,i=0;i<s;i++)null!=(t=this.floors[i].getSize())&&t>e&&(e=t);for(this.maxSize=e,this.customFloorHeight?this.vPitch=this.customFloorHeight:this.vPitch=e/3,i=0;i<s;i++)this.floors[i].setVOffset(this.vPitch,i);this._makeBuildingOBB();var r=s*this.vPitch,o=Math.sqrt(r*r+e*e);this.touchMgr.setZoomMax(5*o)},_makeBuildingOBB:function(){var t,e,i,s=[],r=this.floors.length;for(t=0;t<r;t++)e=this.floors[t].mapHeight,i=this.floors[t].mapWidth,s.push(this.floorPos2RegionPos(t,0,0)),s.push(this.floorPos2RegionPos(t,i,0)),s.push(this.floorPos2RegionPos(t,0,e)),s.push(this.floorPos2RegionPos(t,i,e));this.obb=new YFM.Math.OBB(s)},_grender:function(){YFM.gRegion&&(YFM.gRegion._render(),requestAnimFrame(YFM.gRegion._grender))},_makeAzimuth:function(t){var e=YFM.Math.Vector.vec(0,1,0),i=YFM.Math.Vector.normalize(t),s=YFM.Math.Vector.dot3(i,e);return Math.acos(s)},_clampMinorArc:function(t){var e=2*Math.PI,i=t%e;return i>0&&i>Math.PI?i-=e:i<0&&i<-Math.PI&&(i+=e),i},_calcMarkerFloor:function(t){return t%YFM.Map.FloorMarkers.prototype.shift},_calcModelFloor:function(t){return t%YFM.Math.FloorQuadTree.prototype.shift},_drawText:function(t,e,i){this.ctx2d.fillText(t,e,i)},_cleanText:function(){this.ctx2d.clearRect(0,0,this.txtCanvas.width,this.txtCanvas.height)},_determineFontHeight:function(t){var e=document.getElementsByTagName("body")[0],i=document.createElement("div"),s=document.createTextNode("M");i.appendChild(s),i.setAttribute("style",t),e.appendChild(i);var r=i.offsetHeight;return e.removeChild(i),r},_initMarkerAnim:function(){var t=[],e=2*Math.PI;t.push(YFM.Math.Vector.pos(0,0,15));for(var i=0;i<e;i+=.1)t.push(YFM.Math.Vector.pos(Math.cos(i),Math.sin(i),15));var s,r,o=[];for(s=1,r=t.length-1;s<r;s++)o.push(t[s]),o.push(t[0]),o.push(t[s+1]);o.push(t[s]),o.push(t[0]),o.push(t[1]),this.markerAnim.circleVBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.markerAnim.circleVBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(o,3),this.gl.STATIC_DRAW),this.markerAnim.circleSize=o.length,this.markerAnim.waveRadius=YFM.Math.Vector.vec(12,12),this.markerAnim.waveMax=48,this.markerAnim.waveMin=12,this.markerAnim.waveStep=(this.markerAnim.waveMax-this.markerAnim.waveMin)/56,this.markerAnim.waveColor=YFM.Math.Vector.vec(0,0,.8,.5),this.markerAnim.id=-1}},YFM.Map.RegionLocMarker=function(t,e,i,s,r){var o=YFM.Math.Vector,a=YFM.WebGL.Color;this.gl=t,this.size=e,this.faceColor=o.vec(a.hexColorRed(i),a.hexColorGreen(i),a.hexColorBlue(i),a.hexColorAlpha(i)),this.lineColor=o.vec(a.hexColorRed(s),a.hexColorGreen(s),a.hexColorBlue(s),a.hexColorAlpha(s)),this.region=r,this.waveRadius=o.vec(12,12),this.waveMax=48,this.waveMin=12,this.waveStep=(this.waveMax-this.waveMin)/56,this.locMarkerTexName=null,this.locMarker=null,this.regionLoc=YFM.Math.Vector.pos(0,0,0),this.floorLoc={floor:-1,x:0,y:0},this.anim={floor:0,dist:.1,flag:!1,mover:new YFM.Math.Mover(0,0,0),target:null},this._init(t,e)},YFM.Map.RegionLocMarker.prototype={constructor:YFM.Map.RegionLocMarker,locateLaunch:function(){console.log("-------locateLaunch"),this.waveRadius[0]=this.waveMax,this.waveRadius[1]=this.waveMax},set2DMarkerParam:function(t,e,i,s){var r=YFM.Math.Vector,o=YFM.WebGL.Color;this.locMarkerTexName=t,this.locMarker=null,this.waveColor=r.vec(o.hexColorRed(e),o.hexColorGreen(e),o.hexColorBlue(e),o.hexColorAlpha(e)),this.waveMax=i,this.waveMin=s,this.waveStep=(this.waveMax-this.waveMin)/56},getRegionLoc:function(){return YFM.Math.Vector.vecClone(this.regionLoc)},getFloorLoc:function(){return{floor:this.floorLoc.floor,x:this.floorLoc.x,y:this.floorLoc.y}},getSize:function(){return this.size},updateLocation:function(){-1!==this.floorLoc.floor&&(this.regionLoc=this.region.floorPos2RegionPos(this.floorLoc.floor,this.floorLoc.x,this.floorLoc.y),YFM.Map.STATUS_TOUCH!=this.region.getStatus()&&this.region._traceLoc(this.regionLoc[0],this.regionLoc[1],this.regionLoc[2]),this.region.updateNaviStatus(this.floorLoc,this.regionLoc))},cleanLocation:function(){this.floorLoc.floor=-1,this.floorLoc.x=0,this.floorLoc.y=0},setLocation:function(t,e,i){this.floorLoc.floor=t,this.floorLoc.x=e,this.floorLoc.y=i,this.regionLoc=this.region.floorPos2RegionPos(t,e,i),YFM.Map.STATUS_TOUCH!=this.region.getStatus()&&this.region._traceLoc(this.regionLoc[0],this.regionLoc[1],this.regionLoc[2]),this.region.updateNaviStatus(this.floorLoc,this.regionLoc)},animTo:function(t,e,i){t!=this.floorLoc.floor?(this.anim.flag=!1,this.setLocation(t,e,i)):(this.anim.floor=t,this.anim.flag=!0,this.anim.target=YFM.Math.Vector.pos(e,i,0),this.anim.mover.setLocation(this.floorLoc.x,this.floorLoc.y,0))},render:function(t,e,i,s){if(this._updateAnim(),i&&!(this.floorLoc.floor<0)){if(!this.locMarker&&this.locMarkerTexName){var r=this.region.getTexture(this.locMarkerTexName);null!==r&&(this.locMarker={tex:r.tex,texSize:YFM.Math.Vector.vec(r.w/2,r.h/2)})}if(this.locMarker){var o,a,n,h,l=YFM.Math.Matrix.mulVec(s,this.regionLoc);n=this.region.glCanvas.width/2,h=this.region.glCanvas.height/2,l[0]/=l[3],l[1]/=l[3],l[2]/=l[3],l[3]/=l[3],l[0]*=n,l[1]*=h,this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),o=YFM.Math.Matrix.scaleXYZ(this.waveRadius,0,0,0),a=YFM.Math.Matrix.postTranslate(o,l[0],l[1],0),t.setModelMatrix(a),t.drawTriangles(this.circleVBO,this.waveColor,0,this.circleSize),this.waveRadius[0]>this.waveMin?(this.waveRadius[0]-=this.waveStep,this.waveRadius[1]-=this.waveStep):(this.waveRadius[0]=this.waveMin,this.waveRadius[1]=this.waveMin),e.useProgram(),e.bindTexture(this.locMarker.tex);var u=this.region.getFloorDeflection(this.floorLoc.floor)-(this.region.azimuth+this.region.getFloorAngle(this.floorLoc.floor));o=YFM.Math.Matrix.scaleXYZ(this.locMarker.texSize,0,0,0),o=YFM.Math.Matrix.postTranslate(YFM.Math.Matrix.postRotateXY(o,u,0,0),l[0],l[1],0),e.setModelMatrix(o),e.drawTriangles(this.quadVBO,6,0),this.gl.disable(this.gl.BLEND)}}},_updateAnim:function(){if(this.anim.flag)if(this.anim.mover.arrive(this.anim.target,this.anim.dist))this.anim.flag=!1,this.setLocation(this.anim.floor,this.anim.target[0],this.anim.target[1]);else{this.anim.mover.update();var t=this.anim.mover.getLocation();this.setLocation(this.anim.floor,t[0],t[1])}},_init:function(t,e){var i=YFM.Math.Vector,s=2.5*e,r=[];r.push(i.pos(0,0,0)),r.push(i.pos(0,e,s)),r.push(i.pos(e,0,s)),r.push(i.pos(0,-e,s)),r.push(i.pos(-e,0,s));var o=[];o.push(r[4]),o.push(r[2]),o.push(r[1]),o.push(r[2]),o.push(r[4]),o.push(r[3]),o.push(r[0]),o.push(r[4]),o.push(r[1]),o.push(r[0]),o.push(r[1]),o.push(r[2]),o.push(r[0]),o.push(r[2]),o.push(r[3]),o.push(r[0]),o.push(r[3]),o.push(r[4]),o.push(r[0]),o.push(r[1]),o.push(r[0]),o.push(r[2]),o.push(r[0]),o.push(r[3]),o.push(r[0]),o.push(r[4]),o.push(r[1]),o.push(r[2]),o.push(r[2]),o.push(r[3]),o.push(r[3]),o.push(r[4]),o.push(r[4]),o.push(r[1]),this.trianglesVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.trianglesVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(o,3),t.STATIC_DRAW);var a=[],n=2*Math.PI;a.push(i.pos(0,0,15));for(var h=0;h<n;h+=.1)a.push(i.pos(Math.cos(h),Math.sin(h),15));var l,u,c=[];for(l=1,u=a.length-1;l<u;l++)c.push(a[l]),c.push(a[0]),c.push(a[l+1]);c.push(a[l]),c.push(a[0]),c.push(a[1]),this.circleVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.circleVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(c,3),t.STATIC_DRAW),this.circleSize=c.length;var M=[],d=[],p=[];p.push(YFM.Math.Vector.vec(0,1)),p.push(YFM.Math.Vector.vec(1,1)),p.push(YFM.Math.Vector.vec(1,0)),p.push(YFM.Math.Vector.vec(0,0)),d.push(YFM.Math.Vector.pos(-1,-1,0)),d.push(YFM.Math.Vector.pos(1,-1,0)),d.push(YFM.Math.Vector.pos(1,1,0)),d.push(YFM.Math.Vector.pos(-1,1,0)),M.push(d[0]),M.push(p[0]),M.push(d[1]),M.push(p[1]),M.push(d[2]),M.push(p[2]),M.push(d[0]),M.push(p[0]),M.push(d[2]),M.push(p[2]),M.push(d[3]),M.push(p[3]),this.quadVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.quadVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(M,3),t.STATIC_DRAW)}},YFM.Map.RegionThumbnail=function(t){this.region=t,this.visibility=!1,this.renderParam=null,this.extrudeLight=YFM.Math.Vector.normalize(YFM.Math.Vector.vec(.5,.5,1)),this.scaleRate=1},YFM.Map.RegionThumbnail.prototype={constructor:YFM.Map.RegionThumbnail,setVisibility:function(t){this.visibility=t},persistence:function(){var t=YFM.Math.Matrix,e={};return e.projMat=t.matClone(this.renderParam.projMat),e.viewMat=t.matClone(this.renderParam.viewMat),e.regionMat=t.matClone(this.renderParam.regionMat),e},getPVRMat:function(){return YFM.Math.Matrix.matClone(this.renderParam.pvrMat)},isEnable:function(){return!!this.renderParam},cleanStatus:function(){this.renderParam=null},setParam:function(t){var e=YFM.Math.Matrix;this.renderParam={},this.renderParam.regionMat=e.matClone(t.regionMat),this.renderParam.projMat=e.matClone(t.projMat),this.renderParam.viewMat=e.matClone(t.viewMat),this.renderParam.vrMat=e.mul(this.renderParam.viewMat,this.renderParam.regionMat),this.renderParam.itvrMat=YFM.Math.Matrix.invert(YFM.Math.Matrix.transpose(this.renderParam.vrMat)),this.renderParam.pvrMat=e.mul(e.mul(this.renderParam.projMat,this.renderParam.viewMat),this.renderParam.regionMat)},setScaleRate:function(t){this.scaleRate=t},saveStatus:function(){var t=YFM.Math.Matrix;this.renderParam={},this.renderParam.regionMat=t.postScale(this.region._getRegionMat(),this.scaleRate,0,0,0),this.renderParam.projMat=t.matClone(this.region.camera.getProjectionMat()),this.renderParam.viewMat=t.matClone(this.region.camera.getViewMat()),this.renderParam.vrMat=YFM.Math.Matrix.mul(this.renderParam.viewMat,this.renderParam.regionMat),this.renderParam.pvrMat=YFM.Math.Matrix.mul(this.region.camera.getPVMat(),this.renderParam.regionMat)},render:function(){if(this.visibility&&this.renderParam){var t,e,i;for(t=this.region.floors.length,(i=this.region.gl).clear(i.DEPTH_BUFFER_BIT),this.region.frustum.update(this.renderParam.pvrMat),e=0;e<t;e++)this._renderFloor(e);this.region.route.renderThumbnail()}},_renderFloor:function(t){this.region.baseColorShader.useProgram(),this.region.baseColorShader.setProjectionMatrix(this.renderParam.projMat),this.region.baseColorShader.setViewMatrix(this.renderParam.viewMat),this.region.baseColorShader.setRegionMatrix(this.renderParam.regionMat),this.region.floors[t].renderBase(this.region.baseColorShader,!1,!0),this.region.basePhongShader.useProgram(),this.region.basePhongShader.setPVRMatrix(this.renderParam.pvrMat),this.region.basePhongShader.setNormalMatrix(this.renderParam.itvrMat),this.region.floors[t].renderExtrude(this.region.basePhongShader,this.renderParam.vrMat,this.extrudeLight,!0)}},YFM.Map.RegionTouchMgr=function(t,e,i,s,r){function o(t){if(n.enable)switch(t.preventDefault(),n._updateEventLayerPos(t),t.type){case"touchstart":n.strategy.touchDown(t);break;case"touchmove":n.strategy.touchMove(t);break;case"touchend":n.strategy.touchUp(t);break;case"touchcancel":n.strategy.touchCancel(t)}}function a(t){if(n.enable)switch(t.preventDefault(),t.type){case"mousedown":document.body.tabIndex=-1,document.body.focus(),document.onkeypress=arguments.callee,n._updateEventLayerPos(t),n.strategy_desktop.mouseDown(t);break;case"mouseup":document.onkeypress=null,n._updateEventLayerPos(t),n.strategy_desktop.mouseUp(t);break;case"mouseleave":document.onkeypress=null,n._updateEventLayerPos(t),n.strategy_desktop.mouseLeave(t);case"mousemove":n._updateEventLayerPos(t),n.strategy_desktop.mouseMove(t);break;case"mousewheel":n._updateEventLayerPos(t),n.strategy_desktop.mouseWheel(t);break;case"keypress":n.strategy_desktop.keyPress(t)}}this.hangUp=!1,this.camera=t,this.canvas=e,this.ctx2d=i,this.region=s,this.listener=r,this.touchFloorIndex=-1,this.focusFloorDirty=!0,this.enable=!0,this.isMobile=this._isMobileBrowser(),this.uiScaleRate=1,this.overlook=!1,this.longPressFlag=!1,this.box=e.getBoundingClientRect(),this.touchRec={savedmat:YFM.Math.Matrix.matClone(s._getRegionMat()),pitchCnt:0,degree:0,screenSpacing:0,viewSpacing:0,radius0x:0,radius0y:0,layer0x:0,layer0y:0,layer1x:0,layer1y:0,dy0:0,dy1:0,start0x:0,start0y:0,start1x:0,start1y:0,pre0y:0,pre1y:0,midX:0,midY:0},this.planeRec={planeHeight:0,midpos:null,start0:null,start1:null,prev:null,translateX:0,translateY:0,firstAngle:0},this.viewZoom={max:3e3,min:150};var n=this;this.strategy_desktop={timeStampPrev:0,timeStampCur:0,clickFlag:!1,pitchLock:!1,rotateLock:!1,zoomLock:!1,zoomTarget:null,deltaPitch:0,deltaAngle:0,mousePressed:!1,mouseDown:function(t){this.timeStampPrev=this.timeStampCur,this.timeStampCur=(new Date).getTime(),n.planeRec.planeHeight=n._touch_plane_height(n.touchRec.layer0x,n.touchRec.layer0y),n.touchRec.savedmat=YFM.Math.Matrix.matClone(n.region._getRegionMat()),n.planeRec.start0=n._pos_in_world_space(n.touchRec.layer0x,n.touchRec.layer0y),n.planeRec.translateX=0,n.planeRec.translateY=0,this.mousePressed=!0,this.rotateLock=!1,this.pitchLock=!1,this.zoomLock=!1},mouseUp:function(t){var e=(new Date).getTime(),i=n.planeRec.translateX,s=n.planeRec.translateY;if(!(this.rotateLock||this.pitchLock||this.zoomLock)){if(this.clickFlag){var r=e-this.timeStampPrev;i*i+s*s<100&&r<200&&n._onDClick(n.touchRec.layer0x,n.touchRec.layer0y),this.clickFlag=!1}else{var o=e-this.timeStampCur;if(i*i+s*s<100)if(o<100){this.clickFlag=!0;var a=this;setTimeout(function(){a.clickFlag&&(a.clickFlag=!1,n._onClick(n.touchRec.layer0x,n.touchRec.layer0y))},200)}else o>800&&n._onLongPressUp(n.touchRec.layer0x,n.touchRec.layer0y)}this.mousePressed=!1,this.deltaAngle=0,this.deltaPitch=0}},mouseLeave:function(t){this.mousePressed=!1,this.deltaAngle=0,this.deltaPitch=0},mouseMove:function(t){if(n.enable&&(this.mousePressed&&YFM.Map.STATUS_TOUCH!==n.region.getStatus()&&n.region.setStatus(YFM.Map.STATUS_TOUCH),this.mousePressed&&!this.pitchLock&&!this.rotateLock&&!this.zoomLock)){var e=n._pos_in_world_space(n.touchRec.layer0x,n.touchRec.layer0y);n.planeRec.translateX=e[0]-n.planeRec.start0[0],n.planeRec.translateY=e[1]-n.planeRec.start0[1];var i=YFM.Math.Matrix.postTranslate(n.touchRec.savedmat,n.planeRec.translateX,n.planeRec.translateY,0);if(n.region.displayFloorIndex===n.touchFloorIndex&&n._mapConstraint(n.camera.getPVMat(),i))return;n.region._setRegionMat(i),n._onScroll(n.planeRec.translateX,n.planeRec.translateY),n.focusFloorDirty=!0}},mouseWheel:function(t){if(n.enable&&(this.zoomLock||(this.zoomLock=!0),this.zoomLock)){var e=-t.wheelDelta/2;n.planeRec.planeHeight=n._touch_plane_height(n.touchRec.layer0x,n.touchRec.layer0y);var i=n._world_to_view(n._pos_in_world_space(n.touchRec.layer0x,n.touchRec.layer0y)),s=YFM.Math.Vector.pos(0,0,0),r=YFM.Math.Vector.sub(s,i),o=YFM.Math.Vector.normalize(r),a=n.camera.getLookOffset();e>0?YFM.Math.Vector.norm3(a)>=n.viewZoom.max&&(e=0):e<0&&(0===n.touchFloorIndex||n.region.displayFloorIndex===n.touchFloorIndex)&&YFM.Math.Vector.norm3(r)<=n.viewZoom.min&&(e=0),YFM.Math.Vector.scaleTo(o,e),YFM.Math.Vector.subTo(a,a,o),n.camera.setLookOffset(a[0],a[1],a[2]),n.focusFloorDirty=!0}},keyPress:function(t){if(n.enable&&this.mousePressed){var e=!1,i=!1;if("a"===t.key?(this.deltaAngle+=1,e=!0):"d"===t.key?(this.deltaAngle-=1,e=!0):"w"==t.key?(this.deltaPitch=-1,i=!0):"s"==t.key&&(this.deltaPitch=1,i=!0),!this.rotateLock&&e&&(this.rotateLock=!0,n.touchRec.savedmat=YFM.Math.Matrix.matClone(n.region._getRegionMat()),n.planeRec.start0=n._pos_in_world_space(n.touchRec.layer0x,n.touchRec.layer0y),this.deltaAngle=0),this.rotateLock){var s=YFM.Math.Matrix.postRotateXY(n.touchRec.savedmat,this.deltaAngle,n.planeRec.start0[0],n.planeRec.start0[1]);n.region._setRegionMat(s),n.focusFloorDirty=!0}if(!this.pitchLock&&i){var r=n.planeRec.start0=n._pos_in_world_space(n.touchRec.layer0x,n.touchRec.layer0y);n.camera.resetLookOffsetTan(),n.region.lookAtWorldLoc(r[0],r[1],r[2]),this.pitchLock=!0}if(this.pitchLock){var o=n.camera.getPitch();(o+=this.deltaPitch)<=YFM.Map.RegionTouchMgr.prototype.PITCH_LIMIT&&this.deltaPitch<0?o=YFM.Map.RegionTouchMgr.prototype.PITCH_LIMIT:o>=0&&this.deltaPitch>0?(o=0,n.overlook||(n.region._onOverlook(!0),n.overlook=!0)):o<=0&&this.deltaPitch<0&&n.overlook&&(n.region._onOverlook(!1),n.overlook=!1),n.camera.setPitch(o),n.focusFloorDirty=!0}}}},this.strategy_none={name:"none",mouseDown:function(t){n._onMouseDown(n.touchRec.layer0x,n.touchRec.layer0y)},touchDown:function(t){if(1==t.touches.length)n.planeRec.planeHeight=n._touch_plane_height(n.touchRec.layer0x,n.touchRec.layer0y),n.hangUp=!1,n.touchRec.savedmat=YFM.Math.Matrix.matClone(n.region._getRegionMat()),n.touchRec.start0x=n.touchRec.layer0x,n.touchRec.start0y=n.touchRec.layer0y,n.touchRec.radius0x=t.touches[0].radiusX,n.touchRec.radius0y=t.touches[0].radiusY,n.planeRec.prev=n.planeRec.start0=n._pos_in_world_space(n.touchRec.layer0x,n.touchRec.layer0y),n.planeRec.translateX=0,n.planeRec.translateY=0,n.strategy=n.strategy_scroll;else if(t.touches.length>1){if(!n.enable)return;this.startTime=t.timeStamp,n.planeRec.planeHeight=n._touch_plane_height(n.touchRec.layer0x,n.touchRec.layer0y),n.hangUp=!1,n.touchRec.savedmat=YFM.Math.Matrix.matClone(n.region._getRegionMat()),n.touchRec.start0x=n.touchRec.layer0x,n.touchRec.start0y=n.touchRec.layer0y,n.touchRec.radius0x=t.touches[0].radiusX,n.touchRec.radius0y=t.touches[0].radiusY,n.planeRec.prev=n.planeRec.start0=n._pos_in_world_space(n.touchRec.layer0x,n.touchRec.layer0y),n.planeRec.translateX=0,n.planeRec.translateY=0,n.touchRec.start1x=n.touchRec.layer1x,n.touchRec.start1y=n.touchRec.layer1y,n.planeRec.start1=n._pos_in_world_space(n.touchRec.layer1x,n.touchRec.layer1y),n.touchRec.screenSpacing=n._spacingScreenSpace(n.touchRec.start0x,n.touchRec.start0y,n.touchRec.start1x,n.touchRec.start1y),n.touchRec.viewSpacing=n._spacingViewSpace(n.touchRec.start0x,n.touchRec.start0y,n.touchRec.start1x,n.touchRec.start1y).spacing,n.planeRec.midpos=n._midpoint(n.touchRec.layer0x,n.touchRec.layer0y,n.touchRec.layer1x,n.touchRec.layer1y),n.planeRec.firstAngle=n._calc_angle(t),n.strategy=n.strategy_multi}},touchMove:function(t){},touchUp:function(t){0==t.touches.length&&(n.hangUp=!1)},touchCancel:function(t){n.hangUp=!1}},this.strategy_multi={name:"multi",mouseDown:function(t){n._onMouseDown(n.touchRec.layer0x,n.touchRec.layer0y)},touchDown:function(t){},touchMove:function(t){n.touchRec.pitchCnt=0,n.strategy=n.strategy_rotate},touchUp:function(t){n.hangUp=!1,(new Date).getTime()-n.strategy_none.timeStampCur<100&&(n.touchRec.screenSpacing<300&&n._on2FClick(n.touchRec.start0x,n.touchRec.start0y),n.strategy_none.twoFingerClickFlag=!0),n.strategy=n.strategy_none},touchCancel:function(t){n.strategy=n.strategy_none,n.hangUp=!1}},this.strategy_scroll={name:"scroll",mouseDown:function(t){n._onMouseDown(n.touchRec.layer0x,n.touchRec.layer0y)},touchDown:function(t){t.touches.length>1&&(n.touchRec.savedmat=YFM.Math.Matrix.matClone(n.region._getRegionMat()),n.touchRec.start0x=n.touchRec.layer0x,n.touchRec.start0y=n.touchRec.layer0y,n.touchRec.start1x=n.touchRec.layer1x,n.touchRec.start1y=n.touchRec.layer1y,n.touchRec.screenSpacing=n._spacingScreenSpace(n.touchRec.layer0x,n.touchRec.layer0y,n.touchRec.layer1x,n.touchRec.layer1y),n.touchRec.viewSpacing=n._spacingViewSpace(n.touchRec.layer0x,n.touchRec.layer0y,n.touchRec.layer1x,n.touchRec.layer1y).spacing,n.planeRec.midpos=n._midpoint(n.touchRec.layer0x,n.touchRec.layer0y,n.touchRec.layer1x,n.touchRec.layer1y),n.planeRec.firstAngle=n._calc_angle(t),n.strategy=n.strategy_multi)},touchMove:function(t){YFM.Map.STATUS_TOUCH!==n.region.getStatus()&&n.region.setStatus(YFM.Map.STATUS_TOUCH);var e=n._pos_in_world_space(n.touchRec.layer0x,n.touchRec.layer0y);n.planeRec.translateX=e[0]-n.planeRec.start0[0],n.planeRec.translateY=e[1]-n.planeRec.start0[1],n.planeRec.prev=e;var i=YFM.Math.Matrix.postTranslate(n.touchRec.savedmat,n.planeRec.translateX,n.planeRec.translateY,0);if(n.region.displayFloorIndex===n.touchFloorIndex){var s,r,o,a,h,l,u,c,M=YFM.Math.Matrix,d=YFM.Math.Vector;s=d.pos(0,0,-1),r=d.pos(0,0,1),h=M.mul(n.camera.getPVMat(),n.region.matRegion),l=M.invert(h),o=M.mulVec(l,s),a=M.mulVec(l,r),o[0]/=o[3],o[1]/=o[3],o[2]/=o[3],o[3]/=o[3],a[0]/=a[3],a[1]/=a[3],a[2]/=a[3],a[3]/=a[3],u=YFM.Math.Line.linePP(o,a),h=M.mul(n.camera.getPVMat(),i),l=M.invert(h),o=M.mulVec(l,s),a=M.mulVec(l,r),o[0]/=o[3],o[1]/=o[3],o[2]/=o[3],o[3]/=o[3],a[0]/=a[3],a[1]/=a[3],a[2]/=a[3],a[3]/=a[3],c=YFM.Math.Line.linePP(o,a);var p=n.region.floors[n.touchFloorIndex],g=p.intersectionLine(u);if(p.intersectionLine(c)<g)return}n.region._setRegionMat(i),n._onScroll(n.planeRec.translateX,n.planeRec.translateY),n.focusFloorDirty=!0},touchUp:function(t){var e=n.planeRec.translateX,i=n.planeRec.translateY;e*e+i*i<=16&&n._onClick(n.touchRec.start0x,n.touchRec.start0y),n.hangUp=!1,n.strategy=n.strategy_none},touchCancel:function(t){n.hangUp=!1,n.strategy=n.strategy_none}},this.strategy_rotate={name:"rotate",mouseDown:function(t){},touchDown:function(t){},touchMove:function(t){n.camera.getPVMat();if(!(n.hangUp||t.touches.length<2)){if(YFM.Map.STATUS_TOUCH!==n.region.getStatus()){var e=n._spacingScreenSpace(n.touchRec.layer0x,n.touchRec.layer0y,n.touchRec.layer1x,n.touchRec.layer1y),i=n.touchRec.screenSpacing-e,s=-n.camera.getLookOffsetNormal();return(s+=i/20)>n.viewZoom.max?s=n.viewZoom.max:s<n.viewZoom.min&&(s=n.viewZoom.min),void n.camera.setLookOffset(0,0,-s)}var r=n.touchRec.layer0y-n.touchRec.start0y;if(r*(n.touchRec.layer1y-n.touchRec.start1y)>0){var i=r/256,o=n.camera.getPitch();(o+=i)<=YFM.Map.RegionTouchMgr.prototype.PITCH_LIMIT&&i<0?o=YFM.Map.RegionTouchMgr.prototype.PITCH_LIMIT:o>=0&&i>0?(o=0,n.overlook||(n.region._onOverlook(!0),n.overlook=!0)):o<=0&&i<0&&n.overlook&&(n.region._onOverlook(!1),n.overlook=!1),n.camera.getPitch(),n.camera.setPitch(o)}if(!((e=n._spacingScreenSpace(n.touchRec.layer0x,n.touchRec.layer0y,n.touchRec.layer1x,n.touchRec.layer1y))<200)){var a=n._spacingViewSpace(n.touchRec.layer0x,n.touchRec.layer0y,n.touchRec.layer1x,n.touchRec.layer1y),h=n._calc_angle(t)-n.planeRec.firstAngle,l=YFM.Math.Matrix.postRotateXY(n.touchRec.savedmat,h,n.planeRec.midpos[0],n.planeRec.midpos[1],!0),u=(n.touchRec.viewSpacing-a.spacing)/2;u<0&&a.z<0&&a.z>-20&&(u=-30);var c=n._world_to_view(n.planeRec.midpos),M=YFM.Math.Vector.pos(0,0,0),d=YFM.Math.Vector.sub(M,c),i=YFM.Math.Vector.normalize(d),p=n.camera.getLookOffset();u>0?YFM.Math.Vector.norm3(p)>=n.viewZoom.max&&(u=0):u<0&&(0===n.touchFloorIndex||n.region.displayFloorIndex===n.touchFloorIndex)&&YFM.Math.Vector.norm3(d)<=n.viewZoom.min&&(u=0),YFM.Math.Vector.scaleTo(i,u);var g=YFM.Math.Vector.sub(p,i);n.camera.setLookOffset(g[0],g[1],g[2]),n.region._setRegionMat(l),n.focusFloorDirty=!0}}},touchUp:function(t){n.hangUp=!1,n.strategy=n.strategy_none},touchCancel:function(t){n.hangUp=!1,n.strategy=n.strategy_none}},this.strategy=this.strategy_none,this.isMobile?(e.addEventListener("touchstart",o,!1),e.addEventListener("touchmove",o,!1),e.addEventListener("touchend",o,!1),e.addEventListener("touchcancel",o,!1)):(e.addEventListener("mousedown",a,!1),e.addEventListener("mouseup",a,!1),e.addEventListener("mousemove",a,!1),e.addEventListener("mouseleave",a,!1),e.addEventListener("mousewheel",a,!1))},YFM.Map.RegionTouchMgr.prototype={constructor:YFM.Map.RegionTouchMgr,PITCH_LIMIT:-60,setUIScaleRate:function(t){this.uiScaleRate=t},getViewOffsetMax:function(){return this.viewZoom.max},getViewOffsetMin:function(){return this.viewZoom.min},setEnable:function(t){this.enable=t},onRegionLoadFinish:function(){this.focusFloorDirty=!0},getTouchFloor:function(){return this.touchFloorIndex},getFocusFloorIndex:function(){if(-1!==this.region.displayFloorIndex)return this.region.displayFloorIndex;if(!this.focusFloorDirty)return this.focusFloorIndex;var t,e,i,s,r,o,a=-1;for(i=-1e8,o=-1,r=-1,e=(t=this._floors_collision(this.canvas.width/2,this.canvas.height/2)).length,s=0;s<e;s++)t[s]<0&&t[s]>i&&(i=t[s],o=s),0==t[s]&&(r=s);return r>=0?a=r:o>=0&&(a=o),this.focusFloorIndex=a,this.focusFloorDirty=!1,this.focusFloorIndex},setZoomMax:function(t){this.viewZoom.max=t},setZoomMin:function(t){this.viewZoom.min=t},postTranslate:function(t,e){var i=YFM.Math.Matrix.matClone(this.region._getRegionMat()),s=YFM.Math.Matrix.postTranslate(i,t,e,0);this._mapConstraint(this.camera.getPVMat(),s)||(this.region._setRegionMat(s),this._onScroll(t,e),this.focusFloorDirty=!0)},postRotate:function(t){var e=this._pos_in_world_space(this.region.hw,this.region.hh),i=YFM.Math.Matrix.matClone(this.region._getRegionMat()),s=YFM.Math.Matrix.postRotateXY(i,t,e[0],e[1]);this._mapConstraint(this.camera.getPVMat(),s)||(this.region._setRegionMat(s),this.focusFloorDirty=!0)},getTouchRayPlus:function(t,e){var i,s,r,o,a,n,h,l;return i=t/this.canvas.width*2-1,s=-(e/this.canvas.height*2-1),r=YFM.Math.Vector.pos(i,s,-1),o=YFM.Math.Vector.pos(i,s,1),h=YFM.Math.Matrix.mul(this.camera.getPVMat(),this.region.matRegion),l=YFM.Math.Matrix.invert(h),a=YFM.Math.Matrix.mulVec(l,r),n=YFM.Math.Matrix.mulVec(l,o),a[0]/=a[3],a[1]/=a[3],a[2]/=a[3],a[3]/=a[3],n[0]/=n[3],n[1]/=n[3],n[2]/=n[3],n[3]/=n[3],YFM.Math.Line.linePP(a,n)},_onMouseDown:function(t,e){},_onScroll:function(t,e){null!==this.listener&&this.listener.onScroll(t,e)},_onClick:function(t,e){null!==this.listener&&this.listener.onClick(t,e)},_onDClick:function(t,e){null!==this.listener&&this.listener.onDClick(t,e)},_on2FClick:function(t,e){null!==this.listener&&this.listener.on2FClick(t,e)},_onLongPressUp:function(t,e){null!==this.listener&&this.listener.onLongPressUp(t,e)},_spacingScreenSpace:function(t,e,i,s){var r=i-t,o=s-e;return Math.sqrt(r*r+o*o)},_spacingViewSpace:function(t,e,i,s){var r=this._pos_in_view_space(t,e),o=this._pos_in_view_space(i,s),a=o[0]-r[0],n=o[1]-r[1];return{z:(r[2]+o[2])/2,spacing:Math.sqrt(a*a+n*n)}},_midpoint:function(t,e,i,s){var r,o;return r=(t+i)/2,o=(e+s)/2,this.touchRec.midX=r,this.touchRec.midY=o,this.touchRec.dy0=e-o,this.touchRec.dy1=s-o,this._pos_in_world_space(r,o)},_calc_angle:function(t){var e=this._pos_in_world_space(this.touchRec.layer0x,this.touchRec.layer0y),i=this._pos_in_world_space(this.touchRec.layer1x,this.touchRec.layer1y);return Math.atan2(i[1]-e[1],i[0]-e[0])},_pitch_calc:function(t){return YFM.Math.radian2Deg(YFM.Math.Matrix.eulerParamExtractX(t))},_pitch_detect_continue:function(t){if(t.touches.length<2)return!1;var e,i;return e=this.touchRec.layer0y-this.touchRec.start0y,i=this.touchRec.layer1y-this.touchRec.start1y,e*i>0?this.touchRec.pitchCnt++:this.touchRec.pitchCnt--,this.touchRec.pitchCnt>36},_touch_plane_height:function(t,e){if(-1!==this.region.displayFloorIndex)return this.touchFloorIndex=this.region.displayFloorIndex,this.region._getFloorVOffset(this.region.displayFloorIndex);var i,s,r,o,a,n,h=-1;for(r=-1e8,n=-1,a=-1,s=(i=this._floors_collision(t,e)).length,o=0;o<s;o++)i[o]<0&&i[o]>r&&(r=i[o],n=o),0==i[o]&&(a=o);return a>=0?h=a:n>=0&&(h=n),this.touchFloorIndex=h,this.region._getFloorVOffset(h)},_floors_collision:function(t,e){var i=this.getTouchRayPlus(t,e);return this.region._intersectionLine(i)},_pitch_detect_first:function(t){if(t.touches.length<2)return!1;var e,i,s;return i=mgr.touchRec.layer0y-this.touchRec.midY-this.touchRec.dy0,s=mgr.touchRec.layer1y-this.touchRec.midY-this.touchRec.dy1,this.touchRec.pitchCnt=0,e=!1,i*s>0&&(e=!0),e},_pos_in_world_space:function(t,e){var i,s,r,o,a,n,h,l,u,c;return s=t/this.canvas.width*2-1,r=-(e/this.canvas.height*2-1),o=YFM.Math.Vector.pos(s,r,-1),a=YFM.Math.Vector.pos(s,r,1),l=this.camera.getIPVMat(),n=YFM.Math.Matrix.mulVec(l,o),h=YFM.Math.Matrix.mulVec(l,a),n[0]/=n[3],n[1]/=n[3],n[2]/=n[3],n[3]/=n[3],h[0]/=h[3],h[1]/=h[3],h[2]/=h[3],h[3]/=h[3],c=YFM.Math.Line.linePP(n,h),u=YFM.Math.Plane.plane(0,0,this.planeRec.planeHeight,0,0,1),i=YFM.Math.Plane.intersectionLine(u,c),YFM.Math.Line.getPoint(c,i)},_pos_in_view_space:function(t,e){var i=this._pos_in_world_space(t,e);return this._world_to_view(i)},_world_to_view:function(t){return YFM.Math.Matrix.mulVec(this.camera.getViewMat(),t)},_setOverlook:function(t){this.overlook=t},_screen_to_map:function(t,e){if(this.touchFloorIndex>=0){var i=this._pos_in_world_space(t,e),s=this.region._getFloorMat(this.touchFloorIndex),r=this.region._getRegionMat(),o=YFM.Math.Matrix.mul(r,s),a=YFM.Math.Matrix.invert(o),n=YFM.Math.Matrix.mulVec(a,i);return{floor:this.touchFloorIndex,x:n[0],y:this.region.getFloorAspect(this.touchFloorIndex).h-n[1]}}return null},_updateEventLayerPos:function(t){t.touches&&t.touches.length>=1?(this.touchRec.layer0x=(t.touches[0].pageX-this.box.left)/this.uiScaleRate,this.touchRec.layer0y=(t.touches[0].pageY-this.box.top)/this.uiScaleRate,t.touches.length>=2?(this.touchRec.layer1x=(t.touches[1].pageX-this.box.left)/this.uiScaleRate,this.touchRec.layer1y=(t.touches[1].pageY-this.box.top)/this.uiScaleRate):(this.touchRec.layer1x=0,this.touchRec.layer1y=0)):(this.touchRec.layer0x=t.layerX/this.uiScaleRate,this.touchRec.layer0y=t.layerY/this.uiScaleRate)},_mapConstraint:function(t,e){var i,s,r,o,a,n,h,l,u=YFM.Math.Matrix,c=YFM.Math.Vector;i=c.pos(0,0,-1),s=c.pos(0,0,1),a=u.mul(t,this.region.matRegion),n=u.invert(a),r=u.mulVec(n,i),o=u.mulVec(n,s),r[0]/=r[3],r[1]/=r[3],r[2]/=r[3],r[3]/=r[3],o[0]/=o[3],o[1]/=o[3],o[2]/=o[3],o[3]/=o[3],h=YFM.Math.Line.linePP(r,o),a=u.mul(this.camera.getPVMat(),e),n=u.invert(a),r=u.mulVec(n,i),o=u.mulVec(n,s),r[0]/=r[3],r[1]/=r[3],r[2]/=r[3],r[3]/=r[3],o[0]/=o[3],o[1]/=o[3],o[2]/=o[3],o[3]/=o[3],l=YFM.Math.Line.linePP(r,o);var M;M=this.touchFloorIndex<0?this.region.displayFloorIndex:this.touchFloorIndex;var d=this.region.floors[M],p=d.intersectionLine(h);return d.intersectionLine(l)<p},_isMobileBrowser:function(){var t=navigator.userAgent.toLowerCase(),e="ipad"==t.match(/ipad/i),i="iphone os"==t.match(/iphone os/i),s="midp"==t.match(/midp/i),r="rv:1.2.3.4"==t.match(/rv:1.2.3.4/i),o="ucweb"==t.match(/ucweb/i),a="android"==t.match(/android/i),n="windows ce"==t.match(/windows ce/i),h="windows mobile"==t.match(/windows mobile/i);return e||i||s||r||o||a||n||h}},YFM.Map.SSRoute=function(t){this.region=t,this.time=0,this.timeThumbnail=0,this.width=8,this.stepLen=128,this.dataLoad=!1,this.rotateLeft=YFM.Math.Matrix.rotateXY(90,0,0),this.rotateRight=YFM.Math.Matrix.rotateXY(-90,0,0),this.routeHeight=30,this.displayFloor=-1,this.polylineThumbnail=null,this.polylineZ=null,this.handledPts=null,this.routeData=null,this.light=YFM.Math.Vector.vec(0,0,1),this.tailSize=this.width/2,this.tailColor=YFM.Math.Vector.pos(YFM.WebGL.Color.hexColorRed(47925),YFM.WebGL.Color.hexColorGreen(47925),YFM.WebGL.Color.hexColorBlue(47925)),this.updateNSFlag=!0,this.naviStatus={projection:null,miniOffset:0,validate:!1,projDist:0,goalDist:0,globalDist:0,serialDist:0,nextSerialDist:0,azimuth:0,sug:YFM.Map.Navigate.Suggestion.NONE,nextSug:YFM.Map.Navigate.NextSuggestion.NONE},this._initTail(),this.routeMover={enable:!1,callback:null,index:0,t:0,vt:0,velocity:1,direction:1,ppolyline:null,position:null}},YFM.Map.SSRoute.prototype={constructor:YFM.Map.SSRoute,enableRouteMover:function(t,e){this.routeMover.enable=t,t&&(this.routeMover.callback=e)},setDisplayFloor:function(t){this.displayFloor=t,this.dataLoad&&this._buildVBOFromSeglist()},getNaviStatus:function(){return this.naviStatus.validate?{validate:this.naviStatus.validate,projDist:this.naviStatus.projDist,goalDist:this.naviStatus.goalDist,globalDist:this.naviStatus.globalDist,serialDist:this.naviStatus.serialDist,nextSerialDist:this.naviStatus.nextSerialDist,azimuth:this.naviStatus.azimuth,sug:this.naviStatus.sug,nextSug:this.naviStatus.nextSug}:{validate:!1}},getRouteCenter:function(t){return t>=0?this.floorRouteList[t].box?YFM.Math.Vector.vecClone(this.floorRouteList[t].box.center):null:this.obb?YFM.Math.Vector.vecClone(this.obb.center):null},getRouteRAxis:function(t){return t>=0?this.floorRouteList[t].box?YFM.Math.Vector.vecClone(this.floorRouteList[t].box.r):null:this.obb?YFM.Math.Vector.vecClone(this.obb.r):null},getRouteOBBLength:function(t){if(t>=0){if(this.floorRouteList[t].box){var e=this.floorRouteList[t].box.hr,i=this.floorRouteList[t].box.hs;return 2*Math.sqrt(e*e+i*i)}return 0}if(this.obb){var e=this.obb.hr,i=this.obb.hs,s=this.obb.ht;return 2*Math.sqrt(e*e+i*i+s*s)}return 0},setRoute:function(t){this.routeData=t,this.cleanRoute();var e,i,s,r,o,a,n,h,l,u,c=[];for(a=this.region.getFloorCount(),this.floorRouteList=[],this.globalSegList=[],l=0;l<a;l++)this.floorRouteList.push(new YFM.Map.SSRoute.prototype.FloorRoute(l,this.region,this));for(n=t.length,l=0;l<n;l++)r=t[l],(s=this.region.floorPos2RegionPos(r.floor,r.x,r.y))[2]+=this.routeHeight,c.push(s);for(this.obb=new YFM.Math.OBB(c),u=t[0].floor,l=0;l<n-1;l++)r=t[l],(o=t[l+1]).floor===u?this.floorRouteList[u].addSeg(c[l],c[l+1]):u=o.floor;for(l=0;l<a;++l)this.floorRouteList[l].makeBox();h=0;var M;for(l=this.globalSegList.length-1;l>=0;--l)(M=this.globalSegList[l]).updateFolowLen(h),h+=M.len;this._buildVBOFromSeglist(),this.region.regionThumbnail.isEnable()&&this._buildRouteThumbnail(this.region.regionThumbnail.getPVRMat()),-1!=(e=this.region.getFloorLoc()).floor&&(i=this.region.getRegionLoc(),this.updateNaviStatus(e,i)),this.dataLoad=!0},cleanRoute:function(){this.floorRouteList=null,this.globalSegList=null,this._clean(),this.dataLoad=!1},addGlobalSeg:function(t,e){e&&this.globalSegList.pop(),this.globalSegList.push(t)},setUpdateNSFlag:function(t){var e=!this.updateNSFlag&&t,i=this.updateNSFlag&&!t;if(e){this.updateNSFlag=!0;var s=this.region.getFloorLoc();if(-1!==s.floor){var r=this.region.getRegionLoc();this.updateNaviStatus(s,r)}}else i&&(this.updateNSFlag=!1,this.naviStatus.validate=!1)},updateNaviStatus:function(t,e){this.updateNSFlag&&(this.floorRouteList?-1===t.floor?this.naviStatus.validate=!1:this.floorRouteList[t.floor].makeNaviStatus(this.naviStatus,e):this.naviStatus.validate=!1)},renderThumbnail:function(){if(this.polylineThumbnail){var t=this.region.gl,e=this.region.ssrShader,i=this.region.texturePool;e.useProgram(),e.setTime(this.timeThumbnail);var s=i.getTexture("route_tex");null!=s&&(e.bindTexture(s.tex),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),e.setTranFlag(1),e.drawTriangleStrip(this.polylineThumbnail,0),t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),e.setTranFlag(0),e.drawTriangleStrip(this.polylineThumbnail,0),t.disable(t.DEPTH_TEST),t.disable(t.BLEND),this.timeThumbnail-=.01)}},render:function(t){if(this.polylineZ){this._update(t);var e=this.region.gl,i=this.region.ssrShader,s=this.region.texturePool;i.useProgram(),i.setTime(this.time);var r=0,o=s.getTexture("route_tex"),a=!0;if(null!=o&&(i.bindTexture(o.tex),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),-1!==this.displayFloor&&this.displayFloor!==this.region.getFloorLoc().floor&&(a=!1),this.naviStatus.validate&&this.updateNSFlag&&a&&(r=6*this.naviStatus.miniOffset),i.setTranFlag(1),i.drawTriangleStrip(this.polylineZ,r),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),i.setTranFlag(0),i.drawTriangleStrip(this.polylineZ,r),this.naviStatus.validate&&a&&this._renderTail(t),e.disable(e.DEPTH_TEST),e.disable(e.BLEND),this.time-=.01,this.routeMover.enable&&this.routeMover.callback)){var n=this.region.regionPos2Screen(this.routeMover.position);this.routeMover.callback(n)}}},_initTail:function(){this.tailMesh=new YFM.Mesh.IcosahedronMesh(this.region.gl,4)},_renderTail:function(t){var e=this.region.regionPhongShader;e.useProgram(),e.setProjectionMatrix(t.projMat),e.setViewMatrix(t.viewMat),e.setRegionMatrix(t.regionMat),e.setColor(this.tailColor);var i=YFM.Math.Matrix.transpose(t.vrMat),s=YFM.Math.Matrix.invert(i);e.setLightPos(this.light),e.setNormalMatrix(s);var r,o,a,n,h,l,u;for(a=this.naviStatus.projection,n=YFM.Math.Vector.normalize(YFM.Math.Vector.sub(this.region.getRegionLoc(),a)),h=this.naviStatus.projDist,l=4*this.tailSize,u=0,r=YFM.Math.Matrix.scale(this.tailSize,0,0,0);u<h;)o=YFM.Math.Vector.add(a,YFM.Math.Vector.scale(n,u)),e.setModelMatrix(YFM.Math.Matrix.postTranslate(r,o[0],o[1],o[2]+this.tailSize)),e.drawTriangles(this.tailMesh.getMeshVBO(),this.tailMesh.getMeshBufSize(),0),u+=l},_buildRouteThumbnail:function(t){var e,i,s,r=[];for(s=this.globalSegList.length,currentFloor=this.globalSegList[0].floor,n=0;n<s;n++)e=this.globalSegList[n],n<s-1?(i=this.globalSegList[n+1]).floor===currentFloor?r.push(e.start):(currentFloor=i.floor,r.push(e.start),r.push(e.end)):(r.push(e.start),r.push(e.end));this.polylineThumbnail&&(this.polylineThumbnail.recycle(),this.polylineThumbnail=null);var o,a,n,h,l,u,c,M=YFM.Math.Matrix,d=YFM.Math.Vector,p=[],g=[],f=[],m=[],F=[],v=[],x=d.pos(0),Y=d.pos(0),T=(d.pos(0),d.pos(0)),b=d.vec(0),_=d.vec(0),y=d.vec(0);for(o=0,lineDist=0,n=0,h=r.length;n<h-1;n++)this._pos2ScreenTo(x,r[n],t,this.region.hw,this.region.hh),this._pos2ScreenTo(T,r[n+1],t,this.region.hw,this.region.hh),d.midTo(Y,x,T),d.subTo(b,T,x),a=d.norm3(b),d.normalizeTo(b),M.mulVecTo(this.rotateLeft,b,_),d.scaleTo(_,this.width),M.mulVecTo(this.rotateRight,b,y),d.scaleTo(y,this.width),l=o/this.stepLen,u=(o+a/2)/this.stepLen,c=(o+a)/this.stepLen,o+=a,p.push(d.add(x,_)),g.push(d.pos(0,l)),f.push(d.add(x,y)),m.push(d.pos(1,l)),p.push(d.add(Y,_)),g.push(d.pos(0,u)),f.push(d.add(Y,y)),m.push(d.pos(1,u)),p.push(d.add(T,_)),g.push(d.pos(0,c)),f.push(d.add(T,y)),m.push(d.pos(1,c));for(h=p.length,n=0;n<h;n++)F.push(f[n]),v.push(m[n]),F.push(p[n]),v.push(g[n]);this.polylineThumbnail=new YFM.WebGL.VAttribs(this.region.gl),this.polylineThumbnail.addAttribute("position",F,3,!1),this.polylineThumbnail.addAttribute("uv",v,2,!1)},_buildVBOFromSeglist:function(){var t,e,s,r=[];if(-1===this.displayFloor){for(s=this.globalSegList.length,currentFloor=this.globalSegList[0].floor,i=0;i<s;i++)t=this.globalSegList[i],i<s-1?(e=this.globalSegList[i+1]).floor===currentFloor?r.push(t.start):(currentFloor=e.floor,r.push(t.start),r.push(t.end)):(r.push(t.start),r.push(t.end));this._build(r)}else{var o=this.floorRouteList[this.displayFloor].segList;if(o.length<=0)this._clean();else{for(s=o.length,i=0;i<s;i++)t=o[i],i<s-1?r.push(t.start):(r.push(t.start),r.push(t.end));this._build(r)}}},_build:function(t){this.handledPts=t,this.polylineZ&&(this.polylineZ.recycle(),this.polylineZ=null);var e=YFM.Math.Matrix,i=YFM.Math.Vector;this.vArrayL=[],this.tArrayL=[],this.vArrayR=[],this.tArrayR=[],this.vArrayZ=[],this.tArrayZ=[];var s,r,o,a,n,h,l,u=i.pos(0),c=i.pos(0),M=(i.pos(0),i.pos(0)),d=i.vec(0),p=i.vec(0),g=i.vec(0);for(s=0,lineDist=0,o=0,a=this.handledPts.length;o<a-1;o++)i.midTo(c,u,M),i.subTo(d,M,u),r=i.norm3(d),i.normalizeTo(d),e.mulVecTo(this.rotateLeft,d,p),i.scaleTo(p,this.width),e.mulVecTo(this.rotateRight,d,g),i.scaleTo(g,this.width),n=s/this.stepLen,h=(s+r/2)/this.stepLen,l=(s+r)/this.stepLen,s+=r,this.vArrayL.push(i.add(u,p)),this.tArrayL.push(i.pos(0,n)),this.vArrayR.push(i.add(u,g)),this.tArrayR.push(i.pos(1,n)),this.vArrayL.push(i.add(c,p)),this.tArrayL.push(i.pos(0,h)),this.vArrayR.push(i.add(c,g)),this.tArrayR.push(i.pos(1,h)),this.vArrayL.push(i.add(M,p)),this.tArrayL.push(i.pos(0,l)),this.vArrayR.push(i.add(M,g)),this.tArrayR.push(i.pos(1,l));for(a=this.vArrayL.length,o=0;o<a;o++)this.vArrayZ.push(this.vArrayR[o]),this.tArrayZ.push(this.tArrayR[o]),this.vArrayZ.push(this.vArrayL[o]),this.tArrayZ.push(this.tArrayL[o]);this.polylineZ=new YFM.WebGL.VAttribs(this.region.gl),this.polylineZ.addAttribute("position",this.vArrayZ,3,!1),this.polylineZ.addAttribute("uv",this.tArrayZ,2,!1),this.routeMover.enable&&(this.routeMover.ppolyline=new YFM.Math.PPolyline(this.handledPts),this.routeMover.index=0,this.routeMover.t=0,this.routeMover.direction=1,this.routeMover.vt=this.routeMover.velocity/this.routeMover.ppolyline.getSumLength())},_projection:function(t,e,i,s){var r=YFM.Math.Vector.sub(t,e),o=YFM.Math.Vector.sub(i,e),a=YFM.Math.Vector.dot3(o,o),n=YFM.Math.Vector.dot3(r,o)/a;n<=0?n=0:n>=1&&(n=1),s.pos=YFM.Math.Vector.add(e,YFM.Math.Vector.scale(o,n)),s.t=n},_update:function(t){var e,i,s,r,o,a,n,h,l,u,c=YFM.Math.Matrix,M=YFM.Math.Vector,d=M.pos(0),p=M.pos(0),g=M.pos(0),f=M.vec(0),m=M.vec(0),F=M.vec(0),v=t.pvrMat,x=this.region.getRegionLoc(),Y={pos:null,t:0};l=Number.MAX_VALUE,e=0;var T=!0;if(-1!==this.displayFloor&&this.displayFloor!==this.region.getFloorLoc().floor&&(T=!1),this.naviStatus.validate&&T)for(s=0,r=this.handledPts.length;s<r-1;s++)this._projection(x,this.handledPts[s],this.handledPts[s+1],Y),(h=YFM.Math.Vector.distanceSQ(x,Y.pos))<=l&&(l=h,u=Y.pos,this.naviStatus.miniOffset=s);else this.naviStatus.miniOffset=0;for(s=this.naviStatus.miniOffset,r=this.handledPts.length;s<r-1;s++)this.naviStatus.validate&&s==this.naviStatus.miniOffset&&T?this._pos2ScreenTo(d,u,v,this.region.hw,this.region.hh):this._pos2ScreenTo(d,this.handledPts[s],v,this.region.hw,this.region.hh),this._pos2ScreenTo(g,this.handledPts[s+1],v,this.region.hw,this.region.hh),M.midTo(p,d,g),M.subTo(f,g,d),i=M.norm3(f),M.normalizeTo(f),c.mulVecTo(this.rotateLeft,f,m),M.scaleTo(m,this.width),c.mulVecTo(this.rotateRight,f,F),M.scaleTo(F,this.width),o=e/this.stepLen,a=(e+i/2)/this.stepLen,n=(e+i)/this.stepLen,e+=i,M.addTo(this.vArrayL[3*s+0],d,m),this.tArrayL[3*s+0][1]=o,M.addTo(this.vArrayR[3*s+0],d,F),this.tArrayR[3*s+0][1]=o,M.addTo(this.vArrayL[3*s+1],p,m),this.tArrayL[3*s+1][1]=a,M.addTo(this.vArrayR[3*s+1],p,F),this.tArrayR[3*s+1][1]=a,M.addTo(this.vArrayL[3*s+2],g,m),this.tArrayL[3*s+2][1]=n,M.addTo(this.vArrayR[3*s+2],g,F),this.tArrayR[3*s+2][1]=n;this.polylineZ.updateAttribute("position",this.vArrayZ),this.polylineZ.updateAttribute("uv",this.tArrayZ),this.routeMover.enable&&this._updateRouteMover()},_updateRouteMover:function(){this.routeMover.t+=this.routeMover.vt,this.routeMover.t>1&&(this.routeMover.t=0);var t=this.routeMover.ppolyline.getPoint(this.routeMover.index,this.routeMover.t);this.routeMover.position=t.pos,this.routeMover.index=t.seg.index},_clean:function(){this.polylineZ&&(this.polylineZ.recycle(),this.polylineZ=null),this.handledPts=null},_pos2Screen:function(t,e,i,s){var r=YFM.Math.Matrix.mulVec(e,t);return r[0]/=r[3],r[1]/=r[3],r[2]/=r[3],r[3]/=r[3],r[0]=r[0]*i,r[1]=r[1]*s,r},_pos2ScreenTo:function(t,e,i,s,r){YFM.Math.Matrix.mulVecTo(i,e,t),t[3]>0?(t[0]/=t[3],t[1]/=t[3],t[2]/=t[3],t[3]/=t[3]):t[3]<0&&(t[0]/=-t[3],t[1]/=-t[3],t[2]/=-t[3],t[3]/=-t[3]),t[0]=t[0]*s,t[1]=t[1]*r},_radiusPointPlus:function(t,e,i){var s=t.length;if(i<=0||i>=s-1)e.push(t[i]);else{var r,o,a,n,h,l,u,c,M,d,p,g,f,m,F,v=YFM.Math.Matrix,x=YFM.Math.Vector;e[e.length-1];if(a=t[i-1],r=t[i],o=t[i+1],Math.abs(r[2]-a[2])>1||Math.abs(r[2]-o[2])>1)e.push(r);else{n=x.normalize(x.sub(a,r)),h=x.normalize(x.sub(o,r)),l=x.normalize(x.add(n,h)),u=x.scale(l,-1*this.width),c=x.sub(r,a),M=x.sub(o,r),m=x.cross(c,M),p=1.5708463-(d=Math.acos(x.dot3(l,h))),g=this.width/Math.sin(d),f=this.width/Math.tan(d),F=x.add(r,x.scale(l,g));var Y=[],T=v.rotateXY(-p,F[0],F[1],!0),b=p/3,_=v.rotateXY(b,F[0],F[1],!0);u=v.mulVec(T,u),Y.push(x.add(r,x.scale(n,f))),u=v.mulVec(_,u),Y.push(x.add(F,u)),u=v.mulVec(_,u),Y.push(x.add(F,u)),u=v.mulVec(_,u),Y.push(x.add(F,u)),u=v.mulVec(_,u),Y.push(x.add(F,u)),u=v.mulVec(_,u),Y.push(x.add(F,u)),u=v.mulVec(_,u),Y.push(x.add(r,x.scale(h,f))),m[2]>0?(e.push(Y[0]),e.push(Y[1]),e.push(Y[2]),e.push(Y[3]),e.push(Y[4]),e.push(Y[5]),e.push(Y[6])):(e.push(Y[0]),e.push(Y[5]),e.push(Y[4]),e.push(Y[3]),e.push(Y[2]),e.push(Y[1]),e.push(Y[6]))}}}},YFM.Map.SSRoute.prototype.RouteSeg=function(t,e,i){this.start=t,this.end=e,this.floor=i,this.segVec=YFM.Math.Vector.sub(this.end,this.start),this.lenSQ=YFM.Math.Vector.dot3(this.segVec,this.segVec),this.len=Math.sqrt(this.lenSQ),this.azimuth=this._makeAzimuth(),this.followLen=0},YFM.Map.SSRoute.prototype.RouteSeg.prototype={constructor:YFM.Map.SSRoute.prototype.RouteSeg,updateFolowLen:function(t){this.followLen=t},updateEnd:function(t){this.end=t,this.segVec=YFM.Math.Vector.sub(this.end,this.start),this.lenSQ=YFM.Math.Vector.dot3(this.segVec,this.segVec),this.len=Math.sqrt(this.lenSQ),this.azimuth=this._makeAzimuth()},getPoint:function(t){return YFM.Math.Vector.add(this.start,YFM.Math.Vector.scale(this.segVec,t))},projection:function(t){var e=YFM.Math.Vector.sub(t,this.start),i=YFM.Math.Vector.dot3(e,this.segVec)/this.lenSQ;return i<=0?0:i>=1?1:i},_makeAzimuth:function(){var t=YFM.Math.Vector.vec(0,1,0),e=YFM.Math.Vector.normalize(this.segVec),i=YFM.Math.Vector.dot3(e,t),s=Math.acos(i);return e[0]>0&&(s=2*Math.PI-s),s}},YFM.Map.SSRoute.prototype.FloorRoute=function(t,e,i){this.floor=t,this.region=e,this.route=i,this.segList=[],this.posList=[],this.lastPos=null,this.box=null,this.lastSegVec=null},YFM.Map.SSRoute.prototype.FloorRoute.prototype={constructor:YFM.Map.SSRoute.prototype.FloorRoute,makeBox:function(){this.lastPos&&(this.posList.push(this.lastPos),this.box=new YFM.Math.OBB(this.posList))},addSeg:function(t,e){this.posList.push(t),this.lastPos=e;var i,s,r=new YFM.Map.SSRoute.prototype.RouteSeg(t,e,this.floor),o=YFM.Math.Vector.normalize(r.segVec);null!=this.lastSegVec?(i=YFM.Math.Vector.dot3(o,this.lastSegVec),Math.abs(i-1)<1e-5?((s=this.segList.pop()).updateEnd(e),this.segList.push(s),this.route.addGlobalSeg(s,!0)):(this.segList.push(r),this.route.addGlobalSeg(r,!1))):(this.segList.push(r),this.route.addGlobalSeg(r,!1)),this.lastSegVec=o},makeNaviStatus:function(t,e){var i,s,r,o,a,n,h,l,u=this.segList.length;if(u<=0)t.validate=!1;else{t.validate=!0,a=Number.MAX_VALUE;var c=u;if(c<=0)return void(t.validate=!1);for(n=0;n<c;n++)i=this.segList[n].projection(e),s=this.segList[n].getPoint(i),(o=YFM.Math.Vector.distanceSQ(e,s))<=a&&(a=o,r=s,h=n,i);for(t.projection=r,YFM.Math.Vector.distance(t.projection,this.segList[h].start),t.projDist=YFM.Math.Vector.distance(t.projection,e),t.serialDist=YFM.Math.Vector.distance(t.projection,this.segList[h].end),h+1<u?(t.nextSerialDist=this.segList[h+1].len,(l=this.segList[h+1].azimuth-this.segList[h].azimuth)<0&&(l+=2*Math.PI),l<=.175||l>=6.11?t.nextSug=YFM.Map.Navigate.NextSuggestion.FRONT:l<Math.PI?t.nextSug=YFM.Map.Navigate.NextSuggestion.LEFT:t.nextSug=YFM.Map.Navigate.NextSuggestion.RIGHT):(t.nextSerialDist=0,t.nextSug=YFM.Map.Navigate.NextSuggestion.ARRIVE),t.goalDist=t.serialDist,n=h+1;n<u;n++)t.goalDist+=this.segList[n].len;t.globalDist=t.goalDist+this.segList[u-1].followLen,t.azimuth=this.segList[h].azimuth,t.sug=this.makeCurrentSug(this.region.azimuth,t.azimuth)}},makeCurrentSug:function(t,e){var i;return(i=e-t)<0&&(i=360+i),i>337.5&&i<=0||i>0&&i<=22.5?YFM.Map.Navigate.Suggestion.FRONT:i>22.5&&i<=67.5?YFM.Map.Navigate.Suggestion.FRONT:i>67.5&&i<=112.5?YFM.Map.Navigate.Suggestion.RIGHT:i>112.5&&i<=157.5?YFM.Map.Navigate.Suggestion.BACKWARD:i>157.5&&i<=202.5?YFM.Map.Navigate.Suggestion.BACKWARD:i>202.5&&i<=247.5?YFM.Map.Navigate.Suggestion.BACKWARD:i>247.5&&i<=292.5?YFM.Map.Navigate.Suggestion.LEFT:YFM.Map.Navigate.Suggestion.FRONT},getLength:function(){return this.segList.length},getSeg:function(t){return this.segList[t]}},YFM.Math.Euler=function(t,e,i,s){this.x=t||0,this.y=e||0,this.z=i||0,this.order=s||YFM.Math.Euler.DefaultOrder},YFM.Math.Euler.prototype={RotationOrders:["XYZ","YZX","ZXY","XZY","YXZ","ZYX"],DefaultOrder:"ZXY",constructor:YFM.Math.Euler,setFromMatrix:function(t,e,i){var s=YFM.Math.clamp,r=t[0],o=t[4],a=t[8],n=t[1],h=t[5],l=t[9],u=t[2],c=t[6],M=t[10];return"XYZ"===(e=e||this.order)?(this.y=Math.asin(s(a,-1,1)),Math.abs(a)<.99999?(this.x=Math.atan2(-l,M),this.z=Math.atan2(-o,r)):(this.x=Math.atan2(c,h),this.z=0)):"YXZ"===e?(this.x=Math.asin(-s(l,-1,1)),Math.abs(l)<.99999?(this.y=Math.atan2(a,M),this.z=Math.atan2(n,h)):(this.y=Math.atan2(-u,r),this.z=0)):"ZXY"===e?(this.x=Math.asin(s(c,-1,1)),Math.abs(c)<.99999?(this.y=Math.atan2(-u,M),this.z=Math.atan2(-o,h)):(this.y=0,this.z=Math.atan2(n,r))):"ZYX"===e?(this.y=Math.asin(-s(u,-1,1)),Math.abs(u)<.99999?(this.x=Math.atan2(c,M),this.z=Math.atan2(n,r)):(this.x=0,this.z=Math.atan2(-o,h))):"YZX"===e?(this.z=Math.asin(s(n,-1,1)),Math.abs(n)<.99999?(this.x=Math.atan2(-l,h),this.y=Math.atan2(-u,r)):(this.x=0,this.y=Math.atan2(a,M))):"XZY"===e?(this.z=Math.asin(-s(o,-1,1)),Math.abs(o)<.99999?(this.x=Math.atan2(c,h),this.y=Math.atan2(a,r)):(this.x=Math.atan2(-l,M),this.y=0)):console.warn("setFromRotationMatrix() given unsupported order: "+e),this.order=e,this}},YFM.Math.LDS=function(){var t=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,57];return{halton:function(e,i){return function(t,e){var i,s,r;for(i=s=1/t,r=0;e>0;)r+=i*(e%t),i*=s,e=Math.floor(e/t);return r}(function(e){if(e<0||e>t.length)throw new Error("nthPrimeNumber index out of range");return t[e]}(e),i)}}}(),YFM.Math.Line=function(){var t=function(t,e){var i=[];return i.push(t[0]),i.push(t[1]),i.push(t[2]),i.push(1),i.push(e[0]),i.push(e[1]),i.push(e[2]),i.push(0),i},e=function(t,e){return YFM.Math.Vector.pos(t[0]+t[4]*e,t[1]+t[5]*e,t[2]+t[6]*e)},i=function(t,e,i,s){var r,o,a,n,h,l;return o=YFM.Math.Vector.pos(e,i,s),a=YFM.Math.Vector.sub(o,t),r=YFM.Math.Vector.vec(t[4],t[5],t[6]),h=YFM.Math.Vector.dot3(a,r),h*=h,n=YFM.Math.Vector.norm3SQ(a),l=YFM.Math.Vector.norm3SQ(r),n-h/l},s=function(t,e,s,r){return Math.sqrt(i(t,e,s,r))},r=function(t,e){var i,s,r,o,a,n,h,l,u,c,M=[],d=[],p=[];return u=YFM.Math.Vector.vec(t[4],t[5],t[6]),c=YFM.Math.Vector.vec(e[4],e[5],e[6]),r=YFM.Math.Vector.dot3(u,c),n=YFM.Math.Vector.norm3SQ(u),h=YFM.Math.Vector.norm3SQ(c),s=r*r-n*h,0==(i=YFM.Math.floatEquals(s,0))&&(l=YFM.Math.Vector.sub(e,t),o=YFM.Math.Vector.dot3(l,u),a=YFM.Math.Vector.dot3(l,c),d.push(o),d.push(a),M.push(-YFM.Math.Vector.norm3SQ(c)),M.push(-r),M.push(r),M.push(YFM.Math.Vector.norm3SQ(u)),p.push(d[0]*M[0]+d[1]*M[2]),p.push(d[0]*M[1]+d[1]*M[3]),p[0]/=s,p[1]/=s),{parallel:i,t:p}};return{line:function(t,e,i,s,r,o){var a=[];return a.push(t),a.push(e),a.push(i),a.push(1),a.push(s),a.push(r),a.push(o),a.push(0),a},lineSV:t,linePP:function(t,e){var i=[];return i.push(t[0]),i.push(t[1]),i.push(t[2]),i.push(1),i.push(e[0]-t[0]),i.push(e[1]-t[1]),i.push(e[2]-t[2]),i.push(0),i},getPoint:e,projection:function(t,e){var i=YFM.Math.Vector.pos(t[0],t[1],t[2]),s=YFM.Math.Vector.vec(t[4],t[5],t[6]),r=YFM.Math.Vector.sub(e,i),o=YFM.Math.Vector.dot3(r,s)/YFM.Math.Vector.dot3(s,s);return o<=0?i:o>=1?YFM.Math.Vector.add(i,s):YFM.Math.Vector.pos(t[0]+t[4]*o,t[1]+t[5]*o,t[2]+t[6]*o)},distancePointSQ:i,distancePoint:s,distanceLinesRaw:r,distanceLines:function(t,i){var o,a,n,h;return(a=r(t,i)).parallel?o=s(t,i[0],i[1],i[2]):(n=e(t,a.t[0]),h=e(i,a.t[1]),o=YFM.Math.Vector.distance(n,h)),{parallel:void 0,distance:o}},transform:function(e,i){var s=YFM.Math.Vector.pos(e[0],e[1],e[2]),r=YFM.Math.Vector.vec(e[4],e[5],e[6]);return t(YFM.Math.Matrix.mul(i,s),YFM.Math.Matrix.mul(i,r))}}}(),YFM.Math.Matrix=function(){var t=function(){var t=[];return t.push(1),t.push(0),t.push(0),t.push(0),t.push(0),t.push(1),t.push(0),t.push(0),t.push(0),t.push(0),t.push(1),t.push(0),t.push(0),t.push(0),t.push(0),t.push(1),t},e=function(e,i,s,r,o){var a,n,h,l=t();if(a=o?e:YFM.Math.deg2Radian(e),n=Math.cos(a),h=Math.sin(a),l[3]=0,l[7]=0,l[11]=0,l[12]=0,l[13]=0,l[14]=0,l[15]=1,1==i&&0==s&&0==r)l[5]=n,l[10]=n,l[6]=h,l[9]=-h,l[1]=0,l[2]=0,l[4]=0,l[8]=0,l[0]=1;else if(0==i&&1==s&&0==r)l[0]=n,l[10]=n,l[8]=h,l[2]=-h,l[1]=0,l[4]=0,l[6]=0,l[9]=0,l[5]=1;else if(0==i&&0==s&&1==r)l[0]=n,l[5]=n,l[1]=h,l[4]=-h,l[2]=0,l[6]=0,l[8]=0,l[9]=0,l[10]=1;else{var u=Math.sqrt(i*i+s*s+r*r);if(1!=u){var c=1/u;i*=c,s*=c,r*=c}var M=1-n,d=i*s,p=s*r,g=r*i,f=i*h,m=s*h,F=r*h;l[0]=i*i*M+n,l[4]=d*M-F,l[8]=g*M+m,l[1]=d*M+F,l[5]=s*s*M+n,l[9]=p*M-f,l[2]=g*M-m,l[6]=p*M+f,l[10]=r*r*M+n}return l},i=function(t,e,i,s){var r,o,a,n=[];return r=s?t:YFM.Math.deg2Radian(t),o=Math.cos(r),a=Math.sin(r),n.push(o),n.push(a),n.push(0),n.push(0),n.push(-a),n.push(o),n.push(0),n.push(0),n.push(0),n.push(0),n.push(1),n.push(0),n.push(e*(1-o)+i*a),n.push(i*(1-o)-e*a),n.push(0),n.push(1),n},s=function(t,e,i){var s=[];return s.push(1),s.push(0),s.push(0),s.push(0),s.push(0),s.push(1),s.push(0),s.push(0),s.push(0),s.push(0),s.push(1),s.push(0),s.push(t),s.push(e),s.push(i),s.push(1),s},r=function(t,e,i,s){var r=[];return r.push(t),r.push(0),r.push(0),r.push(0),r.push(0),r.push(t),r.push(0),r.push(0),r.push(0),r.push(0),r.push(t),r.push(0),r.push(e*(1-t)),r.push(i*(1-t)),r.push(s*(1-t)),r.push(1),r},o=function(t,e){var i,s,r,o,a,n,h,l=[];for(n=t.slice(0),h=e.slice(0),a=0;a<4;a++)i=h[4*a+0],s=h[4*a+1],r=h[4*a+2],o=h[4*a+3],l.push(i*n[0]+s*n[4]+r*n[8]+o*n[12]),l.push(i*n[1]+s*n[5]+r*n[9]+o*n[13]),l.push(i*n[2]+s*n[6]+r*n[10]+o*n[14]),l.push(i*n[3]+s*n[7]+r*n[11]+o*n[15]);return l};return{mat:t,matClone:function(t){return t.slice(0)},rotate3d:e,rotateXY:i,translate:s,rotateAxis:function(t,e,i){var s,r,o,a,n,h,l,u=[];return s=i?t:YFM.Math.deg2Radian(t),r=Math.cos(s),o=Math.sin(s),a=1-r,u.push(NaN*a+r),u.push(NaN*a+l*o),u.push(NaN*a-h*o),u.push(0),u.push(NaN*a-l*o),u.push(NaN*a+r),u.push(NaN*a+n*o),u.push(0),u.push(NaN*a+h*o),u.push(NaN*a-n*o),u.push(NaN*a+r),u.push(0),u.push(0),u.push(0),u.push(0),u.push(1),u},scale:r,scaleXYZ:function(t,e,i,s){var r=[];return r.push(t[0]),r.push(0),r.push(0),r.push(0),r.push(0),r.push(t[1]),r.push(0),r.push(0),r.push(0),r.push(0),r.push(t[2]),r.push(0),r.push(e*(1-t[0])),r.push(i*(1-t[1])),r.push(s*(1-t[2])),r.push(1),r},mul:o,mulVec:function(t,e){var i,s,r,o,a=[];return i=e[0],s=e[1],r=e[2],o=e[3],a.push(i*t[0]+s*t[4]+r*t[8]+o*t[12]),a.push(i*t[1]+s*t[5]+r*t[9]+o*t[13]),a.push(i*t[2]+s*t[6]+r*t[10]+o*t[14]),a.push(i*t[3]+s*t[7]+r*t[11]+o*t[15]),a},mulVecTo:function(t,e,i){i[0]=e[0]*t[0]+e[1]*t[4]+e[2]*t[8]+e[3]*t[12],i[1]=e[0]*t[1]+e[1]*t[5]+e[2]*t[9]+e[3]*t[13],i[2]=e[0]*t[2]+e[1]*t[6]+e[2]*t[10]+e[3]*t[14],i[3]=e[0]*t[3]+e[1]*t[7]+e[2]*t[11]+e[3]*t[15]},postTranslate:function(t,e,i,r){var a=s(e,i,r);return o(a,t)},postRotateXY:function(t,e,s,r,a){var n=i(e,s,r,a);return o(n,t)},postRotate3d:function(t,i,s,r,a,n){var h=e(i,s,r,a,n);return o(h,t)},postScale:function(t,e,i,s,a){var n=r(e,i,s,a);return o(n,t)},preTranslate:function(t,e,i,r){var a=s(e,i,r);return o(t,a)},preRotateXY:function(t,e,s,r,a){var n=i(e,s,r,a);return o(t,n)},preRotate3d:function(t,i,s,r,a,n){var h=e(i,s,r,a,n);return o(t,h)},preScale:function(t,e,i,s,a){var n=r(e,i,s,a);return o(t,n)},transpose:function(t){var e=[];return e.push(t[0]),e.push(t[4]),e.push(t[8]),e.push(t[12]),e.push(t[1]),e.push(t[5]),e.push(t[9]),e.push(t[13]),e.push(t[2]),e.push(t[6]),e.push(t[10]),e.push(t[14]),e.push(t[3]),e.push(t[7]),e.push(t[11]),e.push(t[15]),e},invert:function(t){var e=t[0],i=t[1],s=t[2],r=t[3],o=t[4],a=t[5],n=t[6],h=t[7],l=t[8],u=t[9],c=t[10],M=t[11],d=t[12],p=t[13],g=t[14],f=t[15],m=e*a-i*o,F=e*n-s*o,v=e*h-r*o,x=i*n-s*a,Y=i*h-r*a,T=s*h-r*n,b=l*p-u*d,_=l*g-c*d,y=l*f-M*d,R=u*g-c*p,A=u*f-M*p,S=c*f-M*g,L=m*S-F*A+v*R+x*y-Y*_+T*b;if(0!=L){var P=[];return P.push((a*S-n*A+h*R)/L),P.push((s*A-i*S-r*R)/L),P.push((p*T-g*Y+f*x)/L),P.push((c*Y-u*T-M*x)/L),P.push((n*y-o*S-h*_)/L),P.push((e*S-s*y+r*_)/L),P.push((g*v-d*T-f*F)/L),P.push((l*T-c*v+M*F)/L),P.push((o*A-a*y+h*b)/L),P.push((i*y-e*A-r*b)/L),P.push((d*Y-p*v+f*m)/L),P.push((u*v-l*Y-M*m)/L),P.push((a*_-o*R-n*b)/L),P.push((e*R-i*_+s*b)/L),P.push((p*F-d*x-g*m)/L),P.push((l*x-u*F+c*m)/L),P}return null},orthographic:function(e,i,s,r,o,a){var n=t(),h=1/(i-e),l=1/(r-s),u=1/(a-o),c=2*h,M=2*l,d=-2*u,p=-(i+e)*h,g=-(r+s)*l,f=-(a+o)*u;return n[0]=c,n[5]=M,n[10]=d,n[12]=p,n[13]=g,n[14]=f,n[15]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[11]=0,n},perspective:function(t,e,i,s){var r=[],o=1/Math.tan(t*(Math.PI/360)),a=1/(i-s);return r.push(o/e),r.push(0),r.push(0),r.push(0),r.push(0),r.push(o),r.push(0),r.push(0),r.push(0),r.push(0),r.push((s+i)*a),r.push(-1),r.push(0),r.push(0),r.push(2*s*i*a),r.push(0),r},setTranslateZ:function(t,e){t[14]=e},covariance3x3:function(t){var e,i,s,r,o,a,n,h,l,u,c,M,d,p,g=[];for(h=t.length,r=0,o=0,a=0,n=0;n<h;n++)r+=t[n][0],o+=t[n][1],a+=t[n][2];for(r/=h,o/=h,a/=h,l=0,u=0,c=0,M=0,d=0,p=0,n=0;n<h;n++)l+=((e=t[n][0])-r)*(e-r),u+=((i=t[n][1])-o)*(i-o),c+=((s=t[n][2])-a)*(s-a),M+=(e-r)*(i-o),d+=(e-r)*(s-a),p+=(i-o)*(s-a);return l/=h,u/=h,c/=h,M/=h,d/=h,p/=h,g.push(l),g.push(M),g.push(d),g.push(M),g.push(u),g.push(p),g.push(d),g.push(p),g.push(c),g},eig3x3:function(t){var e,i,s,r=[],o=[];if(t[3]!=t[1]||t[6]!=t[2]||t[7]!=t[5])throw new Error("matrix is not symmetric");return(e=[]).push(new Array(t[0],t[3],t[6])),e.push(new Array(t[1],t[4],t[7])),e.push(new Array(t[2],t[5],t[8])),i=new Array(0,0,0),s=new Array(0,0,0),function(t,e,i,s){var r,o,a;for(o=0;o<t;o++)e[o]=s[t-1][o];for(r=t-1;r>0;r--){var n=0,h=0;for(a=0;a<r;a++)n+=Math.abs(e[a]);if(0==n)for(i[r]=e[r-1],o=0;o<r;o++)e[o]=s[r-1][o],s[r][o]=0,s[o][r]=0;else{for(a=0;a<r;a++)e[a]/=n,h+=e[a]*e[a];var l=e[r-1],u=Math.sqrt(h);for(l>0&&(u=-u),i[r]=n*u,h-=l*u,e[r-1]=l-u,o=0;o<r;o++)i[o]=0;for(o=0;o<r;o++){for(l=e[o],s[o][r]=l,u=i[o]+s[o][o]*l,a=o+1;a<=r-1;a++)u+=s[a][o]*e[a],i[a]+=s[a][o]*l;i[o]=u}for(l=0,o=0;o<r;o++)i[o]/=h,l+=i[o]*e[o];var c=l/(h+h);for(o=0;o<r;o++)i[o]-=c*e[o];for(o=0;o<r;o++){for(l=e[o],u=i[o],a=o;a<=r-1;a++)s[a][o]-=l*i[a]+u*e[a];e[o]=s[r-1][o],s[r][o]=0}}e[r]=h}for(r=0;r<t-1;r++){if(s[t-1][r]=s[r][r],s[r][r]=1,0!=(h=e[r+1])){for(a=0;a<=r;a++)e[a]=s[a][r+1]/h;for(o=0;o<=r;o++){for(u=0,a=0;a<=r;a++)u+=s[a][r+1]*s[a][o];for(a=0;a<=r;a++)s[a][o]-=u*e[a]}}for(a=0;a<=r;a++)s[a][r+1]=0}for(o=0;o<t;o++)e[o]=s[t-1][o],s[t-1][o]=0;s[t-1][t-1]=1,i[0]=0}(3,i,s,e),function(t,e,i,s){var r,o,a,n,h,l;for(r=1;r<t;r++)i[r-1]=i[r];i[t-1]=0;var u=0,c=0,M=Math.pow(2,-52);for(n=0;n<t;n++){for(c=Math.max(c,Math.abs(e[n])+Math.abs(i[n])),h=n;h<t&&!(Math.abs(i[h])<=M*c);)h++;if(h>n){l=0;do{if((l+=1)>=7)break;var d=e[n],p=(e[n+1]-d)/(2*i[n]),g=Math.hypot(p,1);p<0&&(g=-g),e[n]=i[n]/(p+g),e[n+1]=i[n]*(p+g);var f=e[n+1],m=d-e[n];for(r=n+2;r<t;r++)e[r]-=m;u+=m,p=e[h];var F=1,v=F,x=F,Y=i[n+1],T=0,b=0;for(r=h-1;r>=n;r--)for(x=v,v=F,b=T,d=F*i[r],m=F*p,g=Math.hypot(p,i[r]),i[r+1]=T*g,T=i[r]/g,p=(F=p/g)*e[r]-T*d,e[r+1]=m+T*(F*d+T*e[r]),a=0;a<t;a++)m=s[a][r+1],s[a][r+1]=T*s[a][r]+F*m,s[a][r]=F*s[a][r]-T*m;p=-T*b*x*Y*i[n]/f,i[n]=T*p,e[n]=F*p}while(Math.abs(i[n])>M*c)}e[n]=e[n]+u,i[n]=0}for(r=0;r<t-1;r++){for(a=r,p=e[r],o=r+1;o<t;o++)e[o]<p&&(a=o,p=e[o]);if(a!=r)for(e[a]=e[r],e[r]=p,o=0;o<t;o++)p=s[o][r],s[o][r]=s[o][a],s[o][a]=p}}(3,i,s,e),r.push(i[0]),r.push(i[1]),r.push(i[2]),o.push(e[0][0]),o.push(e[1][0]),o.push(e[2][0]),o.push(e[0][1]),o.push(e[1][1]),o.push(e[2][1]),o.push(e[0][2]),o.push(e[1][2]),o.push(e[2][2]),{value:r,vec:o}},eulerParamExtract:function(t){var e,i,s;return e=Math.atan2(-t[2],t[10]),i=Math.asin(t[6]),s=Math.atan2(-t[4],t[5]),new YFM.Math.Euler(i,e,s)},eulerParamExtractX:function(t){return Math.asin(t[6])},eulerParamExtractY:function(t){return Math.atan2(-t[2],t[10])},eulerParamExtractZ:function(t){return Math.atan2(-t[4],t[5])},rotationFromQuaternion:function(e){var i=t(),s=e.x,r=e.y,o=e.z,a=e.w,n=s+s,h=r+r,l=o+o,u=s*n,c=s*h,M=s*l,d=r*h,p=r*l,g=o*l,f=a*n,m=a*h,F=a*l;return i[0]=1-(d+g),i[1]=c-F,i[2]=M+m,i[3]=0,i[4]=c+F,i[5]=1-(u+g),i[6]=p-f,i[7]=0,i[8]=M-m,i[9]=p+f,i[10]=1-(u+d),i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}}}(),YFM.Math.PPolyline=function(t){this.sumLength=0,this.segList=[];var e,i,s,r,o;if(i=t.length,s=i-1,i<2)throw new Error("PPolyline pts cnt < 2");for(e=0,r=0;r<s;r++)e+=this._addSeg(t[r],t[r+1]);for(this.sumLength=e,e=0,o=null,r=0;r<s;r++)e+=this._handleSeg(this.segList[r],e,o),o=this.segList[r]},YFM.Math.PPolyline.prototype={constructor:YFM.Math.PPolyline,getSumLength:function(){return this.sumLength},getPoint:function(t,e){var i,s,r=this.segList.length;if(t<0||t>=r)throw new Error("PPolyline getPoint index outof bound:"+t);if(this.segList[t].t0<=e&&e<=this.segList[t].t1)s=t;else if(this.segList[t].t0>e){for(i=t;i>=0;i--)if(this.segList[i].t0<=e&&e<=this.segList[i].t1){s=i;break}}else if(e>this.segList[t].t1)for(i=t;i<r;i++)if(this.segList[i].t0<=e&&e<=this.segList[i].t1){s=i;break}var o=this.segList[s];if(!o)throw new Error("PPolyline getPoint targetIndex outof bound:"+s);var a=(e-o.t0)/o.tlen;return{pos:YFM.Math.Vector.add(o.start,YFM.Math.Vector.scale(o.vec,a)),seg:o}},_addSeg:function(t,e){var i={};return i.index=this.segList.length,i.start=t,i.end=e,i.vec=YFM.Math.Vector.sub(e,t),i.len=Math.sqrt(YFM.Math.Vector.dot3(i.vec,i.vec)),this.segList.push(i),i.len},_handleSeg:function(t,e,i){return t.t0=i?i.t1:e/this.sumLength,t.t1=(e+t.len)/this.sumLength,t.tlen=t.t1-t.t0,t.len}},YFM.Math.Plane=function(){var t=function(t,e,i,s,r,o){var a=YFM.Math.Vector.pos(t,e,i),n=YFM.Math.Vector.normalize(YFM.Math.Vector.vec(s,r,o)),h=-YFM.Math.Vector.dot3(n,a);return n[3]=h,n};return{plane:t,planePN:function(e,i){return t(e[0],e[1],e[2],i[0],i[1],i[2])},planeRaw:function(t,e,i,s){return YFM.Math.Vector.vec(t,e,i,s)},transform:function(t,e){var i,s=YFM.Math.Matrix.invert(e);if(null==s)throw new Error("transform a plane with a singular matrix");return i=YFM.Math.Matrix.transpose(s),YFM.Math.Matrix.mulVec(i,t)},distance:function(t,e,i,s){var r=YFM.Math.Vector.pos(e,i,s);return YFM.Math.Vector.dot4(t,r)},intersectionLine:function(t,e){var i,s,r=YFM.Math.Vector.pos(e[0],e[1],e[2]),o=YFM.Math.Vector.vec(e[4],e[5],e[6]);if(i=YFM.Math.Vector.dot4(t,r),s=YFM.Math.Vector.dot4(t,o),YFM.Math.floatEquals(s,0))throw new Error("Calc intersection of a line parallel to a plane");return-i/s},intersectionPlane:function(t,e){var i,s,r,o,a;if(o=YFM.Math.Vector.cross(t,e),i=Math.floatEquals(0,YFM.Math.Vector.norm3(o)))return{parallel:i};if((s=[]).push(t[0]),s.push(e[0]),s.push(o[0]),s.push(0),s.push(t[1]),s.push(e[1]),s.push(o[1]),s.push(0),s.push(t[2]),s.push(e[2]),s.push(o[2]),s.push(0),s.push(0),s.push(0),s.push(0),s.push(1),null==(r=YFM.Math.Matrix.invert(s)))throw new Error("nv matrix is singular");return a=YFM.Math.Matrix.mulVec(r,YFM.Math.Vector.pos(-t[3],-e[3],0)),{parallel:i,line:YFM.Math.Line.lineSV(a,o)}},intersectionTriplePlane:function(t,e,i){var s,r,o;return(s=[]).push(t[0]),s.push(e[0]),s.push(i[0]),s.push(0),s.push(t[1]),s.push(e[1]),s.push(i[1]),s.push(0),s.push(t[2]),s.push(e[2]),s.push(i[2]),s.push(0),s.push(0),s.push(0),s.push(0),s.push(1),null==(r=YFM.Math.Matrix.invert(s))?{atAPoint:!1}:(o=YFM.Math.Matrix.mulVec(r,YFM.Math.Vector.pos(-t[3],-e[3],-i[3])),{atAPoint:!0,point:o})}}}(),YFM.Math.Quaternion=function(t,e,i,s){this.x=t||0,this.y=e||0,this.z=i||0,this.w=void 0!==s?s:1},YFM.Math.Quaternion.prototype={constructor:YFM.Math.Quaternion,toString:function(t){var e="(";return e=e+this.x.toFixed(t)+", ",e=e+this.y.toFixed(t)+", ",e=e+this.z.toFixed(t)+", ",e=e+this.w.toFixed(t)+")"},clone:function(){return new this.constructor(this.x,this.y,this.z,this.w)},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},setFromEuler:function(t){var e=t.x,i=t.y,s=t.z,r=t.order,o=Math.cos,a=Math.sin,n=o(e/2),h=o(i/2),l=o(s/2),u=a(e/2),c=a(i/2),M=a(s/2);return"XYZ"===r?(this.x=u*h*l+n*c*M,this.y=n*c*l-u*h*M,this.z=n*h*M+u*c*l,this.w=n*h*l-u*c*M):"YXZ"===r?(this.x=u*h*l+n*c*M,this.y=n*c*l-u*h*M,this.z=n*h*M-u*c*l,this.w=n*h*l+u*c*M):"ZXY"===r?(this.x=u*h*l-n*c*M,this.y=n*c*l+u*h*M,this.z=n*h*M+u*c*l,this.w=n*h*l-u*c*M):"ZYX"===r?(this.x=u*h*l-n*c*M,this.y=n*c*l+u*h*M,this.z=n*h*M-u*c*l,this.w=n*h*l+u*c*M):"YZX"===r?(this.x=u*h*l+n*c*M,this.y=n*c*l+u*h*M,this.z=n*h*M-u*c*l,this.w=n*h*l-u*c*M):"XZY"===r&&(this.x=u*h*l-n*c*M,this.y=n*c*l-u*h*M,this.z=n*h*M+u*c*l,this.w=n*h*l+u*c*M),this},setFromAxisAngle:function(t,e){var i=e/2,s=Math.sin(i);return this.x=t[0]*s,this.y=t[1]*s,this.z=t[2]*s,this.w=Math.cos(i),this},setFromRotationMatrix:function(t){var e,i=t[0],s=t[4],r=t[8],o=t[1],a=t[5],n=t[9],h=t[2],l=t[6],u=t[10],c=i+a+u;return c>0?(e=.5/Math.sqrt(c+1),this.w=.25/e,this.x=(l-n)*e,this.y=(r-h)*e,this.z=(o-s)*e):i>a&&i>u?(e=2*Math.sqrt(1+i-a-u),this.w=(l-n)/e,this.x=.25*e,this.y=(s+o)/e,this.z=(r+h)/e):a>u?(e=2*Math.sqrt(1+a-i-u),this.w=(r-h)/e,this.x=(s+o)/e,this.y=.25*e,this.z=(n+l)/e):(e=2*Math.sqrt(1+u-i-a),this.w=(o-s)/e,this.x=(r+h)/e,this.y=(n+l)/e,this.z=.25*e),this},inverse:function(){return this.conjugate().normalize()},conjugate:function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},normalize:function(){var t=this.length();return 0===t?(this.x=0,this.y=0,this.z=0,this.w=1):(t=1/t,this.x=this.x*t,this.y=this.y*t,this.z=this.z*t,this.w=this.w*t),this},multiply:function(t){return this.multiplyQuaternions(this,t)},premultiply:function(t){return this.multiplyQuaternions(t,this)},multiplyQuaternions:function(t,e){var i=t.x,s=t.y,r=t.z,o=t.w,a=e.x,n=e.y,h=e.z,l=e.w;return this.x=i*l+o*a+s*h-r*n,this.y=s*l+o*n+r*a-i*h,this.z=r*l+o*h+i*n-s*a,this.w=o*l-i*a-s*n-r*h,this},slerp:function(t,e){if(0===e)return this;if(1===e)return this.copy(t);var i=this.x,s=this.y,r=this.z,o=this.w,a=o*t.w+i*t.x+s*t.y+r*t.z;if(a<0?(this.w=-t.w,this.x=-t.x,this.y=-t.y,this.z=-t.z,a=-a):this.copy(t),a>=1)return this.w=o,this.x=i,this.y=s,this.z=r,this;var n=Math.sqrt(1-a*a);if(Math.abs(n)<.001)return this.w=.5*(o+this.w),this.x=.5*(i+this.x),this.y=.5*(s+this.y),this.z=.5*(r+this.z),this;var h=Math.atan2(n,a),l=Math.sin((1-e)*h)/n,u=Math.sin(e*h)/n;return this.w=o*l+this.w*u,this.x=i*l+this.x*u,this.y=s*l+this.y*u,this.z=r*l+this.z*u,this}},YFM.Math.Vector=function(){var t=function(t,e){var i=[];return i.push(t[0]-e[0]),i.push(t[1]-e[1]),i.push(t[2]-e[2]),i.push(t[3]-e[3]),i},e=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},i=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]};return{pos:function(){var t=YFM.Math.argumentsToArray(arguments);switch(t.length){case 0:t.push(0);case 1:t.push(0);case 2:t.push(0);case 3:t.push(1)}return t.splice(0,4)},vec:function(){var t=YFM.Math.argumentsToArray(arguments);switch(t.length){case 0:t.push(0);case 1:t.push(0);case 2:t.push(0);case 3:t.push(0)}return t.splice(0,4)},vecClone:function(t){return t.slice(0)},add:function(t,e){var i=[];return i.push(t[0]+e[0]),i.push(t[1]+e[1]),i.push(t[2]+e[2]),i.push(t[3]+e[3]),i},addTo:function(t,e,i){t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t[3]=e[3]+i[3]},sub:t,subTo:function(t,e,i){t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t[3]=e[3]-i[3]},scale:function(t,e){var i=[];return i.push(e*t[0]),i.push(e*t[1]),i.push(e*t[2]),i.push(e*t[3]),i},scaleTo:function(t,e){t[0]*=e,t[1]*=e,t[2]*=e,t[3]*=e},dot3:e,dot4:i,cross:function(t,e){var i=[];return i.push(-e[1]*t[2]+e[2]*t[1]),i.push(e[0]*t[2]-e[2]*t[0]),i.push(-e[0]*t[1]+e[1]*t[0]),i.push(0),i},norm3:function(t){return Math.sqrt(e(t,t))},norm4:function(t){return Math.sqrt(i(t,t))},norm3SQ:function(t){return e(t,t)},norm4SQ:function(t){return i(t,t)},normalize:function(t){var e=[],i=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);return i>0?(e.push(t[0]/i),e.push(t[1]/i),e.push(t[2]/i),e.push(t[3])):(e.push(0),e.push(0),e.push(0),e.push(t[3])),e},normalizeTo:function(t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);e>0?(t[0]=t[0]/e,t[1]=t[1]/e,t[2]=t[2]/e):(t[0]=0,t[1]=0,t[2]=0)},limitTo:function(t,i){var s=e(t,t);if(s>i*i){var r=Math.sqrt(s);t[0]/=r,t[1]/=r,t[2]/=r,t[0]*=i,t[1]*=i,t[2]*=i}},limitToRange:function(t,i,s){var r,o=e(t,t);o>s*s?(r=Math.sqrt(o),t[0]/=r,t[1]/=r,t[2]/=r,t[0]*=s,t[1]*=s,t[2]*=s):o<i*i&&(r=Math.sqrt(o),t[0]/=r,t[1]/=r,t[2]/=r,t[0]*=s,t[1]*=s,t[2]*=s)},mix:function(t,e,i){var s=[];return s.push((1-i)*t[0]+i*e[0]),s.push((1-i)*t[1]+i*e[1]),s.push((1-i)*t[2]+i*e[2]),s.push((1-i)*t[3]+i*e[3]),s},mid:function(t,e){var i=[];return i.push((t[0]+e[0])/2),i.push((t[1]+e[1])/2),i.push((t[2]+e[2])/2),i.push(1),i},midTo:function(t,e,i){t[0]=(e[0]+i[0])/2,t[1]=(e[1]+i[1])/2,t[2]=(e[2]+i[2])/2,t[3]=1},distanceSQ:function(i,s){var r=t(s,i);return e(r,r)},distance:function(i,s){var r=t(s,i);return Math.sqrt(e(r,r))}}}(),YFM.Math.PlanePolygon=function(t){this.barrier=[],this.plane=this._makePlanePts(t)},YFM.Math.PlanePolygon.prototype={constructor:YFM.Math.PlanePolygon,intersectionLine:function(t,e){var i,s,r,o,a,n,h;do{if(o=0,(a=YFM.Math.Plane.intersectionLine(this.plane,t))<0){o=1024;break}for(n=YFM.Math.Line.getPoint(t,a),h=YFM.Math.Matrix.invert(e),n=YFM.Math.Matrix.mulVec(h,n),i=this.barrier.length,s=0;s<i;s++)(r=YFM.Math.Plane.distance(this.barrier[s],n[0],n[1],n[2]))<o&&(o=r)}while(!1);return o},_makePlanePts:function(t){var e,i,s,r,o,a;if((a=t.length)<3)throw new Error("polygon pts count < 3");o=0;do{if(i=YFM.Math.Vector.sub(t[(o+1)%a],t[o%a]),r=YFM.Math.Vector.sub(t[(o+2)%a],t[(o+1)%a]),e=YFM.Math.Vector.cross(i,r),!YFM.Math.floatEquals(YFM.Math.Vector.norm3SQ(e),0))break;o++}while(o<a);if(YFM.Math.floatEquals(YFM.Math.Vector.norm3SQ(e),0))throw new Error("polygon degenerate");e=YFM.Math.Vector.normalize(e),o=0;do{i=YFM.Math.Vector.sub(t[(o+1)%a],t[o%a]),s=YFM.Math.Vector.cross(e,i),s=YFM.Math.Vector.normalize(s),this.barrier.push(YFM.Math.Plane.planePN(t[o],s)),o++}while(o<a);return YFM.Math.Plane.planePN(t[0],e)}},YFM.Math.Mover=function(t,e,i){this.mass=this.DEFAULT_MASS,this.maxForce=this.DEFAULT_MAX_FORCE,this.maxSpeed=this.DEFAULT_MAX_SPEED,this.location=YFM.Math.Vector.pos(t||0,e||0,i||0),this.velocity=YFM.Math.Vector.vec(0,0,0),this.acceleration=YFM.Math.Vector.vec(0,0,0)},YFM.Math.Mover.prototype={constructor:YFM.Math.Mover,DEFAULT_MASS:1,DEFAULT_MAX_FORCE:4,DEFAULT_MAX_SPEED:4,setMass:function(t){this.mass=t},setMaxForce:function(t){this.maxForce=t},setMaxSpeed:function(t){this.maxSpeed=t},setLocation:function(t,e,i){this.location[0]=t,this.location[1]=e,this.location[2]=i},getLocation:function(){return this.location},update:function(){YFM.Math.Vector.addTo(this.velocity,this.velocity,this.acceleration),YFM.Math.Vector.limitTo(this.velocity,this.maxSpeed),YFM.Math.Vector.addTo(this.location,this.location,this.velocity),this.acceleration[0]=0,this.acceleration[1]=0,this.acceleration[2]=0},applyForce:function(t){var e=YFM.Math.Vector.scale(t,1/this.mass);YFM.Math.Vector.addTo(this.acceleration,this.acceleration,e)},seek:function(t){var e,i;e=YFM.Math.Vector.normalize(YFM.Math.Vector.sub(t,this.location)),YFM.Math.Vector.scaleTo(this.maxSpeed),i=YFM.Math.Vector.limitTo(YFM.Math.Vector.sub(e,this.velocity),this.maxForce),this.applyForce(i)},flee:function(t){var e,i;e=YFM.Math.Vector.normalize(YFM.Math.Vector.sub(t,this.location)),YFM.Math.Vector.scaleTo(-this.maxSpeed),i=YFM.Math.Vector.limitTo(YFM.Math.Vector.sub(e,this.velocity),this.maxForce),this.applyForce(i)},arrive:function(t,e){var i,s,r,o;return i=YFM.Math.Vector.sub(t,this.location),(r=YFM.Math.Vector.norm3(i))<=e||(i=YFM.Math.Vector.normalize(i),r<100?(o=YFM.Math.map(r,0,100,0,this.maxSpeed),YFM.Math.Vector.scaleTo(i,o)):YFM.Math.Vector.scaleTo(i,this.maxSpeed),s=YFM.Math.Vector.sub(i,this.velocity),YFM.Math.Vector.limitTo(s,this.maxForce),this.applyForce(s),!1)}},YFM.Math.AABB=function(t,e,i,s,r,o){this.isAABB=!0,this.min=new Array(t,i,r),this.max=new Array(e,s,o);var a=(t+e)/2,n=(i+s)/2,h=(r+o)/2;this.half=new Array((e-t)/2,(s-i)/2,(o-r)/2);var l=YFM.Math.Vector,u=YFM.Math.Plane,c=u.plane(t,n,h,1,0,0),M=u.plane(e,n,h,-1,0,0),d=u.plane(a,i,h,0,1,0),p=u.plane(a,s,h,0,-1,0),g=u.plane(a,n,r,0,0,1),f=u.plane(a,n,o,0,0,-1);this.minPlane=new Array(c,d,g),this.maxPlane=new Array(M,p,f),this.x=l.vec(1,0,0),this.y=l.vec(0,1,0),this.z=l.vec(0,0,1),this.X=l.scale(this.x,e-t),this.Y=l.scale(this.y,s-i),this.Z=l.scale(this.z,o-r),this.center=l.pos(a,n,h)},YFM.Math.AABB.prototype={constructor:YFM.Math.AABB,LEVEL_COLOR:new Array(YFM.Math.Vector.pos(1,0,0),YFM.Math.Vector.pos(1,.5,0),YFM.Math.Vector.pos(1,1,0),YFM.Math.Vector.pos(0,1,0),YFM.Math.Vector.pos(0,1,1),YFM.Math.Vector.pos(0,0,1),YFM.Math.Vector.pos(.5,0,1),YFM.Math.Vector.pos(0,0,0)),posCheck:function(t){return!(this.max[0]<t[0]||this.min[0]>t[0])&&(!(this.max[1]<t[1]||this.min[1]>t[1])&&!(this.max[2]<t[2]||this.min[2]>t[2]))},aabbCheck:function(t){return!(this.max[0]<t.min[0]||this.min[0]>t.max[0])&&(!(this.max[1]<t.min[1]||this.min[1]>t.max[1])&&!(this.max[2]<t.min[2]||this.min[2]>t.max[2]))},aabbCheckPlus:function(t){return this.max[0]<t.min[0]||this.min[0]>t.max[0]?0:this.max[1]<t.min[1]||this.min[1]>t.max[1]?0:this.max[2]<t.min[2]||this.min[2]>t.max[2]?0:this.max[0]>=t.max[0]&&this.min[0]<=t.min[0]&&this.max[1]>=t.max[1]&&this.min[1]<=t.min[1]&&this.max[2]>=t.max[2]&&this.min[2]<=t.min[2]?1:2},obbCheck:function(t){if(!t||!t.isOBB)return-1;var e,i,s,r,o=YFM.Math.Plane;e=0,i=0;do{if(s=t.effectiveRadius(this.minPlane[0]),(r=o.distance(this.minPlane[0],t.center))<-s){e++;break}if(r>s?i++:0,s=t.effectiveRadius(this.maxPlane[0]),(r=o.distance(this.maxPlane[0],t.center))<-s){e++;break}if(r>s?i++:0,s=t.effectiveRadius(this.minPlane[1]),(r=o.distance(this.minPlane[1],t.center))<-s){e++;break}if(r>s?i++:0,s=t.effectiveRadius(this.maxPlane[1]),(r=o.distance(this.maxPlane[1],t.center))<-s?e++:r>s?i++:0,s=t.effectiveRadius(this.minPlane[2]),(r=o.distance(this.minPlane[2],t.center))<-s){e++;break}if(r>s?i++:0,s=t.effectiveRadius(this.maxPlane[2]),(r=o.distance(this.maxPlane[2],t.center))<-s){e++;break}r>s?i++:0}while(!1);return 6==i?1:e>0?-1:0},lineCheckDetail:function(t){var e,i,s,r,o,a,n,h,l,u,c=YFM.Math.Vector,M={result:!1,tMax:Number.MAX_VALUE,tMin:-Number.MAX_VALUE};if(r=Number.MAX_VALUE,o=-Number.MAX_VALUE,e=c.pos(t[0],t[1],t[2]),i=c.normalize(c.vec(t[4],t[5],t[6])),s=c.sub(this.center,e),h=c.dot3(this.x,s),l=c.dot3(this.x,i),YFM.Math.floatNotZero(l)){if(a=(h+this.half[0])/l,n=(h-this.half[0])/l,a>n&&(u=n,n=a,a=u),a>o&&(o=a),n<r&&(r=n),o>r)return M;if(r<0)return M}else if(-h-this.half[0]>0||-h+this.half[0]<0)return M;if(h=YFM.Math.Vector.dot3(this.y,s),l=YFM.Math.Vector.dot3(this.y,i),YFM.Math.floatNotZero(l)){if(a=(h+this.half[1])/l,n=(h-this.half[1])/l,a>n&&(u=n,n=a,a=u),a>o&&(o=a),n<r&&(r=n),o>r)return M;if(r<0)return M}else if(-h-this.half[1]>0||-h+this.half[1]<0)return M;if(h=YFM.Math.Vector.dot3(this.z,s),l=YFM.Math.Vector.dot3(this.z,i),YFM.Math.floatNotZero(l)){if(a=(h+this.half[2])/l,n=(h-this.half[2])/l,a>n&&(u=n,n=a,a=u),a>o&&(o=a),n<r&&(r=n),o>r)return M;if(r<0)return M}else if(-h-this.half[2]>0||-h+this.half[2]<0)return M;return M.result=!0,M.tMax=r,M.tMin=o,M},lineCheck:function(t){return this.lineCheckDetail(t).result},frustumCheckDetail:function(t){var e,i,s,r,o=YFM.Math.Plane,a={check:-1,dist:Number.MAX_VALUE};e=0,i=0;do{if(s=this.effectiveRadius(t.near),a.dist=r=o.distance(t.near,this.center),r<-s){e++;break}if(r>s?i++:0,s=this.effectiveRadius(t.far),(r=o.distance(t.far,this.center))<-s){e++;break}if(r>s?i++:0,s=this.effectiveRadius(t.left),(r=o.distance(t.left,this.center))<-s){e++;break}if(r>s?i++:0,s=this.effectiveRadius(t.right),(r=o.distance(t.right,this.center))<-s?e++:r>s?i++:0,s=this.effectiveRadius(t.bottom),(r=o.distance(t.bottom,this.center))<-s){e++;break}if(r>s?i++:0,s=this.effectiveRadius(t.top),(r=o.distance(t.top,this.center))<-s){e++;break}r>s?i++:0}while(!1);return a.check=6==i?1:e>0?-1:0,a},frustumCheckDetailPlus:function(t){var e,i,s,r,o=YFM.Math.Plane,a={check:-1,dist:[1024,1024,1024,1024,1024,1024],radius:[0,0,0,0,0,0]};e=0,i=0;do{if(a.radius[0]=s=this.effectiveRadius(t.near),a.dist[0]=r=o.distance(t.near,this.center),r<-s){e++;break}if(r>s?i++:0,a.radius[1]=s=this.effectiveRadius(t.far),a.dist[1]=r=o.distance(t.far,this.center),r<-s){e++;break}if(r>s?i++:0,a.radius[2]=s=this.effectiveRadius(t.left),a.dist[2]=r=o.distance(t.left,this.center),r<-s){e++;break}if(r>s?i++:0,a.radius[3]=s=this.effectiveRadius(t.right),a.dist[3]=r=o.distance(t.right,this.center),r<-s?e++:r>s?i++:0,a.radius[4]=s=this.effectiveRadius(t.bottom),a.dist[4]=r=o.distance(t.bottom,this.center),r<-s){e++;break}if(r>s?i++:0,a.radius[5]=s=this.effectiveRadius(t.top),a.dist[5]=r=o.distance(t.top,this.center),r<-s){e++;break}r>s?i++:0}while(!1);return a.check=6==i?1:e>0?-1:0,a},frustumCheck:function(t){return this.frustumCheckDetailPlus(t).check},effectiveRadius:function(t){return(Math.abs(YFM.Math.Vector.dot3(this.X,t))+Math.abs(YFM.Math.Vector.dot3(this.Y,t))+Math.abs(YFM.Math.Vector.dot3(this.Z,t)))/2},setDebugBox:function(t){var e;e=t<7&&t>=0?YFM.Math.AABB.prototype.LEVEL_COLOR[t]:YFM.Math.AABB.prototype.LEVEL_COLOR[7],this._makeBox(e)},renderDebugBox:function(t){if(this.boxBorders){var e=YFM.gs.gl,i=YFM.gs.transform;t&&i.pushMat(t);var s=YFM.gs.colorShader;s.useProgram(),s.setPVMMatrix(i.getPVMMat()),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),s.drawLines(this.boxBorders,2),e.disable(e.DEPTH_TEST),t&&i.popMat()}},_makeBox:function(t){var e=YFM.Math.Vector,i=[];i.push(e.pos(this.min[0],this.min[1],this.min[2])),i.push(e.pos(this.max[0],this.min[1],this.min[2])),i.push(e.pos(this.max[0],this.max[1],this.min[2])),i.push(e.pos(this.min[0],this.max[1],this.min[2])),i.push(e.pos(this.min[0],this.min[1],this.max[2])),i.push(e.pos(this.max[0],this.min[1],this.max[2])),i.push(e.pos(this.max[0],this.max[1],this.max[2])),i.push(e.pos(this.min[0],this.max[1],this.max[2])),this.boxBorders=new YFM.WebGL.VAttribs(YFM.gs.gl);var s=[],r=[];this._putLine(s,r,i,4,5,t),this._putLine(s,r,i,5,6,t),this._putLine(s,r,i,6,7,t),this._putLine(s,r,i,7,4,t),this._putLine(s,r,i,0,4,t),this._putLine(s,r,i,1,5,t),this._putLine(s,r,i,2,6,t),this._putLine(s,r,i,3,7,t),this._putLine(s,r,i,0,1,t),this._putLine(s,r,i,1,2,t),this._putLine(s,r,i,2,3,t),this._putLine(s,r,i,3,0,t),this.boxBorders.addAttribute("position",s,3,!1),this.boxBorders.addAttribute("color",r,3,!1)},_putLine:function(t,e,i,s,r,o){t.push(i[s]),t.push(i[r]),e.push(o),e.push(o)}},YFM.Math.AAOctTree=function(t,e,i,s,r,o){this.root=new this.AAOctNode(null,t,e,i,s,r,o,"0",0),this.objMap={}},YFM.Math.AAOctTree.prototype={constructor:YFM.Math.AAOctTree,cursor:0,THRESHOLD:8,removeObject:function(t){var e=this.objMap[t.toString()];if(e){for(var i,s=e.node,r=[],o=0,a=s.objectList.length;o<a;o++)e!==(i=s.objectList[o])&&r.push(i);s.objectList=r,s.objectList.length<=0&&s.shrink(),delete this.objMap[t.toString()]}return e},insertObject:function(t,e){var i=YFM.Math.AAOctTree.prototype.cursor;YFM.Math.AAOctTree.prototype.cursor+=1;var s={obj:t,obb:e};return this.objMap[i.toString()]=s,this.root.insertObject(s),i},updateObjectObb:function(t,e){var i=this.objMap[t.toString()];if(i){for(var s,r=i.node,o=[],a=0,n=r.objectList.length;a<n;a++)i!==(s=r.objectList[a])&&o.push(s);r.objectList=o,r.objectList.length<=0&&r.shrink(),i.obb=e,this.root.insertObject(i)}return i},frustumCheck:function(t){return this.root.frustumCheck(t)},rayCheck:function(t,e,i){return this.root.rayCheck(t,e,i)},render:function(t,e){this.root.renderCheck(t,e)},AAOctNode:function(t,e,i,s,r,o,a,n,h){this.parentNode=t,this.mask=n,this.level=h,this.box=new YFM.Math.AABB(e,i,s,r,o,a),this.objectList=[],this.children=new Array(null,null,null,null),this.splited=!1}},YFM.Math.AAOctTree.prototype.AAOctNode.prototype={constructor:YFM.Math.AAOctTree.prototype.AAOctNode,shrink:function(){this.isNodeEmpty()&&(this.children[0]=null,this.children[1]=null,this.children[2]=null,this.children[3]=null,this.splited=!1,null!==this.parentNode&&this.parentNode.shrink())},isNodeEmpty:function(){if(this.objectList.length>0)return!1;for(var t=0;t<4;t++)if(null!==this.children[t]&&!this.children[t].isNodeEmpty())return!1;return!0},rayCheck:function(t,e,i){if(this.box.lineCheck(t)){var s=this.objectList.length;for(r=0;r<s;r++)if(this.objectList[r].obb.lineCheck(t)&&(e.push(this.objectList[r]),i))return!0;for(var r=0;r<4;r++)if(null!==this.children[0]&&this.children[0].rayCheck(t,e,i))return!0}return!1},containCheck:function(t){var e=this.box.frustumCheck(t);if(-1==e)return null;if(1==e)return this;if(0==e&&null!==this.children[0]){for(var i=[],s=0;s<4;s++)null!==this.children[s]&&i.push(this.children[s].containCheck(t));var r=1024,o=null;for(s=0;s<4;s++)null!==i[s]&&i[s].level<r&&(o=i[s],r=i[s].level);return o}return null},renderEver:function(t){var e,i;for(e=0;e<4;e++)null!==this.children[e]&&this.children[e].renderEver(t);for(e=0,i=this.objectList.length;e<i;e++)t(this.objectList[e])},renderCheck:function(t,e){var i=this.box.frustumCheckDetailPlus(t).check,s=0;if(-1!=i)if(1===i){for(s=0;s<4;s++)null!==this.children[s]&&this.children[s].renderEver(e);for(s=0,cnt=this.objectList.length;s<cnt;s++)e(this.objectList[s])}else{for(s=0;s<4;s++)null!==this.children[s]&&this.children[s].renderCheck(t,e);for(s=0,cnt=this.objectList.length;s<cnt;s++)t.containCheckOBB(this.objectList[s].obb)&&e(this.objectList[s])}},insertObject:function(t){!this.splited&&this.objectList.length<YFM.Math.AAOctTree.prototype.THRESHOLD?this._insert2ObjList(t):(this.splited||this._spliteSpace(),this._insertToSubSpace(t))},frustumCheck:function(t){return this.box.frustumCheck(t)},_insert2ObjList:function(t){t.node=this,this.objectList.push(t)},_spliteSpace:function(){var t,e,i,s,r;if(this.splited=!0,!(this.level>=6)){for(this.children[0]=new YFM.Math.AAOctTree.prototype.AAOctNode(this,this.box.min[0],this.box.center[0],this.box.min[1],this.box.center[1],this.box.min[2],this.box.max[2],this.mask+"0",this.level+1),this.children[1]=new YFM.Math.AAOctTree.prototype.AAOctNode(this,this.box.center[0],this.box.max[0],this.box.min[1],this.box.center[1],this.box.min[2],this.box.max[2],this.mask+"1",this.level+1),this.children[2]=new YFM.Math.AAOctTree.prototype.AAOctNode(this,this.box.center[0],this.box.max[0],this.box.center[1],this.box.max[1],this.box.min[2],this.box.max[2],this.mask+"2",this.level+1),this.children[3]=new YFM.Math.AAOctTree.prototype.AAOctNode(this,this.box.min[0],this.box.center[0],this.box.center[1],this.box.max[1],this.box.min[2],this.box.max[2],this.mask+"3",this.level+1),r=[],s=0,e=this.objectList.length;s<e;s++){for(t=this.objectList[s],i=0;i<4;i++)if(1===this.children[i].box.obbCheck(t.obb)){this.children[i].insertObject(t);break}4==i&&r.push(t)}this.objectList=r}},_insertToSubSpace:function(t){if(null!==this.children[0])for(var e=0;e<4;e++)if(1===this.children[e].box.obbCheck(t.obb))return void this.children[e].insertObject(t);this._insert2ObjList(t)}},YFM.Math.FloorQuadTree=function(t,e){this.floor=t,this.root=new YFM.Map.FloorQuadNode(null,t,0,t.mapWidth,0,t.mapHeight,e,"0",0),this.objMap={}},YFM.Math.FloorQuadTree.prototype={constructor:YFM.Math.FloorQuadTree,cursor:0,shift:1e4,removeObject:function(t){var e=this.objMap[t.toString()];if(e){for(var i,s=e.node,r=[],o=0,a=s.objectList.length;o<a;o++)e!==(i=s.objectList[o])&&r.push(i);s.objectList=r,s.objectList.length<=0&&s.shrink()}return e},insertObject:function(t,e,i,s,r){var o=YFM.Math.FloorQuadTree.prototype.cursor*YFM.Math.FloorQuadTree.prototype.shift+this.floor.index;YFM.Math.FloorQuadTree.prototype.cursor+=1;var a=this.floor.floorPos2Region(i,s);a[2]+=r;var n={id:o,obj:t,pos:a,floor:e,x:i,y:s,z:r};return this.objMap[o.toString()]=n,this.root.insertObject(n),o},insertObjectOBB:function(t,e){var i=YFM.Math.FloorQuadTree.prototype.cursor*YFM.Math.FloorQuadTree.prototype.shift+this.floor.index;YFM.Math.FloorQuadTree.prototype.cursor+=1;var s={id:i,obj:t,pos:e};return this.objMap[i.toString()]=s,this.root.insertObject(s),i},insertObjectOBBCenter:function(t,e,i){var s=YFM.Math.FloorQuadTree.prototype.cursor*YFM.Math.FloorQuadTree.prototype.shift+this.floor.index,r=this.floor.floorPos2Region(i[0],i[1]);YFM.Math.FloorQuadTree.prototype.cursor+=1;var o={id:s,obj:t,pos:e,center:r};return this.objMap[s.toString()]=o,this.root.insertObject(o),s},frustumCheck:function(t){return this.root.frustumCheck(t)},rayCheck:function(t,e,i){var s=[];return this.root.rayCheck(t,e*e,s,i),s},rayCheckOBB:function(t,e,i){var e=[],s=YFM.Math.Line.transform(t,YFM.Math.Matrix.invert(this.floor.floorMat));return this.root.rayCheckOBB(t,s,e,i),e},render:function(t,e,i,s){this.root.renderCheck(t,e,i,s)},getContainLevel:function(t){var e;return null!=(e=this.root.containCheck(t))?e.level:1024}},YFM.Map.FloorQuadNode=function(t,e,i,s,r,o,a,n,h){this.parentNode=t,this.floor=e,this.xmin=i,this.xmax=s,this.ymin=r,this.ymax=o,this.height=a,this.mask=n,this.level=h;var l,u,c,M,d=[];l=e.floorPos2Region(i,r),u=e.floorPos2Region(s,r),c=e.floorPos2Region(s,o),M=e.floorPos2Region(i,o),d.push(YFM.Math.Vector.pos(l[0],l[1],l[2]-100)),d.push(YFM.Math.Vector.pos(u[0],u[1],u[2]-100)),d.push(YFM.Math.Vector.pos(c[0],c[1],c[2]-100)),d.push(YFM.Math.Vector.pos(M[0],M[1],M[2]-100)),d.push(YFM.Math.Vector.pos(l[0],l[1],l[2]+a)),d.push(YFM.Math.Vector.pos(u[0],u[1],u[2]+a)),d.push(YFM.Math.Vector.pos(c[0],c[1],c[2]+a)),d.push(YFM.Math.Vector.pos(M[0],M[1],M[2]+a)),this.obb=new YFM.Math.OBB(d),this.objectList=[],this.children=new Array(null,null,null,null),this.splited=!1},YFM.Map.FloorQuadNode.prototype={constructor:YFM.Map.FloorQuadNode,shrink:function(){this.isNodeEmpty()&&(this.children[0]=null,this.children[1]=null,this.children[2]=null,this.children[3]=null,this.splited=!1,null!==this.parentNode&&this.parentNode.shrink())},isNodeEmpty:function(){return!(this.objectList.length>0)&&(!(null!==this.children[0]&&!this.children[0].isNodeEmpty())&&(!(null!==this.children[1]&&!this.children[1].isNodeEmpty())&&(!(null!==this.children[2]&&!this.children[2].isNodeEmpty())&&!(null!==this.children[3]&&!this.children[3].isNodeEmpty()))))},rayCheckOBB:function(t,e,s,r){if(this.obb.lineCheck(t)){var o,a=this.objectList.length;for(i=0;i<a;i++)if((o=this.objectList[i].pos).isOBB&&o.lineCheck(t)&&(s.push(this.objectList[i]),r))return!0;if(null!==this.children[0]&&this.children[0].rayCheckOBB(t,e,s,r))return!0;if(null!==this.children[1]&&this.children[1].rayCheckOBB(t,e,s,r))return!0;if(null!==this.children[2]&&this.children[2].rayCheckOBB(t,e,s,r))return!0;if(null!==this.children[3]&&this.children[3].rayCheckOBB(t,e,s,r))return!0}return!1},rayCheck:function(t,e,s,r){if(this.obb.lineCheck(t)){var o,a,n=this.objectList.length;for(i=0;i<n;i++)if(a=this.objectList[i].pos,o=YFM.Math.Line.distancePointSQ(t,a[0],a[1],a[2]),0===e){if(o<=this.objectList[i].radiusSQ&&(s.push(this.objectList[i]),r))return!0}else if(o<=e&&(s.push(this.objectList[i]),r))return!0;if(null!==this.children[0]&&this.children[0].rayCheck(t,e,s,r))return!0;if(null!==this.children[1]&&this.children[1].rayCheck(t,e,s,r))return!0;if(null!==this.children[2]&&this.children[2].rayCheck(t,e,s,r))return!0;if(null!==this.children[3]&&this.children[3].rayCheck(t,e,s,r))return!0}return!1},containCheck:function(t){var e=this.obb.frustumCheck(t);if(-1==e)return null;if(1==e)return this;if(0==e&&null!==this.children[0]){var s=[];s.push(this.children[0].containCheck(t)),s.push(this.children[1].containCheck(t)),s.push(this.children[2].containCheck(t)),s.push(this.children[3].containCheck(t));var r=1024,o=null;for(i=0;i<4;i++)null!==s[i]&&s[i].level<r&&(o=s[i],r=s[i].level);return o}return null},renderEver:function(t,e,i){var s,r;if(0!=(r=this.level>i+1?0:this.level>i?1:1024)){for(s=0;s<4;s++)null!==this.children[s]&&this.children[s].renderEver(t,e,i);for(r>this.objectList.length&&(r=this.objectList.length),s=0;s<r;s++)t(this.objectList[s],e)}},renderCheck:function(t,e,i,s){var r,o;if(0!=(o=this.level>s+1?0:this.level>s?1:1024)){var a=this.obb.frustumCheck(t);if(-1!=a){if(1==a)for(r=0;r<4;r++)null!==this.children[r]&&this.children[r].renderEver(e,i,s);else if(0==a&&this.level<=s)for(r=0;r<4;r++)null!==this.children[r]&&this.children[r].renderCheck(t,e,i,s);for(o>this.objectList.length&&(o=this.objectList.length),r=0;r<o;r++)t.containCheckPoint(this.objectList[r].pos)&&e(this.objectList[r],i)}}},insertObject:function(t){!this.splited&&this.objectList.length<YFM.Math.FloorQuadTree.prototype.THRESHOLD?this._insert2ObjList(t):(this.splited||this._spliteSpace(),this._insertToSubSpace(t))},frustumCheck:function(t){return this.obb.frustumCheck(t)},_insert2ObjList:function(t){t.node=this,this.objectList.push(t)},_spliteSpace:function(){var t,e,i;if(this.splited=!0,!(this.level>=6)){for(this.children[0]=new YFM.Map.FloorQuadNode(this,this.floor,this.xmin,(this.xmin+this.xmax)/2,this.ymin,(this.ymin+this.ymax)/2,this.height,this.mask+"0",this.level+1),this.children[1]=new YFM.Map.FloorQuadNode(this,this.floor,(this.xmin+this.xmax)/2,this.xmax,this.ymin,(this.ymin+this.ymax)/2,this.height,this.mask+"1",this.level+1),this.children[2]=new YFM.Map.FloorQuadNode(this,this.floor,(this.xmin+this.xmax)/2,this.xmax,(this.ymin+this.ymax)/2,this.ymax,this.height,this.mask+"2",this.level+1),this.children[3]=new YFM.Map.FloorQuadNode(this,this.floor,this.xmin,(this.xmin+this.xmax)/2,(this.ymin+this.ymax)/2,this.ymax,this.height,this.mask+"3",this.level+1),i=[];this.objectList.length>0;){t=this.objectList.pop();var s=[];for(s.push(this.children[0].obb.pointCheck(t.pos)),s.push(this.children[1].obb.pointCheck(t.pos)),s.push(this.children[2].obb.pointCheck(t.pos)),s.push(this.children[3].obb.pointCheck(t.pos)),e=0;e<4;e++)if(1==s[e]){this.children[e].insertObject(t);break}4==e&&i.push(t)}this.objectList=i}},_insertToSubSpace:function(t){var e=[];if(null!==this.children[0]){e.push(this.children[0].obb.pointCheck(t.pos)),e.push(this.children[1].obb.pointCheck(t.pos)),e.push(this.children[2].obb.pointCheck(t.pos)),e.push(this.children[3].obb.pointCheck(t.pos));for(var i=0;i<4;i++)if(1==e[i])return void this.children[i].insertObject(t)}this._insert2ObjList(t)},THRESHOLD:16},YFM.Math.FrustumWorldSpace=function(){var t=YFM.Math.Vector;this.near=t.vec(),this.far=t.vec(),this.left=t.vec(),this.right=t.vec(),this.top=t.vec(),this.bottom=t.vec()},YFM.Math.FrustumWorldSpace.prototype={constructor:YFM.Math.FrustumWorldSpace,update:function(t){this.left[0]=t[3]+t[0],this.left[1]=t[7]+t[4],this.left[2]=t[11]+t[8],this.left[3]=t[15]+t[12],this.right[0]=t[3]-t[0],this.right[1]=t[7]-t[4],this.right[2]=t[11]-t[8],this.right[3]=t[15]-t[12],this.bottom[0]=t[3]+t[1],this.bottom[1]=t[7]+t[5],this.bottom[2]=t[11]+t[9],this.bottom[3]=t[15]+t[13],this.top[0]=t[3]-t[1],this.top[1]=t[7]-t[5],this.top[2]=t[11]-t[9],this.top[3]=t[15]-t[13],this.near[0]=t[3]+t[2],this.near[1]=t[7]+t[6],this.near[2]=t[11]+t[10],this.near[3]=t[15]+t[14],this.far[0]=t[3]-t[2],this.far[1]=t[7]-t[6],this.far[2]=t[11]-t[10],this.far[3]=t[15]-t[14]},containCheckPoint:function(t){var e=!1;do{if(YFM.Math.Vector.dot4(this.near,t)<0)break;if(YFM.Math.Vector.dot4(this.far,t)<0)break;if(YFM.Math.Vector.dot4(this.left,t)<0)break;if(YFM.Math.Vector.dot4(this.right,t)<0)break;if(YFM.Math.Vector.dot4(this.bottom,t)<0)break;if(YFM.Math.Vector.dot4(this.top,t)<0)break;e=!0}while(!1);return e},nearDistance:function(t){return YFM.Math.Vector.dot4(this.near,t)},containCheckOBB:function(t){return-1!==t.frustumCheck(this)}},YFM.Math.OBB=function(t){this.isOBB=!0,t.isOBB?this._copyConstruct(t):this._initWork(t)},YFM.Math.OBB.prototype={constructor:YFM.Math.OBB,transform:function(t){var e=YFM.Math.Matrix,i=YFM.Math.Vector,s=YFM.Math.Matrix.invert(t),r=YFM.Math.Matrix.transpose(s);this.raw||(this.raw={center:this.center,r:this.r,s:this.s,t:this.t,R:this.R,S:this.S,T:this.T,r_max:this.r_max,r_min:this.r_min,s_max:this.s_max,s_min:this.s_min,t_max:this.t_max,t_min:this.t_min,r_half:this.r_half,s_half:this.s_half,t_half:this.t_half}),this.center=e.mulVec(t,this.raw.center),this.r=this._reserse3(e.mulVec(t,this.raw.r)),this.s=this._reserse3(e.mulVec(t,this.raw.s)),this.t=this._reserse3(e.mulVec(t,this.raw.t)),this.R=this._reserse3(e.mulVec(t,this.raw.R)),this.S=this._reserse3(e.mulVec(t,this.raw.S)),this.T=this._reserse3(e.mulVec(t,this.raw.T)),this.r_max=e.mulVec(r,this.raw.r_min),this.r_min=e.mulVec(r,this.raw.r_max),this.s_max=e.mulVec(r,this.raw.s_min),this.s_min=e.mulVec(r,this.raw.s_max),this.t_max=e.mulVec(r,this.raw.t_min),this.t_min=e.mulVec(r,this.raw.t_max),this.r_half=this._reserse4(e.mulVec(r,this.raw.r_half)),this.s_half=this._reserse4(e.mulVec(r,this.raw.s_half)),this.t_half=this._reserse4(e.mulVec(r,this.raw.t_half)),this.hr=i.norm3(this.R)/2,this.hs=i.norm3(this.S)/2,this.ht=i.norm3(this.T)/2},pointCheck:function(t){if(t.isOBB)return this.obbCheck(t);var e,i,s;e=0,i=0;do{if((s=YFM.Math.Plane.distance(this.r_min,t))<0){e++;break}if(s>0?i++:0,(s=YFM.Math.Plane.distance(this.r_max,t))<0){e++;break}if(s>0?i++:0,(s=YFM.Math.Plane.distance(this.s_min,t))<0){e++;break}if(s>0?i++:0,(s=YFM.Math.Plane.distance(this.s_max,t))<0){e++;break}if(s>0?i++:0,(s=YFM.Math.Plane.distance(this.t_min,t))<0){e++;break}if(s>0?i++:0,(s=YFM.Math.Plane.distance(this.t_max,t))<0){e++;break}s>0?i++:0,ret=!0}while(!1);return 6==i?1:e>0?-1:0},lineCheckDetail:function(t){var e,i,s,r,o,a,n,h,l,u,c={result:!1,tMax:Number.MAX_VALUE,tMin:-Number.MAX_VALUE};if(r=Number.MAX_VALUE,o=-Number.MAX_VALUE,e=YFM.Math.Vector.pos(t[0],t[1],t[2]),i=YFM.Math.Vector.normalize(YFM.Math.Vector.vec(t[4],t[5],t[6])),s=YFM.Math.Vector.sub(this.center,e),h=YFM.Math.Vector.dot3(this.r,s),l=YFM.Math.Vector.dot3(this.r,i),YFM.Math.floatNotZero(l)){if(a=(h+this.hr)/l,n=(h-this.hr)/l,a>n&&(u=n,n=a,a=u),a>o&&(o=a),n<r&&(r=n),o>r)return c;if(r<0)return c}else if(-h-this.hr>0||-h+this.hr<0)return c;if(h=YFM.Math.Vector.dot3(this.s,s),l=YFM.Math.Vector.dot3(this.s,i),YFM.Math.floatNotZero(l)){if(a=(h+this.hs)/l,n=(h-this.hs)/l,a>n&&(u=n,n=a,a=u),a>o&&(o=a),n<r&&(r=n),o>r)return c;if(r<0)return c}else if(-h-this.hs>0||-h+this.hs<0)return c;if(h=YFM.Math.Vector.dot3(this.t,s),l=YFM.Math.Vector.dot3(this.t,i),YFM.Math.floatNotZero(l)){if(a=(h+this.ht)/l,n=(h-this.ht)/l,a>n&&(u=n,n=a,a=u),a>o&&(o=a),n<r&&(r=n),o>r)return c;if(r<0)return c}else if(-h-this.ht>0||-h+this.ht<0)return c;return c.result=!0,c.tMax=r,c.tMin=o,c},lineCheck:function(t){return this.lineCheckDetail(t).result},obbCheck:function(t){var e,i,s,r;e=0,i=0;do{if(s=t.effectiveRadius(this.r_min),(r=YFM.Math.Plane.distance(this.r_min,t.center))<-s){e++;break}if(r>s?i++:0,s=t.effectiveRadius(this.r_max),(r=YFM.Math.Plane.distance(this.r_max,t.center))<-s){e++;break}if(r>s?i++:0,s=t.effectiveRadius(this.s_min),(r=YFM.Math.Plane.distance(this.s_min,t.center))<-s){e++;break}if(r>s?i++:0,s=t.effectiveRadius(this.s_max),(r=YFM.Math.Plane.distance(this.s_max,t.center))<-s?e++:r>s?i++:0,s=t.effectiveRadius(this.t_min),(r=YFM.Math.Plane.distance(this.t_min,t.center))<-s){e++;break}if(r>s?i++:0,s=t.effectiveRadius(this.t_max),(r=YFM.Math.Plane.distance(this.t_max,t.center))<-s){e++;break}r>s?i++:0}while(!1);return 6==i?1:e>0?-1:0},frustumCheckDetail:function(t){var e,i,s,r,o={check:-1,dist:Number.MAX_VALUE};e=0,i=0;do{if(s=this.effectiveRadius(t.near),o.dist=r=YFM.Math.Plane.distance(t.near,this.center),r<-s){e++;break}if(r>s?i++:0,s=this.effectiveRadius(t.far),(r=YFM.Math.Plane.distance(t.far,this.center))<-s){e++;break}if(r>s?i++:0,s=this.effectiveRadius(t.left),(r=YFM.Math.Plane.distance(t.left,this.center))<-s){e++;break}if(r>s?i++:0,s=this.effectiveRadius(t.right),(r=YFM.Math.Plane.distance(t.right,this.center))<-s?e++:r>s?i++:0,s=this.effectiveRadius(t.bottom),(r=YFM.Math.Plane.distance(t.bottom,this.center))<-s){e++;break}if(r>s?i++:0,s=this.effectiveRadius(t.top),(r=YFM.Math.Plane.distance(t.top,this.center))<-s){e++;break}r>s?i++:0}while(!1);return o.check=6==i?1:e>0?-1:0,o},frustumCheckDetailPlus:function(t){var e,i,s,r,o={check:-1,dist:[1024,1024,1024,1024,1024,1024],radius:[0,0,0,0,0,0,0]};e=0,i=0;do{if(o.radius[0]=s=this.effectiveRadius(t.near),o.dist[0]=r=YFM.Math.Plane.distance(t.near,this.center),r<-s){e++;break}if(r>s?i++:0,o.radius[1]=s=this.effectiveRadius(t.far),o.dist[1]=r=YFM.Math.Plane.distance(t.far,this.center),r<-s){e++;break}if(r>s?i++:0,o.radius[2]=s=this.effectiveRadius(t.left),o.dist[2]=r=YFM.Math.Plane.distance(t.left,this.center),r<-s){e++;break}if(r>s?i++:0,o.radius[3]=s=this.effectiveRadius(t.right),o.dist[3]=r=YFM.Math.Plane.distance(t.right,this.center),r<-s?e++:r>s?i++:0,o.radius[4]=s=this.effectiveRadius(t.bottom),o.dist[4]=r=YFM.Math.Plane.distance(t.bottom,this.center),r<-s){e++;break}if(r>s?i++:0,o.radius[5]=s=this.effectiveRadius(t.top),o.dist[5]=r=YFM.Math.Plane.distance(t.top,this.center),r<-s){e++;break}r>s?i++:0}while(!1);return o.check=6==i?1:e>0?-1:0,o},frustumCheck:function(t){return this.frustumCheckDetail(t).check},effectiveRadius:function(t){return(Math.abs(YFM.Math.Vector.dot3(this.R,t))+Math.abs(YFM.Math.Vector.dot3(this.S,t))+Math.abs(YFM.Math.Vector.dot3(this.T,t)))/2},getCornerPts:function(){var t=YFM.Math.Plane,e=new Array(8);return e[0]=t.intersectionTriplePlane(this.r_min,this.s_max,this.t_min).point,e[1]=t.intersectionTriplePlane(this.r_min,this.s_max,this.t_max).point,e[2]=t.intersectionTriplePlane(this.r_min,this.s_min,this.t_max).point,e[3]=t.intersectionTriplePlane(this.r_min,this.s_min,this.t_min).point,e[4]=t.intersectionTriplePlane(this.r_max,this.s_max,this.t_min).point,e[5]=t.intersectionTriplePlane(this.r_max,this.s_max,this.t_max).point,e[6]=t.intersectionTriplePlane(this.r_max,this.s_min,this.t_max).point,e[7]=t.intersectionTriplePlane(this.r_max,this.s_min,this.t_min).point,e},renderDebugBox:function(t){this.boxBorders&&t.drawLines(this.boxBorders,4)},setDebugBox:function(t){YFM.Math.Vector;var e=this.getCornerPts();this.boxBorders=new YFM.WebGL.VAttribs(YFM.gs.gl);var i=[],s=[],r=YFM.WebGL.Color.getRGBVec(t);this._putLine(i,s,e,4,5,r),this._putLine(i,s,e,5,6,r),this._putLine(i,s,e,6,7,r),this._putLine(i,s,e,7,4,r),this._putLine(i,s,e,0,4,r),this._putLine(i,s,e,1,5,r),this._putLine(i,s,e,2,6,r),this._putLine(i,s,e,3,7,r),this._putLine(i,s,e,0,1,r),this._putLine(i,s,e,1,2,r),this._putLine(i,s,e,2,3,r),this._putLine(i,s,e,3,0,r),this.boxBorders.addAttribute("position",i,3,!1),this.boxBorders.addAttribute("color",s,3,!1)},_putLine:function(t,e,i,s,r,o){t.push(i[s]),t.push(i[r]),e.push(o),e.push(o)},_reserse3:function(t){return t[0]=-t[0],t[1]=-t[1],t[2]=-t[2],t},_reserse4:function(t){return t[0]=-t[0],t[1]=-t[1],t[2]=-t[2],t[3]=-t[3],t},_calc_bounding:function(t){var e,i,s,r,o,a,n,h,l,u,c,M,d,p,g,f;for(a=Number.MAX_VALUE,n=-Number.MAX_VALUE,h=Number.MAX_VALUE,l=-Number.MAX_VALUE,u=Number.MAX_VALUE,c=-Number.MAX_VALUE,i=t.length,e=0;e<i;e++)g=t[e],s=YFM.Math.Vector.dot3(g,this.r),r=YFM.Math.Vector.dot3(g,this.s),o=YFM.Math.Vector.dot3(g,this.t),s>n&&(n=s),s<a&&(a=s),r>l&&(l=r),r<h&&(h=r),o>c&&(c=o),o<u&&(u=o);if(this.r_min=YFM.Math.Plane.planeRaw(this.r[0],this.r[1],this.r[2],-a),this.r_max=YFM.Math.Plane.planeRaw(-this.r[0],-this.r[1],-this.r[2],n),this.s_min=YFM.Math.Plane.planeRaw(this.s[0],this.s[1],this.s[2],-h),this.s_max=YFM.Math.Plane.planeRaw(-this.s[0],-this.s[1],-this.s[2],l),this.t_min=YFM.Math.Plane.planeRaw(this.t[0],this.t[1],this.t[2],-u),this.t_max=YFM.Math.Plane.planeRaw(-this.t[0],-this.t[1],-this.t[2],c),M=(a+n)/2,d=(h+l)/2,p=(u+c)/2,this.r_half=YFM.Math.Plane.planeRaw(this.r[0],this.r[1],this.r[2],-M),this.s_half=YFM.Math.Plane.planeRaw(this.s[0],this.s[1],this.s[2],-d),this.t_half=YFM.Math.Plane.planeRaw(this.t[0],this.t[1],this.t[2],-p),this.hr=(n-a)/2,this.hs=(l-h)/2,this.ht=(c-u)/2,this.R=YFM.Math.Vector.scale(this.r,n-a),this.S=YFM.Math.Vector.scale(this.s,l-h),this.T=YFM.Math.Vector.scale(this.t,c-u),!(f=YFM.Math.Plane.intersectionTriplePlane(this.r_half,this.s_half,this.t_half)).atAPoint)throw new Error("obb calc center failed");this.center=f.point},_copyConstruct:function(t){var e=YFM.Math.Vector,i=e.vecClone;this.center=i(t.center),this.r=i(t.r),this.s=i(t.s),this.t=i(t.t),this.R=i(t.R),this.S=i(t.S),this.T=i(t.T),this.r_max=i(t.r_max),this.r_min=i(t.r_min),this.s_max=i(t.s_max),this.s_min=i(t.s_min),this.t_max=i(t.t_max),this.t_min=i(t.t_min),this.r_half=i(t.r_half),this.s_half=i(t.s_half),this.t_half=i(t.t_half),this.hr=e.norm3(this.R)/2,this.hs=e.norm3(this.S)/2,this.ht=e.norm3(this.T)/2},_initWork:function(t){var e,i;e=YFM.Math.Matrix.covariance3x3(t),i=YFM.Math.Matrix.eig3x3(e),this.t=YFM.Math.Vector.vec(i.vec[0],i.vec[1],i.vec[2]),this.s=YFM.Math.Vector.vec(i.vec[3],i.vec[4],i.vec[5]),this.r=YFM.Math.Vector.vec(i.vec[6],i.vec[7],i.vec[8]),this._calc_bounding(t)}},YFM.Math.TextBlockQuickCheckTree=function(t,e){this.root=new YFM.Map.AABBNode(this,"0",0,0,t,e),this.blockPool=[],this.blockList=[]},YFM.Math.TextBlockQuickCheckTree.prototype={constructor:YFM.Math.TextBlockQuickCheckTree,reset:function(){this.blockPool=this.blockList,this.blockList=[],this.root.reset()},check:function(t,e,i,s){var r=this.root.check(t,e,i,s);return r||this.root.insert(t,e,i,s),r}},YFM.Map.AABBNode=function(t,e,i,s,r,o){this.tree=t,this.mask=e,this.rect=[i,s,r,o],this.objList=[],this.level<2&&this._splite()},YFM.Map.AABBNode.prototype={constructor:YFM.Map.AABBNode,reset:function(){this.objList=[],this.children&&(this.children[0].reset(),this.children[1].reset(),this.children[2].reset(),this.children[3].reset())},insert:function(t,e,i,s){if(this._containBox(this.rect,t,e,i,s)){if(this.children){var r=!1;do{if(this.children[0].insert(t,e,i,s))break;if(this.children[1].insert(t,e,i,s))break;if(this.children[2].insert(t,e,i,s))break;if(this.children[3].insert(t,e,i,s))break;r=!0}while(!1);r&&this._insertBlock(t,e,i,s)}else this._insertBlock(t,e,i,s);return!0}return!1},check:function(t,e,i,s){if(!this._intersectBox(this.rect,t,e,i,s))return!1;for(var r=0,o=this.objList.length;r<o;r++)if(this._intersectBox(this.objList[r],t,e,i,s))return!0;if(this.children){if(this.children[0].check(t,e,i,s))return!0;if(this.children[1].check(t,e,i,s))return!0;if(this.children[2].check(t,e,i,s))return!0;if(this.children[3].check(t,e,i,s))return!0}return!1},_insertBlock:function(t,e,i,s){var r;this.tree.blockPool.length>0?((r=this.tree.blockPool.pop())[0]=t,r[1]=e,r[2]=i,r[3]=s):r=new Array(t,e,i,s),this.objList.push(r),this.tree.blockList.push(r)},_intersectBox:function(t,e,i,s,r){return!(e>t[2]||s<t[0]||i>t[3]||r<t[1])},_containBox:function(t,e,i,s,r){return e>=t[0]&&i>=t[1]&&s<=t[2]&&r<=t[3]},_splite:function(){this.children=new Array(4);var t=(this.rect[0]+this.rect[2])/2,e=(this.rect[1]+this.rect[3])/2;this.children[0]=new YFM.Map.AABBNode(this.tree,this.mask+"0",this.rect[0],this.rect[1],t,e),this.children[1]=new YFM.Map.AABBNode(this.tree,this.mask+"1",t,this.rect[1],this.rect[2],e),this.children[2]=new YFM.Map.AABBNode(this.tree,this.mask+"2",t,e,this.rect[2],this.rect[3]),this.children[3]=new YFM.Map.AABBNode(this.tree,this.mask+"3",this.rect[0],e,t,this.rect[3])}},YFM.Mesh.MtlItem=function(){this.Ns=32,this.Ka=YFM.Math.Vector.pos(),this.Kd=YFM.Math.Vector.pos(),this.Ks=YFM.Math.Vector.pos(),this.mapKd=null},YFM.Mesh.MtlItem.prototype={constructor:YFM.Mesh.MtlItem,setNs:function(t){this.Ns=t},setKa:function(t,e,i){this.Ka[0]=t,this.Ka[1]=e,this.Ka[2]=i},setKd:function(t,e,i){this.Kd[0]=t,this.Kd[1]=e,this.Kd[2]=i},setKs:function(t,e,i){this.Ks[0]=t,this.Ks[1]=e,this.Ks[2]=i},setMapKd:function(t){this.mapKd=t},getNs:function(){return this.Ns},getKa:function(){return this.Ka},getKd:function(){return this.Kd},getKs:function(){return this.Ks},getMapKd:function(){return this.mapKd}},YFM.Mesh.ObjModel=function(t,e,i,s,r){this.baseUrl=e,this.name=i,this.obb=null,this.objects=[],this.gl=t.gl,this.texturePool=t.texturePool,this.hasMaterials=!1,this.materials={},this._loadURLDir(e,i,s,r)},YFM.Mesh.ObjModel.prototype={constructor:YFM.Mesh.ObjModel,persistence:function(){return{baseUrl:this.baseUrl,name:this.name}},VPattern:/v( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,NPattern:/vn( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,UVPattern:/vt( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,FacePattern1:/f( +-?\d+)( +-?\d+)( +-?\d+)( +-?\d+)?/,FacePattern2:/f( +(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+))?/,FacePattern3:/f( +(-?\d+)\/(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+)\/(-?\d+))?/,FacePattern4:/f( +(-?\d+)\/\/(-?\d+))( +(-?\d+)\/\/(-?\d+))( +(-?\d+)\/\/(-?\d+))( +(-?\d+)\/\/(-?\d+))?/,NsPattern:/Ns( +[\d|\.|\+|\-|e|E]+)/,KaPattern:/Ka( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,KdPattern:/Kd( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,KsPattern:/Ks( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,setFloor:function(t){this.floor=t},render:function(t,e){t.setModelMatrix(e);for(var i=0,s=this.objects.length;i<s;i++)this.hasMaterials&&this.objects[i].material.mtl?t.setMTL(this.objects[i].material.mtl,this.texturePool):t.setDefaultMTL(),t.drawTriangles(this.objects[i].mesh)},renderWithColor:function(t,e,i){},_loadURLDir:function(t,e,i,s){this.baseUrl=t;var r,o,a=this;r=t+"/"+e+".mtl",o=t+"/"+e+".obj";var n=new XMLHttpRequest;n.open("GET",r,!0),n.responseType="text",n.onload=function(t){if(200==this.status){a._parseMtl(this.response);var e=new XMLHttpRequest;e.open("GET",o,!0),e.responseType="text",e.onload=function(t){200==this.status?(a._parseObj(this.response),i&&i(a),a.hasMaterials=!0):s&&s(this.status)},e.send()}else s&&s(this.status)},n.send()},_parseMtl:function(t){for(var e,i,s,r,o=t.split("\n"),a=0;a<o.length;a++){var n,h=o[a];if(0!==(h=h.trim()).length&&"#"!==h.charAt(0))if(/^newmtl /.test(h)){var l=h.substring(7).trim();e=new YFM.Mesh.MtlItem,this.materials[l]=e}else if(/^map_Kd /.test(h)){var u=h.substring(7).trim();e.setMapKd(u),this.texturePool.addTexture(u,this.baseUrl+"/"+u)}else null!==(n=YFM.Mesh.ObjModel.prototype.NsPattern.exec(h))?e.setNs(parseFloat(n[1])):null!==(n=YFM.Mesh.ObjModel.prototype.KaPattern.exec(h))?(i=parseFloat(n[1]),s=parseFloat(n[2]),r=parseFloat(n[3]),YFM.Math.floatNotZero(i)||YFM.Math.floatNotZero(i)||YFM.Math.floatNotZero(i)?e.setKa(i,s,r):e.setKa(.6,.6,.6)):null!==(n=YFM.Mesh.ObjModel.prototype.KdPattern.exec(h))?e.setKd(parseFloat(n[1]),parseFloat(n[2]),parseFloat(n[3])):null!==(n=YFM.Mesh.ObjModel.prototype.KsPattern.exec(h))&&e.setKs(parseFloat(n[1]),parseFloat(n[2]),parseFloat(n[3]))}},_parseObj:function(t){function e(t){var e=parseInt(t);return 3*(e>=0?e-1:e+c.length/3)}function i(t){var e=parseInt(t);return 3*(e>=0?e-1:e+M.length/3)}function s(t){var e=parseInt(t);return 2*(e>=0?e-1:e+d.length/2)}function r(t,e,i){l.vertices.push(c[t],c[t+1],c[t+2],c[e],c[e+1],c[e+2],c[i],c[i+1],c[i+2])}function o(t,e,i){l.normals.push(M[t],M[t+1],M[t+2],M[e],M[e+1],M[e+2],M[i],M[i+1],M[i+2])}function a(t,e,i){l.uvs.push(d[t],d[t+1],d[e],d[e+1],d[i],d[i+1])}function n(t,n,h,l,u,c,M,d,p,g,f,m){var F=e(t),v=e(n),x=e(h);if(void 0===l?r(F,v,x):(r(F,v,Y=e(l)),r(v,x,Y)),void 0!==u){var F=s(u),v=s(c),x=s(M);void 0===l?a(F,v,x):(a(F,v,Y=s(d)),a(v,x,Y))}if(void 0!==p){var F=i(p),v=i(g),x=i(f);if(void 0===l)o(F,v,x);else{var Y=i(m);o(F,v,Y),o(v,x,Y)}}}var h,l,u,c=[],M=[],d=[];!1===/^o /gm.test(t)&&(h={name:"",geometry:l={vertices:[],normals:[],uvs:[]},material:u={name:""}},this.objects.push(h));for(var p=t.split("\n"),g=0;g<p.length;g++){var f,m=p[g];0!==(m=m.trim()).length&&"#"!==m.charAt(0)&&(null!==(f=YFM.Mesh.ObjModel.prototype.VPattern.exec(m))?c.push(parseFloat(f[1]),parseFloat(f[2]),parseFloat(f[3])):null!==(f=YFM.Mesh.ObjModel.prototype.NPattern.exec(m))?M.push(parseFloat(f[1]),parseFloat(f[2]),parseFloat(f[3])):null!==(f=YFM.Mesh.ObjModel.prototype.UVPattern.exec(m))?d.push(parseFloat(f[1]),parseFloat(f[2])):null!==(f=YFM.Mesh.ObjModel.prototype.FacePattern1.exec(m))?n(f[1],f[2],f[3],f[4]):null!==(f=YFM.Mesh.ObjModel.prototype.FacePattern2.exec(m))?n(f[2],f[5],f[8],f[11],f[3],f[6],f[9],f[12]):null!==(f=YFM.Mesh.ObjModel.prototype.FacePattern3.exec(m))?n(f[2],f[6],f[10],f[14],f[3],f[7],f[11],f[15],f[4],f[8],f[12],f[16]):null!==(f=YFM.Mesh.ObjModel.prototype.FacePattern4.exec(m))?n(f[2],f[5],f[8],f[11],void 0,void 0,void 0,void 0,f[3],f[6],f[9],f[12]):/^[og] /.test(m)?(l={vertices:[],normals:[],uvs:[]},u={name:""},h={name:m.substring(2).trim(),geometry:l,material:u},this.objects.push(h)):/^usemtl /.test(m)?u&&(u.name=m.substring(7).trim(),u.mtl=this.materials[u.name]):/^mtllib /.test(m)||/^s /.test(m))}for(var g=0,F=this.objects.length;g<F;g++){var v=this.objects[g],x=v.geometry,Y=new YFM.WebGL.VAttribs(this.gl);Y.addAttributeFlat("position",x.vertices,3),x.normals.length>0&&Y.addAttributeFlat("normal",x.normals,3),x.uvs.length>0&&Y.addAttributeFlat("uv",x.uvs,2),v.mesh=Y}for(var T=[],g=0,F=this.objects.length;g<F;g++){for(var b=0,_=(c=this.objects[g].geometry.vertices).length/3;b<_;b++)T.push(YFM.Math.Vector.pos(c[3*b+0],c[3*b+1],c[3*b+2]));delete this.objects[g].geometry}this.obb=new YFM.Math.OBB(T)}},YFM.Mesh.ObjModelInstance=function(t,e,i){if(this.set=t,this.pool=e,this.name=i,this.model=null,this.model=this.pool.getModelByName(this.name),this.model)this.obb=new YFM.Math.OBB(this.model.obb),this.pending=!1;else{var s=[];s.push(YFM.Math.Vector.pos(1,1,1)),s.push(YFM.Math.Vector.pos(-1,1,1)),s.push(YFM.Math.Vector.pos(-1,-1,1)),s.push(YFM.Math.Vector.pos(1,-1,1)),s.push(YFM.Math.Vector.pos(1,1,-1)),s.push(YFM.Math.Vector.pos(-1,1,-1)),s.push(YFM.Math.Vector.pos(-1,-1,-1)),s.push(YFM.Math.Vector.pos(1,-1,-1)),this.obb=new YFM.Math.OBB(s),this.pending=!0}this.instanceMat=YFM.Math.Matrix.mat(),this.azimuth=0,this.scale=1,this.position=YFM.Math.Vector.pos(0,0,0),this.visibility=!0},YFM.Mesh.ObjModelInstance.prototype={constructor:YFM.Mesh.ObjModelInstance,setVisibility:function(t){this.visibility=t},setModelArguments:function(t,e,i){var s=YFM.Math.Matrix;this.instanceMat=s.postTranslate(s.postRotate3d(s.postRotate3d(s.scale(e,0,0,0),90,1,0,0),t,0,0,1),i[0],i[1],i[2]),this.azimuth=t,this.scale=e,this.position[0]=i[0],this.position[1]=i[1],this.position[2]=i[2],this.obb.transform(YFM.Math.Matrix.matClone(this.instanceMat))},render:function(t){if(this.visibility){if(!this.model){var e=this.pool.getModelByName(this.name);e&&(this.model=e)}this.model&&this.model.render(t,this.instanceMat)}}},YFM.Mesh.DodecahedronMesh=function(t,e){this._init(t,e)},YFM.Mesh.DodecahedronMesh.prototype={constructor:YFM.Mesh.DodecahedronMesh,getMeshVBO:function(){return this.meshVBO},getMeshBufSize:function(){return this.meshBufSize},_init:function(t,e){this.mesh=[],this._dodecahedron(e),this.meshVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.meshVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(this.mesh,3),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),this.meshBufSize=this.mesh.length/2,this.mesh=null},_dodecahedron:function(t){var e=(1+Math.sqrt(5))/2,i=1/e,s=[];s.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,-1,-1))),s.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,-1,1))),s.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,1,-1))),s.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,1,1))),s.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,-1,-1))),s.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,-1,1))),s.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,1,-1))),s.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,1,1))),s.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,-i,-e))),s.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,-i,e))),s.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,i,-e))),s.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,i,e))),s.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-i,-e,0))),s.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-i,e,0))),s.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(i,-e,0))),s.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(i,e,0))),s.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-e,0,-i))),s.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(e,0,-i))),s.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-e,0,i))),s.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(e,0,i))),this._divideTriangle(s[3],s[11],s[7],t),this._divideTriangle(s[3],s[7],s[15],t),this._divideTriangle(s[3],s[15],s[13],t),this._divideTriangle(s[7],s[19],s[17],t),this._divideTriangle(s[7],s[17],s[6],t),this._divideTriangle(s[7],s[6],s[15],t),this._divideTriangle(s[17],s[4],s[8],t),this._divideTriangle(s[17],s[8],s[10],t),this._divideTriangle(s[17],s[10],s[6],t),this._divideTriangle(s[8],s[0],s[16],t),this._divideTriangle(s[8],s[16],s[2],t),this._divideTriangle(s[8],s[2],s[10],t),this._divideTriangle(s[0],s[12],s[1],t),this._divideTriangle(s[0],s[1],s[18],t),this._divideTriangle(s[0],s[18],s[16],t),this._divideTriangle(s[6],s[10],s[2],t),this._divideTriangle(s[6],s[2],s[13],t),this._divideTriangle(s[6],s[13],s[15],t),this._divideTriangle(s[2],s[16],s[18],t),this._divideTriangle(s[2],s[18],s[3],t),this._divideTriangle(s[2],s[3],s[13],t),this._divideTriangle(s[18],s[1],s[9],t),this._divideTriangle(s[18],s[9],s[11],t),this._divideTriangle(s[18],s[11],s[3],t),this._divideTriangle(s[4],s[14],s[12],t),this._divideTriangle(s[4],s[12],s[0],t),this._divideTriangle(s[4],s[0],s[8],t),this._divideTriangle(s[11],s[9],s[5],t),this._divideTriangle(s[11],s[5],s[19],t),this._divideTriangle(s[11],s[19],s[7],t),this._divideTriangle(s[19],s[5],s[14],t),this._divideTriangle(s[19],s[14],s[4],t),this._divideTriangle(s[19],s[4],s[17],t),this._divideTriangle(s[1],s[12],s[14],t),this._divideTriangle(s[1],s[14],s[5],t),this._divideTriangle(s[1],s[5],s[9],t)},_divideTriangle:function(t,e,i,s){if(s>0){var r=YFM.Math.Vector.mix(t,e,.5),o=YFM.Math.Vector.mix(t,i,.5),a=YFM.Math.Vector.mix(e,i,.5);r=YFM.Math.Vector.normalize(r),o=YFM.Math.Vector.normalize(o),a=YFM.Math.Vector.normalize(a),this._divideTriangle(t,r,o,s-1),this._divideTriangle(r,e,a,s-1),this._divideTriangle(a,i,o,s-1),this._divideTriangle(r,a,o,s-1)}else this._triangle(t,e,i)},_triangle:function(t,e,i){var s=YFM.Math.Vector.sub(e,t),r=YFM.Math.Vector.sub(i,e),o=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(s,r));this.mesh.push(t),this.mesh.push(o),this.mesh.push(e),this.mesh.push(o),this.mesh.push(i),this.mesh.push(o)}},YFM.Mesh.HexahedronMesh=function(t,e){this._init(t,e)},YFM.Mesh.HexahedronMesh.prototype={constructor:YFM.Mesh.HexahedronMesh,getMeshVBO:function(){return this.meshVBO},getMeshBufSize:function(){return this.meshBufSize},_init:function(t,e){this.mesh=[],this._hexahedron(e),this.meshVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.meshVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(this.mesh,3),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),this.meshBufSize=this.mesh.length/2,this.mesh=null},_hexahedron:function(t){var e=[],i=Math.sqrt(2)/2;e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,1,-i))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,0,-i))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,-1,-i))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,0,-i))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,1,i))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,0,i))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,-1,i))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,0,i))),this._divideTriangle(e[0],e[1],e[3],t),this._divideTriangle(e[3],e[1],e[2],t),this._divideTriangle(e[4],e[7],e[5],t),this._divideTriangle(e[5],e[7],e[6],t),this._divideTriangle(e[7],e[3],e[6],t),this._divideTriangle(e[6],e[3],e[2],t),this._divideTriangle(e[6],e[2],e[5],t),this._divideTriangle(e[5],e[2],e[1],t),this._divideTriangle(e[4],e[5],e[0],t),this._divideTriangle(e[0],e[5],e[1],t),this._divideTriangle(e[7],e[4],e[0],t),this._divideTriangle(e[0],e[3],e[7],t)},_divideTriangle:function(t,e,i,s){if(s>0){var r=YFM.Math.Vector.mix(t,e,.5),o=YFM.Math.Vector.mix(t,i,.5),a=YFM.Math.Vector.mix(e,i,.5);r=YFM.Math.Vector.normalize(r),o=YFM.Math.Vector.normalize(o),a=YFM.Math.Vector.normalize(a),this._divideTriangle(t,r,o,s-1),this._divideTriangle(r,e,a,s-1),this._divideTriangle(a,i,o,s-1),this._divideTriangle(r,a,o,s-1)}else this._triangle(t,e,i)},_triangle:function(t,e,i){var s=YFM.Math.Vector.sub(e,t),r=YFM.Math.Vector.sub(i,e),o=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(s,r));this.mesh.push(t),this.mesh.push(o),this.mesh.push(e),this.mesh.push(o),this.mesh.push(i),this.mesh.push(o)}},YFM.Mesh.IcosahedronMesh=function(t,e){this._init(t,e)},YFM.Mesh.IcosahedronMesh.prototype={constructor:YFM.Mesh.IcosahedronMesh,getMeshVBO:function(){return this.meshVBO},getMeshBufSize:function(){return this.meshBufSize},_init:function(t,e){this.mesh=[],this._icosahedron(e),this.meshVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.meshVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(this.mesh,3),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),this.meshBufSize=this.mesh.length/2,this.mesh=null},_icosahedron:function(t){var e=(1+Math.sqrt(5))/2,i=[];i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,e,0))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,e,0))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,-e,0))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,-e,0))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,-1,e))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,1,e))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,-1,-e))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,1,-e))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(e,0,-1))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(e,0,1))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-e,0,-1))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-e,0,1))),this._divideTriangle(i[0],i[11],i[5],t),this._divideTriangle(i[0],i[5],i[1],t),this._divideTriangle(i[0],i[1],i[7],t),this._divideTriangle(i[0],i[7],i[10],t),this._divideTriangle(i[0],i[10],i[11],t),this._divideTriangle(i[1],i[5],i[9],t),this._divideTriangle(i[5],i[11],i[4],t),this._divideTriangle(i[11],i[10],i[2],t),this._divideTriangle(i[10],i[7],i[6],t),this._divideTriangle(i[7],i[1],i[8],t),this._divideTriangle(i[3],i[9],i[4],t),this._divideTriangle(i[3],i[4],i[2],t),this._divideTriangle(i[3],i[2],i[6],t),this._divideTriangle(i[3],i[6],i[8],t),this._divideTriangle(i[3],i[8],i[9],t),this._divideTriangle(i[4],i[9],i[5],t),this._divideTriangle(i[2],i[4],i[11],t),this._divideTriangle(i[6],i[2],i[10],t),this._divideTriangle(i[8],i[6],i[7],t),this._divideTriangle(i[9],i[8],i[1],t)},_divideTriangle:function(t,e,i,s){if(s>0){var r=YFM.Math.Vector.mix(t,e,.5),o=YFM.Math.Vector.mix(t,i,.5),a=YFM.Math.Vector.mix(e,i,.5);r=YFM.Math.Vector.normalize(r),o=YFM.Math.Vector.normalize(o),a=YFM.Math.Vector.normalize(a),this._divideTriangle(t,r,o,s-1),this._divideTriangle(r,e,a,s-1),this._divideTriangle(a,i,o,s-1),this._divideTriangle(r,a,o,s-1)}else this._triangle(t,e,i)},_triangle:function(t,e,i){var s=YFM.Math.Vector.sub(e,t),r=YFM.Math.Vector.sub(i,e),o=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(s,r));this.mesh.push(t),this.mesh.push(o),this.mesh.push(e),this.mesh.push(o),this.mesh.push(i),this.mesh.push(o)}},YFM.Mesh.OctahedronMesh=function(t,e){this._init(t,e)},YFM.Mesh.OctahedronMesh.prototype={constructor:YFM.Mesh.OctahedronMesh,getMeshVBO:function(){return this.meshVBO},getMeshBufSize:function(){return this.meshBufSize},_init:function(t,e){this.mesh=[],this._octahedron(e),this.meshVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.meshVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(this.mesh,3),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),this.meshBufSize=this.mesh.length/2,this.mesh=null},_octahedron:function(t){var e=[];e.push(YFM.Math.Vector.pos(1,0,0)),e.push(YFM.Math.Vector.pos(-1,0,0)),e.push(YFM.Math.Vector.pos(0,1,0)),e.push(YFM.Math.Vector.pos(0,-1,0)),e.push(YFM.Math.Vector.pos(0,0,1)),e.push(YFM.Math.Vector.pos(0,0,-1)),this._divideTriangle(e[0],e[2],e[4],t),this._divideTriangle(e[0],e[4],e[3],t),this._divideTriangle(e[0],e[3],e[5],t),this._divideTriangle(e[0],e[5],e[2],t),this._divideTriangle(e[1],e[2],e[5],t),this._divideTriangle(e[1],e[5],e[3],t),this._divideTriangle(e[1],e[3],e[4],t),this._divideTriangle(e[1],e[4],e[2],t)},_divideTriangle:function(t,e,i,s){if(s>0){var r=YFM.Math.Vector.mix(t,e,.5),o=YFM.Math.Vector.mix(t,i,.5),a=YFM.Math.Vector.mix(e,i,.5);r=YFM.Math.Vector.normalize(r),o=YFM.Math.Vector.normalize(o),a=YFM.Math.Vector.normalize(a),this._divideTriangle(t,r,o,s-1),this._divideTriangle(r,e,a,s-1),this._divideTriangle(a,i,o,s-1),this._divideTriangle(r,a,o,s-1)}else this._triangle(t,e,i)},_triangle:function(t,e,i){var s=YFM.Math.Vector.sub(e,t),r=YFM.Math.Vector.sub(i,e),o=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(s,r));this.mesh.push(t),this.mesh.push(o),this.mesh.push(e),this.mesh.push(o),this.mesh.push(i),this.mesh.push(o)}},YFM.Mesh.TetrahedronMesh=function(t,e){this._init(t,e)},YFM.Mesh.TetrahedronMesh.prototype={constructor:YFM.Mesh.TetrahedronMesh,getMeshVBO:function(){return this.meshVBO},getMeshBufSize:function(){return this.meshBufSize},_init:function(t,e){this.mesh=[],this._tetrahedron(e),this.meshVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.meshVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(this.mesh,3),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),this.meshBufSize=this.mesh.length/2,this.mesh=null},_tetrahedron:function(t){var e=[];e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,1,1))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,-1,1))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,1,-1))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,-1,-1))),this._divideTriangle(e[2],e[1],e[0],t),this._divideTriangle(e[0],e[3],e[2],t),this._divideTriangle(e[1],e[3],e[0],t),this._divideTriangle(e[2],e[3],e[1],t)},_divideTriangle:function(t,e,i,s){if(s>0){var r=YFM.Math.Vector.mix(t,e,.5),o=YFM.Math.Vector.mix(t,i,.5),a=YFM.Math.Vector.mix(e,i,.5);r=YFM.Math.Vector.normalize(r),o=YFM.Math.Vector.normalize(o),a=YFM.Math.Vector.normalize(a),this._divideTriangle(t,r,o,s-1),this._divideTriangle(r,e,a,s-1),this._divideTriangle(a,i,o,s-1),this._divideTriangle(r,a,o,s-1)}else this._triangle(t,e,i)},_triangle:function(t,e,i){var s=YFM.Math.Vector.sub(e,t),r=YFM.Math.Vector.sub(i,e),o=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(s,r));this.mesh.push(t),this.mesh.push(o),this.mesh.push(e),this.mesh.push(o),this.mesh.push(i),this.mesh.push(o)}},YFM.WebGL.Camera=function(){this.dirty=!0,this.mat_base_view=YFM.Math.Matrix.mat(),this.mat_t_view=YFM.Math.Matrix.mat(),this.mat_view=YFM.Math.Matrix.mat(),this.mat_projection=YFM.Math.Matrix.mat(),this.mat_pv=YFM.Math.Matrix.mat(),this.mat_ipv=YFM.Math.Matrix.mat(),this.mat_iv=YFM.Math.Matrix.mat(),this.quaternion=new YFM.Math.Quaternion,this.pitchEnable=!0,this.pitch=this.DEFAULT_PITCH,this.lookAt=YFM.Math.Vector.vec(0,0,0),this.lookOffset=YFM.Math.Vector.vec(0,0,-400),this.zee=YFM.Math.Vector.vec(0,0,1),this.q0=new YFM.Math.Quaternion(Math.sqrt(.5),0,0,Math.sqrt(.5)),this.q1=new YFM.Math.Quaternion(-Math.sqrt(.5),0,0,Math.sqrt(.5)),this.q2=new YFM.Math.Quaternion,this.enabled=!1,this.deviceOrientation=null,this.screenOrientation=0,this.roll=0,this.alphaOffsetAngle=0;var t=this,e=function(e){t.deviceOrientation=e,t.dirty=!0},i=function(){t.screenOrientation=window.orientation||0};this.connect=function(){window.addEventListener("deviceorientation",e,!1),window.addEventListener("orientationchange",i,!1),t.enabled=!0,t.pitchEnable=!1,t.dirty=!0},this.disconnect=function(){window.removeEventListener("orientationchange",i,!1),window.removeEventListener("deviceorientation",e,!1),t.enabled=!1,t.deviceOrientation=null,t.pitchEnable=!0,t.quaternion=new YFM.Math.Quaternion,t.dirty=!0,t.roll=0},this.ldsN=4,this.ldsIndex=0,this.rgss=[],this.rgss.push(YFM.Math.Vector.vec(0,.25)),this.rgss.push(YFM.Math.Vector.vec(.5,0)),this.rgss.push(YFM.Math.Vector.vec(.75,.5)),this.rgss.push(YFM.Math.Vector.vec(.25,.75))},YFM.WebGL.Camera.prototype={constructor:YFM.WebGL.Camera,DEFAULT_PITCH:-30,setPerspective:function(t,e,i,s){this.mat_projection=YFM.Math.Matrix.perspective(t,e,i,s),this.dirty=!0},setOrthographic:function(t,e,i,s,r,o){this.mat_projection=YFM.Math.Matrix.orthographic(t,e,i,s,r,o),this.dirty=!0},getProjectionMat:function(){return this.mat_projection},getProjectionMatWithLDS:function(t,e){var i=YFM.Math.Matrix.matClone(this.mat_projection),s=YFM.Math.LDS.halton(2,this.ldsIndex),r=YFM.Math.LDS.halton(3,this.ldsIndex);return i[8]+=(s-.5)/t,i[9]+=(r-.5)/e,this.ldsIndex+=1,this.ldsIndex>this.ldsN&&(this.ldsIndex=0),i},getProjectionMatWithRGSS:function(t,e,i){var s=YFM.Math.Matrix.matClone(this.mat_projection),r=this.rgss[t][0],o=this.rgss[t][1];return s[8]+=(2*r-1)/e,s[9]+=(2*o-1)/i,s},getPVMat:function(){return this.dirty&&this._updateViewMat(),this.mat_pv},getIPVMat:function(){return this.dirty&&this._updateViewMat(),this.mat_ipv},getViewMat:function(){return this.dirty&&this._updateViewMat(),this.mat_view},getRoll:function(){return this.roll},getPitch:function(){return this.pitch},setPitch:function(t){this.pitch=t,this.dirty=!0},getEyePos:function(){return this.eyePos},getLookAt:function(){return YFM.Math.Vector.vecClone(this.lookAt)},getAzimuth:function(){var t=YFM.Math.Matrix.rotationFromQuaternion(this.quaternion);return-YFM.Math.Matrix.eulerParamExtractZ(t)},setAzimuth:function(t){this.quaternion.setFromAxisAngle(this.zee,t),this.dirty=!0},setLookAtAzimuth:function(t,e,i,s){this.quaternion.setFromAxisAngle(this.zee,t),this.lookAt[0]=e,this.lookAt[1]=i,this.lookAt[2]=s,this.dirty=!0},setLookAt:function(t,e,i){this.lookAt[0]=t,this.lookAt[1]=e,this.lookAt[2]=i,this.dirty=!0},getLookAt:function(){return YFM.Math.Vector.vecClone(this.lookAt)},getLookOffset:function(){return YFM.Math.Vector.vecClone(this.lookOffset)},getLookOffsetNormal:function(){return this.lookOffset[2]},setLookOffset:function(t,e,i){this.lookOffset[0]=t,this.lookOffset[1]=e,this.lookOffset[2]=i,this.dirty=!0},resetLookOffsetTan:function(){this.lookOffset[0]=0,this.lookOffset[1]=0,this.dirty=!0},_updaeQuaternion:function(){if(!1!==this.enabled&&null!=this.deviceOrientation){var t=YFM.Math.deg2Radian,e=this.deviceOrientation.alpha?t(this.deviceOrientation.alpha)+this.alphaOffsetAngle:0,i=this.deviceOrientation.beta?t(this.deviceOrientation.beta):0,s=this.deviceOrientation.gamma?t(this.deviceOrientation.gamma):0,r=this.screenOrientation?t(this.screenOrientation):0,o=new YFM.Math.Euler(i,e,-s,"YXZ");this.q2.setFromAxisAngle(this.zee,-r),this.quaternion.setFromEuler(o),this.quaternion.premultiply(this.q0),this.quaternion.multiply(this.q1),this.quaternion.multiply(this.q2),this.roll=this.deviceOrientation.gamma?this.deviceOrientation.gamma:0}},_updateViewMat:function(){this._updaeQuaternion();var t=YFM.Math.Matrix.rotationFromQuaternion(this.quaternion),e=YFM.Math.Matrix.mulVec(t,this.lookAt);t=YFM.Math.Matrix.postTranslate(t,-e[0],-e[1],-e[2]);var i=YFM.Math.Matrix.translate(this.lookOffset[0],this.lookOffset[1],this.lookOffset[2]);if(this.pitchEnable){var s=YFM.Math.Matrix.rotate3d(this.pitch,1,0,0);this.mat_view=YFM.Math.Matrix.mul(i,YFM.Math.Matrix.mul(s,t))}else this.mat_view=YFM.Math.Matrix.mul(i,t);this.mat_pv=YFM.Math.Matrix.mul(this.mat_projection,this.mat_view),this.mat_ipv=YFM.Math.Matrix.invert(this.mat_pv),this.dirty=!1}},YFM.WebGL.ModelPool=function(){this.list=[],this.pool={}},YFM.WebGL.ModelPool.prototype={constructor:YFM.WebGL.ModelPool,addModel:function(t,e){return null==this.pool[t]&&(this.pool[t]=e,this.list.push(e),!0)},getModelByName:function(t){return this.pool[t]},getModelCount:function(){return this.list.length},getModelByIndex:function(t){return this.list[t]}},YFM.WebGL.TexturePool=function(t){this.gl=t,this.pool={}},YFM.WebGL.TexturePool.prototype={constructor:YFM.WebGL.TexturePool,addTexture:function(t,e){if(null!=this.pool[t])return!1;var i=new Image,s=new YFM.WebGL.TexturePool.prototype.TextureWrap(t,e,i),r=this;i.crossOrigin="Anonymous",i.onload=function(){r._handleTextureLoaded(s)},i.src=e},addTextureBase64:function(t,e){if(null!=this.pool[t])return!1;var i=new Image,s=new YFM.WebGL.TexturePool.prototype.TextureWrap(t,"data:base64",i),r=this;i.crossOrigin="Anonymous",i.onload=function(){r._handleTextureLoaded(s)},i.src=e},addTextureMip:function(t,e){if(null!=this.pool[t])return!1;var i=new Image,s=new YFM.WebGL.TexturePool.prototype.TextureWrap(t,e,i),r=this;i.crossOrigin="Anonymous",i.onload=function(){r._handleTextureLoadedMip(s)},i.src=e},getTexture:function(t){var e=this.pool[t];return null!=e?{tex:e.tex,w:e.w,h:e.h}:null},_handleTextureLoaded:function(t){this.pool[t.name]=t;var e=this.gl.createTexture();this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.pixelStorei(this.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,t.img),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.bindTexture(this.gl.TEXTURE_2D,null),t.tex=e,t.w=t.img.width,t.h=t.img.height,delete t.img},_handleTextureLoadedMip:function(t){this.pool[t.name]=t;var e=this.gl.createTexture();this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.pixelStorei(this.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,t.img),this.gl.generateMipmap(this.gl.TEXTURE_2D),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR_MIPMAP_LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.REPEAT),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.REPEAT),this.gl.bindTexture(this.gl.TEXTURE_2D,null),t.tex=e,t.w=t.img.width,t.h=t.img.height,delete t.img},TextureWrap:function(t,e,i){this.name=t,this.url=e,this.img=i,this.w=0,this.h=0}},YFM.WebGL.BaseColorProgram=function(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.aColor=t.getAttribLocation(this.program,"aColor"),this.uModelMat=t.getUniformLocation(this.program,"uModelMat"),this.uFloorMat=t.getUniformLocation(this.program,"uFloorMat"),this.uRegionMat=t.getUniformLocation(this.program,"uRegionMat"),this.uViewMat=t.getUniformLocation(this.program,"uViewMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjectionMat"),this.uMapHeight=t.getUniformLocation(this.program,"uMapHeight"),this.uTex=t.getUniformLocation(this.program,"uTex"),this.uColorFlag=t.getUniformLocation(this.program,"uColorFlag"),this.dummyTex=t.createTexture(),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.dummyTex),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,null)},YFM.WebGL.BaseColorProgram.prototype={constructor:YFM.WebGL.BaseColorProgram,useProgram:function(){this.gl.useProgram(this.program),this.gl.bindTexture(this.gl.TEXTURE_2D,this.dummyTex)},bindTexture:function(t){this.gl.activeTexture(this.gl.TEXTURE0),this.gl.uniform1i(this.uTex,0),this.gl.bindTexture(this.gl.TEXTURE_2D,t)},setColorFlag:function(t){this.gl.uniform1i(this.uColorFlag,t)},drawTriangles:function(t,e){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,4,this.gl.FLOAT,!1,32,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aColor,4,this.gl.FLOAT,!1,32,16),this.gl.enableVertexAttribArray(this.aColor),this.gl.drawArrays(this.gl.TRIANGLES,0,e)},drawTrianglesPlus:function(t,e,i){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,4,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,e),this.gl.vertexAttribPointer(this.aColor,4,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.aColor),this.gl.drawArrays(this.gl.TRIANGLES,0,i),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null)},drawPoints:function(t,e){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,24,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aColor,3,this.gl.FLOAT,!1,24,12),this.gl.enableVertexAttribArray(this.aColor),this.gl.drawArrays(this.gl.POINTS,0,e),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null)},drawLines:function(t,e,i){null!=i&&this.gl.lineWidth(i),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,4,this.gl.FLOAT,!1,32,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aColor,4,this.gl.FLOAT,!1,32,16),this.gl.enableVertexAttribArray(this.aColor),this.gl.drawArrays(this.gl.LINES,0,e),null!=i&&this.gl.lineWidth(1)},getProgram:function(){return this.program},setMapHeight:function(t){this.gl.uniform1f(this.uMapHeight,t)},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uViewMat,!1,YFM.Math.flatten(t))},setRegionMatrix:function(t){this.gl.uniformMatrix4fv(this.uRegionMat,!1,YFM.Math.flatten(t))},setFloorMatrix:function(t){this.gl.uniformMatrix4fv(this.uFloorMat,!1,YFM.Math.flatten(t))},setModelMatrix:function(t){this.gl.uniformMatrix4fv(this.uModelMat,!1,YFM.Math.flatten(t))},vshader:"attribute  vec4 aPosition;\nattribute  vec4 aColor;\nuniform mat4 uModelMat;\nuniform mat4 uFloorMat;\nuniform mat4 uRegionMat;\nuniform mat4 uViewMat;\nuniform mat4 uProjectionMat;\nuniform float uMapHeight;\nvarying vec4 vColor;\nvoid main()\n{\n\tvec4 pos = vec4(aPosition.x, uMapHeight-aPosition.y, aPosition.z, 1.0);\n\tgl_Position = uProjectionMat*uViewMat*uRegionMat*uFloorMat*uModelMat*pos;\n   gl_PointSize = 4.0;\n\tvColor = aColor;\n}\n",fshader:"precision mediump float;\nuniform int        uColorFlag;\nuniform sampler2D  uTex;\nvarying vec4 vColor;\nvoid main()\n{\n       if(1 == uColorFlag)\n           gl_FragColor = vColor;\n       else\n           gl_FragColor = texture2D(uTex, vColor.xy);\n}\n"},YFM.WebGL.BasePhongProgram=function(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.aColor=t.getAttribLocation(this.program,"aColor"),this.aNormal=t.getAttribLocation(this.program,"aNormal"),this.uAmbient=t.getUniformLocation(this.program,"uAmbient"),this.uDiffuse=t.getUniformLocation(this.program,"uDiffuse"),this.uFloorMat=t.getUniformLocation(this.program,"uFloorMat"),this.uPVRMat=t.getUniformLocation(this.program,"uPVRMat"),this.uNormalMat=t.getUniformLocation(this.program,"uNormalMat"),this.uMapHeight=t.getUniformLocation(this.program,"uMapHeight"),this.uHeightScale=t.getUniformLocation(this.program,"uHeightScale"),this.uLightPos=t.getUniformLocation(this.program,"uLightPos"),this.uLighting=t.getUniformLocation(this.program,"uLighting"),this.uLighting=t.getUniformLocation(this.program,"uLighting")},YFM.WebGL.BasePhongProgram.prototype={constructor:YFM.WebGL.BasePhongProgram,useProgram:function(){this.gl.useProgram(this.program)},drawTriangles:function(t,e,i){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,4,this.gl.FLOAT,!1,32,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aNormal,4,this.gl.FLOAT,!1,32,16),this.gl.enableVertexAttribArray(this.aNormal),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,e),this.gl.vertexAttribPointer(this.aColor,4,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.aColor),this.gl.drawArrays(this.gl.TRIANGLES,0,i)},drawLines:function(t,e,i){null!=i&&this.gl.lineWidth(i),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!0,36,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aColor,3,this.gl.FLOAT,!1,36,12),this.gl.enableVertexAttribArray(this.aColor),this.gl.vertexAttribPointer(this.aNormal,3,this.gl.FLOAT,!1,36,24),this.gl.enableVertexAttribArray(this.aNormal),this.gl.drawArrays(this.gl.LINES,0,e),null!=i&&this.gl.lineWidth(1)},getProgram:function(){return this.program},setLightPos:function(t){this.gl.uniform4fv(this.uLightPos,t)},setAmbient:function(t){this.gl.uniform4fv(this.uAmbient,t)},setDiffuse:function(t){this.gl.uniform4fv(this.uDiffuse,t)},setLighting:function(t){this.gl.uniform1i(this.uLighting,t)},setMapHeight:function(t){this.gl.uniform1f(this.uMapHeight,t)},setHeightScale:function(t){this.gl.uniform1f(this.uHeightScale,t)},setNormalMatrix:function(t){this.gl.uniformMatrix4fv(this.uNormalMat,!1,YFM.Math.flatten(t))},setPVRMatrix:function(t){this.gl.uniformMatrix4fv(this.uPVRMat,!1,YFM.Math.flatten(t))},setFloorMatrix:function(t){this.gl.uniformMatrix4fv(this.uFloorMat,!1,YFM.Math.flatten(t))},vshader:"attribute vec4 aPosition;  \nattribute vec4 aNormal;    \nattribute vec4 aColor;     \nuniform int    uLighting;  \nuniform vec4   uAmbient;   \nuniform vec4   uDiffuse;   \nuniform float  uSelectArg; \nuniform float  uMapHeight; \nuniform float  uHeightScale;\nuniform mat4   uFloorMat;  \nuniform mat4   uPVRMat;    \nuniform mat4   uNormalMat; \nuniform vec4   uLightPos;  \nvarying vec4   vColor;     \n                           \nvoid main(){               \n   vec4 tPos = vec4(aPosition.x, uMapHeight-aPosition.y, aPosition.z*uHeightScale+1.0, 1.0);\n   vec4 color;                                                     \n   if(1 == uLighting){\n       vec3 L = normalize(uLightPos.xyz);                  \n       vec3 N = normalize((uNormalMat*aNormal).xyz);       \n       float Kd = max( dot(L, N), 0.0 );                   \n       vec4 diffuse = Kd*uDiffuse;                         \n       vColor = aColor*uAmbient+aColor*diffuse;            \n   }else{                                                  \n       vColor = aColor;                                    \n   }                                                       \n   gl_Position = uPVRMat * uFloorMat * tPos;               \n}\n",fshader:"precision mediump float;                                   \nvarying vec4                   vColor;                     \nvoid main() {                                              \n       gl_FragColor = vColor;                              \n}\n"},YFM.WebGL.BillboardIconProgram=function(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.aTexCoord=t.getAttribLocation(this.program,"aTexCoord"),this.uTex=t.getUniformLocation(this.program,"uTex"),this.uModelMat=t.getUniformLocation(this.program,"uModelMat"),this.uRegionMat=t.getUniformLocation(this.program,"uRegionMat"),this.uiViewMat=t.getUniformLocation(this.program,"uiViewMat"),this.uViewMat=t.getUniformLocation(this.program,"uViewMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjMat")},YFM.WebGL.BillboardIconProgram.prototype={constructor:YFM.WebGL.BillboardIconProgram,useProgram:function(){this.gl.useProgram(this.program)},bindTexture:function(t){this.gl.activeTexture(this.gl.TEXTURE0),this.gl.uniform1i(this.uTex,0),this.gl.bindTexture(this.gl.TEXTURE_2D,t)},drawTriangles:function(t,e,i){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!0,24,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aTexCoord,3,this.gl.FLOAT,!1,24,12),this.gl.enableVertexAttribArray(this.aTexCoord),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.drawArrays(this.gl.TRIANGLES,i,e),this.gl.disable(this.gl.BLEND)},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uViewMat,!1,YFM.Math.flatten(t))},setIViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uiViewMat,!1,YFM.Math.flatten(t))},setRegionMatrix:function(t){this.gl.uniformMatrix4fv(this.uRegionMat,!1,YFM.Math.flatten(t))},setModelMatrix:function(t){this.gl.uniformMatrix4fv(this.uModelMat,!1,YFM.Math.flatten(t))},vshader:"attribute vec4  aPosition; \nattribute vec3  aTexCoord; \nvarying vec3 vTexCoord;    \nuniform mat4   uModelMat;  \nuniform mat4   uRegionMat; \nuniform mat4   uiViewMat;  \nuniform mat4   uViewMat;   \nuniform mat4   uProjMat;   \nvoid main( void ) {                            \n    vTexCoord = aTexCoord;                     \n    gl_Position = uProjMat*uViewMat*uRegionMat*uModelMat*uiViewMat*aPosition;\n}\n",fshader:"precision mediump float;                       \nvarying vec3 vTexCoord;                        \nuniform sampler2D uTex;                        \nvoid main() {                                  \n   gl_FragColor = texture2D(uTex, vTexCoord.xy);  \n}\n"},YFM.WebGL.Color2DProgram=function(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.uColor=t.getUniformLocation(this.program,"uColor"),this.uModelMat=t.getUniformLocation(this.program,"uModelMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjMat")},YFM.WebGL.Color2DProgram.prototype={constructor:YFM.WebGL.Color2DProgram,useProgram:function(){this.gl.useProgram(this.program)},draw:function(t,e,i){var s=t.getAttribute("position");if(null!==s){if(s.length<=0)return;this.gl.uniform4fv(this.uColor,YFM.Math.flatten(i)),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,s.vbo),this.gl.vertexAttribPointer(this.aPosition,s.size,this.gl.FLOAT,!1,4*s.size,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.drawArrays(e,0,s.length)}},drawTriangles:function(t,e,i,s){this.gl.uniform4fv(this.uColor,YFM.Math.flatten(e)),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,12,i),this.gl.enableVertexAttribArray(this.aPosition),this.gl.drawArrays(this.gl.TRIANGLES,0,s)},setColor:function(t){this.gl.uniform4fv(this.uColor,YFM.Math.flatten(t))},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setModelMatrix:function(t){this.gl.uniformMatrix4fv(this.uModelMat,!1,YFM.Math.flatten(t))},vshader:"attribute vec4 aPosition;\nuniform mat4   uModelMat;\nuniform mat4   uProjMat;\nuniform vec4   uColor;\nvarying vec4   vColor;\nvoid main( void ) {                            \n    gl_Position = uProjMat*uModelMat*aPosition;\n    vColor = uColor;                           \n}\n",fshader:"precision mediump float;                       \nvarying vec4   vColor;                         \nvoid main() {                                  \n   gl_FragColor = vColor;                      \n}\n"},YFM.WebGL.Marker2DProgram=function(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.aTexCoord=t.getAttribLocation(this.program,"aTexCoord"),this.uTex=t.getUniformLocation(this.program,"uTex"),this.uModelMat=t.getUniformLocation(this.program,"uModelMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjMat")},YFM.WebGL.Marker2DProgram.prototype={constructor:YFM.WebGL.Marker2DProgram,useProgram:function(){this.gl.useProgram(this.program)},bindTexture:function(t){this.gl.activeTexture(this.gl.TEXTURE0),this.gl.uniform1i(this.uTex,0),this.gl.bindTexture(this.gl.TEXTURE_2D,t)},drawTriangles:function(t,e,i){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,24,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aTexCoord,3,this.gl.FLOAT,!1,24,12),this.gl.enableVertexAttribArray(this.aTexCoord),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.drawArrays(this.gl.TRIANGLES,i,e),this.gl.disable(this.gl.BLEND)},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setModelMatrix:function(t){this.gl.uniformMatrix4fv(this.uModelMat,!1,YFM.Math.flatten(t))},vshader:"attribute vec4  aPosition; \nattribute vec3  aTexCoord; \nuniform mat4   uModelMat;  \nuniform mat4   uProjMat;   \nvarying vec3   vTexCoord;  \nvoid main( void ) {                            \n    vTexCoord = aTexCoord;                     \n    gl_Position = uProjMat*uModelMat*aPosition;\n}\n",fshader:"precision mediump float;                       \nvarying vec3 vTexCoord;                        \nuniform sampler2D uTex;                        \nvoid main() {                                  \n   gl_FragColor = texture2D(uTex, vTexCoord.xy);  \n}\n"},YFM.WebGL.ModelPhongProgram=function(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.aNormal=t.getAttribLocation(this.program,"aNormal"),this.aTexCoord=t.getAttribLocation(this.program,"aTexCoord"),this.uNs=t.getUniformLocation(this.program,"uNs"),this.uKa=t.getUniformLocation(this.program,"uKa"),this.uKd=t.getUniformLocation(this.program,"uKd"),this.uKs=t.getUniformLocation(this.program,"uKs"),this.uTexFlag=t.getUniformLocation(this.program,"uTexFlag"),this.uTex=t.getUniformLocation(this.program,"uTex"),this.uColorFlag=t.getUniformLocation(this.program,"uColorFlag"),this.uColor=t.getUniformLocation(this.program,"uColor"),this.uModelMat=t.getUniformLocation(this.program,"uModelMat"),this.uFloorMat=t.getUniformLocation(this.program,"uFloorMat"),this.uRegionMat=t.getUniformLocation(this.program,"uRegionMat"),this.uViewMat=t.getUniformLocation(this.program,"uViewMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjMat"),this.uNormalMat=t.getUniformLocation(this.program,"uNormalMat"),this.uLightPos=t.getUniformLocation(this.program,"uLightPos"),this.defaultNs=32,this.defaultColor=YFM.Math.Vector.pos(1,1,1),this.defaultKa=YFM.Math.Vector.pos(.3,.3,.3),this.defaultKd=YFM.Math.Vector.pos(1,1,1),this.defaultKs=YFM.Math.Vector.pos(.1,.1,.1)},YFM.WebGL.ModelPhongProgram.prototype={constructor:YFM.WebGL.ModelPhongProgram,useProgram:function(){this.gl.useProgram(this.program)},drawLines:function(t,e,i,s){this.gl.uniform1f(this.uNs,this.defaultNs),this.gl.uniform4fv(this.uKa,this.defaultKa),this.gl.uniform4fv(this.uKd,this.defaultKd),this.gl.uniform4fv(this.uKs,this.defaultKs),this.gl.uniform1i(this.uTexFlag,0),this.gl.uniform1i(this.uColorFlag,1),this.gl.uniform4fv(this.uColor,e),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!0,12,i),this.gl.enableVertexAttribArray(this.aPosition),this.gl.drawArrays(this.gl.LINES,0,s)},drawTriangles:function(t){var e,i,s;e=t.getAttribute("position"),i=t.getAttribute("normal"),s=t.getAttribute("uv"),null!==e?(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,e.vbo),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,12,0),this.gl.enableVertexAttribArray(this.aPosition)):this.gl.disableVertexAttribArray(this.aPosition),null!=i?(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,i.vbo),this.gl.vertexAttribPointer(this.aNormal,3,this.gl.FLOAT,!1,12,0),this.gl.enableVertexAttribArray(this.aNormal)):this.gl.disableVertexAttribArray(this.aNormal),null!=s?(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,s.vbo),this.gl.vertexAttribPointer(this.aTexCoord,2,this.gl.FLOAT,!1,8,0),this.gl.enableVertexAttribArray(this.aTexCoord)):this.gl.disableVertexAttribArray(this.aTexCoord),this.gl.drawArrays(this.gl.TRIANGLES,0,e.length)},setTexFlag:function(t){this.gl.uniform1i(this.uTexFlag,t)},bindTexture:function(t){this.gl.activeTexture(this.gl.TEXTURE0),this.gl.uniform1i(this.uTex,0),this.gl.bindTexture(this.gl.TEXTURE_2D,t)},setMTL:function(t,e){if(this.gl.uniform1f(this.uNs,t.getNs()),this.gl.uniform4fv(this.uKa,YFM.Math.flatten(t.getKa())),this.gl.uniform4fv(this.uKd,YFM.Math.flatten(t.getKd())),this.gl.uniform4fv(this.uKs,YFM.Math.flatten(t.getKs())),null!==t.getMapKd()){var i=e.getTexture(t.getMapKd());if(null!=i)return this.gl.uniform1i(this.uTexFlag,1),this.gl.uniform1i(this.uColorFlag,0),void this.bindTexture(i.tex)}this.gl.uniform1i(this.uTexFlag,0),this.gl.uniform1i(this.uColorFlag,1),this.gl.uniform4fv(this.uColor,this.defaultColor)},setDefaultMTL:function(){this.gl.uniform1f(this.uNs,this.defaultNs),this.gl.uniform4fv(this.uKa,this.defaultKa),this.gl.uniform4fv(this.uKd,this.defaultKd),this.gl.uniform4fv(this.uKs,this.defaultKs),this.gl.uniform1i(this.uTexFlag,0),this.gl.uniform1i(this.uColorFlag,1),this.gl.uniform4fv(this.uColor,this.defaultColor)},setColorFlag:function(t){this.gl.uniform1i(this.uColorFlag,t)},setColor:function(t){this.gl.uniform4fv(this.uColor,t)},setLightPos:function(t){this.gl.uniform4fv(this.uLightPos,t)},setNormalMatrix:function(t){this.gl.uniformMatrix4fv(this.uNormalMat,!1,YFM.Math.flatten(t))},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uViewMat,!1,YFM.Math.flatten(t))},setRegionMatrix:function(t){this.gl.uniformMatrix4fv(this.uRegionMat,!1,YFM.Math.flatten(t))},setFloorMatrix:function(t){this.gl.uniformMatrix4fv(this.uFloorMat,!1,YFM.Math.flatten(t))},setModelMatrix:function(t){this.gl.uniformMatrix4fv(this.uModelMat,!1,YFM.Math.flatten(t))},vshader:"attribute vec4 aPosition;  \nattribute vec4 aNormal;    \nattribute vec3 aTexCoord;  \nuniform int    uTexFlag;   \nuniform float  uNs;        \nuniform vec4   uKa;        \nuniform vec4   uKd;        \nuniform vec4   uKs;        \nuniform mat4   uModelMat;  \nuniform mat4   uFloorMat;  \nuniform mat4   uRegionMat; \nuniform mat4   uViewMat;   \nuniform mat4   uProjMat;   \nuniform mat4   uNormalMat; \nuniform vec4   uLightPos;  \nvarying vec3   vTexCoord;  \nvarying vec4   vAmbient;   \nvarying vec4   vDiffuse;   \nvarying vec4   vSpecular;  \n                           \nvoid main(){               \n   mat4 modelViewMatrix = uViewMat*uRegionMat*uFloorMat*uModelMat;\n   vec3 pos = (modelViewMatrix * aPosition).xyz;           \n   vec3 L = normalize((uViewMat*uLightPos).xyz);           \n   vec3 E = -normalize(pos );                              \n   vec3 H = normalize(L + E );                             \n   vec3 N = normalize((uNormalMat*aNormal).xyz);           \n   vAmbient = uKa;                                         \n   vDiffuse = max(dot(L,N), 0.0)*uKd;                      \n   vec4 specular = pow(max(dot(N, H), 0.0), uNs)*uKs;      \n   if(dot(L, N) < 0.0) {                                   \n       specular = vec4(0.0, 0.0, 0.0, 1.0);                \n   }                                                       \n   vSpecular = specular;                                   \n   if(1 == uTexFlag)                                       \n       vTexCoord = vec3(aTexCoord.x, 1.0-aTexCoord.y,0.0); \n   else                                                    \n       vTexCoord = vec3(0.0, 0.0, 0.0);                    \n   gl_Position = uProjMat * modelViewMatrix * aPosition;   \n}\n",fshader:"precision mediump float;       \nuniform int        uColorFlag; \nuniform vec4       uColor;     \nuniform sampler2D  uTex;       \nvarying vec3       vTexCoord;  \nvarying vec4       vAmbient;   \nvarying vec4       vDiffuse;   \nvarying vec4       vSpecular;  \nvoid main() {                  \n       vec4 color;                                                     \n       if(1 == uColorFlag)                                             \n           color = uColor;                                             \n       else                                                            \n           color = texture2D(uTex, vTexCoord.xy);                      \n       gl_FragColor = color*vAmbient+color*vDiffuse+color*vSpecular;   \n}\n"},YFM.WebGL.PointSpiritProgram=function(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.uTex=t.getUniformLocation(this.program,"uTex"),this.uRegionMat=t.getUniformLocation(this.program,"uRegionMat"),this.uViewMat=t.getUniformLocation(this.program,"uViewMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjMat")},YFM.WebGL.PointSpiritProgram.prototype={constructor:YFM.WebGL.PointSpiritProgram,useProgram:function(){this.gl.useProgram(this.program)},bindTexture:function(t){this.gl.activeTexture(this.gl.TEXTURE0),this.gl.uniform1i(this.uTex,0),this.gl.bindTexture(this.gl.TEXTURE_2D,t)},drawPoints:function(t,e){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.drawArrays(this.gl.POINTS,0,e),this.gl.disable(this.gl.BLEND)},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uViewMat,!1,YFM.Math.flatten(t))},setRegionMatrix:function(t){this.gl.uniformMatrix4fv(this.uRegionMat,!1,YFM.Math.flatten(t))},vshader:"attribute vec4  aPosition; \nuniform mat4   uRegionMat; \nuniform mat4   uViewMat;   \nuniform mat4   uProjMat;   \nvoid main( void ) {                            \n    gl_Position = uProjMat*uViewMat*uRegionMat*aPosition;\n    gl_PointSize = 24.0;                        \n}\n",fshader:"precision mediump float;                       \nuniform sampler2D uTex;                        \nvoid main() {                                  \n   gl_FragColor = texture2D(uTex, gl_PointCoord);\n}\n"},YFM.WebGL.RawPanoramaProgram=function(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.uModelMat=t.getUniformLocation(this.program,"uModelMat"),this.uViewMat=t.getUniformLocation(this.program,"uViewMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjectionMat"),this.uTexMap=t.getUniformLocation(this.program,"uTexMap")},YFM.WebGL.RawPanoramaProgram.prototype={constructor:YFM.WebGL.RawPanoramaProgram,useProgram:function(){this.gl.useProgram(this.program)},drawTriangles:function(t,e){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,12,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.drawArrays(this.gl.TRIANGLES,0,e)},getProgram:function(){return this.program},bindTexture:function(t){this.gl.activeTexture(this.gl.TEXTURE0),this.gl.uniform1i(this.uTexMap,0),this.gl.bindTexture(this.gl.TEXTURE_CUBE_MAP,t)},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uViewMat,!1,YFM.Math.flatten(t))},setModelMatrix:function(t){this.gl.uniformMatrix4fv(this.uModelMat,!1,YFM.Math.flatten(t))},vshader:"attribute  vec4 aPosition;\nuniform mat4 uModelMat;\nuniform mat4 uViewMat;\nuniform mat4 uProjectionMat;\nvarying vec3 V;\nvoid main()\n{\n\tgl_Position = uProjectionMat*uViewMat*uModelMat*aPosition;\n   V = normalize(vec3(aPosition.x, aPosition.y, aPosition.z));\n}\n",fshader:"precision mediump float;\nuniform samplerCube uTexMap;\nvarying vec3 V;\nvoid main()\n{\n\tgl_FragColor = textureCube(uTexMap, V);\n}\n"},YFM.WebGL.RegionPhongProgram=function(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.aNormal=t.getAttribLocation(this.program,"aNormal"),this.uColor=t.getUniformLocation(this.program,"uColor"),this.uModelMat=t.getUniformLocation(this.program,"uModelMat"),this.uRegionMat=t.getUniformLocation(this.program,"uRegionMat"),this.uViewMat=t.getUniformLocation(this.program,"uViewMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjMat"),this.uNormalMat=t.getUniformLocation(this.program,"uNormalMat"),this.uLightPos=t.getUniformLocation(this.program,"uLightPos")},YFM.WebGL.RegionPhongProgram.prototype={constructor:YFM.WebGL.RegionPhongProgram,useProgram:function(){this.gl.useProgram(this.program)},drawTriangles:function(t,e,i){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,24,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aNormal,3,this.gl.FLOAT,!1,24,12),this.gl.enableVertexAttribArray(this.aNormal),this.gl.drawArrays(this.gl.TRIANGLES,i,e-i)},drawTrianglesPlus:function(t,e,i){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,24,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aNormal,3,this.gl.FLOAT,!1,24,12),this.gl.enableVertexAttribArray(this.aNormal),this.gl.drawArrays(this.gl.TRIANGLES,e,i-e)},drawLines:function(t,e,i){null!=i&&this.gl.lineWidth(i),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!0,24,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aNormal,3,this.gl.FLOAT,!1,24,12),this.gl.enableVertexAttribArray(this.aNormal),this.gl.drawArrays(this.gl.LINES,0,e),null!=i&&this.gl.lineWidth(1)},setColor:function(t){this.gl.uniform4fv(this.uColor,t)},setLightPos:function(t){this.gl.uniform4fv(this.uLightPos,t)},setNormalMatrix:function(t){this.gl.uniformMatrix4fv(this.uNormalMat,!1,YFM.Math.flatten(t))},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uViewMat,!1,YFM.Math.flatten(t))},setRegionMatrix:function(t){this.gl.uniformMatrix4fv(this.uRegionMat,!1,YFM.Math.flatten(t))},setModelMatrix:function(t){this.gl.uniformMatrix4fv(this.uModelMat,!1,YFM.Math.flatten(t))},vshader:"attribute vec4 aPosition;  \nattribute vec4 aNormal;    \nuniform vec4   uColor;     \nuniform mat4   uModelMat;  \nuniform mat4   uRegionMat; \nuniform mat4   uViewMat;   \nuniform mat4   uProjMat;   \nuniform mat4   uNormalMat; \nuniform vec4   uLightPos;  \nvarying vec4   vColor;     \n                           \nvoid main(){               \n   float shininess = 320.0;                                \n   vec4 ambient, diffuse, specular;                        \n   vec4 ambientProduct = vec4(0.5, 0.5, 0.5, 1.0 );        \n   vec4 diffuseProduct = vec4(1.0, 1.0, 1.0, 1.0 );        \n   vec4 specularProduct= vec4(0.2, 0.2, 0.2, 1.0 );        \n                                                           \n   mat4 modelViewMatrix = uViewMat*uRegionMat*uModelMat;   \n   vec3 pos = (modelViewMatrix * aPosition).xyz;           \n   vec3 L = normalize((uViewMat*uLightPos).xyz);           \n   vec3 E = -normalize(pos );                              \n   vec3 H = normalize(L + E );                             \n   vec3 N = normalize((uNormalMat*aNormal).xyz);           \n   ambient = ambientProduct;                               \n   float Kd = max( dot(L, N), 0.0 );                       \n   diffuse = Kd*diffuseProduct;                            \n   float Ks = pow(max(dot(N, H), 0.0), shininess);         \n   specular = Ks * specularProduct;                        \n   if(dot(L, N) < 0.0) {                                   \n       specular = vec4(0.0, 0.0, 0.0, 1.0);                \n   }                                                       \n   gl_Position = uProjMat * modelViewMatrix * aPosition;   \n   vColor = uColor*ambient+uColor*diffuse+uColor*specular; \n}\n",fshader:"precision mediump float;                                   \nvarying vec4                   vColor;                     \nvoid main() {                                              \n       gl_FragColor = vColor;                              \n}\n"},YFM.WebGL.SSRProgram=function(t,e){this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.aTexCoord=t.getAttribLocation(this.program,"aTexCoord"),this.aLineDist=t.getAttribLocation(this.program,"aLineDist"),this.uTime=t.getUniformLocation(this.program,"uTime"),this.uHH=t.getUniformLocation(this.program,"uHH"),this.uHW=t.getUniformLocation(this.program,"uHW"),this.uTotalLen=t.getUniformLocation(this.program,"uTotalLen"),this.uNaviArg=t.getUniformLocation(this.program,"uNaviArg"),this.uTranFlag=t.getUniformLocation(this.program,"uTranFlag"),this.uLimitFlag=t.getUniformLocation(this.program,"uLimitFlag"),this.uLimitMin=t.getUniformLocation(this.program,"uLimitMin"),this.uLimitMax=t.getUniformLocation(this.program,"uLimitMax"),this.useProgram(),this.setHH(e.hh),this.setHW(e.hw)},YFM.WebGL.SSRProgram.prototype={constructor:YFM.WebGL.SSRProgram,useProgram:function(){this.gl.useProgram(this.program)},bindTexture:function(t){this.gl.activeTexture(this.gl.TEXTURE0),this.gl.uniform1i(this.uTex,0),this.gl.bindTexture(this.gl.TEXTURE_2D,t)},drawTriangleStrip:function(t,e,i){var s=t.getAttribute("position"),r=t.getAttribute("uv");if(null!==s){if(s.length<=0)return;if(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,s.vbo),this.gl.vertexAttribPointer(this.aPosition,s.size,this.gl.FLOAT,!1,4*s.size,0),this.gl.enableVertexAttribArray(this.aPosition),null!==r){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,r.vbo),this.gl.vertexAttribPointer(this.aTexCoord,2,this.gl.FLOAT,!1,8,0),this.gl.enableVertexAttribArray(this.aTexCoord);var o=i||s.length-e;this.gl.drawArrays(this.gl.TRIANGLE_STRIP,e,o)}}},setTime:function(t){this.gl.uniform1f(this.uTime,t)},setHH:function(t){this.gl.uniform1f(this.uHH,t)},setHW:function(t){this.gl.uniform1f(this.uHW,t)},setTranFlag:function(t){this.gl.uniform1i(this.uTranFlag,t)},vshader:"attribute  vec4 aPosition; \nattribute vec3  aTexCoord; \nuniform float uTime;       \nuniform float uHH;         \nuniform float uHW;         \nvarying vec3   vTexCoord;  \nvoid main(){               \n   gl_Position = vec4(aPosition.x/uHW, aPosition.y/uHH, aPosition.z, 1.0);\n   vTexCoord = vec3(aTexCoord.x, aTexCoord.y + uTime, 0.0);\n}\n",fshader:"precision mediump float;   \nvarying vec3 vTexCoord;    \nuniform int   uTranFlag;   \nuniform sampler2D uTex;    \nvoid main(){\n   vec4 c = texture2D(uTex, vTexCoord.xy);     \n   if(1 == uTranFlag)                          \n       gl_FragColor = c*vec4(0.3,0.3,0.3,0.3); \n   else                                        \n       gl_FragColor = c;                       \n}\n"},YFM.WebGL.SelectColorProgram=function(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.uModelMat=t.getUniformLocation(this.program,"uModelMat"),this.uRegionMat=t.getUniformLocation(this.program,"uRegionMat"),this.uViewMat=t.getUniformLocation(this.program,"uViewMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjectionMat"),this.uColor=t.getUniformLocation(this.program,"uColor")},YFM.WebGL.SelectColorProgram.prototype={constructor:YFM.WebGL.SelectColorProgram,useProgram:function(){this.gl.useProgram(this.program)},drawTriangles:function(t,e,i,s){this.gl.uniform4fv(this.uColor,YFM.Math.flatten(e)),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,12,i),this.gl.enableVertexAttribArray(this.aPosition),this.gl.drawArrays(this.gl.TRIANGLES,0,s)},drawLines:function(t,e,i,s){this.gl.uniform4fv(this.uColor,YFM.Math.flatten(e)),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!0,12,i),this.gl.enableVertexAttribArray(this.aPosition),this.gl.drawArrays(this.gl.LINES,0,s)},setColor:function(t){this.gl.uniform4fv(this.uColor,YFM.Math.flatten(t))},drawLinesPlus:function(t,e){var i=t.getAttribute("position");if(null!==i){if(i.length<=0)return;this.gl.bindBuffer(this.gl.ARRAY_BUFFER,i.vbo),this.gl.vertexAttribPointer(this.aPosition,i.size,this.gl.FLOAT,!1,4*i.size,0),this.gl.enableVertexAttribArray(this.aPosition),e&&this.gl.lineWidth(e),this.gl.drawArrays(this.gl.LINES,0,i.length),e&&this.gl.lineWidth(1)}},drawLineStripPlus:function(t,e){var i=t.getAttribute("position");if(null!==i){if(i.length<=0)return;this.gl.bindBuffer(this.gl.ARRAY_BUFFER,i.vbo),this.gl.vertexAttribPointer(this.aPosition,i.size,this.gl.FLOAT,!1,4*i.size,0),this.gl.enableVertexAttribArray(this.aPosition),e&&this.gl.lineWidth(e),this.gl.drawArrays(this.gl.LINE_STRIP,0,i.length),e&&this.gl.lineWidth(1)}},getProgram:function(){return this.program},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uViewMat,!1,YFM.Math.flatten(t))},setRegionMatrix:function(t){this.gl.uniformMatrix4fv(this.uRegionMat,!1,YFM.Math.flatten(t))},setModelMatrix:function(t){this.gl.uniformMatrix4fv(this.uModelMat,!1,YFM.Math.flatten(t))},vshader:"attribute  vec4 aPosition;\nuniform vec4 uColor;\nuniform mat4 uModelMat;\nuniform mat4 uRegionMat;\nuniform mat4 uViewMat;\nuniform mat4 uProjectionMat;\nvarying vec4 vColor;\nvoid main()\n{\n\tgl_Position = uProjectionMat*uViewMat*uRegionMat*uModelMat*aPosition;\n\tvColor = uColor;\n}\n",fshader:"precision mediump float;\nvarying vec4 vColor;\nvoid main()\n{\n\tgl_FragColor = vColor;\n}\n"},YFM.WebGL.TrajectoryProgram=function(t,e){this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.aTexCoord=t.getAttribLocation(this.program,"aTexCoord"),this.uPVRMat=t.getUniformLocation(this.program,"uPVRMat"),this.uFloorMat=t.getUniformLocation(this.program,"uFloorMat"),this.uMapHeight=t.getUniformLocation(this.program,"uMapHeight"),this.uTime=t.getUniformLocation(this.program,"uTime"),this.uTex=t.getUniformLocation(this.program,"uTex")},YFM.WebGL.TrajectoryProgram.prototype={constructor:YFM.WebGL.TrajectoryProgram,useProgram:function(){this.gl.useProgram(this.program)},bindTexture:function(t){this.gl.activeTexture(this.gl.TEXTURE0),this.gl.uniform1i(this.uTex,0),this.gl.bindTexture(this.gl.TEXTURE_2D,t)},drawTriangleStrip:function(t){var e=t.getAttribute("pos"),i=t.getAttribute("uv"),s=t.getAttribute("index");if(null!==e){if(e.length<=0)return;this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,s.vbo),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,e.vbo),this.gl.vertexAttribPointer(this.aPosition,e.size,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,i.vbo),this.gl.vertexAttribPointer(this.aTexCoord,i.size,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.aTexCoord),this.gl.drawElements(this.gl.TRIANGLE_STRIP,s.length,this.gl.UNSIGNED_SHORT,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,null)}},setPVRMat:function(t){this.gl.uniformMatrix4fv(this.uPVRMat,!1,YFM.Math.flatten(t))},setFloorMat:function(t){this.gl.uniformMatrix4fv(this.uFloorMat,!1,YFM.Math.flatten(t))},setTime:function(t){this.gl.uniform1f(this.uTime,t)},setMapHeight:function(t){this.gl.uniform1f(this.uMapHeight,t)},vshader:"attribute vec2 aPosition;  \nattribute vec3 aTexCoord;  \nuniform mat4 uPVRMat;      \nuniform mat4 uFloorMat;    \nuniform float uMapHeight;  \nuniform float uTime;       \nvarying vec3 vTexCoord;    \nvoid main(){               \n   vec4 pos = vec4(aPosition.x, uMapHeight-aPosition.y, 1.0, 1.0);\n\tgl_Position = uPVRMat*uFloorMat*pos; \n   vTexCoord = vec3(aTexCoord.x, aTexCoord.y + uTime, aTexCoord.z);\n}\n",fshader:"precision mediump float;   \nuniform sampler2D uTex;    \nvarying vec3 vTexCoord;    \nvoid main(){               \n   gl_FragColor = texture2D(uTex, vTexCoord.xy);         \n}\n"},YFM.WebGL.Rays=function(t){this.region=region,this.rays=null,this.vArray=[]},YFM.WebGL.Rays.prototype={constructor:YFM.WebGL.Rays,addRay:function(t){var e=YFM.Math.Vector,i=e.pos(t[0],t[1],t[2]),s=e.vec(t[4],t[5],t[6]),r=e.add(i,s);this.vArray.push(i),this.vArray.push(r)},build:function(){this.rays=new YFM.WebGL.VAttribs(this.region.gl),this.rays.addAttribute("position",this.vArray,3,!1)},clean:function(){this.rays=null,this.vArray=[],this.cArray=[]},render:function(t){if(this.rays){var e=this.region.gl;e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),t.drawLinesPlus(this.rays,2),e.disable(e.DEPTH_TEST)}}},YFM.WebGL.VAttribs=function(t){this.gl=t,this.attributes={}},YFM.WebGL.VAttribs.prototype={constructor:YFM.WebGL.VAttribs,persistence:function(){var t={};for(var e in this.attributes){var i=this.attributes[e];t[e]={rawArray:i.rawArray,size:i.size,length:i.length,normalized:i.normalized}}return t},addAttributeFlat:function(t,e,i,s){var r=this.gl,o=s||!1,a=new Float32Array(e),n=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,n),r.bufferData(r.ARRAY_BUFFER,a,r.STATIC_DRAW),r.bindBuffer(r.ARRAY_BUFFER,null),this.attributes[t]={vbo:n,size:i,length:e.length/i,normalized:o}},addAttributeElementFlat:function(t,e){var i=this.gl,s=new Uint16Array(e),r=i.createBuffer();i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,r),i.bufferData(i.ELEMENT_ARRAY_BUFFER,s,i.STATIC_DRAW),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),this.attributes[t]={vbo:r,length:e.length}},addAttribute:function(t,e,i,s){var r=this.gl,o=s||!1,a=r.createBuffer(),n=YFM.Math.flatten(e,i);r.bindBuffer(r.ARRAY_BUFFER,a),r.bufferData(r.ARRAY_BUFFER,n,r.STATIC_DRAW),r.bindBuffer(r.ARRAY_BUFFER,null),this.attributes[t]={vbo:a,size:i,length:e.length,normalized:o}},updateAttribute:function(t,e){var i=this.gl,s=this.attributes[t];if(s){var r=YFM.Math.flatten(e,s.size);i.bindBuffer(i.ARRAY_BUFFER,s.vbo),i.bufferData(i.ARRAY_BUFFER,r,i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,null)}},getAttribute:function(t){return this.attributes[t]},recycle:function(){for(var t in this.attributes){var e=this.attributes[t].vbo,i=this.gl;setTimeout(function(){i.deleteBuffer(e)},2e3)}}};